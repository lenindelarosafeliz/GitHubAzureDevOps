/* w2ui 2.0.x (nightly) (1/28/2022, 8:20:26 AM) (c) http://w2ui.com, vitmalina@gmail.com */
class w2event{constructor(e){this.handlers=[],void 0!==e&&w2utils.checkName(e)&&(w2ui[e]=this)}on(e,t){let i;var s;if("string"==typeof e&&-1!==e.indexOf(".")&&(e=(s=e.split("."))[0],i=s[1]),"string"==typeof e&&-1!==e.indexOf(":")&&(s=e.split(":"),-1!==["complete","done"].indexOf(e[1])&&(e[1]="after"),e={type:s[0],execute:s[1]},i&&(e.scope=i)),$.isPlainObject(e)||(e={type:e,scope:i}),(e=$.extend({type:null,execute:"before",target:null,onComplete:null},e)).type){if(t)return Array.isArray(this.handlers)||(this.handlers=[]),this.handlers.push({edata:e,handler:t}),this;console.log("ERROR: You must specify event handler function when calling .on() method of "+this.name)}else console.log("ERROR: You must specify event type when calling .on() method of "+this.name)}off(s,l){let n;var e;if("string"==typeof s&&-1!==s.indexOf(".")&&(s=(e=s.split("."))[0],n=e[1],""===s&&(s="*")),"string"==typeof s&&-1!==s.indexOf(":")&&(e=s.split(":"),-1!==["complete","done"].indexOf(s[1])&&(s[1]="after"),s={type:e[0],execute:e[1]}),$.isPlainObject(s)||(s={type:s}),(s=$.extend({},{type:null,execute:null,target:null,onComplete:null},s)).type||n){l=l||null;let i=[];for(let e=0,t=this.handlers.length;e<t;e++){var a=this.handlers[e];(a.edata.type!==s.type&&"*"!==s.type&&(null==a.edata.scope||""!=s.type)||a.edata.target!==s.target&&null!=s.target||a.edata.execute!==s.execute&&null!=s.execute||!(a.handler===l&&null!=l||null!=n&&a.edata.scope==n))&&i.push(a)}return this.handlers=i,this}console.log("ERROR: You must specify event type when calling .off() method of "+this.name)}trigger(i){"before"===(i=$.extend({type:null,phase:"before",target:null,doneHandlers:[]},i,{isStopped:!1,isCancelled:!1,done(e){this.doneHandlers.push(e)},preventDefault(){this.isCancelled=!0},stopPropagation(){this.isStopped=!0}})).phase&&(i.onComplete=null);let s,e,l;null==i.target&&(i.target=null),Array.isArray(this.handlers)||(this.handlers=[]);for(let t=this.handlers.length-1;0<=t;t--){let e=this.handlers[t];if(!(null==e||e.edata.type!==i.type&&"*"!==e.edata.type||e.edata.target!==i.target&&null!=e.edata.target||e.edata.execute!==i.phase&&"*"!==e.edata.execute&&"*"!==e.edata.phase)&&(i=$.extend({},e.edata,i),s=[],l=new RegExp(/\((.*?)\)/).exec(e.handler),l&&(s=l[1].split(/\s*,\s*/)),2===s.length?e.handler.call(this,i.target,i):e.handler.call(this,i),!0===i.isStopped||!0===i.stop))return i}var t="on"+i.type.substr(0,1).toUpperCase()+i.type.substr(1);if("before"===i.phase&&"function"==typeof this[t]&&(e=this[t],s=[],l=new RegExp(/\((.*?)\)/).exec(e),l&&(s=l[1].split(/\s*,\s*/)),2===s.length?e.call(this,i.target,i):e.call(this,i),!0===i.isStopped||!0===i.stop))return i;if(null!=i.object&&"before"===i.phase&&"function"==typeof i.object[t]&&(e=i.object[t],s=[],l=new RegExp(/\((.*?)\)/).exec(e),l&&(s=l[1].split(/\s*,\s*/)),2===s.length?e.call(this,i.target,i):e.call(this,i),!0===i.isStopped||!0===i.stop))return i;if("after"===i.phase){"function"==typeof i.onComplete&&i.onComplete.call(this,i);for(let e=0;e<i.doneHandlers.length;e++)"function"==typeof i.doneHandlers[e]&&i.doneHandlers[e].call(this,i)}return i}}const w2locale={locale:"en-US",dateFormat:"m/d/yyyy",timeFormat:"hh:mi pm",datetimeFormat:"m/d/yyyy|hh:mi pm",currencyPrefix:"$",currencySuffix:"",currencyPrecision:2,groupSymbol:",",decimalSymbol:".",shortmonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],fullmonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortdays:["M","T","W","T","F","S","S"],fulldays:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],weekStarts:"M",phrases:{"${count} letters or more...":"---","Add new record":"---","Add New":"---","Advanced Search":"---",after:"---","AJAX error. See console for more details.":"---","All Fields":"---",All:"---",Any:"---","Are you sure you want to delete ${count} ${records}?":"---","Attach files by dragging and dropping or Click to Select":"---",before:"---","begins with":"---",begins:"---",between:"---",buffered:"---",Cancel:"---",Close:"---",Column:"---",Confirmation:"---",contains:"---",Copied:"---","Copy to clipboard":"---","Current Date & Time":"---","Delete selected records":"---",Delete:"---",'Do you want to delete search item "${item}"?':"---","Edit selected record":"---",Edit:"---","Empty list":"---","ends with":"---",ends:"---","Field should be at least ${count} characters.":"---",Hide:"---",in:"---","is not":"---",is:"---","less than":"---","Line #":"---","Load ${count} more...":"---","Loading...":"---","Maximum number of files is ${count}":"---","Maximum total size is ${count}":"---",Modified:"---","more than":"---","Multiple Fields":"---",Name:"---","No items found":"---","No matches":"---",No:"---",none:"---","Not a float":"---","Not a hex number":"---","Not a valid date":"---","Not a valid email":"---","Not alpha-numeric":"---","Not an integer":"---","Not in money format":"---","not in":"---",Notification:"---",of:"---",Ok:"---",Opacity:"---","Record ID":"---",record:"---",records:"---","Refreshing...":"---","Reload data in the list":"---",Remove:"---","Request aborted.":"---","Required field":"---",Reset:"---","Restore Default State":"---","Returned data is not in valid JSON format.":"---","Save changed records":"---","Save Grid State":"---",Save:"---","Saved Searches":"---","Saving...":"---","Search took ${count} seconds":"---",Search:"---","Select Hour":"---","Select Minute":"---",selected:"---","Server Response ${count} seconds":"---","Show/hide columns":"---",Show:"---",Size:"---",Skip:"---","Sorting took ${count} seconds":"---","Type to search...":"---",Type:"---",Yes:"---",Yesterday:"---","Your remote data source record count has changed, reloading from the first record.":"---"}};let w2ui={},w2utils=(g=>{let e={};return{version:"2.0.x",settings:g.extend(!0,{},{dataType:"HTTPJSON",dateStartYear:1950,dateEndYear:2030,macButtonOrder:!1,warnNoPhrase:!1},w2locale,{phrases:null}),isBin:function(e){return/^[0-1]+$/.test(e)},isInt:o,isFloat:s,isMoney:function(e){if("object"==typeof e||""===e)return!1;if(s(e))return!0;let t=w2utils.settings,i=new RegExp("^"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[-+]?"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[0-9]*[\\"+t.decimalSymbol+"]?[0-9]+"+(t.currencySuffix?"\\"+t.currencySuffix+"?":"")+"$","i");"string"==typeof e&&(e=e.replace(new RegExp(t.groupSymbol,"g"),""));return i.test(e)},isHex:function(e){return/^(0x)?[0-9a-fA-F]+$/.test(e)},isAlphaNumeric:function(e){return/^[a-zA-Z0-9_-]+$/.test(e)},isEmail:function(e){return/^[a-zA-Z0-9._%\-+]+@[а-яА-Яa-zA-Z0-9.-]+\.[а-яА-Яa-zA-Z]+$/.test(e)},isIpAddress:function(e){let t=new RegExp("^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$");return t.test(e)},isDate:function(i,e,t){if(!i)return!1;let s="Invalid Date",l,n,a;null==e&&(e=w2utils.settings.dateFormat);if("function"==typeof i.getFullYear)a=i.getFullYear(),l=i.getMonth()+1,n=i.getDate();else if(parseInt(i)==i&&0<parseInt(i))i=new Date(parseInt(i)),a=i.getFullYear(),l=i.getMonth()+1,n=i.getDate();else{if(i=String(i),new RegExp("mon","ig").test(e)){e=e.replace(/month/gi,"m").replace(/mon/gi,"m").replace(/dd/gi,"d").replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase(),i=i.replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase();for(let t=0,e=w2utils.settings.fullmonths.length;t<e;t++){let e=w2utils.settings.fullmonths[t];i=i.replace(new RegExp(e,"ig"),parseInt(t)+1).replace(new RegExp(e.substr(0,3),"ig"),parseInt(t)+1)}}var r=i.replace(/-/g,"/").replace(/\./g,"/").toLowerCase().split("/"),e=e.replace(/-/g,"/").replace(/\./g,"/").toLowerCase();"mm/dd/yyyy"===e&&(l=r[0],n=r[1],a=r[2]),"m/d/yyyy"===e&&(l=r[0],n=r[1],a=r[2]),"dd/mm/yyyy"===e&&(l=r[1],n=r[0],a=r[2]),"d/m/yyyy"===e&&(l=r[1],n=r[0],a=r[2]),"yyyy/dd/mm"===e&&(l=r[2],n=r[1],a=r[0]),"yyyy/d/m"===e&&(l=r[2],n=r[1],a=r[0]),"yyyy/mm/dd"===e&&(l=r[1],n=r[2],a=r[0]),"yyyy/m/d"===e&&(l=r[1],n=r[2],a=r[0]),"mm/dd/yy"===e&&(l=r[0],n=r[1],a=r[2]),"m/d/yy"===e&&(l=r[0],n=r[1],a=parseInt(r[2])+1900),"dd/mm/yy"===e&&(l=r[1],n=r[0],a=parseInt(r[2])+1900),"d/m/yy"===e&&(l=r[1],n=r[0],a=parseInt(r[2])+1900),"yy/dd/mm"===e&&(l=r[2],n=r[1],a=parseInt(r[0])+1900),"yy/d/m"===e&&(l=r[2],n=r[1],a=parseInt(r[0])+1900),"yy/mm/dd"===e&&(l=r[1],n=r[2],a=parseInt(r[0])+1900),"yy/m/d"===e&&(l=r[1],n=r[2],a=parseInt(r[0])+1900)}if(!o(a))return!1;if(!o(l))return!1;if(!o(n))return!1;if(a=+a,l=+l,n=+n,s=new Date(a,l-1,n),s.setFullYear(a),null==l)return!1;if("Invalid Date"===String(s))return!1;if(s.getMonth()+1!==l||s.getDate()!==n||s.getFullYear()!==a)return!1;return!0!==t||s},isTime:function(e,t){if(null==e)return!1;let i,s,l;e=(e=String(e)).toUpperCase(),s=0<=e.indexOf("AM");var n=(l=0<=e.indexOf("PM"))||s;i=n?12:24;let a=(e=e.replace("AM","").replace("PM","").trim()).split(":"),r=parseInt(a[0]||0),o=parseInt(a[1]||0),d=parseInt(a[2]||0);if((!n||1!==a.length)&&2!==a.length&&3!==a.length)return!1;if(""===a[0]||r<0||r>i||!this.isInt(a[0])||2<a[0].length)return!1;if(1<a.length&&(""===a[1]||o<0||59<o||!this.isInt(a[1])||2!==a[1].length))return!1;if(2<a.length&&(""===a[2]||d<0||59<d||!this.isInt(a[2])||2!==a[2].length))return!1;if(!n&&i===r&&(0!==o||0!==d))return!1;if(n&&1===a.length&&0===r)return!1;if(!0!==t)return!0;l&&12!==r&&(r+=12);s&&12===r&&(r+=12);return{hours:r,minutes:o,seconds:d}},isDateTime:function(i,s,l){if("function"==typeof i.getFullYear)return!0!==l||i;var n=parseInt(i);if(n===i)return!(n<0)&&(!0!==l||new Date(n));n=String(i).indexOf(" ");{if(n<0)return!(String(i).indexOf("T")<0||"Invalid Date"==String(new Date(i)))&&(!0!==l||new Date(i));{let e=(s=null==s?w2utils.settings.datetimeFormat:s).split("|");n=[i.substr(0,n),i.substr(n).trim()];e[0]=e[0].trim(),e[1]&&(e[1]=e[1].trim());let t=w2utils.isDate(n[0],e[0],!0);n=w2utils.isTime(n[1],!0);return!1!==t&&!1!==n&&(!0!==l||(t.setHours(n.hours),t.setMinutes(n.minutes),t.setSeconds(n.seconds),t))}}},age:function(e){let t;if(""===e||null==e)return"";t="function"==typeof e.getFullYear?e:parseInt(e)==e&&0<parseInt(e)?new Date(parseInt(e)):new Date(e);if("Invalid Date"===String(t))return"";let i=new Date,s=(i.getTime()-t.getTime())/1e3,l="",n="";s<0?(l=0,n="sec"):s<60?(l=Math.floor(s),n="sec",s<0&&(l=0,n="sec")):s<3600?(l=Math.floor(s/60),n="min"):s<86400?(l=Math.floor(s/60/60),n="hour"):s<2592e3?(l=Math.floor(s/24/60/60),n="day"):s<31536e3?(l=Math.floor(s/30/24/60/60*10)/10,n="month"):s<126144e3?(l=Math.floor(s/365/24/60/60*10)/10,n="year"):126144e3<=s&&(l=Math.floor(s/365.25/24/60/60*10)/10,n="year");return l+" "+n+(1<l?"s":"")},interval:function(e){let t="";t=e<100?"< 0.01 sec":e<1e3?Math.floor(e/10)/100+" sec":e<1e4?Math.floor(e/100)/10+" sec":e<6e4?Math.floor(e/1e3)+" secs":e<36e5?Math.floor(e/6e4)+" mins":e<864e5?Math.floor(e/36e5*10)/10+" hours":e<2628e6?Math.floor(e/864e5*10)/10+" days":e<31536e6?Math.floor(e/2628e6*10)/10+" months":Math.floor(e/31536e5)/10+" years";return t},date:function(e){if(""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let t=new Date(e);w2utils.isInt(e)&&(t=new Date(Number(e)));if("Invalid Date"===String(t))return"";let i=w2utils.settings.shortmonths,s=new Date,l=new Date;l.setTime(l.getTime()-864e5);let n=i[t.getMonth()]+" "+t.getDate()+", "+t.getFullYear(),a=i[s.getMonth()]+" "+s.getDate()+", "+s.getFullYear(),r=i[l.getMonth()]+" "+l.getDate()+", "+l.getFullYear(),o=t.getHours()-(12<t.getHours()?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+" "+(12<=t.getHours()?"pm":"am"),d=t.getHours()-(12<t.getHours()?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+":"+(t.getSeconds()<10?"0":"")+t.getSeconds()+" "+(12<=t.getHours()?"pm":"am"),h=n;n==a&&(h=o);n==r&&(h=w2utils.lang("Yesterday"));return'<span title="'+n+" "+d+'">'+h+"</span>"},formatSize:function(e){if(!w2utils.isFloat(e)||""===e)return"";if(0===(e=parseFloat(e)))return 0;var t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return(Math.floor(e/Math.pow(1024,t)*10)/10).toFixed(0===t?0:1)+" "+(["Bt","KB","MB","GB","TB","PB","EB","ZB"][t]||"??")},formatNumber:function(e,t,i){if(null==e||""===e||"object"==typeof e)return"";let s={minimumFractionDigits:t,maximumFractionDigits:t,useGrouping:i};(null==t||t<0)&&(s.minimumFractionDigits=0,s.maximumFractionDigits=20);return parseFloat(e).toLocaleString(w2utils.settings.locale,s)},formatDate:function(e,t){t=t||this.settings.dateFormat;if(""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);w2utils.isInt(e)&&(i=new Date(Number(e)));if("Invalid Date"===String(i))return"";var s=i.getFullYear(),l=i.getMonth(),e=i.getDate();return t.toLowerCase().replace("month",w2utils.settings.fullmonths[l]).replace("mon",w2utils.settings.shortmonths[l]).replace(/yyyy/g,("000"+s).slice(-4)).replace(/yyy/g,("000"+s).slice(-4)).replace(/yy/g,("0"+s).slice(-2)).replace(/(^|[^a-z$])y/g,"$1"+s).replace(/mm/g,("0"+(l+1)).slice(-2)).replace(/dd/g,("0"+e).slice(-2)).replace(/th/g,1==e?"st":"th").replace(/th/g,2==e?"nd":"th").replace(/th/g,3==e?"rd":"th").replace(/(^|[^a-z$])m/g,"$1"+(l+1)).replace(/(^|[^a-z$])d/g,"$1"+e)},formatTime:function(e,t){t=t||this.settings.timeFormat;if(""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);w2utils.isInt(e)&&(i=new Date(Number(e)));w2utils.isTime(e)&&(e=w2utils.isTime(e,!0),i=new Date,i.setHours(e.hours),i.setMinutes(e.minutes));if("Invalid Date"===String(i))return"";let s="am",l=i.getHours(),n=i.getHours(),a=i.getMinutes(),r=i.getSeconds();a<10&&(a="0"+a);r<10&&(r="0"+r);-1===t.indexOf("am")&&-1===t.indexOf("pm")||(12<=l&&(s="pm"),12<l&&(l-=12),0===l&&(l=12));return t.toLowerCase().replace("am",s).replace("pm",s).replace("hhh",l<10?"0"+l:l).replace("hh24",n<10?"0"+n:n).replace("h24",n).replace("hh",l).replace("mm",a).replace("mi",a).replace("ss",r).replace(/(^|[^a-z$])h/g,"$1"+l).replace(/(^|[^a-z$])m/g,"$1"+a).replace(/(^|[^a-z$])s/g,"$1"+r)},formatDateTime:function(e,t){let i;if(""===e||null==e||"object"==typeof e&&!e.getMonth)return"";"string"!=typeof t?i=[this.settings.dateFormat,this.settings.timeFormat]:(i=t.split("|"),i[0]=i[0].trim(),i[1]=1<i.length?i[1].trim():this.settings.timeFormat);"h12"===i[1]&&(i[1]="h:m pm");"h24"===i[1]&&(i[1]="h24:m");return this.formatDate(e,i[0])+" "+this.formatTime(e,i[1])},stripTags:function(t){if(null==t)return t;switch(typeof t){case"number":break;case"string":t=String(t).replace(/<(?:[^>=]|='[^']*'|="[^"]*"|=[^'"][^\s>]*)*>/gi,"");break;case"object":if(Array.isArray(t)){t=g.extend(!0,[],t);for(let e=0;e<t.length;e++)t[e]=this.stripTags(t[e])}else for(var e in t=g.extend(!0,{},t))t[e]=this.stripTags(t[e])}return t},encodeTags:i,decodeTags:function(t){if(null==t)return t;switch(typeof t){case"number":break;case"string":t=String(t).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&");break;case"object":if(Array.isArray(t)){t=g.extend(!0,[],t);for(let e=0;e<t.length;e++)t[e]=this.decodeTags(t[e])}else for(var e in t=g.extend(!0,{},t))t[e]=this.decodeTags(t[e])}return t},escapeId:function(e){return""===e||null==e?"":g.escapeSelector(e)},unescapeId:function(e){return""===e||null==e?"":g.find.selectors.preFilter.ATTR([null,e])[1]},normMenu:function(i,e){return Array.isArray(i)?(i.forEach((e,t)=>{"string"==typeof e||"number"==typeof e?i[t]={id:e,text:e}:null!=e?(null!=e.caption&&null==e.text&&(e.text=e.caption),null!=e.text&&null==e.id&&(e.id=e.text),null==e.text&&null!=e.id&&(e.text=e.id)):i[t]={id:null,text:"null"}}),i):"function"==typeof i?w2utils.normMenu.call(this,i.call(this,e)):"object"==typeof i?Object.keys(i).map(e=>({id:e,text:i[e]})):void 0},bindEvents:m,base64encode:function(e){let t="",i,s,l,n,a,r,o,d=0,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";e=function(t){t=String(t).replace(/\r\n/g,"\n");let i="";for(let e=0;e<t.length;e++){var s=t.charCodeAt(e);s<128?i+=String.fromCharCode(s):(127<s&&s<2048?i+=String.fromCharCode(s>>6|192):(i+=String.fromCharCode(s>>12|224),i+=String.fromCharCode(s>>6&63|128)),i+=String.fromCharCode(63&s|128))}return i}(e);for(;d<e.length;)i=e.charCodeAt(d++),s=e.charCodeAt(d++),l=e.charCodeAt(d++),n=i>>2,a=(3&i)<<4|s>>4,r=(15&s)<<2|l>>6,o=63&l,isNaN(s)?r=o=64:isNaN(l)&&(o=64),t=t+h.charAt(n)+h.charAt(a)+h.charAt(r)+h.charAt(o);return t},base64decode:function(e){let t="",i,s,l,n,a,r,o,d=0,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(;d<e.length;)n=h.indexOf(e.charAt(d++)),a=h.indexOf(e.charAt(d++)),r=h.indexOf(e.charAt(d++)),o=h.indexOf(e.charAt(d++)),i=n<<2|a>>4,s=(15&a)<<4|r>>2,l=(3&r)<<6|o,t+=String.fromCharCode(i),64!==r&&(t+=String.fromCharCode(s)),64!==o&&(t+=String.fromCharCode(l));return t=function(e){let t="",i=0,s,l,n;for(;i<e.length;)(s=e.charCodeAt(i))<128?(t+=String.fromCharCode(s),i++):191<s&&s<224?(l=e.charCodeAt(i+1),t+=String.fromCharCode((31&s)<<6|63&l),i+=2):(l=e.charCodeAt(i+1),n=e.charCodeAt(i+2),t+=String.fromCharCode((15&s)<<12|(63&l)<<6|63&n),i+=3);return t}(t),t},md5:function(e){let n=0;function r(e,t,i,s,l,n){return f((n=f(f(t,e),f(s,n)))<<l|n>>>32-l,i)}function h(e,t,i,s,l,n,a){return r(t&i|~t&s,e,t,l,n,a)}function u(e,t,i,s,l,n,a){return r(t&s|i&~s,e,t,l,n,a)}function c(e,t,i,s,l,n,a){return r(t^i^s,e,t,l,n,a)}function p(e,t,i,s,l,n,a){return r(i^(t|~s),e,t,l,n,a)}function f(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}return function(e){return function(t){try{n}catch(e){n=0}let i=n?"0123456789ABCDEF":"0123456789abcdef",s="",l;for(let e=0;e<t.length;e++)l=t.charCodeAt(e),s+=i.charAt(l>>>4&15)+i.charAt(15&l);return s}(function(t){let i="";for(let e=0;e<32*t.length;e+=8)i+=String.fromCharCode(t[e>>5]>>>e%32&255);return i}(function(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;let i=1732584193,s=-271733879,l=-1732584194,n=271733878;for(let e=0;e<t.length;e+=16){var a=i,r=s,o=l,d=n;i=h(i,s,l,n,t[e+0],7,-680876936),n=h(n,i,s,l,t[e+1],12,-389564586),l=h(l,n,i,s,t[e+2],17,606105819),s=h(s,l,n,i,t[e+3],22,-1044525330),i=h(i,s,l,n,t[e+4],7,-176418897),n=h(n,i,s,l,t[e+5],12,1200080426),l=h(l,n,i,s,t[e+6],17,-1473231341),s=h(s,l,n,i,t[e+7],22,-45705983),i=h(i,s,l,n,t[e+8],7,1770035416),n=h(n,i,s,l,t[e+9],12,-1958414417),l=h(l,n,i,s,t[e+10],17,-42063),s=h(s,l,n,i,t[e+11],22,-1990404162),i=h(i,s,l,n,t[e+12],7,1804603682),n=h(n,i,s,l,t[e+13],12,-40341101),l=h(l,n,i,s,t[e+14],17,-1502002290),s=h(s,l,n,i,t[e+15],22,1236535329),i=u(i,s,l,n,t[e+1],5,-165796510),n=u(n,i,s,l,t[e+6],9,-1069501632),l=u(l,n,i,s,t[e+11],14,643717713),s=u(s,l,n,i,t[e+0],20,-373897302),i=u(i,s,l,n,t[e+5],5,-701558691),n=u(n,i,s,l,t[e+10],9,38016083),l=u(l,n,i,s,t[e+15],14,-660478335),s=u(s,l,n,i,t[e+4],20,-405537848),i=u(i,s,l,n,t[e+9],5,568446438),n=u(n,i,s,l,t[e+14],9,-1019803690),l=u(l,n,i,s,t[e+3],14,-187363961),s=u(s,l,n,i,t[e+8],20,1163531501),i=u(i,s,l,n,t[e+13],5,-1444681467),n=u(n,i,s,l,t[e+2],9,-51403784),l=u(l,n,i,s,t[e+7],14,1735328473),s=u(s,l,n,i,t[e+12],20,-1926607734),i=c(i,s,l,n,t[e+5],4,-378558),n=c(n,i,s,l,t[e+8],11,-2022574463),l=c(l,n,i,s,t[e+11],16,1839030562),s=c(s,l,n,i,t[e+14],23,-35309556),i=c(i,s,l,n,t[e+1],4,-1530992060),n=c(n,i,s,l,t[e+4],11,1272893353),l=c(l,n,i,s,t[e+7],16,-155497632),s=c(s,l,n,i,t[e+10],23,-1094730640),i=c(i,s,l,n,t[e+13],4,681279174),n=c(n,i,s,l,t[e+0],11,-358537222),l=c(l,n,i,s,t[e+3],16,-722521979),s=c(s,l,n,i,t[e+6],23,76029189),i=c(i,s,l,n,t[e+9],4,-640364487),n=c(n,i,s,l,t[e+12],11,-421815835),l=c(l,n,i,s,t[e+15],16,530742520),s=c(s,l,n,i,t[e+2],23,-995338651),i=p(i,s,l,n,t[e+0],6,-198630844),n=p(n,i,s,l,t[e+7],10,1126891415),l=p(l,n,i,s,t[e+14],15,-1416354905),s=p(s,l,n,i,t[e+5],21,-57434055),i=p(i,s,l,n,t[e+12],6,1700485571),n=p(n,i,s,l,t[e+3],10,-1894986606),l=p(l,n,i,s,t[e+10],15,-1051523),s=p(s,l,n,i,t[e+1],21,-2054922799),i=p(i,s,l,n,t[e+8],6,1873313359),n=p(n,i,s,l,t[e+15],10,-30611744),l=p(l,n,i,s,t[e+6],15,-1560198380),s=p(s,l,n,i,t[e+13],21,1309151649),i=p(i,s,l,n,t[e+4],6,-145523070),n=p(n,i,s,l,t[e+11],10,-1120210379),l=p(l,n,i,s,t[e+2],15,718787259),s=p(s,l,n,i,t[e+9],21,-343485551),i=f(i,a),s=f(s,r),l=f(l,o),n=f(n,d)}return Array(i,s,l,n)}(function(t){let i=Array(t.length>>2);for(let e=0;e<i.length;e++)i[e]=0;for(let e=0;e<8*t.length;e+=8)i[e>>5]|=(255&t.charCodeAt(e/8))<<e%32;return i}(e=function(e){let t="",i=-1,s,l;for(;++i<e.length;)s=e.charCodeAt(i),l=i+1<e.length?e.charCodeAt(i+1):0,55296<=s&&s<=56319&&56320<=l&&l<=57343&&(s=65536+((1023&s)<<10)+(1023&l),i++),s<=127?t+=String.fromCharCode(s):s<=2047?t+=String.fromCharCode(192|s>>>6&31,128|63&s):s<=65535?t+=String.fromCharCode(224|s>>>12&15,128|s>>>6&63,128|63&s):s<=2097151&&(t+=String.fromCharCode(240|s>>>18&7,128|s>>>12&63,128|s>>>6&63,128|63&s));return t}(e)),8*e.length)))}(e)},transition:function(e,t,i,s){let l=g(e).width(),n=g(e).height();if(e&&t){switch(e.parentNode.style.cssText+="perspective: 900px; overflow: hidden;",e.style.cssText+="; position: absolute; z-index: 1019; backface-visibility: hidden",t.style.cssText+="; position: absolute; z-index: 1020; backface-visibility: hidden",i){case"slide-left":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d("+l+"px, 0, 0)",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(-"+l+"px, 0, 0)"},1);break;case"slide-right":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(-"+l+"px, 0, 0)",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0px, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d("+l+"px, 0, 0)"},1);break;case"slide-down":e.style.cssText+="overflow: hidden; z-index: 1; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; z-index: 0; transform: translate3d(0, 0, 0)",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(0, "+n+"px, 0)"},1);break;case"slide-up":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(0, "+n+"px, 0)",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)"},1);break;case"flip-left":e.style.cssText+="overflow: hidden; transform: rotateY(0deg)",t.style.cssText+="overflow: hidden; transform: rotateY(-180deg)",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateY(180deg)"},1);break;case"flip-right":e.style.cssText+="overflow: hidden; transform: rotateY(0deg)",t.style.cssText+="overflow: hidden; transform: rotateY(180deg)",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateY(-180deg)"},1);break;case"flip-down":e.style.cssText+="overflow: hidden; transform: rotateX(0deg)",t.style.cssText+="overflow: hidden; transform: rotateX(180deg)",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateX(-180deg)"},1);break;case"flip-up":e.style.cssText+="overflow: hidden; transform: rotateX(0deg)",t.style.cssText+="overflow: hidden; transform: rotateX(-180deg)",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateX(180deg)"},1);break;case"pop-in":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(.8); opacity: 0;",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; transform: scale(1); opacity: 1;",e.style.cssText+="transition: 0.5s;"},1);break;case"pop-out":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(1); opacity: 1;",t.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); opacity: 0;",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; opacity: 1;",e.style.cssText+="transition: 0.5s; transform: scale(1.7); opacity: 0;"},1);break;default:e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; translate3d(0, 0, 0); opacity: 0;",g(t).show(),setTimeout(()=>{t.style.cssText+="transition: 0.5s; opacity: 1;",e.style.cssText+="transition: 0.5s"},1)}setTimeout(()=>{"slide-down"===i&&(g(e).css("z-index","1019"),g(t).css("z-index","1020")),t&&g(t).css({opacity:"1"}).css(w2utils.cssPrefix({transition:"",transform:""})),e&&g(e).css({opacity:"1"}).css(w2utils.cssPrefix({transition:"",transform:""})),"function"==typeof s&&s()},500)}else console.log("ERROR: Cannot do transition when one of the divs is null")},lock:function(e,t,i){let s={};"object"==typeof t?s=t:(s.msg=t,s.spinner=i);s.msg||0===s.msg||(s.msg="");w2utils.unlock(e),g(e).prepend('<div class="w2ui-lock"></div><div class="w2ui-lock-msg"></div>');let l=g(e).find(".w2ui-lock"),n=g(e).find(".w2ui-lock-msg");s.msg||n.css({"background-color":"transparent","background-image":"none",border:"0px","box-shadow":"none"});!0===s.spinner&&(s.msg='<div class="w2ui-spinner" '+(s.msg?"":'style="width: 35px; height: 35px"')+"></div>"+s.msg);null!=s.opacity&&l.css("opacity",s.opacity);"function"==typeof l.fadeIn?(l.fadeIn(200),n.html(s.msg).fadeIn(200)):(l.show(),n.html(s.msg).show(0))},unlock:function(e,t){o(t)?(g(e).find(".w2ui-lock").fadeOut(t),setTimeout(()=>{g(e).find(".w2ui-lock").remove(),g(e).find(".w2ui-lock-msg").remove()},t)):(g(e).find(".w2ui-lock").remove(),g(e).find(".w2ui-lock-msg").remove())},message:function(p,f){return new Promise((t,e)=>{let s=this,i,l;g().w2tag(),null==(f=f||{width:200,height:100}).on&&(o=f,f=new w2event,g.extend(f,o)),null==f.width&&(f.width=200),null==f.height&&(f.height=100);var n=parseInt(g(p.box).width()),a=parseInt(g(p.box).height()),r=parseInt(g(p.box).find(p.title).css("height")||0);f.width>n&&(f.width=n-10),f.height>a-r&&(f.height=a-10-r),f.originalWidth=f.width,f.originalHeight=f.height,parseInt(f.width)<0&&(f.width=n+f.width),parseInt(f.width)<10&&(f.width=10),parseInt(f.height)<0&&(f.height=a+f.height-r),parseInt(f.height)<10&&(f.height=10),null==f.hideOnClick&&(f.hideOnClick=!1);var o=g(p.box).data("options")||{};(null==f.width||f.width>o.width-10)&&(f.width=o.width-10),(null==f.height||f.height>o.height-r-5)&&(f.height=o.height-r-5),f.originalHeight<0&&(f.height=a+f.originalHeight-r),f.originalWidth<0&&(f.width=n+2*f.originalWidth);let d=g(p.box).find(p.title),h=g(p.box).find(".w2ui-message.w2ui-closing");0<g(p.box).find(".w2ui-message.w2ui-closing").length&&(clearTimeout(i),c(h,h.data("options")||{}));let u=g(p.box).find(".w2ui-message").length;if(""===(f.html||"").trim()&&""===(f.body||"").trim()&&""===(f.buttons||"").trim()){if(0!==u){let e=g(p.box).find("#w2ui-message"+(u-1));(f=e.data("options")||{}).trigger&&(l=f.trigger({phase:"before",type:"close",target:"self",box:f.box[0]}),!0===l.isCancelled)||(e.css(w2utils.cssPrefix({transition:"0.15s",transform:"translateY(-"+f.height+"px)"})).addClass("w2ui-closing animating"),1===u?this.unlock&&(p.param?this.unlock(p.param,150):this.unlock(150)):g(p.box).find("#w2ui-message"+(u-2)).css("z-index",1500),i=setTimeout(()=>{c(e,f)},150))}}else{""===(f.body||"").trim()&&""===(f.buttons||"").trim()||(f.html='<div class="w2ui-message-body">'+(f.body||"")+'</div><div class="w2ui-message-buttons">'+(f.buttons||"")+"</div>"),g(p.box).find(".w2ui-message").css("z-index",1390),d.data("old-z-index",d.css("z-index")),d.css("z-index",1501),g(p.box).find(p.body).before('<div id="w2ui-message'+u+'" data-mousedown="stop"    class="w2ui-message" style="display: none; z-index: 1500; '+(0===d.length?"top: 0px;":"top: "+w2utils.getSize(d,"height")+"px;")+(null!=f.width?"width: "+f.width+"px; left: "+(n-f.width)/2+"px;":"left: 10px; right: 10px;")+(null!=f.height?"height: "+f.height+"px;":"bottom: 6px;")+w2utils.cssPrefix("transition",".3s",!0)+'"'+(!0===f.hideOnClick?p.param?`data-click='["message", "${p.param}"]`:'data-click="message"':"")+"></div>"),m("#w2ui-message"+u,this),g(p.box).find("#w2ui-message"+u).addClass("animating").data("options",f).data("prev_focus",g(":focus"));let e=g(p.box).find("#w2ui-message"+u).css("display");if(g(p.box).find("#w2ui-message"+u).css(w2utils.cssPrefix({transform:"none"===e?"translateY(-"+f.height+"px)":"translateY(0px)"})),"none"===e){if(g(p.box).find("#w2ui-message"+u).show().html(f.html),f.box=g(p.box).find("#w2ui-message"+u),f.trigger&&(l=f.trigger({phase:"before",type:"open",target:"self",box:f.box[0]}),!0===l.isCancelled))return d.css("z-index",d.data("old-z-index")),void g(p.box).find("#w2ui-message"+u).remove();setTimeout(()=>{g(p.box).find("#w2ui-message"+u).css(w2utils.cssPrefix({transform:"none"===e?"translateY(0px)":"translateY(-"+f.height+"px)"}))},1),0===u&&this.lock&&(p.param?this.lock(p.param):this.lock()),setTimeout(()=>{g(p.box).find("#w2ui-message"+u).removeClass("animating").css(w2utils.cssPrefix({transition:"0s"})),f.trigger&&(f.trigger(g.extend(l,{phase:"after"})),t({box:g(p.box).find("#w2ui-message"+u)}))},350)}}function c(e,t){if(null==l&&t.trigger&&(l=t.trigger({phase:"before",type:"close",target:"self"}),!0===l.isCancelled))return d.css("z-index",d.data("old-z-index")),void g(p.box).find("#w2ui-message"+u).remove();let i=e.data("prev_focus");e.remove(),i&&0<i.length?i.focus():s&&"function"==typeof s.focus&&s.focus(),d.css("z-index",d.data("old-z-index")),t.trigger&&t.trigger(g.extend(l,{phase:"after"}))}})},naturalCompare:function(e,t){let s,i,l=1,n=0,a=0,r=String.alphabet;function o(e,t,i){if(i){for(s=t;(i=o(e,s))<76&&65<i;)++s;return+e.slice(t-1,s)}return-1<(i=r&&r.indexOf(e.charAt(t)))?i+76:(i=e.charCodeAt(t)||0)<45||127<i?i:i<46?65:i<48?i-1:i<58?i+18:i<65?i-11:i<91?i+11:i<97?i-37:i<123?i+5:i-63}if((e+="")!=(t+=""))for(;l;)if(i=o(e,n++),l=o(t,a++),i<76&&l<76&&66<i&&66<l&&(i=o(e,n,n),l=o(t,a,n=s),a=s),i!=l)return i<l?-1:1;return 0},i18nCompare:Intl.Collator().compare,execTemplate:l,lang:function(e,t){if(!e||null==this.settings.phrases||"string"!=typeof e||"<=>=".includes(e))return l(e,t);let i=this.settings.phrases[e];null==i?(i=e,this.settings.warnNoPhrase&&(this.settings.missing||(this.settings.missing={}),this.settings.missing[e]="---",this.settings.phrases[e]="---",console.log(`Missing translation for "%c${e}%c", see %c w2utils.settings.phrases %c with value "---"`,"color: orange","","color: #999",""))):"---"!==i||this.settings.warnNoPhrase||(i=e);"---"===i&&(i=`<span ${w2utils.tooltip(e)}>---</span>`);return l(i,t)},locale:function(n,a){return new Promise((s,l)=>{if(Array.isArray(n)){w2utils.settings.phrases={};let t=[];return n.forEach(e=>{t.push(w2utils.locale(e,!0))}),void Promise.allSettled(t).then(e=>{s(e.map(e=>e.value))})}n=n||"en-us",g.isPlainObject(n)?w2utils.settings=g.extend(!0,{},w2utils.settings,w2locale,n):(5===n.length&&(n="locale/"+n.toLowerCase()+".json"),g.ajax({url:n,type:"GET",dataType:"JSON",success(e,t,i){w2utils.settings=a?g.extend(!0,{},w2utils.settings,e):g.extend(!0,{},w2utils.settings,w2locale,{phrases:{}},e),s(e)},error(e,t,i){console.log("ERROR: Cannot load locale "+n),l(i)}}))})},getSize:function(e,t){let i=g(e),s=parseInt(i.css("border-left-width"))||0,l=parseInt(i.css("border-right-width"))||0,n=parseInt(i.css("border-top-width"))||0,a=parseInt(i.css("border-bottom-width"))||0,r=parseInt(i.css("margin-left"))||0,o=parseInt(i.css("margin-right"))||0,d=parseInt(i.css("margin-top"))||0,h=parseInt(i.css("margin-bottom"))||0,u=parseInt(i.css("padding-left"))||0,c=parseInt(i.css("padding-right"))||0,p=parseInt(i.css("padding-top"))||0,f=parseInt(i.css("padding-bottom"))||0;switch(t){case"top":return n+d+p;case"bottom":return a+h+f;case"left":return s+r+u;case"right":return l+o+c;case"width":return s+l+r+o+u+c+parseInt(i.width());case"height":return n+a+d+h+p+f+parseInt(i.height());case"+width":return s+l+r+o+u+c;case"+height":return n+a+d+h+p+f}return 0},getStrWidth:function(e,t){var e='<div id="_tmp_width" style="position: absolute; top: -900px;'+(t||"")+'">'+i(e)+"</div>";return g("body").append(e),e=g("#_tmp_width").width(),g("#_tmp_width").remove(),e},scrollBarSize:function(){if(e.scrollBarSize)return e.scrollBarSize;g("body").append('<div id="_scrollbar_width" style="position: absolute; top: -300px; width: 100px; height: 100px; overflow-y: scroll;">    <div style="height: 120px">1</div></div>'),e.scrollBarSize=100-g("#_scrollbar_width > div").width(),g("#_scrollbar_width").remove(),0<=String(navigator.userAgent).indexOf("MSIE")&&(e.scrollBarSize=e.scrollBarSize/2);return e.scrollBarSize},checkName:function(e){return null!=e?null==w2ui[e]?!!w2utils.isAlphaNumeric(e)||(console.log('ERROR: Property "name" has to be alpha-numeric (a-z, 0-9, dash and underscore).'),!1):(console.log(`ERROR: Object named "${e}" is already registered as w2ui.${e}.`),!1):(console.log('ERROR: Property "name" is required but not supplied.'),!1)},checkUniqueId:function(t,i,s,l){Array.isArray(i)||(i=[i]);for(let e=0;e<i.length;e++)if(i[e].id===t)return console.log(`ERROR: The item "id=${t}" is not unique within the ${s} "${l}".`,i),!1;return!0},parseRoute:function(e){let a=[],t=e.replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,(e,t,i,s,l,n)=>(a.push({name:s,optional:!!n}),t=t||"",(n?"":t)+"(?:"+(n?t:"")+(i||"")+(l||(i?"([^/.]+?)":"([^/]+?)"))+")"+(n||""))).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)");return{path:new RegExp("^"+t+"$","i"),keys:a}},cssPrefix:function(e,t,i){let s={},l={},n="";g.isPlainObject(e)?(s=e,!0===t&&(i=!0)):s[e]=t;for(var a in s)l[a]=s[a],l["-webkit-"+a]=s[a],l["-moz-"+a]=s[a].replace("-webkit-","-moz-"),l["-ms-"+a]=s[a].replace("-webkit-","-ms-"),l["-o-"+a]=s[a].replace("-webkit-","-o-");if(!0===i)for(var r in l)n+=r+": "+l[r]+"; ";else n=l;return n},parseColor:function(e){{if("string"!=typeof e)return null;e=e.trim().toUpperCase()}"#"===e[0]&&(e=e.substr(1));let t={};if(3===e.length)t={r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:1};else if(6===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:1};else if(8===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:Math.round(parseInt(e.substr(6,2),16)/255*100)/100};else if(4<e.length&&"RGB("===e.substr(0,4)){var i=e.replace("RGB","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:1}}else{if(!(5<e.length&&"RGBA("===e.substr(0,5)))return null;e=e.replace("RGBA","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(e[0],10),g:parseInt(e[1],10),b:parseInt(e[2],10),a:parseFloat(e[3])}}return t},hsv2rgb:function(e,t,i,s){let l,n,a,r,o,d,h,u;1===arguments.length&&(t=e.s,i=e.v,s=e.a,e=e.h);switch(e/=360,t/=100,i/=100,r=Math.floor(6*e),o=6*e-r,d=i*(1-t),h=i*(1-o*t),u=i*(1-(1-o)*t),r%6){case 0:l=i,n=u,a=d;break;case 1:l=h,n=i,a=d;break;case 2:l=d,n=i,a=u;break;case 3:l=d,n=h,a=i;break;case 4:l=u,n=d,a=i;break;case 5:l=i,n=d,a=h}return{r:Math.round(255*l),g:Math.round(255*n),b:Math.round(255*a),a:null!=s?s:1}},rgb2hsv:function(e,t,i,s){1===arguments.length&&(t=e.g,i=e.b,s=e.a,e=e.r);let l=Math.max(e,t,i),n=Math.min(e,t,i),a=l-n,r,o=0===l?0:a/l,d=l/255;switch(l){case n:r=0;break;case e:r=t-i+a*(t<i?6:0),r/=6*a;break;case t:r=i-e+2*a,r/=6*a;break;case i:r=e-t+4*a,r/=6*a}return{h:Math.round(360*r),s:Math.round(100*o),v:Math.round(100*d),a:null!=s?s:1}},tooltip:function(e,t){let i="mouseenter",s="mouseleave",l=!1;"object"==typeof e&&(t=e);t=t||{},"string"==typeof e&&(t.html=e);t.showOn&&(i=t.showOn,delete t.showOn);t.hideOn&&(s=t.hideOn,delete t.hideOn);!0===t.overlay&&(l=!0,delete t.overlay);return` on${i}="jQuery(this).${l?"w2overlay":"w2tag"}(`+` JSON.parse(w2utils.base64decode('${w2utils.base64encode(JSON.stringify(t))}')))"`+` on${s}="jQuery(this).${l?"w2overlay":"w2tag"}(`+`${l&&null!=t.name?`JSON.parse(w2utils.base64decode('${w2utils.base64encode(JSON.stringify({name:t.name}))}'))`:""}`+')"'},clone:n,extend:function t(i,s){if(Array.isArray(i)){if(!Array.isArray(s))throw new Error("Arrays can be extended with arrays only");s.forEach(e=>{i.push(n(e))})}else{if(!i||"object"!=typeof i)throw new Error("Object is not extendable, only {} or [] can be extended.");if(null==s||"object"!=typeof s)throw new Error("Object can be extended with other objects only.");Object.keys(s).forEach(e=>{i[e]=n(s[e])})}if(2<arguments.length)for(let e=2;e<arguments.length;e++)t(i,arguments[e]);return i},getCursorPosition:function(i){if(null==i)return null;let s=0,t=i.ownerDocument||i.document,e=t.defaultView||t.parentWindow,l;if(i.tagName&&"INPUT"===i.tagName.toUpperCase()&&i.selectionStart)s=i.selectionStart;else if(e.getSelection){if(l=e.getSelection(),0<l.rangeCount){let e=l.getRangeAt(0),t=e.cloneRange();t.selectNodeContents(i),t.setEnd(e.endContainer,e.endOffset),s=t.toString().length}}else if((l=t.selection)&&"Control"!==l.type){var n=l.createRange();let e=t.body.createTextRange();e.moveToElementText(i),e.setEndPoint("EndToEnd",n),s=e.text.length}return s},setCursorPosition:function(i,s,e){let t=document.createRange(),l,n=window.getSelection();if(null!=i){for(let t=0;t<i.childNodes.length;t++){let e=g(i.childNodes[t]).text();if(i.childNodes[t].tagName&&(e=g(i.childNodes[t]).html(),e=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&nbsp;/g," ")),s<=e.length){l=i.childNodes[t],l.childNodes&&0<l.childNodes.length&&(l=l.childNodes[0]),l.childNodes&&0<l.childNodes.length&&(l=l.childNodes[0]);break}s-=e.length}null!=l&&(s>l.length&&(s=l.length),t.setStart(l,s),e?t.setEnd(l,e):t.collapse(!0),n.removeAllRanges(),n.addRange(t))}},testLocalStorage:t,hasLocalStorage:t(),isMac:/Mac/i.test(navigator.platform),isMobile:/(iphone|ipod|ipad|mobile|android)/i.test(navigator.userAgent),isIOS:/(iphone|ipod|ipad)/i.test(navigator.platform),isAndroid:/(android)/i.test(navigator.userAgent),isSafari:/^((?!chrome|android).)*safari/i.test(navigator.userAgent)};function o(e){return/^[-+]?[0-9]+$/.test(e)}function s(e){return("number"==typeof(e="string"==typeof e?e.replace(w2utils.settings.groupSymbol,"").replace(w2utils.settings.decimalSymbol,"."):e)||"string"==typeof e&&""!==e)&&!isNaN(Number(e))}function i(t){if(null==t)return t;switch(typeof t){case"number":break;case"string":t=String(t).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");break;case"object":if(Array.isArray(t)){t=g.extend(!0,[],t);for(let e=0;e<t.length;e++)t[e]=this.encodeTags(t[e])}else for(var e in t=g.extend(!0,{},t))t[e]=this.encodeTags(t[e])}return t}function l(e,i){return"string"==typeof e&&i&&"object"==typeof i?e.replace(/\${([^}]+)?}/g,function(e,t){return i[t]||t}):e}function t(){var e="w2ui_test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}function n(e){let i;return Array.isArray(e)?(i=Array.from(e),i.forEach((e,t)=>{i[t]=n(e)})):null!=e&&"object"==typeof e?(i={},Object.assign(i,e),Object.keys(i).forEach(e=>{i[e]=n(i[e])})):i=e,i}function m(e,l){g(e).each((e,s)=>{var t=g(s).data();Object.keys(t).forEach(i=>{if(-1!=["click","dblclick","mouseenter","mouseleave","mouseover","mouseout","mousedown","mousemove","mouseup","contextmenu","focus","blur","input","change","keydown","keyup","keypress"].indexOf(String(i).toLowerCase())){let e=g(s).data(i);"string"==typeof e&&(e=e.split("|").map(e=>("null"===(e="undefined"===(e="false"===(e="true"===e?!0:e)?!1:e)?void 0:e)&&(e=null),e=parseFloat(e)==e?parseFloat(e):e)));let t=e[0];e=e.slice(1),g(s).off(i+".w2utils-bind").on(i+".w2utils-bind",function(i){switch(t){case"alert":alert(e[0]);break;case"stop":i.stopPropagation();break;case"prevent":i.preventDefault();break;case"stopPrevent":return i.stopPropagation(),i.preventDefault(),!1;default:l[t].apply(l,e.map((e,t)=>{switch(String(e).toLowerCase()){case"event":return i;case"this":return this;default:return e}}))}})}})})}})(jQuery);w2utils.formatters={number(e,t){return 20<parseInt(t)&&(t=20),parseInt(t)<0&&(t=0),null==e||""===e?"":w2utils.formatNumber(parseFloat(e),t,!0)},float(e,t){return w2utils.formatters.number(e,t)},int(e,t){return w2utils.formatters.number(e,0)},money(e,t){if(null==e||""===e)return"";e=w2utils.formatNumber(Number(e),w2utils.settings.currencyPrecision);return(w2utils.settings.currencyPrefix||"")+e+(w2utils.settings.currencySuffix||"")},currency(e,t){return w2utils.formatters.money(e,t)},percent(e,t){return null==e||""===e?"":w2utils.formatNumber(e,t||1)+"%"},size(e,t){return null==e||""===e?"":w2utils.formatSize(parseInt(e))},date(e,t){if(""===t&&(t=w2utils.settings.dateFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),'<span title="'+i+'">'+w2utils.formatDate(i,t)+"</span>"},datetime(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),'<span title="'+i+'">'+w2utils.formatDateTime(i,t)+"</span>"},time(e,t){if("h24"===(t="h12"===(t=""===t?w2utils.settings.timeFormat:t)?"hh:mi pm":t)&&(t="h24:mi"),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),'<span title="'+i+'">'+w2utils.formatTime(e,t)+"</span>"},timestamp(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),i.toString?i.toString():""},gmt(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),i.toUTCString?i.toUTCString():""},age(e,t){if(null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,null,!0);return!1===i&&(i=w2utils.isDate(e,null,!0)),'<span title="'+i+'">'+w2utils.age(e)+(t?" "+t:"")+"</span>"},interval(e,t){return null==e||0===e||""===e?"":w2utils.interval(e)+(t?" "+t:"")},toggle(e,t){return e?"Yes":""},password(t,e){let i="";for(let e=0;e<t.length;e++)i+="*";return i}};class w2grid extends w2event{constructor(e){if(super(e.name),this.name=null,this.box=null,this.columns=[],this.columnGroups=[],this.records=[],this.summary=[],this.searches=[],this.toolbar={},this.ranges=[],this.menu=[],this.searchMap={},this.searchData=[],this.sortMap={},this.sortData=[],this.savedSearches=[],this.total=0,this.recid=null,this.last={field:"",label:"",logic:"AND",search:"",searchIds:[],selection:{indexes:[],columns:{}},_selection:null,multi:!1,scrollTop:0,scrollLeft:0,colStart:0,colEnd:0,xhr:null,xhr_cmd:"",xhr_offset:null,xhr_start:0,xhr_response:0,xhr_hasMore:!1,pull_more:!1,pull_refresh:!0,loaded:!1,range_start:null,range_end:null,sel_ind:null,sel_col:null,sel_type:null,sel_recid:null,idCache:{},move:null,cancelClick:null,inEditMode:!1,_edit:null,kbd_timer:null,marker_timer:null,click_time:null,click_recid:null,bubbleEl:null,colResizing:!1,tmp:null,copy_event:null,userSelect:"",columnDrag:!1,state:null,show_extra:0,_toolbar_height:0},this.header="",this.url="",this.limit=100,this.offset=0,this.postData={},this.routeData={},this.httpHeaders={},this.show={header:!1,toolbar:!1,footer:!1,columnHeaders:!0,lineNumbers:!1,orderColumn:!1,expandColumn:!1,selectColumn:!1,emptyRecords:!0,toolbarReload:!0,toolbarColumns:!1,toolbarSearch:!0,toolbarAdd:!1,toolbarEdit:!1,toolbarDelete:!1,toolbarSave:!1,searchAll:!0,searchLogic:!0,searchHiddenMsg:!1,searchSave:!0,statusRange:!0,statusBuffered:!1,statusRecordID:!0,statusSelection:!0,statusResponse:!0,statusSort:!1,statusSearch:!1,recordTitles:!1,selectionBorder:!0,skipRecords:!0,saveRestoreState:!0},this.stateId=null,this.hasFocus=!1,this.autoLoad=!0,this.fixedBody=!0,this.recordHeight=32,this.lineNumberWidth=34,this.keyboard=!0,this.selectType="row",this.multiSearch=!0,this.multiSelect=!0,this.multiSort=!0,this.reorderColumns=!1,this.reorderRows=!1,this.showExtraOnSearch=0,this.markSearch=!0,this.columnTooltip="top|bottom",this.disableCVS=!1,this.nestedFields=!0,this.vs_start=150,this.vs_extra=15,this.style="",this.tabIndex=null,this.method=null,this.dataType=null,this.parser=null,this.advanceOnEdit=!0,this.useLocalStorage=!0,this.colDefaults={text:"",field:"",size:null,min:20,max:null,gridMinWidth:null,sizeCorrected:null,sizeCalculated:null,sizeOriginal:null,sizeType:null,hidden:!1,sortable:!1,sortMode:null,searchable:!1,resizable:!0,hideable:!0,autoResize:null,attr:"",style:"",render:null,title:null,tooltip:null,editable:{},frozen:!1,info:null,clipboardCopy:!1},this.stateColProps={text:!1,field:!0,size:!0,min:!1,max:!1,gridMinWidth:!1,sizeCorrected:!1,sizeCalculated:!0,sizeOriginal:!0,sizeType:!0,hidden:!0,sortable:!1,sortMode:!0,searchable:!1,resizable:!1,hideable:!1,autoResize:!1,attr:!1,style:!1,render:!1,title:!1,tooltip:!1,editable:!1,frozen:!0,info:!1,clipboardCopy:!1},this.msgDelete="Are you sure you want to delete ${count} ${records}?",this.msgNotJSON="Returned data is not in valid JSON format.",this.msgAJAXerror="AJAX error. See console for more details.",this.msgRefresh="Refreshing...",this.msgNeedReload="Your remote data source record count has changed, reloading from the first record.",this.msgEmpty="",this.buttons={reload:{type:"button",id:"w2ui-reload",icon:"w2ui-icon-reload",tooltip:"Reload data in the list"},columns:{type:"drop",id:"w2ui-column-on-off",icon:"w2ui-icon-columns",tooltip:"Show/hide columns",arrow:!1,html:""},search:{type:"html",id:"w2ui-search",html:"<div class=\"w2ui-icon w2ui-icon-search w2ui-search-down\" onclick=\"let grid = w2ui[jQuery(this).parents('div.w2ui-grid').attr('name')]; grid.searchShowFields()\"></div>"},add:{type:"button",id:"w2ui-add",text:"Add New",tooltip:"Add new record",icon:"w2ui-icon-plus"},edit:{type:"button",id:"w2ui-edit",text:"Edit",tooltip:"Edit selected record",icon:"w2ui-icon-pencil",disabled:!0},delete:{type:"button",id:"w2ui-delete",text:"Delete",tooltip:"Delete selected records",icon:"w2ui-icon-cross",disabled:!0},save:{type:"button",id:"w2ui-save",text:"Save",tooltip:"Save changed records",icon:"w2ui-icon-check"}},this.operators={text:["is","begins","contains","ends"],number:["=","between",">","<",">=","<="],date:["is","between",{oper:"less",text:"before"},{oper:"more",text:"after"}],list:["is"],hex:["is","between"],color:["is","begins","contains","ends"],enum:["in","not in"]},this.defaultOperator={text:"begins",number:"=",date:"is",list:"is",enum:"in",hex:"begins",color:"begins"},this.operatorsMap={text:"text",int:"number",float:"number",money:"number",currency:"number",percent:"number",hex:"hex",alphanumeric:"text",color:"color",date:"date",time:"date",datetime:"date",list:"list",combo:"text",enum:"enum",file:"enum",select:"list",radio:"list",checkbox:"list",toggle:"list"},this.onAdd=null,this.onEdit=null,this.onRequest=null,this.onLoad=null,this.onDelete=null,this.onSave=null,this.onSelect=null,this.onUnselect=null,this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onMenuClick=null,this.onColumnClick=null,this.onColumnDblClick=null,this.onColumnResize=null,this.onColumnAutoResize=null,this.onSort=null,this.onSearch=null,this.onSearchOpen=null,this.onChange=null,this.onRestore=null,this.onExpand=null,this.onCollapse=null,this.onError=null,this.onKeydown=null,this.onToolbar=null,this.onColumnOnOff=null,this.onCopy=null,this.onPaste=null,this.onSelectionExtend=null,this.onEditField=null,this.onRender=null,this.onRefresh=null,this.onReload=null,this.onResize=null,this.onDestroy=null,this.onStateSave=null,this.onStateRestore=null,this.onFocus=null,this.onBlur=null,this.onReorderRow=null,this.onSearchSave=null,this.onSearchRemove=null,this.onSearchSelect=null,this.onColumnSelect=null,this.onColumnDragStart=null,this.onColumnDragEnd=null,this.onResizerDblClick=null,$.extend(!0,this,e),Array.isArray(this.records)){let i=[];this.records.forEach((e,t)=>{null!=e[this.recid]&&(e.recid=e[this.recid]),null==e.recid&&console.log("ERROR: Cannot add records without recid. (obj: "+this.name+")"),e.w2ui&&!0===e.w2ui.summary&&(this.summary.push(e),i.push(t))}),i.sort();for(let e=i.length-1;0<=e;e--)this.records.splice(i[e],1)}if(Array.isArray(this.columns)&&this.columns.forEach((i,e)=>{i=$.extend({},this.colDefaults,i);e=(this.columns[e]=i).searchable;if(null!=e&&!1!==e&&null==this.getSearch(i.field))if($.isPlainObject(e))this.addSearch($.extend({field:i.field,label:i.text,type:"text"},e));else{let e=i.searchable,t="";!0===i.searchable&&(e="text",t='size="20"'),this.addSearch({field:i.field,label:i.text,type:e,attr:t})}}),w2utils.hasLocalStorage&&this.useLocalStorage)try{var t=JSON.parse(localStorage.w2ui||"{}");if(t&&t.searches){let e=t.searches[this.stateId||this.name];Array.isArray(e)&&e.forEach(e=>{this.savedSearches.push({id:e.name,text:e.name,icon:"w2ui-icon-search",remove:!0,logic:e.logic,data:e.data})})}}catch(e){}}add(i,s){Array.isArray(i)||(i=[i]);let l=0;for(let t=0;t<i.length;t++){let e=i[t];null!=e[this.recid]&&(e.recid=e[this.recid]),null!=e.recid?(e.w2ui&&!0===e.w2ui.summary?s?this.summary.unshift(e):this.summary.push(e):s?this.records.unshift(e):this.records.push(e),l++):console.log("ERROR: Cannot add record without recid. (obj: "+this.name+")")}return("object"!=typeof this.url?this.url:this.url.get)||(this.total=this.records.length,this.localSort(!1,!0),this.localSearch()),this.refresh(),l}find(s,e,t){let l=[],n=!1;for(var i in s=null==s?{}:s)-1!=String(i).indexOf(".")&&(n=!0);var a=t?this.last.range_start:0;let r=t?this.last.range_end+1:this.records.length;r>this.records.length&&(r=this.records.length);for(let i=a;i<r;i++){let t=!0;for(var o in s){let e=this.records[i][o];n&&-1!=String(o).indexOf(".")&&(e=this.parseField(this.records[i],o)),"not-null"==s[o]?null!=e&&""!==e||(t=!1):s[o]!=e&&(t=!1)}t&&!0!==e&&l.push(this.records[i].recid),t&&!0===e&&l.push(i)}return l}set(e,t,i){if("object"==typeof e&&null!==e&&(i=t,t=e,e=null),null==e){for(let e=0;e<this.records.length;e++)$.extend(!0,this.records[e],t);!0!==i&&this.refresh()}else{var s=this.get(e,!0);if(null==s)return!1;!this.records[s]||this.records[s].recid!=e?$.extend(!0,this.summary[s],t):$.extend(!0,this.records[s],t),!0!==i&&this.refreshRow(e,s)}return!0}get(i,s){if(Array.isArray(i)){let t=[];for(let e=0;e<i.length;e++){var l=this.get(i[e],s);null!==l&&t.push(l)}return t}{let t=this.last.idCache;t||(this.last.idCache=t={});let e=t[i];if("number"==typeof e){if(0<=e&&e<this.records.length&&this.records[e].recid==i)return!0===s?e:this.records[e];if(e=~e,0<=e&&e<this.summary.length&&this.summary[e].recid==i)return!0===s?e:this.summary[e];this.last.idCache=t={}}for(let e=0;e<this.records.length;e++)if(this.records[e].recid==i)return t[i]=e,!0===s?e:this.records[e];for(let e=0;e<this.summary.length;e++)if(this.summary[e].recid==i)return t[i]=~e,!0===s?e:this.summary[e];return null}}getFirst(e){if(0==this.records.length)return null;let t=this.records[0];var i=this.last.searchIds;return 0<this.searchData.length&&(t=Array.isArray(i)&&0<i.length?this.records[i[e||0]]:null),t}remove(){let i=0;for(let t=0;t<arguments.length;t++){for(let e=this.records.length-1;0<=e;e--)this.records[e].recid==arguments[t]&&(this.records.splice(e,1),i++);for(let e=this.summary.length-1;0<=e;e--)this.summary[e].recid==arguments[t]&&(this.summary.splice(e,1),i++)}return("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(!1,!0),this.localSearch()),this.refresh(),i}addColumn(e,s){let t=0;1==arguments.length?(s=e,e=this.columns.length):null==(e="string"==typeof e?this.getColumn(e,!0):e)&&(e=this.columns.length),Array.isArray(s)||(s=[s]);for(let i=0;i<s.length;i++){var l=$.extend({},this.colDefaults,s[i]);if(this.columns.splice(e,0,l),s[i].searchable){let e=s[i].searchable,t="";!0===s[i].searchable&&(e="text",t='size="20"'),this.addSearch({field:s[i].field,label:s[i].label,type:e,attr:t})}e++,t++}return this.refresh(),t}removeColumn(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.columns.length-1;0<=e;e--)this.columns[e].field==arguments[t]&&(this.columns[e].searchable&&this.removeSearch(arguments[t]),this.columns.splice(e,1),i++);return this.refresh(),i}getColumn(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.columns.length;e++)t.push(this.columns[e].field);return t}for(let e=0;e<this.columns.length;e++)if(this.columns[e].field==t)return!0===i?e:this.columns[e];return null}updateColumn(e,s){let l=0;return(e=Array.isArray(e)?e:[e]).forEach(e=>{this.columns.forEach(i=>{if(i.field==e){let t=$.extend(!0,{},s);Object.keys(t).forEach(e=>{"function"==typeof t[e]&&(t[e]=t[e](i)),i[e]!=t[e]&&l++}),$.extend(!0,i,t)}})}),0<l&&this.refresh(),l}toggleColumn(){return this.updateColumn(Array.from(arguments),{hidden(e){return!e.hidden}})}showColumn(){return this.updateColumn(Array.from(arguments),{hidden:!1})}hideColumn(){return this.updateColumn(Array.from(arguments),{hidden:!0})}addSearch(t,i){let s=0;1==arguments.length?(i=t,t=this.searches.length):null==(t="string"==typeof t?this.getSearch(t,!0):t)&&(t=this.searches.length),Array.isArray(i)||(i=[i]);for(let e=0;e<i.length;e++)this.searches.splice(t,0,i[e]),t++,s++;return this.searchClose(),s}removeSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&(this.searches.splice(e,1),i++);return this.searchClose(),i}getSearch(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.searches.length;e++)t.push(this.searches[e].field);return t}for(let e=0;e<this.searches.length;e++)if(this.searches[e].field==t)return!0===i?e:this.searches[e];return null}toggleSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&(this.searches[e].hidden=!this.searches[e].hidden,i++);return this.searchClose(),i}showSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&!1!==this.searches[e].hidden&&(this.searches[e].hidden=!1,i++);return this.searchClose(),i}hideSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&!0!==this.searches[e].hidden&&(this.searches[e].hidden=!0,i++);return this.searchClose(),i}getSearchData(t){for(let e=0;e<this.searchData.length;e++)if(this.searchData[e].field==t)return this.searchData[e];return null}localSort(t,i){let r=this;if("object"!=typeof this.url?this.url:this.url.get)console.log("ERROR: grid.localSort can only be used on local data source, grid.url should be empty.");else if(!$.isEmptyObject(this.sortData)){let e=(new Date).getTime();this.selectionSave(),this.prepareData(),i||this.reset();for(let t=0;t<this.sortData.length;t++){let e=this.getColumn(this.sortData[t].field);if(!e)return;"string"==typeof e.render&&(-1!=["date","age"].indexOf(e.render.split(":")[0])&&(this.sortData[t].field_=e.field+"_"),-1!=["time"].indexOf(e.render.split(":")[0])&&(this.sortData[t].field_=e.field+"_"))}return function(){for(let t=0;t<r.records.length;t++){let e=r.records[t];e.w2ui&&null!=e.w2ui.parent_recid&&(e.w2ui._path=n(e))}}(),this.records.sort((e,t)=>function(e,t){if(!(e.w2ui&&null!=e.w2ui.parent_recid||t.w2ui&&null!=t.w2ui.parent_recid))return a(e,t);var i=n(e),s=n(t);for(let e=0;e<Math.min(i.length,s.length);e++){var l=a(i[e],s[e]);if(0!==l)return l}return i.length>s.length?1:i.length<s.length?-1:(console.log("ERROR: two paths should not be equal."),0)}(e,t)),function(){for(let t=0;t<r.records.length;t++){let e=r.records[t];e.w2ui&&null!=e.w2ui.parent_recid&&(e.w2ui._path=null)}}(),this.selectionRestore(i),e=(new Date).getTime()-e,!0!==t&&this.show.statusSort&&setTimeout(()=>{this.status(w2utils.lang("Sorting took ${count} seconds",{count:e/1e3}))},10),e;function n(e){if(!e.w2ui||null==e.w2ui.parent_recid)return[e];if(e.w2ui._path)return e.w2ui._path;var t=r.get(e.w2ui.parent_recid);return t?n(t).concat(e):(console.log("ERROR: no parent record: "+e.w2ui.parent_recid),[e])}function a(s,l){if(s===l)return 0;for(let i=0;i<r.sortData.length;i++){var n=r.sortData[i].field,a=r.sortData[i].field_||n;let e=s[a],t=l[a];-1!=String(n).indexOf(".")&&(e=r.parseField(s,a),t=r.parseField(l,a));n=r.getColumn(n);n&&0<Object.keys(n.editable).length&&($.isPlainObject(e)&&e.text&&(e=e.text),$.isPlainObject(t)&&t.text&&(t=t.text));n=o(e,t,i,r.sortData[i].direction,n.sortMode||"default");if(0!==n)return n}return o(s.recid,l.recid,0,"asc")}function o(e,t,i,s,l){if(e===t)return 0;if((null==e||""===e)&&null!=t&&""!==t)return 1;if(null!=e&&""!==e&&(null==t||""===t))return-1;var n="asc"===s.toLowerCase()?1:-1;if(typeof e!=typeof t)return typeof t<typeof e?n:-n;if(e.constructor.name!=t.constructor.name)return e.constructor.name>t.constructor.name?n:-n;e&&"object"==typeof e&&(e=e.valueOf()),t&&"object"==typeof t&&(t=t.valueOf());s={}.toString;switch(e&&"object"==typeof e&&e.toString!=s&&(e=String(e)),t&&"object"==typeof t&&t.toString!=s&&(t=String(t)),"string"==typeof e&&(e=e.toLowerCase().trim()),"string"==typeof t&&(t=t.toLowerCase().trim()),l){case"natural":l=w2utils.naturalCompare;break;case"i18n":l=w2utils.i18nCompare}return"function"==typeof l?l(e,t)*n:t<e?n:e<t?-n:0}}}localSearch(t){let c=this;var i="object"!=typeof this.url?this.url:this.url.get;if(i)console.log("ERROR: grid.localSearch can only be used on local data source, grid.url should be empty.");else{let e=(new Date).getTime(),u={}.toString,l={};if(this.total=this.records.length,this.last.searchIds=[],this.prepareData(),0<this.searchData.length&&!i){for(let s=this.total=0;s<this.records.length;s++){var n=this.records[s];if(function i(l){let n=0,a,r,o,d;let h=!1;for(let e=0;e<c.searchData.length;e++){let i=c.searchData[e],s=c.getSearch(i.field);if(null!=i){null==s&&(s={field:i.field,type:i.type});let t=c.parseField(l,s.field);switch(a=null===t||void 0===t||"object"==typeof t&&t.toString==u?"":String(t).toLowerCase(),null!=i.value&&(Array.isArray(i.value)?(r=i.value[0],o=i.value[1]):r=String(i.value).toLowerCase()),i.operator){case"=":case"is":c.parseField(l,s.field)==i.value?n++:"date"==s.type?(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.formatDate(d,"yyyy-mm-dd"),r=w2utils.formatDate(w2utils.isDate(r,w2utils.settings.dateFormat,!0),"yyyy-mm-dd"),a==r&&n++):"time"==s.type?(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.formatTime(d,"hh24:mi"),r=w2utils.formatTime(r,"hh24:mi"),a==r&&n++):"datetime"==s.type&&(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.formatDateTime(d,"yyyy-mm-dd|hh24:mm:ss"),r=w2utils.formatDateTime(w2utils.isDateTime(r,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),a==r&&n++);break;case"between":-1!=["int","float","money","currency","percent"].indexOf(s.type)?parseFloat(c.parseField(l,s.field))>=parseFloat(r)&&parseFloat(c.parseField(l,s.field))<=parseFloat(o)&&n++:"date"==s.type?(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.isDate(d,w2utils.settings.dateFormat,!0),r=w2utils.isDate(r,w2utils.settings.dateFormat,!0),o=w2utils.isDate(o,w2utils.settings.dateFormat,!0),null!=o&&(o=new Date(o.getTime()+864e5)),a>=r&&a<o&&n++):"time"==s.type?(a=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),r=w2utils.isTime(r,!0),o=w2utils.isTime(o,!0),r=(new Date).setHours(r.hours,r.minutes,r.seconds||0,0),o=(new Date).setHours(o.hours,o.minutes,o.seconds||0,0),a>=r&&a<o&&n++):"datetime"==s.type&&(a=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),r=w2utils.isDateTime(r,w2utils.settings.datetimeFormat,!0),o=w2utils.isDateTime(o,w2utils.settings.datetimeFormat,!0),o=o&&new Date(o.getTime()+864e5),a>=r&&a<o&&n++);break;case"<=":h=!0;case"<":case"less":-1!=["int","float","money","currency","percent"].indexOf(s.type)?(a=parseFloat(c.parseField(l,s.field)),r=parseFloat(i.value),(a<r||h&&a===r)&&n++):"date"==s.type?(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.isDate(d,w2utils.settings.dateFormat,!0),r=w2utils.isDate(r,w2utils.settings.dateFormat,!0),(a<r||h&&a===r)&&n++):"time"==s.type?(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.formatTime(d,"hh24:mi"),r=w2utils.formatTime(r,"hh24:mi"),(a<r||h&&a===r)&&n++):"datetime"==s.type&&(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.formatDateTime(d,"yyyy-mm-dd|hh24:mm:ss"),r=w2utils.formatDateTime(w2utils.isDateTime(r,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),a.length==r.length&&(a<r||h&&a===r)&&n++);break;case">=":h=!0;case">":case"more":-1!=["int","float","money","currency","percent"].indexOf(s.type)?(a=parseFloat(c.parseField(l,s.field)),r=parseFloat(i.value),(a>r||h&&a===r)&&n++):"date"==s.type?(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.isDate(d,w2utils.settings.dateFormat,!0),r=w2utils.isDate(r,w2utils.settings.dateFormat,!0),(a>r||h&&a===r)&&n++):"time"==s.type?(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.formatTime(d,"hh24:mi"),r=w2utils.formatTime(r,"hh24:mi"),(a>r||h&&a===r)&&n++):"datetime"==s.type&&(d=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.formatDateTime(d,"yyyy-mm-dd|hh24:mm:ss"),r=w2utils.formatDateTime(w2utils.isDateTime(r,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),a.length==r.length&&(a>r||h&&a===r)&&n++);break;case"in":d=i.value,i.svalue&&(d=i.svalue),-1===d.indexOf(w2utils.isFloat(t)?parseFloat(t):t)&&-1===d.indexOf(a)||n++;break;case"not in":d=i.value,i.svalue&&(d=i.svalue),-1===d.indexOf(w2utils.isFloat(t)?parseFloat(t):t)&&-1===d.indexOf(a)&&n++;break;case"begins":case"begins with":0===a.indexOf(r)&&n++;break;case"contains":0<=a.indexOf(r)&&n++;break;case"null":null==c.parseField(l,s.field)&&n++;break;case"not null":null!=c.parseField(l,s.field)&&n++;break;case"ends":case"ends with":let e=a.lastIndexOf(r);-1!==e&&e==a.length-r.length&&n++}}}if("OR"==c.last.logic&&0!==n||"AND"==c.last.logic&&n==c.searchData.length)return!0;if(l.w2ui&&l.w2ui.children&&!0!==l.w2ui.expanded)for(let t=0;t<l.w2ui.children.length;t++){let e=l.w2ui.children[t];if(i(e))return!0}return!1}(n))if(n&&n.w2ui&&!function e(t){if(void 0===t)return;if(l[t])return;l[t]=!0;let i=c.get(t,!0);if(null==i)return;if(-1!=$.inArray(i,c.last.searchIds))return;let s=c.records[i];s&&s.w2ui&&e(s.w2ui.parent_recid);c.last.searchIds.push(i)}(n.w2ui.parent_recid),0<this.showExtraOnSearch){let t=this.showExtraOnSearch,i=this.showExtraOnSearch;if(s<t&&(t=s),s+i>this.records.length&&(i=this.records.length-s),0<t)for(let e=s-t;e<s;e++)this.last.searchIds.indexOf(e)<0&&this.last.searchIds.push(e);if(this.last.searchIds.indexOf(s)<0&&this.last.searchIds.push(s),0<i)for(let e=s+1;e<=s+i;e++)this.last.searchIds.indexOf(e)<0&&this.last.searchIds.push(e)}else this.last.searchIds.push(s)}this.total=this.last.searchIds.length}return e=(new Date).getTime()-e,!0!==t&&this.show.statusSearch&&setTimeout(()=>{this.status(w2utils.lang("Search took ${count} seconds",{count:e/1e3}))},10),e}}getRangeData(e,i){var s=this.get(e[0].recid,!0),l=this.get(e[1].recid,!0),n=e[0].column,a=e[1].column;let r=[];if(n==a)for(let e=s;e<=l;e++){var t=this.records[e],o=t[this.columns[n].field]||null;!0!==i?r.push(o):r.push({data:o,column:n,index:e,record:t})}else if(s==l){var d=this.records[s];for(let e=n;e<=a;e++){var h=d[this.columns[e].field]||null;!0!==i?r.push(h):r.push({data:h,column:e,index:s,record:d})}}else for(let t=s;t<=l;t++){var u=this.records[t];r.push([]);for(let e=n;e<=a;e++){var c=u[this.columns[e].field];!0!==i?r[r.length-1].push(c):r[r.length-1].push({data:c,column:e,index:t,record:u})}}return r}addRange(s){let e=0,l,n;if("row"==this.selectType)return e;Array.isArray(s)||(s=[s]);for(let i=0;i<s.length;i++){if("object"!=typeof s[i]&&(s[i]={name:"selection"}),"selection"==s[i].name){if(!1===this.show.selectionBorder)continue;var a=this.getSelection();if(0===a.length){this.removeRange("selection");continue}l=a[0],n=a[a.length-1]}else l=s[i].range[0],n=s[i].range[1];if(l){a={name:s[i].name,range:[{recid:l.recid,column:l.column},{recid:n.recid,column:n.column}],style:s[i].style||""};let t=!1;for(let e=0;e<this.ranges.length;e++)if(this.ranges[e].name==s[i].name){t=e;break}!1!==t?this.ranges[t]=a:this.ranges.push(a),e++}}return this.refreshRanges(),e}removeRange(){let t=0;for(let e=0;e<arguments.length;e++){var i=arguments[e];$(this.box).find("#grid_"+this.name+"_"+i).remove(),$(this.box).find("#grid_"+this.name+"_f"+i).remove();for(let e=this.ranges.length-1;0<=e;e--)this.ranges[e].name==i&&(this.ranges.splice(e,1),t++)}return t}refreshRanges(){if(0!==this.ranges.length){let n=this,h,u,c;var e=(new Date).getTime();let p=$(this.box).find("#grid_"+this.name+"_frecords"),f=$(this.box).find("#grid_"+this.name+"_records");for(let d=0;d<this.ranges.length;d++){var g=this.ranges[d];let e=g.range[0],t=g.range[1];null==e.index&&(e.index=this.get(e.recid,!0)),null==t.index&&(t.index=this.get(t.recid,!0));let i=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+' td[col="'+e.column+'"]'),s=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t.recid)+' td[col="'+t.column+'"]'),l=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(e.recid)+' td[col="'+e.column+'"]'),n=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t.recid)+' td[col="'+t.column+'"]'),a=t.column;e.column<this.last.colStart&&t.column>this.last.colStart&&(i=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+' td[col="start"]')),e.column<this.last.colEnd&&t.column>this.last.colEnd&&(a='"end"',s=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t.recid)+' td[col="end"]'));var m=parseInt($(this.box).find("#grid_"+this.name+"_rec_top").next().attr("index")),w=parseInt($(this.box).find("#grid_"+this.name+"_rec_bottom").prev().attr("index")),b=parseInt($(this.box).find("#grid_"+this.name+"_frec_top").next().attr("index")),y=parseInt($(this.box).find("#grid_"+this.name+"_frec_bottom").prev().attr("index"));0===i.length&&e.index<m&&t.index>m&&(i=$(this.box).find("#grid_"+this.name+"_rec_top").next().find("td[col="+e.column+"]")),0===s.length&&t.index>w&&e.index<w&&(s=$(this.box).find("#grid_"+this.name+"_rec_bottom").prev().find("td[col="+a+"]")),0===l.length&&e.index<b&&t.index>b&&(l=$(this.box).find("#grid_"+this.name+"_frec_top").next().find("td[col="+e.column+"]")),0===n.length&&t.index>y&&e.index<y&&(n=$(this.box).find("#grid_"+this.name+"_frec_bottom").prev().find("td[col="+t.column+"]"));let r=$(this.box).find("#grid_"+this.name+"_editable"),o=r.find(".w2ui-input");b=o.attr("recid"),y=o.attr("column");"selection"==g.name&&g.range[0].recid==b&&g.range[0].column==y||(h=$(this.box).find("#grid_"+this.name+"_f"+g.name),0<l.length||0<n.length?(0===h.length?(p.append('<div id="grid_'+this.name+"_f"+g.name+'" class="w2ui-selection" style="'+g.style+'">'+("selection"==g.name?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),h=$(this.box).find("#grid_"+this.name+"_f"+g.name)):(h.attr("style",g.style),h.find(".w2ui-selection-resizer").show()),0===n.length&&(n=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t.recid)+" td:last-child"),0===n.length&&(n=$(this.box).find("#grid_"+this.name+"_frec_bottom td:first-child")),h.css("border-right","0px"),h.find(".w2ui-selection-resizer").hide()),null!=e.recid&&null!=t.recid&&0<l.length&&0<n.length?(u=l.position().left+l.scrollLeft(),c=l.position().top-l.scrollTop(),h.show().css({left:(0<u?u:0)+"px",top:(0<c?c:0)+"px",width:n.position().left-l.position().left+n.width()+2+"px",height:n.position().top-l.position().top+n.height()+1+"px"})):h.hide()):h.hide(),h=$(this.box).find("#grid_"+this.name+"_"+g.name),0<i.length||0<s.length?(0===h.length?(f.append('<div id="grid_'+this.name+"_"+g.name+'" class="w2ui-selection" style="'+g.style+'">'+("selection"==g.name?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),h=$(this.box).find("#grid_"+this.name+"_"+g.name)):h.attr("style",g.style),0===i.length&&(i=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+" td:first-child"),0===i.length&&(i=$(this.box).find("#grid_"+this.name+"_rec_top td:first-child"))),0!==n.length&&h.css("border-left","0px"),null!=e.recid&&null!=t.recid&&0<i.length&&0<s.length?(u=i.position().left+i.scrollLeft(),c=i.position().top-i.scrollTop(),h.show().css({left:(0<u?u:0)+"px",top:(0<c?c:0)+"px",width:s.position().left-i.position().left+s.width()+2+"px",height:s.position().top-i.position().top+s.height()+1+"px"})):h.hide()):h.hide())}$(this.box).find(".w2ui-selection-resizer").off("mousedown").on("mousedown",function(e){var t=n.getSelection();n.last.move={type:"expand",x:e.screenX,y:e.screenY,divX:0,divY:0,recid:t[0].recid,column:t[0].column,originalRange:[{recid:t[0].recid,column:t[0].column},{recid:t[t.length-1].recid,column:t[t.length-1].column}],newRange:[{recid:t[0].recid,column:t[0].column},{recid:t[t.length-1].recid,column:t[t.length-1].column}]},$(document).off(".w2ui-"+n.name).on("mousemove.w2ui-"+n.name,i).on("mouseup.w2ui-"+n.name,s),e.preventDefault()}).off("dblclick").on("dblclick",function(e){e=n.trigger({phase:"before",type:"resizerDblClick",target:n.name,originalEvent:e});!0!==e.isCancelled&&n.trigger($.extend(e,{phase:"after"}))});let a={phase:"before",type:"selectionExtend",target:n.name,originalRange:null,newRange:null};return(new Date).getTime()-e;function i(s){let l=n.last.move;if(l&&"expand"==l.type){l.divX=s.screenX-l.x,l.divY=s.screenY-l.y;let e,t,i=s.originalEvent.target;"TD"!=i.tagName.toUpperCase()&&(i=$(i).parents("td")[0]),null!=$(i).attr("col")&&(t=parseInt($(i).attr("col"))),i=$(i).parents("tr")[0],e=$(i).attr("recid"),l.newRange[1].recid==e&&l.newRange[1].column==t||(s=$.extend({},l.newRange),l.newRange=[{recid:l.recid,column:l.column},{recid:e,column:t}],a=n.trigger($.extend(a,{originalRange:l.originalRange,newRange:l.newRange})),!0===a.isCancelled?(l.newRange=s,a.newRange=s):(n.removeRange("grid-selection-expand"),n.addRange({name:"grid-selection-expand",range:a.newRange,style:"background-color: rgba(100,100,100,0.1); border: 2px dotted rgba(100,100,100,0.5);"})))}}function s(e){n.removeRange("grid-selection-expand"),delete n.last.move,$(document).off(".w2ui-"+n.name),n.trigger($.extend(a,{phase:"after"}))}}}select(){if(0===arguments.length)return 0;let a=0,r=this.last.selection;this.multiSelect||this.selectNone();let t=Array.prototype.slice.call(arguments);Array.isArray(t[0])&&(t=t[0]);let e={phase:"before",type:"select",target:this.name};1==t.length?(e.multiple=!1,$.isPlainObject(t[0])?(e.recid=t[0].recid,e.column=t[0].column):e.recid=t[0]):(e.multiple=!0,e.recids=t);var i=this.trigger(e);if(!0===i.isCancelled)return 0;if("row"==this.selectType)for(let e=0;e<t.length;e++){var s="object"==typeof t[e]?t[e].recid:t[e],l=this.get(s,!0);if(null!=l){let e=null,t=null;(0!==this.searchData.length||l+1>=this.last.range_start&&l+1<=this.last.range_end)&&(e=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(s)),t=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(s))),"row"==this.selectType&&-1==r.indexes.indexOf(l)&&(r.indexes.push(l),e&&t&&(e.addClass("w2ui-selected").data("selected","yes").find(".w2ui-col-number").addClass("w2ui-row-selected"),t.addClass("w2ui-selected").data("selected","yes").find(".w2ui-col-number").addClass("w2ui-row-selected"),e.find(".w2ui-grid-select-check").prop("checked",!0)),a++)}}else{let l={};for(let e=0;e<t.length;e++){var o="object"==typeof t[e]?t[e].recid:t[e],d="object"==typeof t[e]?t[e].column:null;if(l[o]=l[o]||[],Array.isArray(d))l[o]=d;else if(w2utils.isInt(d))l[o].push(d);else for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||l[o].push(parseInt(e))}let n=[];for(var h in l){var u=this.get(h,!0);if(null!=u){let t=null,i=null;u+1>=this.last.range_start&&u+1<=this.last.range_end&&(t=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(h)),i=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(h)));let s=r.columns[u]||[];-1==r.indexes.indexOf(u)&&r.indexes.push(u);for(let e=0;e<l[h].length;e++)-1==s.indexOf(l[h][e])&&s.push(l[h][e]);s.sort((e,t)=>e-t);for(let e=0;e<l[h].length;e++){var c=l[h][e];-1==n.indexOf(c)&&n.push(c),t&&(t.find("#grid_"+this.name+"_data_"+u+"_"+c).addClass("w2ui-selected"),t.find(".w2ui-col-number").addClass("w2ui-row-selected"),t.data("selected","yes"),t.find(".w2ui-grid-select-check").prop("checked",!0)),i&&(i.find("#grid_"+this.name+"_data_"+u+"_"+c).addClass("w2ui-selected"),i.find(".w2ui-col-number").addClass("w2ui-row-selected"),i.data("selected","yes"),i.find(".w2ui-grid-select-check").prop("checked",!0)),a++}r.columns[u]=s}}for(let e=0;e<n.length;e++)$(this.box).find("#grid_"+this.name+"_column_"+n[e]+" .w2ui-col-header").addClass("w2ui-col-selected")}r.indexes.sort((e,t)=>e-t);var n=0<this.records.length&&r.indexes.length==this.records.length,p=0<r.indexes.length&&0!==this.searchData.length&&r.indexes.length==this.last.searchIds.length;return n||p?$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(r,n),this.trigger($.extend(i,{phase:"after"})),a}unselect(){let n=0,a=this.last.selection,i=Array.prototype.slice.call(arguments);Array.isArray(i[0])&&(i=i[0]);let e={phase:"before",type:"unselect",target:this.name};1==i.length?(e.multiple=!1,$.isPlainObject(i[0])?(e.recid=i[0].recid,e.column=i[0].column):e.recid=i[0]):(e.multiple=!0,e.recids=i);var t=this.trigger(e);if(!0===t.isCancelled)return 0;for(let t=0;t<i.length;t++){var r="object"==typeof i[t]?i[t].recid:i[t],o=this.get(r);if(null!=o){o=this.get(o.recid,!0);let s=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(r)),l=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(r));if("row"==this.selectType)-1!=a.indexes.indexOf(o)&&(a.indexes.splice(a.indexes.indexOf(o),1),s.removeClass("w2ui-selected w2ui-inactive").removeData("selected").find(".w2ui-col-number").removeClass("w2ui-row-selected"),l.removeClass("w2ui-selected w2ui-inactive").removeData("selected").find(".w2ui-col-number").removeClass("w2ui-row-selected"),0!=s.length&&(s[0].style.cssText="height: "+this.recordHeight+"px; "+s.attr("custom_style"),l[0].style.cssText="height: "+this.recordHeight+"px; "+l.attr("custom_style")),s.find(".w2ui-grid-select-check").prop("checked",!1),n++);else{var d=i[t].column;if(!w2utils.isInt(d)){let t=[];for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||t.push({recid:r,column:e});return this.unselect(t)}let e=a.columns[o];if(Array.isArray(e)&&-1!=e.indexOf(d)){e.splice(e.indexOf(d),1),$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(r)).find(" > td[col="+d+"]").removeClass("w2ui-selected w2ui-inactive"),$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(r)).find(" > td[col="+d+"]").removeClass("w2ui-selected w2ui-inactive");let t=!1,i=!1;var h=this.getSelection();for(let e=0;e<h.length;e++)h[e].column==d&&(t=!0),h[e].recid==r&&(i=!0);t||$(this.box).find(".w2ui-grid-columns td[col="+d+"] .w2ui-col-header, .w2ui-grid-fcolumns td[col="+d+"] .w2ui-col-header").removeClass("w2ui-col-selected"),i||$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(r)).find(".w2ui-col-number").removeClass("w2ui-row-selected"),n++,0===e.length&&(delete a.columns[o],a.indexes.splice(a.indexes.indexOf(o),1),s.removeData("selected"),s.find(".w2ui-grid-select-check").prop("checked",!1),l.removeData("selected"))}}}}var s=0<this.records.length&&a.indexes.length==this.records.length,l=0<a.indexes.length&&0!==this.searchData.length&&a.indexes.length==this.last.searchIds.length;return s||l?$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(a,s),this.trigger($.extend(t,{phase:"after"})),n}selectAll(){var e=(new Date).getTime();if(!1!==this.multiSelect){var t=this.trigger({phase:"before",type:"select",target:this.name,all:!0});if(!0!==t.isCancelled){var l="object"!=typeof this.url?this.url:this.url.get;let i=this.last.selection,s=[];for(let e=0;e<this.columns.length;e++)s.push(e);if(i.indexes=[],l||0===this.searchData.length){let t=this.records.length;0==this.searchData.length||l||(t=this.last.searchIds.length);for(let e=0;e<t;e++)i.indexes.push(e),"row"!=this.selectType&&(i.columns[e]=s.slice())}else for(let e=0;e<this.last.searchIds.length;e++)i.indexes.push(this.last.searchIds[e]),"row"!=this.selectType&&(i.columns[this.last.searchIds[e]]=s.slice());return"row"==this.selectType?($(this.box).find(".w2ui-grid-records tr").not(".w2ui-empty-record").addClass("w2ui-selected").data("selected","yes").find(".w2ui-col-number").addClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-frecords tr").not(".w2ui-empty-record").addClass("w2ui-selected").data("selected","yes").find(".w2ui-col-number").addClass("w2ui-row-selected")):($(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").addClass("w2ui-col-selected"),$(this.box).find(".w2ui-grid-records tr .w2ui-col-number").addClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-records tr").not(".w2ui-empty-record").find(".w2ui-grid-data").not(".w2ui-col-select").addClass("w2ui-selected").data("selected","yes"),$(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").addClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-frecords tr").not(".w2ui-empty-record").find(".w2ui-grid-data").not(".w2ui-col-select").addClass("w2ui-selected").data("selected","yes")),$(this.box).find("input.w2ui-grid-select-check").prop("checked",!0),i=this.getSelection(!0),1==i.length?this.toolbar.enable("w2ui-edit"):this.toolbar.disable("w2ui-edit"),1<=i.length?this.toolbar.enable("w2ui-delete"):this.toolbar.disable("w2ui-delete"),this.addRange("selection"),$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0),this.status(),this.updateToolbar({indexes:i},!0),this.trigger($.extend(t,{phase:"after"})),(new Date).getTime()-e}}}selectNone(){var t=(new Date).getTime(),i=this.trigger({phase:"before",type:"unselect",target:this.name,all:!0});if(!0!==i.isCancelled){let e=this.last.selection;return"row"==this.selectType?($(this.box).find(".w2ui-grid-records tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").removeData("selected").find(".w2ui-col-number").removeClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-frecords tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").removeData("selected").find(".w2ui-col-number").removeClass("w2ui-row-selected")):($(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").removeClass("w2ui-col-selected"),$(this.box).find(".w2ui-grid-records tr .w2ui-col-number").removeClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").removeClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-data.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").removeData("selected")),$(this.box).find("input.w2ui-grid-select-check").prop("checked",!1),e.indexes=[],e.columns={},this.toolbar.disable("w2ui-edit","w2ui-delete"),this.removeRange("selection"),$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.updateToolbar(e,!1),this.trigger($.extend(i,{phase:"after"})),(new Date).getTime()-t}}updateToolbar(s){let l=this,n=s&&s.indexes?s.indexes.length:0;function i(t,i){if(null!=t.batch){let e=!1;!0===t.batch?0<n&&(e=!0):"number"==typeof t.batch?n===t.batch&&(e=!0):"function"==typeof t.batch&&(e=t.batch({cnt:n,sel:s})),e?l.toolbar.enable(i+t.id):l.toolbar.disable(i+t.id)}}this.toolbar.items.forEach(t=>{i(t,""),Array.isArray(t.items)&&t.items.forEach(e=>{i(e,t.id+":")})})}getSelection(t){let i=[];var s=this.last.selection;if("row"==this.selectType){for(let e=0;e<s.indexes.length;e++)this.records[s.indexes[e]]&&(!0===t?i.push(s.indexes[e]):i.push(this.records[s.indexes[e]].recid));return i}for(let t=0;t<s.indexes.length;t++){var l=s.columns[s.indexes[t]];if(this.records[s.indexes[t]])for(let e=0;e<l.length;e++)i.push({recid:this.records[s.indexes[t]].recid,index:parseInt(s.indexes[t]),column:l[e]})}return i}search(l,n){var i,s,a,e="object"!=typeof this.url?this.url:this.url.get;let r=[],o=this.last.multi,t=this.last.logic,d=this.last.field,h=this.last.search,u=!1;for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(r.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),u=!0);if(0===arguments.length){this.focus(),t=$(this.box).find(`#grid_${this.name}_logic`).val(),h="";for(let e=0;e<this.searches.length;e++){var c=this.searches[e],p=$(this.box).find("#grid_"+this.name+"_operator_"+e).val();let i=$(this.box).find("#grid_"+this.name+"_field_"+e),s=$(this.box).find("#grid_"+this.name+"_field2_"+e),l=i.val(),n=s.val(),t=null,a=null;if(-1!=["int","float","money","currency","percent"].indexOf(c.type)){let e=i.data("w2field"),t=s.data("w2field");e&&(l=e.clean(l)),t&&(n=t.clean(n))}if(-1!=["list","enum"].indexOf(c.type)||-1!=["in","not in"].indexOf(p))if(l=i.data("selected")||{},Array.isArray(l)){t=[];for(let e=0;e<l.length;e++)t.push(w2utils.isFloat(l[e].id)?parseFloat(l[e].id):String(l[e].id).toLowerCase()),delete l[e].hidden;$.isEmptyObject(l)&&(l="")}else a=l.text||"",l=l.id||"";if(""!==l&&null!=l||null!=n&&""!==n){let e={field:c.field,type:c.type,operator:p};"between"==p?$.extend(e,{value:[l,n]}):"in"==p&&"string"==typeof l||"not in"==p&&"string"==typeof l?$.extend(e,{value:l.split(",")}):$.extend(e,{value:l}),t&&$.extend(e,{svalue:t}),a&&$.extend(e,{text:a});try{"date"==c.type&&"between"==p&&(e.value[0]=l,e.value[1]=n),"date"==c.type&&"is"==p&&(e.value=l)}catch(e){}r.push(e),o=!0}}}if("string"==typeof l&&(1==arguments.length&&(n=l,l="all"),d=l,h=n,o=!1,t=u?"AND":"OR",null!=n))if("all"==l.toLowerCase())if(0<this.searches.length)for(let t=0;t<this.searches.length;t++){let e=this.searches[t];if(("text"==e.type||"alphanumeric"==e.type&&w2utils.isAlphaNumeric(n)||"int"==e.type&&w2utils.isInt(n)||"float"==e.type&&w2utils.isFloat(n)||"percent"==e.type&&w2utils.isFloat(n)||("hex"==e.type||"color"==e.type)&&w2utils.isHex(n)||"currency"==e.type&&w2utils.isMoney(n)||"money"==e.type&&w2utils.isMoney(n)||"date"==e.type&&w2utils.isDate(n)||"time"==e.type&&w2utils.isTime(n)||"datetime"==e.type&&w2utils.isDateTime(n)||"datetime"==e.type&&w2utils.isDate(n)||"enum"==e.type&&w2utils.isAlphaNumeric(n)||"list"==e.type&&w2utils.isAlphaNumeric(n))&&(i=this.defaultOperator[this.operatorsMap[e.type]],i={field:e.field,type:e.type,operator:null!=e.operator?e.operator:i,value:n},""!=String(n).trim()&&r.push(i)),-1!=["int","float","money","currency","percent"].indexOf(e.type)&&2==String(n).trim().split("-").length&&(s=String(n).trim().split("-"),s={field:e.field,type:e.type,operator:null!=e.operator?e.operator:"between",value:[s[0],s[1]]},r.push(s)),-1!=["list","enum"].indexOf(e.type)){let i=[];null==e.options&&(e.options={}),Array.isArray(e.options.items)||(e.options.items=[]);for(let t=0;t<e.options.items;t++){var f=e.options.items[t];try{let e=new RegExp(n,"i");e.test(f)&&i.push(t),f.text&&e.test(f.text)&&i.push(f.id)}catch(e){}}0<i.length&&(s={field:e.field,type:e.type,operator:null!=e.operator?e.operator:"in",value:i},r.push(s))}}else for(let e=0;e<this.columns.length;e++){var g={field:this.columns[e].field,type:"text",operator:this.defaultOperator.text,value:n};r.push(g)}else{let i=$(this.box).find("#grid_"+this.name+"_search_all"),s=this.getSearch(l);if(null==s&&(s={field:l,type:"text"}),s.field==l&&(this.last.label=s.label),""!==n){let e=this.defaultOperator[this.operatorsMap[s.type]],t=n;if(-1!=["date","time","datetime"].indexOf(s.type)&&(e="is"),-1!=["list","enum"].indexOf(s.type)&&(e="is",a=i.data("selected"),t=a&&!$.isEmptyObject(a)?a.id:""),"int"==s.type&&""!==n)if(e="is",-1==String(n).indexOf("-")||2==(w=n.split("-")).length&&(e="between",t=[parseInt(w[0]),parseInt(w[1])]),-1!=String(n).indexOf(",")){var m=n.split(",");e="in",t=[];for(let e=0;e<m.length;e++)t.push(m[e])}null!=s.operator&&(e=s.operator);var w={field:s.field,type:s.type,operator:e,value:t};r.push(w)}}if(Array.isArray(l)){let e="AND";"string"==typeof n&&(e=n.toUpperCase(),"OR"!=e&&"AND"!=e&&(e="AND")),h="",o=!0,t=e;for(let t=0;t<l.length;t++){let e=l[t];"number"==typeof e.value&&(e.operator=this.defaultOperator.number),"string"==typeof e.value&&(e.operator=this.defaultOperator.text),Array.isArray(e.value)&&(e.operator=this.defaultOperator.enum),w2utils.isDate(e.value)&&(e.operator=this.defaultOperator.date),r.push(e)}}w=this.trigger({phase:"before",type:"search",target:this.name,multi:0===arguments.length,searchField:l||"multi",searchValue:l?n:"multi",searchData:r,searchLogic:t});!0!==w.isCancelled&&(this.searchData=w.searchData,this.last.field=d,this.last.search=h,this.last.multi=o,this.last.logic=w.searchLogic,this.last.scrollTop=0,this.last.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),e?(this.last.xhr_offset=0,this.reload()):(this.localSearch(),this.refresh()),this.trigger($.extend(w,{phase:"after"})))}searchOpen(){if(this.box&&0!==this.searches.length){let t=this,i=this.trigger({phase:"before",type:"searchOpen",target:this.name});if(!0!==i.isCancelled){let e=$(t.box).find(".w2ui-grid-search-input .w2ui-search-drop");e.addClass("checked"),$(t.box).find("#grid_"+t.name+"_search_all").w2overlay({html:this.getSearchesHTML(),name:this.name+"-searchOverlay",align:"left",class:"w2ui-grid-search-advanced",onShow(){t.initSearches(),t.last.search_opened=!0,$(`#w2ui-overlay-${t.name}-searchOverlay .w2ui-grid-search-advanced`).data("grid-name",t.name),w2utils.bindEvents($(`#w2ui-overlay-${t.name}-searchOverlay`).find("select, input, button"),t);let e=$(`#w2ui-overlay-${t.name}-searchOverlay *[rel=search]`);0<e.length&&e[0].focus(),t.trigger($.extend(i,{phase:"after"}))},onHide(){e.removeClass("checked"),t.last.search_opened=!1}})}}}searchClose(){this.box&&0!==this.searches.length&&(this.toolbar&&this.toolbar.uncheck("w2ui-search-advanced","w2ui-column-on-off"),$().w2overlay({name:this.name+"-searchOverlay"}))}searchSuggest(e,t,i){let l=this;clearTimeout(this.last.kbd_timer),clearTimeout(this.last.overlay_timer),this.searchShowFields(!0),this.searchClose(),!0!==t?0<$(`#w2ui-overlay-${this.name}-suggestOverlay`).length||(e?(e=$(this.box).find(`#grid_${this.name}_search_all`)[0],Array.isArray(this.savedSearches)&&0<this.savedSearches.length&&$(e).w2menu({align:"both",name:this.name+"-suggestOverlay",items:this.savedSearches,menuStyle:"top: 34px",topHTML:`<div class="w2ui-grid-search-suggest">${w2utils.lang("Saved Searches")}</div>`,render(e){let t=e.text;return e.isDefault&&(t=`<b>${t}</b>`),t},onSelect(e){var t=l.trigger({phase:"before",type:"searchSelect",target:l.name,index:e.index,item:e.item});!0!==t.isCancelled?(l.last.logic=e.item.logic||"AND",l.last.search="",l.last.label="[Multiple Fields]",l.searchData=$.extend(!0,[],e.item.data),l.searchSelected={name:e.item.id,logic:e.item.logic,data:$.extend(!0,[],e.item.data)},l.reload(),l.trigger($.extend(t,{phase:"after"}))):e.preventDefault()},onRemove(s){let e=l.trigger({phase:"before",type:"searchRemove",target:l.name,index:s.index,item:s.item});!0!==e.isCancelled?l.confirm(w2utils.lang('Do you want to delete search item "${item}"?',{item:s.item.text})).yes(()=>{if(w2utils.hasLocalStorage&&this.useLocalStorage)try{var t,i=JSON.parse(localStorage.w2ui||"{}");if(i&&i.searches){let e=i.searches[l.stateId||l.name];Array.isArray(e)&&(null!==(t=e.findIndex((e,t)=>e.name==s.item.id))&&e.splice(t,1),localStorage.w2ui=JSON.stringify(i))}}catch(e){}i=l.savedSearches.findIndex((e,t)=>e.name==s.item.id);null!==i&&l.savedSearches.splice(i,1),l.trigger($.extend(e,{phase:"after"}))}):s.preventDefault()}})):this.last.overlay_timer=setTimeout(()=>{this.searchSuggest(!0)},100)):$(i).w2overlay({name:this.name+"-suggestOverlay"})}searchFieldDrop(t,i,s){let l=this;var n=this.searches[t];let a=this.searchData[i];this.name,this.name,this.getOperators(n.type,n.operators);let r="";switch(n.type){case"text":case"alphanumeric":case"hex":case"color":case"list":case"combo":case"enum":{let e="width: 250px;";-1!=["hex","color"].indexOf(n.type)&&(e="width: 90px;"),r+='<input rel="search" type="text" id="grid_'+this.name+"_field_"+t+'" name="'+n.field+'"    class="w2ui-input" style="'+e+n.style+'" '+n.inTag+"/>";break}case"int":case"float":case"money":case"currency":case"percent":case"date":case"time":case"datetime":let e="width: 80px";"datetime"==n.type&&(e="width: 140px;"),r+='<input rel="search" type="text" class="w2ui-input" style="'+e+n.style+'" id="grid_'+this.name+"_field_"+t+'" name="'+n.field+'" '+n.inTag+'/><span id="grid_'+this.name+"_extra1_"+t+'" style="padding-left: 5px; color: #6f6f6f; font-size: 10px"></span><span id="grid_'+this.name+"_range_"+t+'" style="display: none">&#160;-&#160;&#160;<input rel="search" type="text" class="w2ui-input" style="'+e+n.style+'" id="grid_'+this.name+"_field2_"+t+'" name="'+n.field+'" '+n.inTag+'/></span><span id="grid_'+this.name+"_extra2_"+t+'" style="padding-left: 5px; color: #6f6f6f; font-size: 10px"></span>';break;case"select":r+='<select rel="search" class="w2ui-input" style="'+n.style+'" id="grid_'+this.name+"_field_"+t+'"  name="'+n.field+'" '+n.inTag+'  onclick="event.stopPropagation();"></select>'}let o=a.operator;if("more"==o&&"date"==a.type&&(o="since"),"less"==o&&"date"==a.type&&(o="before"),Array.isArray(a.value)){let t="";a.value.forEach(e=>{t+=`<li>${e.text||e}</li>`}),"date"==a.type&&(t="",a.value.forEach(e=>{t+=`<li>${w2utils.formatDate(e)}</li>`})),$(s).w2overlay({name:this.name+"-fieldOverlay",html:`
                    <div class="w2ui-grid-search-single">
                        <span class="operator">${o}</span>
                        <div class="options">
                            <ul>${t}</ul>
                        </div>
                        <div class="buttons">
                            <button id="remove" class="w2ui-btn">${w2utils.lang("Remove This Field")}</button>
                        </div>
                    </div>`,onShow(e){$("#w2ui-overlay").find("#remove").on("click",()=>{l.searchData.splice(`${i}`,1),l.reload(),l.localSearch(),$(s).w2overlay({name:l.name+"-fieldOverlay"})})}})}else{let e=a.value;"date"==a.type&&(e=w2utils.formatDateTime(e)),$(s).w2overlay({html:`
                    <div class="w2ui-grid-search-single">
                        <div class="options">
                            <span class="operator">${w2utils.lang(o)}</span>
                            "<span>${e}</span>"
                        </div>
                        <div class="buttons">
                            <button id="remove" class="w2ui-btn">${w2utils.lang("Remove This Field")}</button>
                        </div>
                    </div>`,onShow(e){$("#w2ui-overlay").find("#remove").on("click",()=>{l.searchData.splice(`${i}`,1),l.reload(),l.localSearch(),$(s).w2overlay({name:l.name+"-fieldOverlay"})})}})}}searchSave(){let i="";this.searchSelected&&(i=this.searchSelected.name);let l=this,n=this.trigger({phase:"before",type:"searchSave",target:this.name,saveLocalStorage:!0});!0!==n.isCancelled&&this.message({width:350,height:150,body:`<div style="padding-top: 29px; text-align: center;">
                <span style="width: 280px; display: inline-block; text-align: left; padding-bottom: 4px;">${w2utils.lang("Save Search")}</span>
                <input class="search-name" placeholder="${w2utils.lang("Search name")}" style="width: 280px">
            </div>`,buttons:`
                <button id="grid-search-cancel" class="w2ui-btn">${w2utils.lang("Cancel")}</button>
                <button id="grid-search-save" class="w2ui-btn w2ui-btn-blue" ${""==String(i).trim()?"disabled":""}>${w2utils.lang("Save")}</button>
            `,onOpen(e){setTimeout(()=>{$(this.box).find("#grid-search-cancel").on("click",()=>{l.message()}),$(this.box).find("#grid-search-save").on("click",()=>{var e,i=$(l.box).find(".w2ui-message .search-name").val();if(l.searchSelected?(e=l.savedSearches.findIndex(e=>e.id==l.searchSelected.name),Object.assign(l.savedSearches[e],{id:i,text:i,logic:l.last.logic,data:$.extend(!0,[],l.searchData)})):l.savedSearches.push({id:i,text:i,icon:"w2ui-icon-search",remove:!0,logic:l.last.logic,data:l.searchData}),w2utils.hasLocalStorage&&l.useLocalStorage)try{let e=JSON.parse(localStorage.w2ui||"{}");e=e||{},e.searches||(e.searches={}),Array.isArray(e.searches[l.stateId||l.name])||(e.searches[l.stateId||l.name]=[]);let t=e.searches[l.stateId||l.name];var s=t.findIndex(e=>e.name==l.searchSelected.name);-1!==s?Object.assign(t[s],{name:i,logic:l.last.logic,data:l.searchData}):t.push({name:i,logic:l.last.logic,data:l.searchData}),localStorage.w2ui=JSON.stringify(e)}catch(e){return delete localStorage.w2ui,null}l.message(),l.searchSelected?(l.searchSelected.name=i,$(l.box).find(`#grid_${l.name}_search_name .name-text`).html(i)):(l.searchSelected={name:i,logic:l.last.logic,data:$.extend(!0,[],l.searchData)},$(l.box).find(`#grid_${l.name}_search_all`).val(" ").prop("readOnly",!0),$(l.box).find(`#grid_${l.name}_search_name`).show().find(".name-text").html(i)),this.trigger($.extend(n,{phase:"after",name:i}))});let t=$(this.box).find("input, button");t.off(".message").on("blur.message",function(e){t.index(e.target)+1===t.length&&(t.get(0).focus(),e.preventDefault())}).on("keydown.message",function(e){var t=String($(l.box).find(".w2ui-message-body input").val()).trim();13==e.keyCode&&""!=t&&$(l.box).find("#grid-search-save").click(),27==e.keyCode&&l.message()}),$(this.box).find(".w2ui-message-body input").on("input",function(e){let t=$(this).closest(".w2ui-message").find("#grid-search-save");""===String($(this).val()).trim()?t.prop("disabled",!0):t.prop("disabled",!1)}).val(i).focus()},25)}})}searchReset(e){let t=[],i=!1;for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(t.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),i=!0);var s=this.trigger({phase:"before",type:"search",reset:!0,target:this.name,searchData:t});if(!0!==s.isCancelled){if(this.searchData=s.searchData,this.searchSelected=null,this.last.search="",this.last.logic=i?"AND":"OR",0<this.searches.length)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields";else{let e=0;for(;e<this.searches.length&&(this.searches[e].hidden||!1===this.searches[e].simple);)e++;e>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[e].field,this.last.label=this.searches[e].label)}this.last.multi=!1,this.last.xhr_offset=0,this.last.scrollTop=0,this.last.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),$(this.box).find("#grid_"+this.name+"_search_all").val("").removeData("selected"),e||this.reload(),this.trigger($.extend(s,{phase:"after"}))}}searchShowFields(e){let t=$(this.box).find("#grid_"+this.name+"_search_all");if(!0!==e){let l='<div class="w2ui-grid-search-fields"><table><tbody>';for(let s=-1;s<this.searches.length;s++){let e=this.searches[s];var n=e?e.field:null,n=this.getColumn(n);let t=!1,i=w2utils.lang("This column is hidden");if(1==this.show.searchHiddenMsg&&-1!=s&&(null==n||!0===n.hidden&&!1!==n.hideable)&&(t=!0,null==n&&(i=w2utils.lang("This column does not exist"))),-1==s){if(!this.multiSearch||!this.show.searchAll)continue;e={field:"all",label:"All Fields"}}else{if(null!=n&&!1===n.hideable)continue;if(!0===this.searches[s].hidden||!1===this.searches[s].simple)continue}null==e.label&&null!=e.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",e),e.label=e.caption),l+='<tr style="'+(t?"color: silver":"")+'" '+(t?"onmouseenter=\"jQuery(this).w2tag({ top: 4, html: '"+i+'\' })" onmouseleave="jQuery(this).w2tag()"':"")+(w2utils.isIOS?"onTouchStart":"onClick")+"=\"event.stopPropagation();            w2ui['"+this.name+"'].searchInitInput('"+e.field+"');           jQuery('#grid_"+this.name+"_search_all').w2overlay({ name: '"+this.name+"-searchFields' });\"           jQuery(this).addClass('w2ui-selected');      onmousedown=\"jQuery(this).parent().find('tr').removeClass('w2ui-selected'); jQuery(this).addClass('w2ui-selected')\"       onmouseup=\"jQuery(this).removeClass('w2ui-selected')\"    >   <td>       <span class=\"w2ui-column-check w2ui-icon-"+(e.field==this.last.field?"check":"empty")+'"></span>   </td>   <td>'+w2utils.lang(e.label)+"</td></tr>"}l+="</tbody></table></div>";let e=this.name+"-searchFields";1==$("#w2ui-overlay-"+e).length&&(l=""),setTimeout(()=>{$(t).w2overlay({html:l,name:e,left:-2,tipLeft:18})},1)}else $(t).w2overlay({name:this.name+"-searchFields"})}searchInitInput(e,t){let i,s=$(this.box).find("#grid_"+this.name+"_search_all");if("all"==e)i={field:"all",label:w2utils.lang("All Fields")};else if(i=this.getSearch(e),null==i)return;""!=this.last.search?(this.last.label=i.label,this.search(i.field,this.last.search)):(this.last.field=i.field,this.last.label=i.label),s.attr("placeholder",w2utils.lang("Search")+" "+w2utils.lang(i.label||i.caption||i.field,!0)),$().w2overlay({name:this.name+"-searchFields"})}clear(e){this.total=0,this.records=[],this.summary=[],this.last.xhr_offset=0,this.last.idCache={},this.reset(!0),e||this.refresh()}reset(e){this.last.scrollTop=0,this.last.scrollLeft=0,this.last.selection={indexes:[],columns:{}},this.last.range_start=null,this.last.range_end=null,$(this.box).find("#grid_"+this.name+"_records").prop("scrollTop",0),e||this.refresh()}skip(e,t){("object"!=typeof this.url?this.url:this.url.get)?(this.offset=parseInt(e),this.offset>this.total&&(this.offset=this.total-this.limit),(this.offset<0||!w2utils.isInt(this.offset))&&(this.offset=0),this.clear(!0),this.reload(t)):console.log("ERROR: grid.skip() can only be called when you have remote data source.")}load(e,t){null!=e?(this.clear(!0),this.request("get",{},e,t)):console.log('ERROR: You need to provide url argument when calling .load() method of "'+this.name+'" object.')}reload(e){let t=this;var i="object"!=typeof this.url?this.url:this.url.get;t.selectionSave(),i?this.load(i,()=>{t.selectionRestore(),"function"==typeof e&&e()}):(this.reset(!0),this.localSearch(),this.selectionRestore(),"function"==typeof e&&e({status:"success"}))}request(s,l,n,a){if(null==l&&(l={}),""!=(n=""==n||null==n?this.url:n)&&null!=n){w2utils.isInt(this.offset)||(this.offset=0),w2utils.isInt(this.last.xhr_offset)||(this.last.xhr_offset=0);let e,t={limit:this.limit,offset:parseInt(this.offset)+parseInt(this.last.xhr_offset),searchLogic:this.last.logic,search:this.searchData.map(e=>{let t=$.extend({},e);return this.searchMap&&this.searchMap[t.field]&&(t.field=this.searchMap[t.field]),t}),sort:this.sortData.map(e=>{let t=$.extend({},e);return this.sortMap&&this.sortMap[t.field]&&(t.field=this.sortMap[t.field]),t})};if(0===this.searchData.length&&(delete t.search,delete t.searchLogic),0===this.sortData.length&&delete t.sort,$.extend(t,this.postData),$.extend(t,l),"delete"!=s&&"save"!=s||(delete t.limit,delete t.offset,"delete"==(t.action=s)&&(t[this.recid||"recid"]=this.getSelection())),"get"==s){if(e=this.trigger({phase:"before",type:"request",target:this.name,url:n,postData:t,httpHeaders:this.httpHeaders}),!0===e.isCancelled)return void("function"==typeof a&&a({status:"error",message:w2utils.lang("Request aborted.")}))}else e={url:n,postData:t,httpHeaders:this.httpHeaders};if(0===this.last.xhr_offset&&this.lock(w2utils.lang(this.msgRefresh),!0),this.last.xhr)try{this.last.xhr.abort()}catch(e){}if(n="object"!=typeof e.url?e.url:e.url.get,"save"==s&&"object"==typeof e.url&&(n=e.url.save),"delete"==s&&"object"==typeof e.url&&(n=e.url.remove),!$.isEmptyObject(this.routeData)){var r=w2utils.parseRoute(n);if(0<r.keys.length)for(let e=0;e<r.keys.length;e++)null!=this.routeData[r.keys[e].name]&&(n=n.replace(new RegExp(":"+r.keys[e].name,"g"),this.routeData[r.keys[e].name]))}let i={type:"GET",url:n,data:e.postData,headers:e.httpHeaders,dataType:"json"};switch(this.dataType||w2utils.settings.dataType){case"HTTP":i.data="object"==typeof i.data?String($.param(i.data,!1)).replace(/%5B/g,"[").replace(/%5D/g,"]"):i.data;break;case"HTTPJSON":i.data={request:JSON.stringify(i.data)};break;case"RESTFULL":i.type="GET","save"==s&&(i.type="PUT"),"delete"==s&&(i.type="DELETE"),i.data="object"==typeof i.data?String($.param(i.data,!1)).replace(/%5B/g,"[").replace(/%5D/g,"]"):i.data;break;case"RESTFULLJSON":i.type="GET","save"==s&&(i.type="PUT"),"delete"==s&&(i.type="DELETE"),i.data=JSON.stringify(i.data),i.contentType="application/json";break;case"JSON":i.type="POST",i.data=JSON.stringify(i.data),i.contentType="application/json"}this.method&&(i.type=this.method),this.last.xhr_cmd=s,this.last.xhr_start=(new Date).getTime(),this.last.loaded=!1,this.last.xhr=$.ajax(i).done((e,t,i)=>{this.requestComplete(t,i,s,a)}).fail((t,e,i)=>{i={status:e,error:i,rawResponseText:t.responseText},i=this.trigger({phase:"before",type:"error",error:i,xhr:t});if(!0!==i.isCancelled){if("abort"!=e){let e;try{e="object"==typeof t.responseJSON?t.responseJSON:JSON.parse(t.responseText)}catch(e){}console.log("ERROR: Server communication failed.","\n   EXPECTED:",{status:"success",total:5,records:[{recid:1,field:"value"}]},"\n         OR:",{status:"error",message:"error message"},"\n   RECEIVED:","object"==typeof e?e:t.responseText),this.requestComplete("error",t,s,a)}this.trigger($.extend(i,{phase:"after"}))}}),"get"==s&&this.trigger($.extend(e,{phase:"after"}))}}requestComplete(t,i,s,l){this.unlock(),this.last.xhr_response=((new Date).getTime()-this.last.xhr_start)/1e3,setTimeout(()=>{this.show.statusResponse&&this.status(w2utils.lang("Server Response ${count} seconds",{count:this.last.xhr_response}))},10),this.last.pull_more=!1,this.last.pull_refresh=!0;let e="load";"save"==this.last.xhr_cmd&&(e="save"),"delete"==this.last.xhr_cmd&&(e="delete");var n=this.trigger({phase:"before",target:this.name,type:e,xhr:i,status:t});if(!0!==n.isCancelled){let e;if("error"!=t){if("function"==typeof this.parser?(e=this.parser(i.responseJSON),"object"!=typeof e&&console.log("ERROR: Your parser did not return proper object")):(e=i.responseJSON,null==e?e={status:"error",message:w2utils.lang(this.msgNotJSON),responseText:i.responseText}:Array.isArray(e)&&(e={status:"success",records:e,total:e.length})),"error"==e.status)this.error(e.message);else if("get"==s){if(null==e.total&&(e.total=-1),null==e.records&&(e.records=[]),e.records.length==this.limit?(t=this.records.length+e.records.length,this.last.xhr_hasMore=t!=this.total):(this.last.xhr_hasMore=!1,this.total=this.offset+this.last.xhr_offset+e.records.length),this.last.xhr_hasMore||$(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").hide(),0===this.last.xhr_offset)this.records=[],this.summary=[];else if(-1!=e.total&&parseInt(e.total)!=parseInt(this.total)){let e=this;return void this.message(w2utils.lang(this.msgNeedReload)).ok(()=>{delete e.last.xhr_offset,e.reload()})}w2utils.isInt(e.total)&&(this.total=parseInt(e.total)),e.records&&e.records.forEach(e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.records.length),(e.w2ui&&!0===e.w2ui.summary?this.summary:this.records).push(e)}),e.summary&&(this.summary=[],e.summary.forEach(e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.summary.length),this.summary.push(e)}))}else if("delete"==s)return this.reset(),void this.reload()}else e={status:"error",message:w2utils.lang(this.msgAJAXerror),responseText:i.responseText},this.error(w2utils.lang(this.msgAJAXerror));("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(),this.localSearch()),this.total=parseInt(this.total),0===this.last.xhr_offset?this.refresh():(this.scroll(),this.resize()),"function"==typeof l&&l(e),this.trigger($.extend(n,{phase:"after"})),this.last.loaded=!0}else"function"==typeof l&&l({status:"error",message:w2utils.lang("Request aborted.")})}error(e){var t=this.trigger({target:this.name,type:"error",message:e,xhr:this.last.xhr});!0!==t.isCancelled&&(this.message(e),this.trigger($.extend(t,{phase:"after"})))}getChanges(t){let i=[];void 0===t&&(t=this.records);for(let e=0;e<t.length;e++){var s=t[e];if(s.w2ui){if(null!=s.w2ui.changes){let e={};e[this.recid||"recid"]=s.recid,i.push($.extend(!0,e,s.w2ui.changes))}!0!==s.w2ui.expanded&&s.w2ui.children&&s.w2ui.children.length&&$.merge(i,this.getChanges(s.w2ui.children))}}return i}mergeChanges(){let i=this.getChanges();for(let t=0;t<i.length;t++){let e=this.get(i[t][this.recid||"recid"]);for(var s in i[t])if(!("recid"==s||this.recid&&s==this.recid)){"object"==typeof i[t][s]&&(i[t][s]=i[t][s].text);try{!function e(t,i,s){let l=i.split(".");1==l.length?t[i]=s:(t=t[l[0]],l.shift(),e(t,l.join("."),s))}(e,s,i[t][s])}catch(e){console.log("ERROR: Cannot merge. ",e.message||"",e)}e.w2ui&&delete e.w2ui.changes}}this.refresh()}save(t){var e=this.getChanges(),i="object"!=typeof this.url?this.url:this.url.save;let s=this.trigger({phase:"before",target:this.name,type:"save",changes:e});!0!==s.isCancelled?i?this.request("save",{changes:s.changes},null,e=>{"error"!==e.status&&this.mergeChanges(),this.trigger($.extend(s,{phase:"after"})),"function"==typeof t&&t(e)}):(this.mergeChanges(),this.trigger($.extend(s,{phase:"after"}))):i&&"function"==typeof t&&t({status:"error",message:w2utils.lang("Request aborted.")})}editField(d,h,u,t){let c=this,p,f;if(!0!==this.last.inEditMode){p=this.get(d,!0);let o=this.getCellEditable(p,h);if(o){let a=this.records[p],r=this.columns[h];var g=!0===r.frozen?"_f":"_";if(-1==["enum","file"].indexOf(o.type)){let n=this.trigger({phase:"before",type:"editField",target:this.name,recid:d,column:h,value:u,index:p,originalEvent:t});if(!0!==n.isCancelled&&(u=n.value,this.last.inEditMode=!0,this.last._edit={value:u,index:p,column:h,recid:d},this.selectNone(),this.select({recid:d,column:h}),-1==["checkbox","check"].indexOf(o.type))){let t=$(this.box).find("#grid_"+this.name+g+"rec_"+w2utils.escapeId(d)),i=t.find("[col="+h+"] > div");$(this.box).find("div.w2ui-edit-box").remove(),"row"!=this.selectType&&($(this.box).find("#grid_"+this.name+g+"selection").attr("id","grid_"+this.name+"_editable").removeClass("w2ui-selection").addClass("w2ui-edit-box").prepend('<div style="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;"></div>').find(".w2ui-selection-resizer").remove(),i=$(this.box).find("#grid_"+this.name+"_editable >div:first-child")),null==o.inTag&&(o.inTag=""),null==o.outTag&&(o.outTag=""),null==o.style&&(o.style=""),null==o.items&&(o.items=[]);let s=a.w2ui&&a.w2ui.changes&&null!=a.w2ui.changes[r.field]?w2utils.stripTags(a.w2ui.changes[r.field]):w2utils.stripTags(c.parseField(a,r.field));null==s&&(s="");let e="object"!=typeof s?s:"";null!=n.old_value&&(e=n.old_value),null!=u&&(s=u);let l=null!=r.style?r.style+";":"";switch("string"==typeof r.render&&-1!=["number","int","float","money","percent","size"].indexOf(r.render.split(":")[0])&&(l+="text-align: right;"),0<o.items.length&&!$.isPlainObject(o.items[0])&&(o.items=w2utils.normMenu(o.items)),o.type){case"select":{let t="";for(let e=0;e<o.items.length;e++)t+='<option value="'+o.items[e].id+'"'+(o.items[e].id==s?' selected="selected"':"")+">"+o.items[e].text+"</option>";i.addClass("w2ui-editable").html('<select id="grid_'+this.name+"_edit_"+d+"_"+h+'" column="'+h+'" class="w2ui-input"    style="width: 100%; pointer-events: auto; padding: 0 0 0 3px; margin: 0px; border-left: 0; border-right: 0; border-radius: 0px;            outline: none; font-family: inherit;'+l+o.style+'"     field="'+r.field+'" recid="'+d+'"     '+o.inTag+">"+t+"</select>"+o.outTag),setTimeout(()=>{i.find("select").on("change",function(e){delete c.last.move}).on("blur",function(e){1!=$(this).data("keep-open")&&c.editChange.call(c,this,p,h,e)})},10);break}case"div":{let e=t.find("[col="+h+"] > div");var m="font-family: "+e.css("font-family")+"; font-size: "+e.css("font-size")+";";i.addClass("w2ui-editable").html('<div id="grid_'+this.name+"_edit_"+d+"_"+h+'" class="w2ui-input"    contenteditable style="'+m+l+o.style+'" autocorrect="off" autocomplete="off" spellcheck="false"     field="'+r.field+'" recid="'+d+'" column="'+h+'" '+o.inTag+"></div>"+o.outTag),null==u&&i.find("div.w2ui-input").text("object"!=typeof s?s:""),f=i.find("div.w2ui-input").get(0),setTimeout(()=>{let t=f;$(t).on("blur",function(e){1!=$(this).data("keep-open")&&c.editChange.call(c,t,p,h,e)})},10),null!=u&&$(f).text("object"!=typeof s?s:"");break}default:{let e=t.find("[col="+h+"] > div");m="font-family: "+e.css("font-family")+"; font-size: "+e.css("font-size");i.addClass("w2ui-editable").html('<input id="grid_'+this.name+"_edit_"+d+"_"+h+'" autocorrect="off" autocomplete="off" spellcheck="false" type="text"     style="'+m+"; "+l+o.style+'"     field="'+r.field+'" recid="'+d+'" column="'+h+'" class="w2ui-input"'+o.inTag+"/>"+o.outTag),"number"==o.type&&(s=w2utils.formatNumber(s)),"date"==o.type&&(s=w2utils.formatDate(w2utils.isDate(s,o.format,!0)||new Date,o.format)),null==u&&i.find("input").val("object"!=typeof s?s:""),f=i.find("input").get(0),$(f).w2field(o.type,$.extend(o,{selected:s})),setTimeout(()=>{let e=f;"list"==o.type&&(e=$($(f).data("w2field").helpers.focus).find("input"),"object"!=typeof s&&""!=s&&e.val(s).css({opacity:1}).prev().css({opacity:1}),i.find("input").on("change",function(e){c.editChange.call(c,f,p,h,e)})),$(e).on("blur",function(e){1!=$(this).data("keep-open")&&c.editChange.call(c,f,p,h,e)})},10),null!=u&&$(f).val("object"!=typeof s?s:""),f.select()}}function w(e){try{var t="DIV"==this.tagName.toUpperCase()?$(this).text():this.value;let e=$(c.box).find("#grid_"+c.name+"_editable");var i="font-family: "+$(this).css("font-family")+"; font-size: "+$(this).css("font-size")+"; white-space: pre;",s=w2utils.getStrWidth(t,i);s+20>e.width()&&e.width(s+20)}catch(e){}}setTimeout(()=>{f=f||i.find("input").get(0),this.last.inEditMode&&(i.find("input, select, div.w2ui-input").data("old_value",e).on("mousedown",function(e){e.stopPropagation()}).on("click",function(e){"div"==o.type?w.call(i.find("div.w2ui-input")[0],null):w.call(i.find("input, select")[0],null)}).on("paste",function(e){let t=e.originalEvent;e.preventDefault();e=t.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,e)}).on("keydown",function(i){let s=this;var e="DIV"==s.tagName.toUpperCase()?$(s).text():$(s).val();switch(i.keyCode){case 8:"list"!=o.type||$(f).data("w2field")||i.preventDefault();break;case 9:case 13:i.preventDefault();break;case 37:0===w2utils.getCursorPosition(s)&&i.preventDefault();break;case 39:w2utils.getCursorPosition(s)==e.length&&(w2utils.setCursorPosition(s,e.length),i.preventDefault())}setTimeout(()=>{switch(i.keyCode){case 9:{let t=i.shiftKey?c.prevCell(p,h,!0):c.nextCell(p,h,!0);if(null!=t){let e=c.records[t.index].recid;s.blur(),setTimeout(()=>{"row"!=c.selectType?(c.selectNone(),c.select({recid:e,column:t.colIndex})):c.editField(e,t.colIndex,null,i)},1),i.preventDefault&&i.preventDefault()}break}case 13:if(s.blur(),c.advanceOnEdit){let e=i.shiftKey?c.prevRow(p,h,1):c.nextRow(p,h,1);null==e&&(e=p),setTimeout(()=>{"row"!=c.selectType?(c.selectNone(),c.select({recid:c.records[e].recid,column:h})):c.editField(c.records[e].recid,h,null,i)},1)}"DIV"==s.tagName.toUpperCase()&&i.preventDefault();break;case 27:{let e=c.parseField(a,r.field);a.w2ui&&a.w2ui.changes&&null!=a.w2ui.changes[r.field]&&(e=a.w2ui.changes[r.field]),null!=$(s).data("old_value")&&(e=$(s).data("old_value")),"DIV"==s.tagName.toUpperCase()?$(s).text(null!=e?e:""):s.value=null!=e?e:"",s.blur(),setTimeout(()=>{c.select({recid:d,column:h})},1);break}}w.call(s,i)},1)}).on("keyup",function(e){w.call(this,e)}),setTimeout(()=>{if(c.last.inEditMode){let e=i.find(".w2ui-input"),t=null!=$(e).val()?$(e).val().length:0;"div"==o.type&&(t=$(e).text().length),0<e.length&&(e.focus(),clearTimeout(c.last.kbd_timer),"SELECT"!=e[0].tagName.toUpperCase()&&w2utils.setCursorPosition(e[0],t),(e[0].resize=w).call(e[0],null))}},50),this.trigger($.extend(n,{phase:"after",input:i.find("input, select, div.w2ui-input")})))},5)}}else console.log('ERROR: input types "enum" and "file" are not supported in inline editing.')}}else if(t&&13==t.keyCode){if(p=this.last._edit.index,h=this.last._edit.column,d=this.last._edit.recid,this.editChange({type:"custom",value:this.last._edit.value},this.get(d,!0),h,t),this.advanceOnEdit){let e=t.shiftKey?this.prevRow(p,h,1):this.nextRow(p,h,1);null!=e&&e!=p&&setTimeout(()=>{"row"!=this.selectType?(this.selectNone(),this.select({recid:this.records[e].recid,column:h})):this.editField(this.records[e].recid,h,null,t)},1)}this.last.inEditMode=!1}else{let e=$(this.box).find("div.w2ui-edit-box .w2ui-input");0<e.length&&"DIV"==e[0].tagName&&(e.text(e.text()+u),w2utils.setCursorPosition(e[0],e.text().length))}}editChange(e,t,i,s){setTimeout(()=>{let e=$(this.box).find("#grid_"+this.name+"_focus");e.is(":focus")||e.focus()},10);var l=t<0;let n=(l?this.summary:this.records)[t=t<0?-t-1:t];var a=this.columns[i],r=$(this.box).find("#grid_"+this.name+(!0===a.frozen?"_frec_":"_rec_")+w2utils.escapeId(n.recid));let o=e.tagName&&"DIV"==e.tagName.toUpperCase()?$(e).text():e.value,d=$(e).data("w2field");d&&("list"==d.type&&(o=$(e).data("selected")),!$.isEmptyObject(o)&&null!=o||(o=""),$.isPlainObject(o)||(o=d.clean(o))),"checkbox"==e.type&&(n.w2ui&&!1===n.w2ui.editable&&(e.checked=!e.checked),o=e.checked);var h=this.parseField(n,a.field),u=n.w2ui&&n.w2ui.changes&&n.w2ui.changes.hasOwnProperty(a.field)?n.w2ui.changes[a.field]:h;let c={phase:"before",type:"change",target:this.name,input_id:e.id,recid:n.recid,index:t,column:i,originalEvent:s.originalEvent||s,value_new:o,value_previous:u,value_original:h};for(null!=$(s.target).data("old_value")&&(c.value_previous=$(s.target).data("old_value"));;){if(o=c.value_new,"object"!=typeof o&&String(h)!=String(o)||"object"==typeof o&&o&&o.id!=h&&("object"!=typeof h||null==h||o.id!=h.id)){if(c=this.trigger($.extend(c,{type:"change",phase:"before"})),!0!==c.isCancelled){if(o!==c.value_new)continue;(""!==c.value_new&&null!=c.value_new||""!==u&&null!=u)&&(n.w2ui=n.w2ui??{},n.w2ui.changes=n.w2ui.changes??{},n.w2ui.changes[a.field]=c.value_new),this.trigger($.extend(c,{phase:"after"}))}}else if(c=this.trigger($.extend(c,{type:"restore",phase:"before"})),!0!==c.isCancelled){if(o!==c.value_new)continue;n.w2ui&&n.w2ui.changes&&delete n.w2ui.changes[a.field],n.w2ui&&$.isEmptyObject(n.w2ui.changes)&&delete n.w2ui.changes,this.trigger($.extend(c,{phase:"after"}))}break}let p=$(r).find("[col="+i+"]");l||(n.w2ui&&n.w2ui.changes&&null!=n.w2ui.changes[a.field]?p.addClass("w2ui-changed"):p.removeClass("w2ui-changed"),p.replaceWith(this.getCellHTML(t,i,l))),$(this.box).find("div.w2ui-edit-box").remove(),this.show.toolbarSave&&(0<this.getChanges().length?this.toolbar.enable("w2ui-save"):this.toolbar.disable("w2ui-save")),this.last.inEditMode=!1}delete(e){var t=this.trigger({phase:"before",target:this.name,type:"delete",force:e});if(e&&this.message(),!0!==t.isCancelled){e=t.force,setTimeout(()=>{$().w2tag()},20);var i=this.getSelection();if(0!==i.length)if(""==this.msgDelete||e){if("object"!=typeof this.url?this.url:this.url.remove)this.request("delete");else if("object"!=typeof i[0])this.selectNone(),this.remove.apply(this,i);else{for(let t=0;t<i.length;t++){var s=this.columns[i[t].column].field,l=this.get(i[t].recid,!0);let e=this.records[l];null!=l&&"recid"!=s&&(this.records[l][s]="",e.w2ui&&e.w2ui.changes&&delete e.w2ui.changes[s])}this.update()}this.trigger($.extend(t,{phase:"after"}))}else{t=w2utils.lang(this.msgDelete,{count:i.length,records:w2utils.lang(1==i.length?"record":"records")});this.confirm({width:380,height:170,yes_text:"Delete",yes_class:"w2ui-btn-red",no_text:"Cancel",body:'<div class="w2ui-centered">'+t+"</div>"}).yes(()=>{this.delete(!0)})}}}click(a,r){var o=(new Date).getTime();let d=null;if(!(1==this.last.cancelClick||r&&r.altKey))if("object"==typeof a&&null!==a&&(d=a.column,a=a.recid),null==r&&(r={}),o-parseInt(this.last.click_time)<350&&this.last.click_recid==a&&"click"==r.type)this.dblClick(a,r);else{this.last.bubbleEl&&($(this.last.bubbleEl).w2tag(),this.last.bubbleEl=null),this.last.click_time=o;var h=this.last.click_recid;if(this.last.click_recid=a,null==d&&r.target){let e=r.target;"TD"!=e.tagName.toUpperCase()&&(e=$(e).parents("td")[0]),null!=$(e).attr("col")&&(d=parseInt($(e).attr("col")))}var i=this.trigger({phase:"before",target:this.name,type:"click",recid:a,column:d,originalEvent:r});if(!0!==i.isCancelled){var u=this.getSelection();$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1);o=this.get(a,!0);let s=[];this.last.sel_ind=o,this.last.sel_col=d,this.last.sel_recid=a,this.last.sel_type="click";let e,l,t,n;if(r.shiftKey&&0<u.length&&this.multiSelect){if(u[0].recid){e=this.get(u[0].recid,!0),l=this.get(a,!0),n=d>u[0].column?(t=u[0].column,d):(t=d,u[0].column);for(let e=t;e<=n;e++)s.push(e)}else e=this.get(h,!0),l=this.get(a,!0);let i=[];e>l&&(h=e,e=l,l=h);var c="object"!=typeof this.url?this.url:this.url.get;for(let t=e;t<=l;t++)if(!(0<this.searchData.length)||c||-1!=$.inArray(t,this.last.searchIds))if("row"==this.selectType)i.push(this.records[t].recid);else for(let e=0;e<s.length;e++)i.push({recid:this.records[t].recid,column:s[e]});this.select(i)}else{let e=this.last.selection,t=-1!=e.indexes.indexOf(o),i=!1;$(r.target).parents("td").hasClass("w2ui-col-select")&&(i=!0),(r.ctrlKey||r.shiftKey||r.metaKey||i)&&this.multiSelect||this.showSelectColumn?(r=$(r.target).parents("tr").find(".w2ui-grid-select-check").is(":checked"),"row"==this.selectType||-1!=$.inArray(d,e.columns[o])||r||(t=!1),!0===t?this.unselect({recid:a,column:d}):this.select({recid:a,column:d})):("row"!=this.selectType&&-1==$.inArray(d,e.columns[o])&&(t=!1),300<u.length?this.selectNone():this.unselect(u),!0===t&&1==u.length?this.unselect({recid:a,column:d}):this.select({recid:a,column:d}))}this.status(),this.initResize(),this.trigger($.extend(i,{phase:"after"}))}}}columnClick(l,i){if(!0!==this.last.colResizing){let e=this.trigger({phase:"before",type:"columnClick",target:this.name,field:l,originalEvent:i});if(!0!==e.isCancelled){if("row"==this.selectType){var t=this.getColumn(l);t&&t.sortable&&this.sort(l,null,!(!i||!i.ctrlKey&&!i.metaKey)),"line-number"==e.field&&(this.getSelection().length>=this.records.length?this.selectNone():this.selectAll())}else if(!i.altKey||(n=this.getColumn(l))&&n.sortable&&this.sort(l,null,!(!i||!i.ctrlKey&&!i.metaKey)),"line-number"==e.field)this.getSelection().length>=this.records.length?this.selectNone():this.selectAll();else{i.shiftKey||i.metaKey||i.ctrlKey||this.selectNone();var n=this.getSelection(),l=this.getColumn(e.field,!0);let t=[],s=[];if(0!=n.length&&i.shiftKey){let t=l,i=n[0].column;t>i&&(t=n[0].column,i=l);for(let e=t;e<=i;e++)s.push(e)}else s.push(l);if(e=this.trigger({phase:"before",type:"columnSelect",target:this.name,columns:s}),!0!==e.isCancelled){for(let e=0;e<this.records.length;e++)t.push({recid:this.records[e].recid,column:s});this.select(t)}this.trigger($.extend(e,{phase:"after"}))}this.trigger($.extend(e,{phase:"after"}))}}}columnDblClick(e,t){t=this.trigger({phase:"before",type:"columnDblClick",target:this.name,field:e,originalEvent:t});!0!==t.isCancelled&&this.trigger($.extend(t,{phase:"after"}))}focus(e){e=this.trigger({phase:"before",type:"focus",target:this.name,originalEvent:e});if(!0===e.isCancelled)return!1;this.hasFocus=!0,$(this.box).removeClass("w2ui-inactive").find(".w2ui-inactive").removeClass("w2ui-inactive"),setTimeout(()=>{let e=$(this.box).find("#grid_"+this.name+"_focus");e.is(":focus")||e.focus()},10),this.trigger($.extend(e,{phase:"after"}))}blur(e){e=this.trigger({phase:"before",type:"blur",target:this.name,originalEvent:e});if(!0===e.isCancelled)return!1;this.hasFocus=!1,$(this.box).addClass("w2ui-inactive").find(".w2ui-selected").addClass("w2ui-inactive"),$(this.box).find(".w2ui-selection").addClass("w2ui-inactive"),this.trigger($.extend(e,{phase:"after"}))}keydown(p){let f=this,g="object"!=typeof this.url?this.url:this.url.get;if(!0===f.keyboard){var m=f.trigger({phase:"before",type:"keydown",target:f.name,originalEvent:p});if(!0!==m.isCancelled)if(0<$(this.box).find(">.w2ui-message").length)27==p.keyCode&&this.message();else{let t=!1,i=$(f.box).find("#grid_"+f.name+"_records"),n=f.getSelection();0===n.length&&(t=!0);let s=n[0]||null,a=[],l=n[n.length-1];if("object"==typeof s&&null!=s){s=n[0].recid,a=[];let e=0;for(;;){if(!n[e]||n[e].recid!=s)break;a.push(n[e].column),e++}l=n[n.length-1].recid}let r=f.get(s,!0),o=f.get(l,!0),d=$(f.box).find(`#grid_${f.name}_rec_${null!=r?w2utils.escapeId(f.records[r].recid):"none"}`);var w=Math.floor($(f.box).find(`#grid_${f.name}_records`).height()/f.recordHeight);let h=!1,e=p.keyCode,u=p.shiftKey;switch(e){case 8:case 46:f.delete(),h=!0,p.stopPropagation();break;case 27:f.selectNone(),h=!0;break;case 65:if(!p.metaKey&&!p.ctrlKey)break;f.selectAll(),h=!0;break;case 13:if("row"==this.selectType&&!0===f.show.expandColumn){if(d.length<=0)break;f.toggle(s,p),h=!0}else{for(let e=0;e<this.columns.length;e++)if(this.getCellEditable(r,e)){a.push(parseInt(e));break}"row"==this.selectType&&this.last._edit&&this.last._edit.column&&(a=[this.last._edit.column]),0<a.length&&(f.editField(s,a[0],null,p),h=!0)}break;case 37:!function(){if(t)x();else{if("row"==f.selectType){if(d.length<=0)return;var e=f.records[r].w2ui||{};!e||null==e.parent_recid||Array.isArray(e.children)&&0!==e.children.length&&e.expanded?f.collapse(s,p):(f.unselect(s),f.collapse(e.parent_recid,p),f.select(e.parent_recid))}else{let l=f.prevCell(r,a[0]);if(l=l.index!=r?null:l.colIndex,u||null!=l||(f.selectNone(),l=0),null!=l)if(u&&f.multiSelect){if(v())return;let t=[],i=[],s=[];if(0===a.indexOf(f.last.sel_col)&&1<a.length){for(let e=0;e<n.length;e++)-1==t.indexOf(n[e].recid)&&t.push(n[e].recid),s.push({recid:n[e].recid,column:a[a.length-1]});f.unselect(s),f.scrollIntoView(r,a[a.length-1],!0)}else{for(let e=0;e<n.length;e++)-1==t.indexOf(n[e].recid)&&t.push(n[e].recid),i.push({recid:n[e].recid,column:l});f.select(i),f.scrollIntoView(r,l,!0)}}else p.metaKey=!1,f.click({recid:s,column:l},p),f.scrollIntoView(r,l,!0);else if(!u)if(1<n.length)f.selectNone();else for(let e=1;e<n.length;e++)f.unselect(n[e])}h=!0}}();break;case 39:!function(){if(t)x();else{if("row"==f.selectType){if(d.length<=0)return;f.expand(s,p)}else{let l=f.nextCell(r,a[a.length-1]);if(l=l.index!=r?null:l.colIndex,u||null!=l||(f.selectNone(),l=f.columns.length-1),null!=l)if(u&&39==e&&f.multiSelect){if(v())return;let t=[],i=[],s=[];if(a.indexOf(f.last.sel_col)==a.length-1&&1<a.length){for(let e=0;e<n.length;e++)-1==t.indexOf(n[e].recid)&&t.push(n[e].recid),s.push({recid:n[e].recid,column:a[0]});f.unselect(s),f.scrollIntoView(r,a[0],!0)}else{for(let e=0;e<n.length;e++)-1==t.indexOf(n[e].recid)&&t.push(n[e].recid),i.push({recid:n[e].recid,column:l});f.select(i),f.scrollIntoView(r,l,!0)}}else p.metaKey=!1,f.click({recid:s,column:l},p),f.scrollIntoView(r,l,!0);else if(!u)if(1<n.length)f.selectNone();else for(let e=0;e<n.length-1;e++)f.unselect(n[e])}h=!0}}();break;case 33:b(w);break;case 34:y(w);break;case 35:y(-1);break;case 36:b(-1);break;case 38:b(p.metaKey||p.ctrlKey?-1:1);break;case 40:y(p.metaKey||p.ctrlKey?-1:1);break;case 17:case 91:if(t)break;w2utils.isSafari&&(f.last.copy_event=f.copy(!1,p),$(f.box).find("#grid_"+f.name+"_focus").val(f.last.copy_event.text).select());break;case 67:(p.metaKey||p.ctrlKey)&&(w2utils.isSafari||(f.last.copy_event=f.copy(!1,p),$(f.box).find("#grid_"+f.name+"_focus").val(f.last.copy_event.text).select()),f.copy(f.last.copy_event,p));break;case 88:if(t)break;(p.ctrlKey||p.metaKey)&&(w2utils.isSafari||(f.last.copy_event=f.copy(!1,p),$(f.box).find("#grid_"+f.name+"_focus").val(f.last.copy_event.text).select()),f.copy(f.last.copy_event,p))}let c=[32,187,189,192,219,220,221,186,222,188,190,191];for(let e=48;e<=111;e++)c.push(e);function b(e){if(t&&x(),!(d.length<=0)){let i=f.prevRow(r,"row"==f.selectType?0:n[0].column,e);if(u||null!=i||(i=0==f.searchData.length||g?0:f.last.searchIds[0]),null!=i){if(u&&f.multiSelect){if(v())return;if("row"==f.selectType)f.last.sel_ind>i&&f.last.sel_ind!=o?f.unselect(f.records[o].recid):f.select(f.records[i].recid);else if(f.last.sel_ind>i&&f.last.sel_ind!=o){i=o;let t=[];for(let e=0;e<a.length;e++)t.push({recid:f.records[i].recid,column:a[e]});f.unselect(t)}else{let t=[];for(let e=0;e<a.length;e++)t.push({recid:f.records[i].recid,column:a[e]});f.select(t)}}else 300<n.length?f.selectNone():f.unselect(n),f.click({recid:f.records[i].recid,column:a[0]},p);f.scrollIntoView(i,null,!1,1!=e),p.preventDefault&&p.preventDefault()}else if(!u)if(1<n.length)f.selectNone();else for(let e=1;e<n.length;e++)f.unselect(n[e])}}function y(e){if(t&&x(),!(d.length<=0)){let i=f.nextRow(o,"row"==f.selectType?0:n[0].column,e);if(u||null!=i||(i=0==f.searchData.length||g?f.records.length-1:f.last.searchIds[f.last.searchIds.length-1]),null!=i){if(u&&f.multiSelect){if(v())return;if("row"==f.selectType)f.last.sel_ind<i&&f.last.sel_ind!=r?f.unselect(f.records[r].recid):f.select(f.records[i].recid);else if(f.last.sel_ind<i&&f.last.sel_ind!=r){i=r;let t=[];for(let e=0;e<a.length;e++)t.push({recid:f.records[i].recid,column:a[e]});f.unselect(t)}else{let t=[];for(let e=0;e<a.length;e++)t.push({recid:f.records[i].recid,column:a[e]});f.select(t)}}else 300<n.length?f.selectNone():f.unselect(n),f.click({recid:f.records[i].recid,column:a[0]},p);f.scrollIntoView(i,null,!1,1!=e),h=!0}else if(!u)if(1<n.length)f.selectNone();else for(let e=0;e<n.length-1;e++)f.unselect(n[e])}}function x(){if(f.records&&0!==f.records.length){let e=Math.floor(i[0].scrollTop/f.recordHeight)+1;(!f.records[e]||e<2)&&(e=0),void 0!==f.records[e]&&f.select({recid:f.records[e].recid,column:0})}}function v(){if("click"==f.last.sel_type){if("row"==f.selectType)return f.last.sel_type="key",1<n.length&&(n.splice(n.indexOf(f.records[f.last.sel_ind].recid),1),f.unselect(n),1);if(f.last.sel_type="key",1<n.length){for(let e=0;e<n.length;e++)if(n[e].recid==f.last.sel_recid&&n[e].column==f.last.sel_col){n.splice(e,1);break}return f.unselect(n),1}}}-1==c.indexOf(e)||p.ctrlKey||p.metaKey||h||(0===a.length&&a.push(0),h=!1,setTimeout(()=>{let e=$(f.box).find("#grid_"+f.name+"_focus");var t=e.val();e.val(""),f.editField(s,a[0],t,p)},1)),h&&p.preventDefault&&p.preventDefault(),f.trigger($.extend(m,{phase:"after"}))}}}scrollIntoView(s,l,n,t){let i=this.records.length;if(0==this.searchData.length||this.url||(i=this.last.searchIds.length),0!==i){if(null==s){var a=this.getSelection();if(0===a.length)return;$.isPlainObject(a[0])?(s=a[0].index,l=a[0].column):s=this.get(a[0],!0)}let e=$(this.box).find("#grid_"+this.name+"_records");var r=this.last.searchIds.length;if(0<r&&(s=this.last.searchIds.indexOf(s)),e.height()<this.recordHeight*(0<r?r:i)&&0<e.length&&(r=(a=Math.floor(e[0].scrollTop/this.recordHeight))+Math.floor(e.height()/this.recordHeight),s==a&&(!0===n?e.prop({scrollTop:e.scrollTop()-e.height()/1.3}):(e.stop(),e.animate({scrollTop:e.scrollTop()-e.height()/1.3},250,"linear"))),s==r&&(!0===n?e.prop({scrollTop:e.scrollTop()+e.height()/1.3}):(e.stop(),e.animate({scrollTop:e.scrollTop()+e.height()/1.3},250,"linear"))),(s<a||r<s)&&(!0===n?e.prop({scrollTop:(s-1)*this.recordHeight}):(e.stop(),e.animate({scrollTop:(s-1)*this.recordHeight},250,"linear"))),!0===t&&(!0===n?e.prop({scrollTop:s*this.recordHeight}):(e.stop(),e.animate({scrollTop:s*this.recordHeight},250,"linear")))),null!=l){let t=0,i=0;s=w2utils.scrollBarSize();for(let e=0;e<=l;e++){var o=this.columns[e];o.frozen||o.hidden||(t=i,i+=parseInt(o.sizeCalculated))}e.width()<i-e.scrollLeft()?!0===n?e.prop({scrollLeft:t-s}):e.animate({scrollLeft:t-s},250,"linear"):t<e.scrollLeft()&&(!0===n?e.prop({scrollLeft:i-e.width()+2*s}):e.animate({scrollLeft:i-e.width()+2*s},250,"linear"))}}}scrollToColumn(s){if(null!=s){let t=0,i=!1;for(let e=0;e<this.columns.length;e++){var l=this.columns[e];if(l.field==s){i=!0;break}l.frozen||l.hidden||(l=parseInt(l.sizeCalculated||l.size),t+=l)}i&&(this.last.scrollLeft=t+1,this.scroll())}}dblClick(e,t){let i=null;if("object"==typeof e&&null!==e&&(i=e.column,e=e.recid),null==t&&(t={}),null==i&&t.target){let e=t.target;"TD"!=e.tagName.toUpperCase()&&(e=$(e).parents("td")[0]),i=parseInt($(e).attr("col"))}var s=this.get(e,!0),l=this.records[s],n=this.trigger({phase:"before",target:this.name,type:"dblClick",recid:e,column:i,originalEvent:t});!0!==n.isCancelled&&(this.selectNone(),this.getCellEditable(s,i)?this.editField(e,i,null,t):(this.select({recid:e,column:i}),(this.show.expandColumn||l&&l.w2ui&&Array.isArray(l.w2ui.children))&&this.toggle(e)),this.trigger($.extend(n,{phase:"after"})))}contextMenu(s,l,n){const t=this;if("text"!=this.last.userSelect){null==(n=null==n?{offsetX:0,offsetY:0,target:$(this.box).find("#grid_"+this.name+"_rec_"+s)[0]}:n).offsetX&&(n.offsetX=n.layerX-n.target.offsetLeft,n.offsetY=n.layerY-n.target.offsetTop),w2utils.isFloat(s)&&(s=parseFloat(s));let i=this.getSelection();if("row"==this.selectType)-1==i.indexOf(s)&&this.click(s);else{let e=$(n.target);"TD"!=e[0].tagName.toUpperCase()&&(e=$(n.target).parents("td"));let t=!1;l=e.attr("col");for(let e=0;e<i.length;e++)i[e].recid!=s&&i[e].column!=l||(t=!0);t||null==s||this.click({recid:s,column:l}),t||null==l||this.columnClick(this.columns[l].field,n)}var e=this.trigger({phase:"before",type:"contextMenu",target:this.name,originalEvent:n,recid:s,column:l});!0!==e.isCancelled&&(0<t.menu.length&&$(t.box).find(n.target).w2menu(t.menu,{originalEvent:n,contextMenu:!0,onSelect(e){t.menuClick(s,e)}}),n.preventDefault&&n.preventDefault(),this.trigger($.extend(e,{phase:"after"})))}}menuClick(e,t){t=this.trigger({phase:"before",type:"menuClick",target:this.name,originalEvent:t.originalEvent,menuEvent:t,recid:e,menuIndex:t.index,menuItem:t.item});!0!==t.isCancelled&&this.trigger($.extend(t,{phase:"after"}))}toggle(e){let t=this.get(e);if(null!=t)return t.w2ui=t.w2ui||{},!0===t.w2ui.expanded?this.collapse(e):this.expand(e)}expand(i,s){var e=this.get(i,!0);let l=this.records[e];l.w2ui=l.w2ui||{};var n=w2utils.escapeId(i);let t=l.w2ui.children,a;if(Array.isArray(t)){if(!0===l.w2ui.expanded||0===t.length)return!1;if(a=this.trigger({phase:"before",type:"expand",target:this.name,recid:i}),!0===a.isCancelled)return!1;l.w2ui.expanded=!0,t.forEach(e=>{e.w2ui=e.w2ui||{},e.w2ui.parent_recid=l.recid,null==e.w2ui.children&&(e.w2ui.children=[])}),this.records.splice.apply(this.records,[e+1,0].concat(t)),-1!==this.total&&(this.total+=t.length),("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(!0,!0),0<this.searchData.length&&this.localSearch(!0)),!0!==s&&this.refresh(),this.trigger($.extend(a,{phase:"after"}))}else{if(0<$(this.box).find("#grid_"+this.name+"_rec_"+n+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if("none"==l.w2ui.expanded)return!1;if($(this.box).find("#grid_"+this.name+"_rec_"+n).after('<tr id="grid_'+this.name+"_rec_"+i+'_expanded_row" class="w2ui-expanded-row">    <td colspan="100" class="w2ui-expanded2">        <div id="grid_'+this.name+"_rec_"+i+'_expanded"></div>    </td>    <td class="w2ui-grid-data-last"></td></tr>'),$(this.box).find("#grid_"+this.name+"_frec_"+n).after('<tr id="grid_'+this.name+"_frec_"+i+'_expanded_row" class="w2ui-expanded-row">'+(this.show.lineNumbers?'<td class="w2ui-col-number"></td>':"")+'    <td class="w2ui-grid-data w2ui-expanded1" colspan="100">       <div id="grid_'+this.name+"_frec_"+i+'_expanded"></div>   </td></tr>'),a=this.trigger({phase:"before",type:"expand",target:this.name,recid:i,box_id:"grid_"+this.name+"_rec_"+i+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+n+"_expanded"}),!0===a.isCancelled)return $(this.box).find("#grid_"+this.name+"_rec_"+n+"_expanded_row").remove(),$(this.box).find("#grid_"+this.name+"_frec_"+n+"_expanded_row").remove(),!1;let e=$(this.box).find("#grid_"+this.name+"_rec_"+i+"_expanded"),t=$(this.box).find("#grid_"+this.name+"_frec_"+i+"_expanded");s=e.find("> div:first-child").height();e.height()<s&&e.css({height:s+"px"}),t.height()<s&&t.css({height:s+"px"}),$(this.box).find("#grid_"+this.name+"_rec_"+n).attr("expanded","yes").addClass("w2ui-expanded"),$(this.box).find("#grid_"+this.name+"_frec_"+n).attr("expanded","yes").addClass("w2ui-expanded"),$(this.box).find("#grid_"+this.name+"_cell_"+this.get(i,!0)+"_expand div").html("-"),l.w2ui.expanded=!0,this.trigger($.extend(a,{phase:"after"})),this.resizeRecords()}return!0}collapse(i,s){var l=this.get(i,!0);let n=this.records[l];n.w2ui=n.w2ui||{};let e=w2utils.escapeId(i);var t=n.w2ui.children;let a;if(Array.isArray(t)){if(!0!==n.w2ui.expanded)return!1;if(a=this.trigger({phase:"before",type:"collapse",target:this.name,recid:i}),!0===a.isCancelled)return!1;!function i(s){s.w2ui.expanded=!1;for(let t=0;t<s.w2ui.children.length;t++){let e=s.w2ui.children[t];e.w2ui.expanded&&i(e)}}(n);let t=[];for(let e=n;null!=e;e=this.get(e.w2ui.parent_recid))t.push(e.w2ui.parent_recid);l=l+1;let e=l;for(;;){if(this.records.length<=e+1||null==this.records[e+1].w2ui||0<=t.indexOf(this.records[e+1].w2ui.parent_recid))break;e++}this.records.splice(l,e-l+1),-1!==this.total&&(this.total-=e-l+1),("object"!=typeof this.url?this.url:this.url.get)||0<this.searchData.length&&this.localSearch(!0),!0!==s&&this.refresh(),this.trigger($.extend(a,{phase:"after"}))}else{if(0===$(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if(a=this.trigger({phase:"before",type:"collapse",target:this.name,recid:i,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"}),!0===a.isCancelled)return!1;$(this.box).find("#grid_"+this.name+"_rec_"+e).removeAttr("expanded").removeClass("w2ui-expanded"),$(this.box).find("#grid_"+this.name+"_frec_"+e).removeAttr("expanded").removeClass("w2ui-expanded"),$(this.box).find("#grid_"+this.name+"_cell_"+this.get(i,!0)+"_expand div").html("+"),$(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded").css("height","0px"),$(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded").css("height","0px"),setTimeout(()=>{$(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded_row").remove(),$(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded_row").remove(),n.w2ui.expanded=!1,this.trigger($.extend(a,{phase:"after"})),this.resizeRecords()},300)}return!0}sort(i,e,s){var t=this.trigger({phase:"before",type:"sort",target:this.name,field:i,direction:e,multiField:s});if(!0!==t.isCancelled){if(null!=i){let t=this.sortData.length;for(let e=0;e<this.sortData.length;e++)if(this.sortData[e].field==i){t=e;break}null==e&&(e=null==this.sortData[t]?"asc":(null==this.sortData[t].direction&&(this.sortData[t].direction=""),"asc"===this.sortData[t].direction.toLowerCase()?"desc":"asc")),!1===this.multiSort&&(this.sortData=[],t=0),1!=s&&(this.sortData=[],t=0),null==this.sortData[t]&&(this.sortData[t]={}),this.sortData[t].field=i,this.sortData[t].direction=e}else this.sortData=[];("object"!=typeof this.url?this.url:this.url.get)?(this.trigger($.extend(t,{phase:"after",direction:e})),this.last.xhr_offset=0,this.reload()):(this.localSort(!1,!0),0<this.searchData.length&&this.localSearch(!0),this.last.scrollTop=0,$(this.box).find("#grid_"+this.name+"_records").prop("scrollTop",0),this.trigger($.extend(t,{phase:"after",direction:e})),this.refresh())}}copy(e,t){if($.isPlainObject(e))return this.trigger($.extend(e,{phase:"after"})),e.text;var l=this.getSelection();if(0===l.length)return"";let n="";if("object"==typeof l[0]){let t=l[0].column,i=l[0].column,s=[];for(let e=0;e<l.length;e++)l[e].column<t&&(t=l[e].column),l[e].column>i&&(i=l[e].column),-1==s.indexOf(l[e].index)&&s.push(l[e].index);s.sort((e,t)=>e-t);for(let e=0;e<s.length;e++){var a=s[e];for(let e=t;e<=i;e++)!0!==this.columns[e].hidden&&(n+=this.getCellCopy(a,e)+"\t");n=n.substr(0,n.length-1),n+="\n"}}else{for(let e=0;e<this.columns.length;e++){var i=this.columns[e];if(!0!==i.hidden){let e=i.text||i.field;i.text&&i.text.length<3&&i.tooltip&&(e=i.tooltip),n+='"'+w2utils.stripTags(e)+'"\t'}}n=n.substr(0,n.length-1),n+="\n";for(let e=0;e<l.length;e++){var s=this.get(l[e],!0);for(let e=0;e<this.columns.length;e++)!0!==this.columns[e].hidden&&(n+='"'+this.getCellCopy(s,e)+'"\t');n=n.substr(0,n.length-1),n+="\n"}}n=n.substr(0,n.length-1);let r;return null==e?(r=this.trigger({phase:"before",type:"copy",target:this.name,text:n,cut:88==t.keyCode,originalEvent:t}),!0===r.isCancelled?"":(n=r.text,this.trigger($.extend(r,{phase:"after"})),n)):!1===e?(r=this.trigger({phase:"before",type:"copy",target:this.name,text:n,cut:88==t.keyCode,originalEvent:t}),!0===r.isCancelled?"":(n=r.text,r)):void 0}getCellCopy(e,t){return w2utils.stripTags(this.getCellHTML(e,t))}paste(l,e){var t=this.getSelection();let n=this.get(t[0].recid,!0);var a,r,o,d=t[0].column,e=this.trigger({phase:"before",type:"paste",target:this.name,text:l,index:n,column:d,originalEvent:e});if(!0!==e.isCancelled){if(l=e.text,"row"==this.selectType||0===t.length)return console.log("ERROR: You can paste only if grid.selectType = 'cell' and when at least one cell selected."),void this.trigger($.extend(e,{phase:"after"}));if("object"!=typeof l){let s=[];l=l.split("\n");for(let e=0;e<l.length;e++){var h=l[e].split("\t");let t=0;var u=this.records[n];let i=[];if(null!=u){for(let e=0;e<h.length;e++)this.columns[d+t]&&(a=u,r=this.columns[d+t].field,o=h[e],a.w2ui=a.w2ui||{},a.w2ui.changes=a.w2ui.changes||{},a.w2ui.changes[r]=o,i.push(d+t),t++);for(let e=0;e<i.length;e++)s.push({recid:u.recid,column:i[e]});n++}}this.selectNone(),this.select(s)}else this.selectNone(),this.select([{recid:this.records[n],column:d}]);this.refresh(),this.trigger($.extend(e,{phase:"after"}))}}resize(){var e=(new Date).getTime();if(this.box&&$(this.box).attr("name")==this.name){$(this.box).find("> div.w2ui-grid-box").css("width",$(this.box).width()).css("height",$(this.box).height());var t=this.trigger({phase:"before",type:"resize",target:this.name});if(!0!==t.isCancelled)return this.resizeBoxes(),this.resizeRecords(),this.toolbar&&this.toolbar.resize&&this.toolbar.resize(),this.trigger($.extend(t,{phase:"after"})),(new Date).getTime()-e}}update({cells:t,fullCellRefresh:i,ignoreColumns:l}={}){var e=(new Date).getTime();let h=this;if(null==this.box)return 0;if(Array.isArray(t))for(let e=0;e<t.length;e++){var s=t[e].index,n=t[e].column;if(!(s<0))if(null!=s&&null!=n){let e=this.records[s]??{};e.w2ui=e.w2ui??{},e.w2ui._update=e.w2ui._update??{cells:[]};let t=e.w2ui._update.row1,i=e.w2ui._update.row2;null!=t&&t.isConnected&&null!=i&&i.isColSelected||(t=this.box.querySelector(`#grid_${this.name}_rec_${w2utils.escapeId(e.recid)}`),i=this.box.querySelector(`#grid_${this.name}_frec_${w2utils.escapeId(e.recid)}`),e.w2ui._update.row1=t,e.w2ui._update.row2=i),a(e,t,i,s,n)}else console.log("ERROR: Wrong argument for grid.update({ cells }), cells should be [{ index: X, column: Y }, ...]")}else for(let e=this.last.range_start-1;e<=this.last.range_end;e++){let s=e;s=0<this.last.searchIds.length?this.last.searchIds[e]:e;let l=this.records[s];if(!(s<0||null==l)){l.w2ui=l.w2ui??{},l.w2ui._update=l.w2ui._update??{cells:[]};let t=l.w2ui._update.row1,i=l.w2ui._update.row2;null!=t&&t.isConnected&&null!=i&&i.isColSelected||(t=this.box.querySelector(`#grid_${this.name}_rec_${w2utils.escapeId(l.recid)}`),i=this.box.querySelector(`#grid_${this.name}_frec_${w2utils.escapeId(l.recid)}`),l.w2ui._update.row1=t,l.w2ui._update.row2=i);for(let e=0;e<this.columns.length;e++)a(l,t,i,s,e)}}return(new Date).getTime()-e;function a(e,s,n,a,r){var o=h.columns[r];if(!Array.isArray(l)||!l.includes(r)&&!l.includes(o.field)){let l=e.w2ui._update.cells[r];if(null!=l&&l.isConnected||(l=h.box.querySelector(`#grid_${h.name}_data_${a}_${r}`),e.w2ui._update.cells[r]=l),null!=l){if(i)$(l).replaceWith(h.getCellHTML(a,r,!1)),l=h.box.querySelector(`#grid_${h.name}_data_${a}_${r}`),e.w2ui._update.cells[r]=l;else{let e=l.children[0],{value:t,style:i,className:s}=h.getCellValue(a,r,!1,!0);if(e.innerHTML!=t&&(e.innerHTML=t),""!=i&&l.style.cssText!=i&&(l.style.cssText=i),""!=s){let t=["w2ui-grid-data"],i=[];a=s.split(" ").filter(e=>!!e);l.classList.forEach(e=>{t.includes(e)||i.push(e)}),l.classList.remove(...i),l.classList.add(...a)}}if(h.columns[r].style&&h.columns[r].style!=l.style.cssText&&(l.style.cssText=h.columns[r].style??""),null!=e.w2ui.class){if("string"==typeof e.w2ui.class){let t=["w2ui-odd","w2ui-even","w2ui-record"],i=[];var d=e.w2ui.class.split(" ").filter(e=>!!e);s&&n&&(s.classList.forEach(e=>{t.includes(e)||i.push(e)}),s.classList.remove(...i),s.classList.add(...d),n.classList.remove(...i),n.classList.add(...d))}if($.isPlainObject(e.w2ui.class)&&"string"==typeof e.w2ui.class[o.field]){let t=["w2ui-grid-data"],i=[];d=e.w2ui.class[o.field].split(" ").filter(e=>!!e);l.classList.forEach(e=>{t.includes(e)||i.push(e)}),l.classList.remove(...i),l.classList.add(...d)}}null!=e.w2ui.style&&(s&&n&&"string"==typeof e.w2ui.style&&s.style.cssText!==e.w2ui.style&&(s.style.cssText="height: "+h.recordHeight+"px;"+e.w2ui.style,s.setAttribute("custom_style",e.w2ui.style),n.style.cssText="height: "+h.recordHeight+"px;"+e.w2ui.style,n.setAttribute("custom_style",e.w2ui.style)),$.isPlainObject(e.w2ui.style)&&"string"==typeof e.w2ui.style[o.field]&&l.style.cssText!==e.w2ui.style[o.field]&&(l.style.cssText=e.w2ui.style[o.field]))}}}}refreshCell(e,t){var i=this.get(e,!0),t=this.getColumn(t,!0),e=!this.records[i]||this.records[i].recid!=e;let s=$(this.box).find((e?".w2ui-grid-summary ":"")+"#grid_"+this.name+"_data_"+i+"_"+t);if(0==s.length)return!1;s.replaceWith(this.getCellHTML(i,t,e))}refreshRow(t,i){let s=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t)),l=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t));if(0<s.length){null==i&&(i=this.get(t,!0));var n=s.attr("line"),a=!this.records[i]||this.records[i].recid!=t,r="object"!=typeof this.url?this.url:this.url.get;if(0<this.searchData.length&&!r)for(let e=0;e<this.last.searchIds.length;e++)this.last.searchIds[e]==i&&(i=e);n=this.getRecordHTML(i,n,a);$(s).replaceWith(n[0]),$(l).replaceWith(n[1]);let e=this.records[i].w2ui?this.records[i].w2ui.style:"";"string"==typeof e&&(s=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t)),l=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t)),s.attr("custom_style",e),l.attr("custom_style",e),s.hasClass("w2ui-selected")&&(e=e.replace("background-color","none")),s[0].style.cssText="height: "+this.recordHeight+"px;"+e,l[0].style.cssText="height: "+this.recordHeight+"px;"+e),a&&this.resize()}}refresh(){var e=(new Date).getTime(),t="object"!=typeof this.url?this.url:this.url.get;if(this.total<=0&&!t&&0===this.searchData.length&&(this.total=this.records.length),this.box){var s=this.trigger({phase:"before",target:this.name,type:"refresh"});if(!0!==s.isCancelled){if(this.show.header?$(this.box).find("#grid_"+this.name+"_header").html(w2utils.lang(this.header)+"&#160;").show():$(this.box).find("#grid_"+this.name+"_header").hide(),this.show.toolbar){if(this.toolbar.disable("w2ui-edit","w2ui-delete"),!(this.toolbar&&this.toolbar.get("w2ui-column-on-off")&&this.toolbar.get("w2ui-column-on-off").checked)&&($(this.box).find("#grid_"+this.name+"_toolbar").show(),"object"==typeof this.toolbar)){var l=this.toolbar.items;for(let e=0;e<l.length;e++)"w2ui-search"!=l[e].id&&"break"!=l[e].type&&this.toolbar.refresh(l[e].id)}}else $(this.box).find("#grid_"+this.name+"_toolbar").hide();this.searchClose();let i=$(this.box).find("#grid_"+this.name+"_search_all");!this.multiSearch&&"all"==this.last.field&&0<this.searches.length&&(this.last.field=this.searches[0].field,this.last.label=this.searches[0].label);for(let e=0;e<this.searches.length;e++)this.searches[e].field==this.last.field&&(this.last.label=this.searches[e].label);if(this.last.multi?(i.attr("placeholder","["+w2utils.lang("Multiple Fields")+"]"),i.w2field("clear")):i.attr("placeholder",w2utils.lang("Search")+" "+w2utils.lang(this.last.label,!0)),i.val()!=this.last.search){let e=this.last.search,t=i.data("w2field");t&&(e=t.format(e)),i.val(e)}this.refreshSearch(),this.refreshBody(),this.show.footer?$(this.box).find("#grid_"+this.name+"_footer").html(this.getFooterHTML()).show():$(this.box).find("#grid_"+this.name+"_footer").hide();var n=this.last.selection,t=0<this.records.length&&n.indexes.length==this.records.length,n=0<n.indexes.length&&0!==this.searchData.length&&n.indexes.length==this.last.searchIds.length;t||n?$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status();var a=this.find({"w2ui.expanded":!0},!0,!0);for(let t=0;t<a.length;t++){let e=this.records[a[t]].w2ui;e&&!Array.isArray(e.children)&&(e.expanded=!1)}return this.markSearch&&setTimeout(()=>{let t=[];for(let e=0;e<this.searchData.length;e++){var i=this.searchData[e],s=this.getSearch(i.field);s&&!s.hidden&&(s=this.getColumn(i.field,!0),t.push({field:i.field,search:i.value,col:s}))}0<t.length&&t.forEach(e=>{$(this.box).find('td[col="'+e.col+'"]').not(".w2ui-head").w2marker(e.search)})},50),this.show.toolbarSave&&(0<this.getChanges().length?this.toolbar.enable("w2ui-save"):this.toolbar.disable("w2ui-save")),this.trigger($.extend(s,{phase:"after"})),this.resize(),this.addRange("selection"),setTimeout(()=>{this.resize(),this.scroll()},1),this.reorderColumns&&!this.last.columnDrag?this.last.columnDrag=this.initColumnDrag():!this.reorderColumns&&this.last.columnDrag&&this.last.columnDrag.remove(),(new Date).getTime()-e}}}refreshSearch(){if(this.multiSearch&&0<this.searchData.length){0==$(this.box).find(".w2ui-grid-searches").length&&$(this.box).find(".w2ui-grid-toolbar").css("height",this.last._toolbar_height+35+"px").append(`<div id="grid_${this.name}_searches" class="w2ui-grid-searches"></div>`);let n=`
                <span id="grid_${this.name}_search_logic" class="w2ui-grid-search-logic"></span>
                <div class="grid-search-line"></div>`;this.searchData.forEach((i,e)=>{var t=this.getSearch(i.field,!0),s=this.searches[t];let l;if(l=Array.isArray(i.value)?`<span class="grid-search-count">${i.value.length}</span>`:`: ${i.value}`,s&&"date"==s.type)if("between"==i.operator){let e=i.value[0],t=i.value[1];Number(e)===e&&(e=w2utils.formatDate(e)),Number(t)===t&&(t=w2utils.formatDate(t)),l=`: ${e} - ${t}`}else{let e=i.value;Number(e)==e&&(e=w2utils.formatDate(e));let t=i.operator;"more"==t&&(t="since"),"less"==t&&(t="before"),"more:"==t.substr(0,5)&&(t="since"),l=`: ${t} ${e}`}n+=`<span class="w2ui-action" data-click="searchFieldDrop|${t}|${e}|this">
                    ${s?s.label:""}
                    ${l}
                    <span class="icon-chevron-down"></span>
                </span>`}),n+=`
                ${this.show.searchSave?`<div class="grid-search-line"></div>
                       <button class="w2ui-btn grid-search-btn" data-click="searchSave">${w2utils.lang("Save")}</button>
                      `:""}
                <button class="w2ui-btn grid-search-btn btn-remove"
                    data-click="searchReset">X</button>
            `,$(this.box).find(`#grid_${this.name}_searches`).html(n),$(this.box).find(`#grid_${this.name}_search_logic`).html(w2utils.lang("AND"==this.last.logic?"All":"Any"))}else $(this.box).find(".w2ui-grid-toolbar").css("height",this.last._toolbar_height).find(".w2ui-grid-searches").remove();this.searchSelected?($(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),$(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.name)):($(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),$(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html("")),w2utils.bindEvents($(this.box).find(`#grid_${this.name}_searches .w2ui-action, #grid_${this.name}_searches button`),this)}refreshBody(){this.scroll();var e=this.getRecordsHTML(),t=this.getColumnsHTML(),t='<div id="grid_'+this.name+'_frecords" class="w2ui-grid-frecords" style="margin-bottom: '+(w2utils.scrollBarSize()-1)+'px;">'+e[0]+'</div><div id="grid_'+this.name+'_records" class="w2ui-grid-records" onscroll="w2ui[\''+this.name+"'].scroll(event);\">"+e[1]+'</div><div id="grid_'+this.name+'_scroll1" class="w2ui-grid-scroll1" style="height: '+w2utils.scrollBarSize()+'px"></div><div id="grid_'+this.name+'_fcolumns" class="w2ui-grid-fcolumns">    <table><tbody>'+t[0]+'</tbody></table></div><div id="grid_'+this.name+'_columns" class="w2ui-grid-columns">    <table><tbody>'+t[1]+"</tbody></table></div>";let a=$(this.box).find("#grid_"+this.name+"_body",this.box).html(t),r=$(this.box).find("#grid_"+this.name+"_records",this.box),i=$(this.box).find("#grid_"+this.name+"_frecords",this.box),o=this;"row"==this.selectType&&(r.on("mouseover mouseout","tr",function(e){$(o.box).find("#grid_"+o.name+"_frec_"+w2utils.escapeId($(this).attr("recid"))).toggleClass("w2ui-record-hover","mouseover"==e.type)}),i.on("mouseover mouseout","tr",function(e){$(o.box).find("#grid_"+o.name+"_rec_"+w2utils.escapeId($(this).attr("recid"))).toggleClass("w2ui-record-hover","mouseover"==e.type)})),w2utils.isIOS?r.add(i).on("click","tr",function(e){o.dblClick($(this).attr("recid"),e)}):r.add(i).on("click","tr",function(e){o.click($(this).attr("recid"),e)}).on("contextmenu","tr",function(e){o.contextMenu($(this).attr("recid"),null,e)}),a.data("scrolldata",{lastTime:0,lastDelta:0,time:0}).find(".w2ui-grid-frecords").on("mousewheel DOMMouseScroll ",function(e){e.preventDefault();let t=e.originalEvent,i=a.data("scrolldata"),s=$(this).siblings(".w2ui-grid-records").addBack().filter(".w2ui-grid-records"),l=null!=typeof t.wheelDelta?-1*t.wheelDelta/120:(t.detail||t.deltaY)/3,n=s.scrollTop();i.time=+new Date,i.lastTime<i.time-150&&(i.lastDelta=0),i.lastTime=i.time,i.lastDelta+=l,l=Math.abs(i.lastDelta)<1?0:Math.round(i.lastDelta),a.data("scrolldata",i),l*=(Math.round(r.height()/o.recordHeight)-1)*o.recordHeight/4,s.stop().animate({scrollTop:n+l},250,"linear")}),0===this.records.length&&this.msgEmpty?$(this.box).find("#grid_"+this.name+"_body").append('<div id="grid_'+this.name+'_empty_msg" class="w2ui-grid-empty-msg"><div>'+this.msgEmpty+"</div></div>"):0<$(this.box).find("#grid_"+this.name+"_empty_msg").length&&$(this.box).find("#grid_"+this.name+"_empty_msg").remove(),0<this.summary.length?(t=this.getSummaryHTML(),$(this.box).find("#grid_"+this.name+"_fsummary").html(t[0]).show(),$(this.box).find("#grid_"+this.name+"_summary").html(t[1]).show()):($(this.box).find("#grid_"+this.name+"_fsummary").hide(),$(this.box).find("#grid_"+this.name+"_summary").hide())}render(e){let c=this;var i=(new Date).getTime();if(null!=e&&(0<$(this.box).find("#grid_"+this.name+"_body").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-grid w2ui-inactive").html(""),this.box=e),this.box){var s="object"!=typeof this.url?this.url:this.url.get,e=this.trigger({phase:"before",target:this.name,type:"render",box:e});if(!0!==e.isCancelled){if(this.reset(!0),!this.last.field)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields";else{let e=0;for(;e<this.searches.length&&(this.searches[e].hidden||!1===this.searches[e].simple);)e++;e>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[e].field,this.last.label=this.searches[e].label)}if($(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-grid w2ui-inactive").html('<div class="w2ui-grid-box">    <div id="grid_'+this.name+'_header" class="w2ui-grid-header"></div>    <div id="grid_'+this.name+'_toolbar" class="w2ui-grid-toolbar"></div>    <div id="grid_'+this.name+'_body" class="w2ui-grid-body"></div>    <div id="grid_'+this.name+'_fsummary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_summary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_footer" class="w2ui-grid-footer"></div>    <textarea id="grid_'+this.name+'_focus" class="w2ui-grid-focus-input" '+(this.tabIndex?'tabindex="'+this.tabIndex+'"':"")+(w2utils.isIOS?"readonly":"")+"></textarea></div>"),"row"!=this.selectType&&$(this.box).addClass("w2ui-ss"),0<$(this.box).length&&($(this.box)[0].style.cssText+=this.style),this.initToolbar(),null!=this.toolbar&&this.toolbar.render($(this.box).find("#grid_"+this.name+"_toolbar")[0]),this.last._toolbar_height=$(this.box).find(`#grid_${this.name}_toolbar`).prop("offsetHeight"),this.last.field&&"all"!=this.last.field){let e=this.searchData;setTimeout(()=>{this.searchInitInput(this.last.field,1==e.length?e[0].value:null)},1)}$(this.box).find("#grid_"+this.name+"_footer").html(this.getFooterHTML()),this.last.state||(this.last.state=this.stateSave(!0)),this.stateRestore(),s&&(this.clear(),this.refresh());let t=!1;for(let e=0;e<this.searches.length;e++)if(this.searches[e].hidden){t=!0;break}t?(this.searchReset(!1),s||setTimeout(()=>{this.searchReset()},1)):this.reload(),$(this.box).find("#grid_"+this.name+"_focus").on("focus",function(e){clearTimeout(c.last.kbd_timer),c.hasFocus||c.focus()}).on("blur",function(e){clearTimeout(c.last.kbd_timer),c.last.kbd_timer=setTimeout(()=>{c.hasFocus&&c.blur()},100)}).on("paste",function(s){let l=s.originalEvent.clipboardData||null;if(l){let e=l.items;2==e.length&&(2==e.length&&"file"==e[1].kind&&(e=[e[1]]),2==e.length&&"text/plain"==e[0].type&&"text/html"==e[1].type&&(e=[e[1]]));let i=[];for(var n in e){let t=e[n];if("file"===t.kind){n=t.getAsFile();i.push({kind:"file",data:n})}else if("string"===t.kind&&("text/plain"===t.type||"text/html"===t.type)){s.preventDefault();let e=l.getData("text/plain");-1!=e.indexOf("\r")&&-1==e.indexOf("\n")&&(e=e.replace(/\r/g,"\n")),i.push({kind:"text/html"==t.type?"html":"text",data:e})}}1===i.length&&"file"!=i[0].kind&&(i=i[0].data),w2ui[c.name].paste(i,s.originalEvent),s.preventDefault()}}).on("keydown",function(e){w2ui[c.name].keydown.call(w2ui[c.name],e)});let u;return $(this.box).off("mousedown.mouseStart").on("mousedown.mouseStart",function(n){if(1==n.which&&("text"==c.last.userSelect&&(c.last.userSelect="",$(c.box).find(".w2ui-grid-body").css(w2utils.cssPrefix("user-select","none"))),!("row"==c.selectType&&($(n.target).parents().hasClass("w2ui-head")||$(n.target).hasClass("w2ui-head"))||c.last.move&&"expand"==c.last.move.type))){if(n.altKey)$(c.box).find(".w2ui-grid-body").css(w2utils.cssPrefix("user-select","text")),c.selectNone(),c.last.move={type:"text-select"},c.last.userSelect="text";else{let e=n.target,t={x:n.offsetX-10,y:n.offsetY-10},i=!1;for(;e&&(!e.classList||!e.classList.contains("w2ui-grid"));)e.tagName&&"TD"==e.tagName.toUpperCase()&&(i=!0),e.tagName&&"TR"!=e.tagName.toUpperCase()&&1==i&&(t.x+=e.offsetLeft,t.y+=e.offsetTop),e=e.parentNode;c.last.move={x:n.screenX,y:n.screenY,divX:0,divY:0,focusX:t.x,focusY:t.y,recid:$(n.target).parents("tr").attr("recid"),column:parseInt(("TD"==n.target.tagName.toUpperCase()?$(n.target):$(n.target).parents("td")).attr("col")),type:"select",ghost:!1,start:!0},null==c.last.move.recid&&(c.last.move.type="select-column");let s=n.target,l=$(c.box).find("#grid_"+c.name+"_focus");if(c.last.move){let e=c.last.move.focusX,t=c.last.move.focusY,i=$(s).parents("table").parent();(i.hasClass("w2ui-grid-records")||i.hasClass("w2ui-grid-frecords")||i.hasClass("w2ui-grid-columns")||i.hasClass("w2ui-grid-fcolumns")||i.hasClass("w2ui-grid-summary"))&&(e=c.last.move.focusX-$(c.box).find("#grid_"+c.name+"_records").scrollLeft(),t=c.last.move.focusY-$(c.box).find("#grid_"+c.name+"_records").scrollTop()),($(s).hasClass("w2ui-grid-footer")||0<$(s).parents("div.w2ui-grid-footer").length)&&(t=$(c.box).find("#grid_"+c.name+"_footer").position().top),i.hasClass("w2ui-scroll-wrapper")&&i.parent().hasClass("w2ui-toolbar")&&(e=c.last.move.focusX-i.scrollLeft()),l.css({left:e-10,top:t})}setTimeout(()=>{-1!=["INPUT","TEXTAREA","SELECT"].indexOf(s.tagName.toUpperCase())?$(s).focus():l.is(":focus")||l.focus()},50),c.multiSelect||c.reorderRows||"drag"!=c.last.move.type||delete c.last.move}if(1==c.reorderRows){let e=n.target;if("TD"!=e.tagName.toUpperCase()&&(e=$(e).parents("td")[0]),$(e).hasClass("w2ui-col-number")||$(e).hasClass("w2ui-col-order")){c.selectNone(),c.last.move.reorder=!0;var s=$(c.box).find(".w2ui-even.w2ui-empty-record").css("background-color"),l=$(c.box).find(".w2ui-odd.w2ui-empty-record").css("background-color");$(c.box).find(".w2ui-even td").not(".w2ui-col-number").css("background-color",s),$(c.box).find(".w2ui-odd td").not(".w2ui-col-number").css("background-color",l);let t=c.last.move,i=$(c.box).find(".w2ui-grid-records");if(!t.ghost){let e=$(c.box).find("#grid_"+c.name+"_rec_"+t.recid);l=e.parents("table").find("tr:first-child").clone();t.offsetY=n.offsetY,t.from=t.recid,t.pos=e.position(),t.ghost=$(e).clone(!0),t.ghost.removeAttr("id"),e.find("td").remove(),e.append('<td colspan="1000"><div style="height: '+c.recordHeight+'px; background-color: #eee; border-bottom: 1px dashed #aaa; border-top: 1px dashed #aaa;"></div></td>'),i.append('<div id="grid_'+c.name+'_ghost_line" style="position: absolute; z-index: 999999; pointer-events: none; width: 100%;"></div>'),i.append('<table id="grid_'+c.name+'_ghost" style="position: absolute; z-index: 999998; opacity: 0.9; pointer-events: none;"></table>'),$(c.box).find("#grid_"+c.name+"_ghost").append(l).append(t.ghost)}let e=$(c.box).find("#grid_"+c.name+"_ghost");e.css({top:t.pos.top,left:t.pos.left,"border-top":"1px solid #aaa","border-bottom":"1px solid #aaa"})}else c.last.move.reorder=!1}$(document).on("mousemove.w2ui-"+c.name,a).on("mouseup.w2ui-"+c.name,r),n.stopPropagation()}}),this.updateToolbar(),this.trigger($.extend(e,{phase:"after"})),0===$(this.box).closest(".w2ui-layout").length&&$(window).off("resize.w2ui-"+c.name).on("resize.w2ui-"+c.name,function(e){null==w2ui[c.name]?$(window).off("resize.w2ui-"+c.name):w2ui[c.name].resize()}),(new Date).getTime()-i;function a(r){if(r.target.tagName){let a=c.last.move;if(a&&-1!=["select","select-column"].indexOf(a.type)&&(a.divX=r.screenX-a.x,a.divY=r.screenY-a.y,!(Math.abs(a.divX)<=1&&Math.abs(a.divY)<=1)))if(c.last.cancelClick=!0,1==c.reorderRows&&c.last.move.reorder){let e=$(r.target).parents("tr"),i=e.attr("recid");if("-none-"==i&&(i="bottom"),i!=a.from){let e=$(c.box).find("#grid_"+c.name+"_rec_"+i);$(c.box).find(".insert-before"),e.addClass("insert-before"),a.lastY=r.screenY,a.to=i;var s=e.position();let t=$(c.box).find("#grid_"+c.name+"_ghost_line");s?t.css({top:s.top,left:a.pos.left,"border-top":"2px solid #769EFC"}):t.css({"border-top":"2px solid transparent"})}let t=$(c.box).find("#grid_"+c.name+"_ghost");t.css({top:a.pos.top+a.divY,left:a.pos.left})}else{a.start&&a.recid&&(c.selectNone(),a.start=!1);let n=[];var t=("TR"==r.target.tagName.toUpperCase()?$(r.target):$(r.target).parents("tr")).attr("recid");if(null==t){if("row"!=c.selectType&&(!c.last.move||"select"!=c.last.move.type)){s=parseInt($(r.target).parents("td").attr("col"));if(isNaN(s))c.removeRange("column-selection"),$(c.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected"),$(c.box).find(".w2ui-col-number").removeClass("w2ui-row-selected"),delete a.colRange;else{let e=s+"-"+s;a.column<s&&(e=a.column+"-"+s),a.column>s&&(e=s+"-"+a.column);let t=[];var i=e.split("-");for(let e=parseInt(i[0]);e<=parseInt(i[1]);e++)t.push(e);if(a.colRange!=e&&(u=c.trigger({phase:"before",type:"columnSelect",target:c.name,columns:t,isCancelled:!1}),!0!==u.isCancelled)){null==a.colRange&&c.selectNone();var l=e.split("-");$(c.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected");for(let e=parseInt(l[0]);e<=parseInt(l[1]);e++)$(c.box).find("#grid_"+c.name+"_column_"+e+" .w2ui-col-header").addClass("w2ui-col-selected");$(c.box).find(".w2ui-col-number").not(".w2ui-head").addClass("w2ui-row-selected"),a.colRange=e,c.removeRange("column-selection"),c.addRange({name:"column-selection",range:[{recid:c.records[0].recid,column:l[0]},{recid:c.records[c.records.length-1].recid,column:l[1]}],style:"background-color: rgba(90, 145, 234, 0.1)"})}}}}else{let l=c.get(a.recid,!0);if(!(null==l||c.records[l]&&c.records[l].recid!=a.recid)){let e=c.get(t,!0);if(null!=e){let i=parseInt(a.column),s=parseInt(("TD"==r.target.tagName.toUpperCase()?$(r.target):$(r.target).parents("td")).attr("col"));isNaN(i)&&isNaN(s)&&(i=0,s=c.columns.length-1),l>e&&(d=l,l=e,e=d);var o,d="ind1:"+l+",ind2;"+e+",col1:"+i+",col2:"+s;if(a.range!=d){a.range=d;for(let t=l;t<=e;t++)if(!(0<c.last.searchIds.length&&-1==c.last.searchIds.indexOf(t)))if("row"!=c.selectType){i>s&&(o=i,i=s,s=o);for(let e=i;e<=s;e++)c.columns[e].hidden||n.push({recid:c.records[t].recid,column:parseInt(e)})}else n.push(c.records[t].recid);if("row"!=c.selectType){var h=c.getSelection();let e=[];for(let i=0;i<n.length;i++){let t=!1;for(let e=0;e<h.length;e++)n[i].recid==h[e].recid&&n[i].column==h[e].column&&(t=!0);t||e.push({recid:n[i].recid,column:n[i].column})}c.select(e),e=[];for(let i=0;i<h.length;i++){let t=!1;for(let e=0;e<n.length;e++)n[e].recid==h[i].recid&&n[e].column==h[i].column&&(t=!0);t||e.push({recid:h[i].recid,column:h[i].column})}c.unselect(e)}else if(c.multiSelect){let t=c.getSelection();for(let e=0;e<n.length;e++)-1==t.indexOf(n[e])&&c.select(n[e]);for(let e=0;e<t.length;e++)-1==n.indexOf(t[e])&&c.unselect(t[e])}}}}}}}}function r(t){let s=c.last.move;if(setTimeout(()=>{delete c.last.cancelClick},1),!$(t.target).parents().hasClass(".w2ui-head")&&!$(t.target).hasClass(".w2ui-head")){if(s&&-1!=["select","select-column"].indexOf(s.type)){if(null!=s.colRange&&!0!==u.isCancelled){var l=s.colRange.split("-");let i=[];for(let e=0;e<c.records.length;e++){let t=[];for(let e=parseInt(l[0]);e<=parseInt(l[1]);e++)t.push(e);i.push({recid:c.records[e].recid,column:t})}c.removeRange("column-selection"),c.trigger($.extend(u,{phase:"after"})),c.select(i)}if(1==c.reorderRows&&c.last.move.reorder)if(null!=s.to){var i=c.trigger({phase:"before",target:c.name,type:"reorderRow",recid:s.from,moveBefore:s.to});if(!0===i.isCancelled)return o(),void delete c.last.move;var n=c.get(s.from,!0);let e=c.get(s.to,!0);"bottom"==s.to&&(e=c.records.length);t=c.records[n];null!=n&&null!=e&&(c.records.splice(n,1),n>e?c.records.splice(e,0,t):c.records.splice(e-1,0,t)),o(),c.trigger($.extend(i,{phase:"after"}))}else o()}delete c.last.move,$(document).off(".w2ui-"+c.name)}}function o(){$(c.box).find("#grid_"+c.name+"_ghost").remove(),$(c.box).find("#grid_"+c.name+"_ghost_line").remove(),c.refresh(),delete c.last.move}}}}destroy(){var e=this.trigger({phase:"before",target:this.name,type:"destroy"});!0!==e.isCancelled&&($(this.box).off(),"object"==typeof this.toolbar&&this.toolbar.destroy&&this.toolbar.destroy(),0<$(this.box).find("#grid_"+this.name+"_body").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-grid w2ui-inactive").html(""),delete w2ui[this.name],this.trigger($.extend(e,{phase:"after"})))}initColumnOnOff(){if(this.show.toolbarColumns){let i='<div class="w2ui-grid-col-onoff"><table><tbody><tr id="grid_'+this.name+'_column_ln_check" onclick="w2ui[\''+this.name+'\'].columnOnOff(event, \'line-numbers\'); event.stopPropagation();">   <td style="width: 30px; text-align: center; padding-right: 3px; color: #888;">      <span class="w2ui-column-check w2ui-icon-'+(this.show.lineNumbers?"check":"empty")+'"></span>   </td>   <td>      <label>'+w2utils.lang("Line #")+"</label>   </td></tr>";for(let t=0;t<this.columns.length;t++){var s=this.columns[t];let e=this.columns[t].text;!1!==s.hideable&&(!e&&this.columns[t].tooltip&&(e=this.columns[t].tooltip),e=e||"- column "+(parseInt(t)+1)+" -",i+='<tr id="grid_'+this.name+"_column_"+t+'_check"        onclick="w2ui[\''+this.name+"'].columnOnOff(event, '"+s.field+'\'); event.stopPropagation();">   <td style="width: 30px; text-align: center; padding-right: 3px; color: #888;">      <span class="w2ui-column-check w2ui-icon-'+(s.hidden?"empty":"check")+'"></span>   </td>   <td>       <label>'+w2utils.stripTags(e)+"</label>   </td></tr>")}var e="object"!=typeof this.url?this.url:this.url.get;(e&&this.show.skipRecords||this.show.saveRestoreState)&&(i+='<tr style="pointer-events: none"><td colspan="2"><div style="border-top: 1px solid #ddd;"></div></td></tr>'),e&&this.show.skipRecords&&(i+='<tr><td colspan="2" style="padding: 0px">    <div style="cursor: pointer; padding: 2px 8px; cursor: default">'+w2utils.lang("Skip")+'        <input type="text" style="width: 60px" value="'+this.offset+'"             onkeydown="if ([48,49,50,51,52,53,54,55,56,57,58,13,8,46,37,39].indexOf(event.keyCode) == -1) { event.preventDefault() }"            onkeypress="if (event.keyCode == 13) {                w2ui[\''+this.name+"'].skip(this.value);                jQuery('.w2ui-overlay')[0].hide();             }\"/> "+w2utils.lang("records")+"    </div></td></tr>"),this.show.saveRestoreState&&(i+='<tr><td colspan="2" onclick="let grid = w2ui[\''+this.name+"']; grid.toolbar.uncheck('w2ui-column-on-off'); grid.stateSave();\">    <div style=\"cursor: pointer; padding: 4px 8px; cursor: default\">"+w2utils.lang("Save Grid State")+'</div></td></tr><tr><td colspan="2" onclick="let grid = w2ui[\''+this.name+"']; grid.toolbar.uncheck('w2ui-column-on-off'); grid.stateReset();\">    <div style=\"cursor: pointer; padding: 4px 8px; cursor: default\">"+w2utils.lang("Restore Default State")+"</div></td></tr>"),i+="</tbody></table></div>",this.toolbar.get("w2ui-column-on-off").html=i}}initColumnDrag(e){if(this.columnGroups&&this.columnGroups.length)throw"Draggable columns are not currently supported with column groups.";let o=this,d={};function t(){d.pressed=!1,clearTimeout(d.timeout)}function i(a){d.timeout&&clearTimeout(d.timeout);let r=this;d.pressed=!0,d.timeout=setTimeout(()=>{if(d.pressed&&0!==d.numberPreColumnsPresent){let e,i,t,s,l,n=["w2ui-col-number","w2ui-col-expand","w2ui-col-select"].concat(["w2ui-head-last"]);if($(a.originalEvent.target).parents().hasClass("w2ui-head")){for(let e=0,t=n.length;e<t;e++)if($(a.originalEvent.target).parents().hasClass(n[e]))return;if(d.numberPreColumnsPresent=$(o.box).find(".w2ui-head.w2ui-col-number, .w2ui-head.w2ui-col-expand, .w2ui-head.w2ui-col-select").length,d.columnHead=s=$(a.originalEvent.target).parents(".w2ui-head"),d.originalPos=l=parseInt(s.attr("col"),10),!0===(e=o.trigger({type:"columnDragStart",phase:"before",originalEvent:a,origColumnNumber:l,target:s[0]})).isCancelled)return!1;i=d.columns=$(o.box).find(".w2ui-head:not(.w2ui-head-last)"),$(document).on("mouseup",u),$(document).on("mousemove",h),d.ghost=$(r).clone(!0),$(d.ghost).find('[col]:not([col="'+d.originalPos+'"]), .w2ui-toolbar, .w2ui-grid-header').remove(),$(d.ghost).find(".w2ui-col-number, .w2ui-col-expand, .w2ui-col-select").remove(),$(d.ghost).find(".w2ui-grid-body").css({top:0}),t=$(d.ghost).find('[col="'+d.originalPos+'"]'),$(document.body).append(d.ghost),$(d.ghost).css({width:0,height:0,margin:0,position:"fixed",zIndex:999999,opacity:0}).addClass(".w2ui-grid-ghost").animate({width:t.width(),height:$(o.box).find(".w2ui-grid-body").first().height(),left:a.pageX,top:a.pageY,opacity:.8},0),d.offsets=[];for(let e=0,t=i.length;e<t;e++)d.offsets.push($(i[e]).offset().left);o.trigger($.extend(e,{phase:"after"}))}}},150)}function h(e){var t,i,s;d.pressed&&(i=e.originalEvent.pageX,s=e.originalEvent.pageY,t=d.offsets,e=$(".w2ui-head:not(.w2ui-head-last)").width(),d.targetInt=Math.max(d.numberPreColumnsPresent,function(i,s,l){{if(i<=s[0])return 0;if(i>=s[s.length-1]+l)return s.length;for(let e=0,t=s.length;e<t;e++){var n=s[e],a=s[e+1]||s[e]+l,r=(a-s[e])/2+s[e];if(n<i&&i<=r)return e;if(r<i&&i<=a)return e+1}return 0}}(i,t,e)),function(e){d.marker||d.markerLeft||(d.marker=$('<div class="col-intersection-marker"><div class="top-marker"></div><div class="bottom-marker"></div></div>'),d.markerLeft=$('<div class="col-intersection-marker"><div class="top-marker"></div><div class="bottom-marker"></div></div>'));d.lastInt&&d.lastInt===e||(d.lastInt=e,d.marker.remove(),d.markerLeft.remove(),$(".w2ui-head").removeClass("w2ui-col-intersection"),e>=d.columns.length?($(d.columns[d.columns.length-1]).children("div:last").append(d.marker.addClass("right").removeClass("left")),$(d.columns[d.columns.length-1]).addClass("w2ui-col-intersection")):e<=d.numberPreColumnsPresent?($(d.columns[d.numberPreColumnsPresent]).prepend(d.marker.addClass("left").removeClass("right")).css({position:"relative"}),$(d.columns[d.numberPreColumnsPresent]).prev().addClass("w2ui-col-intersection")):($(d.columns[e]).children("div:last").prepend(d.marker.addClass("left").removeClass("right")),$(d.columns[e]).prev().children("div:last").append(d.markerLeft.addClass("right").removeClass("left")).css({position:"relative"}),$(d.columns[e-1]).addClass("w2ui-col-intersection")))}(d.targetInt),i=i,s=s,$(d.ghost).css({left:i-10,top:s-10}))}function u(e){d.pressed=!1;let t,i,s,l,n,a=$(o.box).find(".w2ui-grid-ghost");if(!0===(t=o.trigger({type:"columnDragEnd",phase:"before",originalEvent:e,target:d.columnHead[0]})).isCancelled)return!1;s=o.columns[d.originalPos],l=o.columns,n=$(d.columns[Math.min(d.lastInt,d.columns.length-1)]),(i=d.lastInt<d.columns.length?parseInt(n.attr("col")):l.length)!==d.originalPos+1&&i!==d.originalPos&&n&&n.length?($(d.ghost).animate({top:$(o.box).offset().top,left:n.offset().left,width:0,height:0,opacity:.2},300,function(){$(this).remove(),a.remove()}),l.splice(i,0,$.extend({},s)),l.splice(l.indexOf(s),1)):($(d.ghost).remove(),a.remove()),$(document).off("mouseup",u),$(document).off("mousemove",h),d.marker&&d.marker.remove(),d={},o.refresh(),o.trigger($.extend(t,{phase:"after",targetColumnNumber:i-1}))}return d.lastInt=void 0,d.pressed=!1,d.timeout=null,d.columnHead=null,$(o.box).off("mousedown.colDrag").on("mousedown.colDrag",i),$(o.box).off("mouseup.colDrag").on("mouseup.colDrag",t),{remove(){$(o.box).off("mousedown.colDrag",i),$(o.box).off("mouseup.colDrag",t),$(o.box).find(".w2ui-head").removeAttr("draggable"),o.last.columnDrag=!1}}}columnOnOff(i,s){let l=$(i.target).parents("tr").find(".w2ui-column-check");var e=this.trigger({phase:"before",target:this.name,type:"columnOnOff",field:s,originalEvent:i});if(!0!==e.isCancelled){let t=this;var i=!(i.shiftKey||i.metaKey||i.ctrlKey||$(i.target).hasClass("w2ui-column-check")),n=t.find({"w2ui.expanded":!0},!0);for(let e=0;e<n.length;e++){var a=this.records[e].w2ui;a&&!Array.isArray(a.children)&&(this.records[e].w2ui.expanded=!1)}if("line-numbers"==s)this.show.lineNumbers=!this.show.lineNumbers,this.show.lineNumbers?l.addClass("w2ui-icon-check").removeClass("w2ui-icon-empty"):l.addClass("w2ui-icon-empty").removeClass("w2ui-icon-check"),this.refreshBody(),this.resizeRecords();else{let e=this.getColumn(s);e.hidden?(l.addClass("w2ui-icon-check").removeClass("w2ui-icon-empty"),setTimeout(()=>{t.showColumn(e.field)},i?0:50)):(l.addClass("w2ui-icon-empty").removeClass("w2ui-icon-check"),setTimeout(()=>{t.hideColumn(e.field)},i?0:50))}i&&setTimeout(()=>{$().w2overlay({name:t.name+"_toolbar"})},40),this.trigger($.extend(e,{phase:"after"}))}}initToolbar(){let l=this;if(null==this.toolbar.render){let t=this.toolbar.items||[];var e;if(this.toolbar.items=[],this.toolbar=new w2toolbar($.extend(!0,{},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.show.toolbarReload&&this.toolbar.items.push($.extend(!0,{},this.buttons.reload)),this.show.toolbarColumns&&this.toolbar.items.push($.extend(!0,{},this.buttons.columns)),this.show.toolbarSearch&&(e=`
                    <div class="w2ui-grid-search-input">
                        ${this.buttons.search.html}
                        <div id="grid_${this.name}_search_name" class="w2ui-grid-search-name">
                            <span class="name-icon w2ui-icon-search"></span>
                            <span class="name-text"></span>
                            <span class="name-cross w2ui-action" data-click="searchReset">x</span>
                        </div>
                        <input type="text" id="grid_${this.name}_search_all" class="w2ui-search-all" tabindex="-1"
                            autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            placeholder="${w2utils.lang(this.last.label,!0)}" value="${this.last.search}"
                            data-focus="searchSuggest" data-blur="searchSuggest|true|true|this" data-click="stop"
                        >
                        <div class="w2ui-search-drop w2ui-action" data-click="searchOpen"
                                style="${this.multiSearch?"":"display: none"}">
                            <span class="w2ui-icon-drop"></span>
                        </div>
                    </div>`,this.toolbar.items.push({id:"w2ui-search",type:"html",html:e,onRefresh(e){e.done(()=>{let e=$(this.box).find(`#grid_${l.name}_search_all`);w2utils.bindEvents($(this.box).find(`#grid_${l.name}_search_all, .w2ui-action`),l),e.on("change",function(e){let t=this.value;var i=jQuery(this).data("selected");let s=jQuery(this).data("w2field");s&&(t=s.clean(t)),s&&"list"==s.type&&i&&void 0===i.id?l.searchReset():l.search(l.last.field,t),l.searchSuggest(!0,!0,this)}).on("keydown",function(e){40==e.keyCode&&l.searchSuggest(!0)})})}})),this.show.toolbarAdd&&Array.isArray(t)&&-1==t.map(e=>e.id).indexOf(this.buttons.add.id)&&this.toolbar.items.push($.extend(!0,{},this.buttons.add)),this.show.toolbarEdit&&Array.isArray(t)&&-1==t.map(e=>e.id).indexOf(this.buttons.edit.id)&&this.toolbar.items.push($.extend(!0,{},this.buttons.edit)),this.show.toolbarDelete&&Array.isArray(t)&&-1==t.map(e=>e.id).indexOf(this.buttons.delete.id)&&this.toolbar.items.push($.extend(!0,{},this.buttons.delete)),this.show.toolbarSave&&Array.isArray(t)&&-1==t.map(e=>e.id).indexOf(this.buttons.save.id)&&((this.show.toolbarAdd||this.show.toolbarDelete||this.show.toolbarEdit)&&this.toolbar.items.push({type:"break",id:"w2ui-break2"}),this.toolbar.items.push($.extend(!0,{},this.buttons.save))),t)for(let e=0;e<t.length;e++)this.toolbar.items.push(t[e]);this.toolbar.on("click",e=>{var i=this.trigger({phase:"before",type:"toolbar",target:e.target,originalEvent:e});if(!0!==i.isCancelled){var s=e.target;let t;switch(s){case"w2ui-reload":if(t=this.trigger({phase:"before",type:"reload",target:this.name}),!0===t.isCancelled)return!1;this.reload(),this.trigger($.extend(t,{phase:"after"}));break;case"w2ui-column-on-off":this.initColumnOnOff(),this.initResize(),this.resize();break;case"w2ui-search-advanced":this.toolbar.get(s).checked?this.searchClose():this.searchOpen(),this.toolbar.tooltipHide("w2ui-search-advanced"),e.preventDefault();break;case"w2ui-add":if(t=this.trigger({phase:"before",target:this.name,type:"add",recid:null}),!0===t.isCancelled)return!1;this.trigger($.extend(t,{phase:"after"})),setTimeout(()=>{$().w2tag()},20);break;case"w2ui-edit":{var l=this.getSelection();let e=null;if(1==l.length&&(e=l[0]),t=this.trigger({phase:"before",target:this.name,type:"edit",recid:e}),!0===t.isCancelled)return!1;this.trigger($.extend(t,{phase:"after"})),setTimeout(()=>{$().w2tag()},20);break}case"w2ui-delete":this.delete();break;case"w2ui-save":this.save()}this.trigger($.extend(i,{phase:"after"}))}}),this.toolbar.on("refresh",e=>{if("w2ui-search"==e.target){let e=this.searchData;setTimeout(()=>{this.searchInitInput(this.last.field,1==e.length?e[0].value:null)},1)}})}}initResize(){let n=this;$(this.box).find(".w2ui-resizer").off(".grid-col-resize").on("click.grid-col-resize",function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault()}).on("mousedown.grid-col-resize",function(e){e=e||window.event,n.last.colResizing=!0,n.last.tmp={x:e.screenX,y:e.screenY,gx:e.screenX,gy:e.screenY,col:parseInt($(this).attr("name"))},n.last.tmp.tds=$(n.box).find("#grid_"+n.name+"_body table tr:first-child td[col="+n.last.tmp.col+"]"),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault();for(let e=0;e<n.columns.length;e++)n.columns[e].hidden||(null==n.columns[e].sizeOriginal&&(n.columns[e].sizeOriginal=n.columns[e].size),n.columns[e].size=n.columns[e].sizeCalculated);let i={phase:"before",type:"columnResize",target:n.name,column:n.last.tmp.col,field:n.columns[n.last.tmp.col].field};i=n.trigger($.extend(i,{resizeBy:0,originalEvent:e}));let s;$(document).off(".grid-col-resize").on("mousemove.grid-col-resize",function(e){var t;1==n.last.colResizing&&(e=e||window.event,i=n.trigger($.extend(i,{resizeBy:e.screenX-n.last.tmp.gx,originalEvent:e})),!0!==i.isCancelled?(n.last.tmp.x=e.screenX-n.last.tmp.x,n.last.tmp.y=e.screenY-n.last.tmp.y,t=parseInt(n.columns[n.last.tmp.col].size)+n.last.tmp.x+"px",n.columns[n.last.tmp.col].size=t,s&&clearTimeout(s),s=setTimeout(()=>{n.resizeRecords(),n.scroll()},100),n.last.tmp.tds.css({width:t}),n.last.tmp.x=e.screenX,n.last.tmp.y=e.screenY):i.isCancelled=!1)}).on("mouseup.grid-col-resize",function(e){$(document).off(".grid-col-resize"),n.resizeRecords(),n.scroll(),n.trigger($.extend(i,{phase:"after",originalEvent:e})),setTimeout(()=>{n.last.colResizing=!1},1)})}).on("dblclick.grid-col-resize",function(e){let t=parseInt($(this).attr("name")),i=n.columns[t],s=0;if(!1===i.autoResize)return!0;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault(),$(n.box).find('.w2ui-grid-records td[col="'+t+'"] > div',n.box).each(()=>{var e=this.offsetWidth-this.scrollWidth;e<s&&(s=e-3)});let l={phase:"before",type:"columnAutoResize",target:n.name,column:i,field:i.field};l=n.trigger($.extend(l,{resizeBy:Math.abs(s),originalEvent:e})),!0!==l.isCancelled?(s<0&&(i.size=Math.min(parseInt(i.size)+Math.abs(s),i.max||1/0)+"px",n.resizeRecords(),n.resizeRecords(),n.scroll()),n.trigger($.extend(l,{phase:"after",originalEvent:e}))):l.isCancelled=!1}).each((e,t)=>{let i=$(t).parent();$(t).css({height:i.height(),"margin-left":i.width()-3+"px"})})}resizeBoxes(){let e=$(this.box).find("#grid_"+this.name+"_header"),t=$(this.box).find("#grid_"+this.name+"_toolbar"),i=$(this.box).find("#grid_"+this.name+"_fsummary"),s=$(this.box).find("#grid_"+this.name+"_summary"),l=$(this.box).find("#grid_"+this.name+"_footer"),n=$(this.box).find("#grid_"+this.name+"_body");this.show.header&&e.css({top:"0px",left:"0px",right:"0px"}),this.show.toolbar&&t.css({top:0+(this.show.header?w2utils.getSize(e,"height"):0)+"px",left:"0px",right:"0px"}),0<this.summary.length&&(i.css({bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+"px"}),s.css({bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+"px",right:"0px"})),this.show.footer&&l.css({bottom:"0px",left:"0px",right:"0px"}),n.css({top:0+(this.show.header?w2utils.getSize(e,"height"):0)+(this.show.toolbar?w2utils.getSize(t,"height"):0)+"px",bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+(0<this.summary.length?w2utils.getSize(s,"height"):0)+"px",left:"0px",right:"0px"})}resizeRecords(){let s=this;$(this.box).find(".w2ui-empty-record").remove();let e=$(this.box),t=$(this.box).find("> div.w2ui-grid-box");var i=$(this.box).find("#grid_"+this.name+"_header"),l=$(this.box).find("#grid_"+this.name+"_toolbar");let n=$(this.box).find("#grid_"+this.name+"_summary"),a=$(this.box).find("#grid_"+this.name+"_fsummary");var r,o,d=$(this.box).find("#grid_"+this.name+"_footer");let h=$(this.box).find("#grid_"+this.name+"_body"),u=$(this.box).find("#grid_"+this.name+"_columns"),c=$(this.box).find("#grid_"+this.name+"_fcolumns"),p=$(this.box).find("#grid_"+this.name+"_records"),f=$(this.box).find("#grid_"+this.name+"_frecords"),g=$(this.box).find("#grid_"+this.name+"_scroll1"),m=8*String(this.total).length+10;m<34&&(m=34),null!=this.lineNumberWidth&&(m=this.lineNumberWidth);let w=!1,b=!1,y=0;for(let e=0;e<this.columns.length;e++)this.columns[e].frozen||this.columns[e].hidden||(r=parseInt(this.columns[e].sizeCalculated||this.columns[e].size),y+=r);p.width()<y&&(w=!0),h.height()-u.height()<$(p).find(">table").height()+(w?w2utils.scrollBarSize():0)&&(b=!0),this.fixedBody?(o=t.height()-(this.show.header?w2utils.getSize(i,"height"):0)-(this.show.toolbar?w2utils.getSize(l,"height"):0)-("none"!=n.css("display")?w2utils.getSize(n,"height"):0)-(this.show.footer?w2utils.getSize(d,"height"):0),h.css("height",o)):(v=w2utils.getSize(u,"height")+w2utils.getSize($(this.box).find("#grid_"+this.name+"_records table"),"height")+(w?w2utils.scrollBarSize():0),this.height=v+w2utils.getSize(t,"+height")+(this.show.header?w2utils.getSize(i,"height"):0)+(this.show.toolbar?w2utils.getSize(l,"height"):0)+("none"!=n.css("display")?w2utils.getSize(n,"height"):0)+(this.show.footer?w2utils.getSize(d,"height"):0),t.css("height",this.height),h.css("height",v),e.css("height",w2utils.getSize(t,"height")+w2utils.getSize(e,"+height")));let x=this.records.length;var v="object"!=typeof this.url?this.url:this.url.get;if(0==this.searchData.length||v||(x=this.last.searchIds.length),this.fixedBody||(b=!1),w||b?(u.find("> table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",w2utils.scrollBarSize()).show(),p.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+w2utils.getSize(u,"height")+"px","-webkit-overflow-scrolling":"touch","overflow-x":w?"auto":"hidden","overflow-y":b?"auto":"hidden"})):(u.find("> table > tbody > tr:nth-child(1) td.w2ui-head-last").hide(),p.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+w2utils.getSize(u,"height")+"px",overflow:"hidden"}),0<p.length&&(this.last.scrollTop=0,this.last.scrollLeft=0)),w?(f.css("margin-bottom",w2utils.scrollBarSize()),g.show()):(f.css("margin-bottom",0),g.hide()),f.css({overflow:"hidden",top:p.css("top")}),this.show.emptyRecords&&!b){let t=Math.floor(p.height()/this.recordHeight)-1,e=0;if(p[0]&&(e=p[0].scrollHeight-t*this.recordHeight),e>=this.recordHeight&&(e-=this.recordHeight,t++),this.fixedBody){for(let e=x;e<t;e++)_(e,this.recordHeight,this);_(t,e,this)}}function _(e,t,i){let s="",l="";var n;s+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',l+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',i.show.lineNumbers&&(s+='<td class="w2ui-col-number"></td>'),i.show.selectColumn&&(s+='<td class="w2ui-grid-data w2ui-col-select"></td>'),i.show.expandColumn&&(s+='<td class="w2ui-grid-data w2ui-col-expand"></td>'),l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',i.show.orderColumn&&(l+='<td class="w2ui-grid-data w2ui-col-order" col="order"></td>');for(let e=0;e<i.columns.length;e++){var a=i.columns[e];(a.hidden||e<i.last.colStart||e>i.last.colEnd)&&!a.frozen||(n='<td class="w2ui-grid-data" '+(null!=a.attr?a.attr:"")+' col="'+e+'"></td>',a.frozen?s+=n:l+=n)}s+='<td class="w2ui-grid-data-last"></td> </tr>',l+='<td class="w2ui-grid-data-last" col="end"></td> </tr>',$(i.box).find("#grid_"+i.name+"_frecords > table").append(s),$(i.box).find("#grid_"+i.name+"_records > table").append(l)}let k,C;if(0<h.length){let i=parseInt(h.width())-(b?w2utils.scrollBarSize():0)-(this.show.lineNumbers?m:0)-(this.show.selectColumn?26:0)-(this.show.expandColumn?26:0)-1;k=i;let s=!1;for(let t=C=0;t<this.columns.length;t++){let e=this.columns[t];0<e.gridMinWidth&&(e.gridMinWidth>k&&!0!==e.hidden&&(e.hidden=!0,s=!0),e.gridMinWidth<k&&!0===e.hidden&&(e.hidden=!1,s=!0))}if(!0===s)return void this.refresh();for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||("px"==String(e.size).substr(String(e.size).length-2).toLowerCase()?(i-=parseFloat(e.size),this.columns[t].sizeCalculated=e.size,this.columns[t].sizeType="px"):(C+=parseFloat(e.size),this.columns[t].sizeType="%",delete e.sizeCorrected))}if(100!=C&&0<C)for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||"%"==e.sizeType&&(e.sizeCorrected=Math.round(100*parseFloat(e.size)*100/C)/100+"%")}for(let e=0;e<this.columns.length;e++){var T=this.columns[e];T.hidden||"%"==T.sizeType&&(null!=this.columns[e].sizeCorrected?this.columns[e].sizeCalculated=Math.floor(i*parseFloat(T.sizeCorrected)/100)-1+"px":this.columns[e].sizeCalculated=Math.floor(i*parseFloat(T.size)/100)-1+"px")}}let S=0;for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||(null==e.min&&(e.min=20),parseInt(e.sizeCalculated)<parseInt(e.min)&&(e.sizeCalculated=e.min+"px"),parseInt(e.sizeCalculated)>parseInt(e.max)&&(e.sizeCalculated=e.max+"px"),S+=parseInt(e.sizeCalculated))}let O=parseInt(k)-parseInt(S);if(0<O&&0<C){let t=0;for(;;){let e=this.columns[t];if(null!=e)if(e.hidden||"px"==e.sizeType)t++;else{if(e.sizeCalculated=parseInt(e.sizeCalculated)+1+"px",O--,0===O)break;t++}else t=0}}else 0<O&&u.find("> table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",w2utils.scrollBarSize()).show();let D=1;this.show.lineNumbers&&(D+=m),this.show.selectColumn&&(D+=26),this.show.expandColumn&&(D+=26);for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||this.columns[e].frozen&&(D+=parseInt(this.columns[e].sizeCalculated));c.css("width",D),f.css("width",D),a.css("width",D),g.css("width",D),u.css("left",D),p.css("left",D),n.css("left",D),u.find("> table > tbody > tr:nth-child(1) td").add(c.find("> table > tbody > tr:nth-child(1) td")).each((e,i)=>{$(i).hasClass("w2ui-col-number")&&$(i).css("width",m);var t=$(i).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<s.last.colStart;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}s.columns[t]&&$(i).css("width",s.columns[t].sizeCalculated)}if($(i).hasClass("w2ui-head-last"))if(s.last.colEnd+1<s.columns.length){let t=0;for(let e=s.last.colEnd+1;e<s.columns.length;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}else $(i).css("width",w2utils.scrollBarSize()+(0<O&&0===C?O:0)+"px")}),3==u.find("> table > tbody > tr").length&&u.find("> table > tbody > tr:nth-child(1) td").add(c.find("> table > tbody > tr:nth-child(1) td")).html("").css({height:"0px",border:"0px",padding:"0px",margin:"0px"}),p.find("> table > tbody > tr:nth-child(1) td").add(f.find("> table > tbody > tr:nth-child(1) td")).each((e,i)=>{$(i).hasClass("w2ui-col-number")&&$(i).css("width",m);var t=$(i).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<s.last.colStart;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}s.columns[t]&&$(i).css("width",s.columns[t].sizeCalculated)}if($(i).hasClass("w2ui-grid-data-last")&&0===$(i).parents(".w2ui-grid-frecords").length)if(s.last.colEnd+1<s.columns.length){let t=0;for(let e=s.last.colEnd+1;e<s.columns.length;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}else $(i).css("width",(0<O&&0===C?O:0)+"px")}),n.find("> table > tbody > tr:nth-child(1) td").add(a.find("> table > tbody > tr:nth-child(1) td")).each((e,i)=>{$(i).hasClass("w2ui-col-number")&&$(i).css("width",m);var t=$(i).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<s.last.colStart;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}s.columns[t]&&$(i).css("width",s.columns[t].sizeCalculated)}$(i).hasClass("w2ui-grid-data-last")&&0===$(i).parents(".w2ui-grid-frecords").length&&$(i).css("width",w2utils.scrollBarSize()+(0<O&&0===C?O:0)+"px")}),this.initResize(),this.refreshRanges(),(this.last.scrollTop||this.last.scrollLeft)&&0<p.length&&(u.prop("scrollLeft",this.last.scrollLeft),p.prop("scrollTop",this.last.scrollTop),p.prop("scrollLeft",this.last.scrollLeft))}getSearchesHTML(){let s=`
            <div class="search-title">
                ${w2utils.lang("Advanced Search")}
                <span class="search-logic" style="${this.show.searchLogic?"":"display: none"}">
                    <select id="grid_${this.name}_logic">
                        <option value="AND" ${"AND"==this.last.logic?"selected":""}>${w2utils.lang("All")}</option>
                        <option value="OR" ${"OR"==this.last.logic?"selected":""}>${w2utils.lang("Any")}</option>
                    </select>
                </span>
            </div>
            <table cellspacing="0"><tbody>
        `;for(let i=0;i<this.searches.length;i++){let t=this.searches[i];if(t.type=String(t.type).toLowerCase(),!t.hidden){null==t.inTag&&(t.inTag=""),null==t.outTag&&(t.outTag=""),null==t.style&&(t.style=""),null==t.type&&(t.type="text"),null==t.label&&null!=t.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",t),t.label=t.caption);var l=`<select id="grid_${this.name}_operator_${i}" class="w2ui-input" data-change="initOperator|${i}">
                    ${this.getOperators(t.type,t.operators)}
                </select>`;s+=`<tr>
                        <td class="caption">${w2utils.lang(t.label)||""}</td>
                        <td class="operator">${l}</td>
                        <td class="value">`;let e;switch(t.type){case"text":case"alphanumeric":case"hex":case"color":case"list":case"combo":case"enum":e="width: 250px;",-1!=["hex","color"].indexOf(t.type)&&(e="width: 90px;"),s+=`<input rel="search" type="text" id="grid_${this.name}_field_${i}" name="${t.field}"
                               class="w2ui-input" style="${e+t.style}" ${t.inTag}>`;break;case"int":case"float":case"money":case"currency":case"percent":case"date":case"time":case"datetime":e="width: 90px;","datetime"==t.type&&(e="width: 140px;"),s+=`<input id="grid_${this.name}_field_${i}" name="${t.field}" ${t.inTag} rel="search" type="text"
                                class="w2ui-input" style="${e+t.style}">
                            <span id="grid_${this.name}_range_${i}" style="display: none">&#160;-&#160;&#160;
                                <input rel="search" type="text" class="w2ui-input" style="${e+t.style}" id="grid_${this.name}_field2_${i}" name="${t.field}" ${t.inTag}>
                            </span>`;break;case"select":s+=`<select rel="search" class="w2ui-input" style="${t.style}" id="grid_${this.name}_field_${i}"
                                name="${t.field}" ${t.inTag}></select>`}s+=t.outTag+"    </td></tr>"}}return s+=`<tr>
            <td colspan="2" class="actions">
                <button type="button" class="w2ui-btn close-btn" data-click="searchClose">${w2utils.lang("Close")}</button>
            </td>
            <td class="actions">
                <button type="button" class="w2ui-btn" data-click="searchReset">${w2utils.lang("Reset")}</button>
                <button type="button" class="w2ui-btn w2ui-btn-blue" data-click="search">${w2utils.lang("Search")}</button>
            </td>
        </tr></tbody></table>`,s}getOperators(e,t){let i=this.operators[this.operatorsMap[e]]||[];null!=t&&Array.isArray(t)&&(i=t);let s="";return i.forEach(e=>{let t=e;Array.isArray(e)?(t=e[1],e=e[0],null==t&&(t=e)):$.isPlainObject(e)&&(t=e.text,e=e.oper),s+=`<option value="${e}">${w2utils.lang(t)}</option>\n`}),s}initOperator(e){let i;var t=this.searches[e],s=this.getSearchData(t.field);let l=$(this.box).find(`#grid_${this.name}_range_${e}`),n=$(this.box).find(`#grid_${this.name}_field_${e}`),a=$(this.box).find(`#grid_${this.name}_field2_${e}`),r=$(this.box).find(`#grid_${this.name}_operator_${e}`);var o,d=r.val();switch(n.show(),l.hide(),d){case"between":l.show(),a.w2field(t.type,t.options);break;case"null":case"not null":n.hide(),n.val(d),n.trigger("change")}switch(t.type){case"text":case"alphanumeric":"in"==d||"not in"==d?(o=n.data("w2field"))&&"clear"!=o.type||(n.w2field("enum",t.options),s&&Array.isArray(s.value)&&n.data("selected",s.value)):(o=n.data("selected"),n.w2field("clear"),n.removeData("w2field"),Array.isArray(o)&&0<o.length&&o[0].text&&n.val(o[0].text));break;case"int":case"float":case"hex":case"color":case"money":case"currency":case"percent":case"date":case"time":case"datetime":n.w2field(t.type,t.options),a.w2field(t.type,t.options),setTimeout(()=>{n.keydown(),a.keydown()},1);break;case"list":case"combo":case"enum":i=t.options,"list"==t.type&&(i.selected={}),"enum"==t.type&&(i.selected=[]),s&&(i.selected=s.value),n.w2field(t.type,$.extend({openOnFocus:!0},i)),s&&null!=s.text&&n.data("selected",{id:s.value,text:s.text});break;case"select":i='<option value="">--</option>';for(let e=0;e<t.options.items.length;e++){var h=t.options.items[e];if($.isPlainObject(t.options.items[e])){let e=h.id,t=h.text;null==e&&null!=h.value&&(e=h.value),null==t&&null!=h.text&&(t=h.text),null==e&&(e=""),i+='<option value="'+e+'">'+t+"</option>"}else i+='<option value="'+h+'">'+h+"</option>"}n.html(i)}}initSearches(){let t=this;for(let n=0;n<this.searches.length;n++){let e=this.searches[n];var a=this.getSearchData(e.field);e.type=String(e.type).toLowerCase(),"object"!=typeof e.options&&(e.options={});let t=e.operator,i=this.operators[this.operatorsMap[e.type]]||[];e.operators&&(i=e.operators),$.isPlainObject(t)&&(t=t.oper),i.forEach((e,t)=>{$.isPlainObject(e)&&(i[t]=e.oper)}),a&&a.operator&&(t=a.operator);var r=this.defaultOperator[this.operatorsMap[e.type]];-1==i.indexOf(t)&&(t=r),$(this.box).find(`#grid_${this.name}_operator_${n}`).val(t),this.initOperator(n);let s=$(this.box).find(`#grid_${this.name}_field_${n}`),l=$(this.box).find(`#grid_${this.name}_field2_${n}`);null!=a&&("int"==a.type&&-1!=["in","not in"].indexOf(a.operator)&&s.w2field("clear").val(a.value),Array.isArray(a.value)?-1!=["in","not in"].indexOf(a.operator)?s.val(a.value).trigger("change"):(s.val(a.value[0]).trigger("change"),l.val(a.value[1]).trigger("change")):null!=a.value&&s.val(a.value).trigger("change"))}$(this.box).find(`#w2ui-overlay-${this.name}-searchOverlay .w2ui-grid-search-advanced *[rel=search]`).on("keypress",function(e){13==e.keyCode&&(t.search(),$().w2overlay({name:t.name+"-searchOverlay"}))})}getColumnsHTML(){let d=this,e="",t="";var i,s,l;return this.show.columnHeaders&&(t=0<this.columnGroups.length?(i=n(!0),s=function(){let l="<tr>",n="<tr>",a="",e=d.columnGroups.length-1;null==d.columnGroups[e].text&&null!=d.columnGroups[e].caption&&(console.log("NOTICE: grid columnGroup.caption property is deprecated, please use columnGroup.text. Group -> ",d.columnGroups[e]),d.columnGroups[e].text=d.columnGroups[e].caption);""!=d.columnGroups[d.columnGroups.length-1].text&&d.columnGroups.push({text:""});d.show.lineNumbers&&(l+='<td class="w2ui-head w2ui-col-number">    <div>&#160;</div></td>');d.show.selectColumn&&(l+='<td class="w2ui-head w2ui-col-select">    <div style="height: 25px">&#160;</div></td>');d.show.expandColumn&&(l+='<td class="w2ui-head w2ui-col-expand">    <div style="height: 25px">&#160;</div></td>');let r=0;n+='<td id="grid_'+d.name+'_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>',d.show.orderColumn&&(n+='<td class="w2ui-head w2ui-col-order" col="order">    <div style="height: 25px">&#160;</div></td>');for(let e=0;e<d.columnGroups.length;e++){let t=d.columnGroups[e],i=d.columns[r]||{};null!=t.colspan&&(t.span=t.colspan),null!=t.span&&t.span==parseInt(t.span)||(t.span=1),null==i.text&&null!=i.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column ->",i),i.text=i.caption);let s=0;for(let e=r;e<r+t.span;e++)d.columns[e]&&!d.columns[e].hidden&&s++;if(e==d.columnGroups.length-1&&(s=100),!(s<=0))if(!0===t.main){let t="";for(let e=0;e<d.sortData.length;e++)d.sortData[e].field==i.field&&("asc"===(d.sortData[e].direction||"").toLowerCase()&&(t="w2ui-sort-up"),"desc"===(d.sortData[e].direction||"").toLowerCase()&&(t="w2ui-sort-down"));let e="";!1!==i.resizable&&(e='<div class="w2ui-resizer" name="'+r+'"></div>');var o=w2utils.lang("function"==typeof i.text?i.text(i):i.text);a='<td id="grid_'+d.name+"_column_"+r+'" class="w2ui-head '+t+'" col="'+r+'"     rowspan="2" colspan="'+s+'"     oncontextmenu = "w2ui[\''+d.name+"'].contextMenu(null, "+r+', event);"    onclick="w2ui[\''+d.name+"'].columnClick('"+i.field+"', event);\"    ondblclick=\"w2ui['"+d.name+"'].columnDblClick('"+i.field+"', event);\">"+e+'    <div class="w2ui-col-group w2ui-col-header '+(t?"w2ui-col-sorted":"")+'">        <div class="'+t+'"></div>'+(o||"&#160;")+"    </div></td>",i&&i.frozen?l+=a:n+=a}else{o=w2utils.lang("function"==typeof t.text?t.text(t):t.text);a='<td id="grid_'+d.name+"_column_"+r+'" class="w2ui-head" col="'+r+'"         colspan="'+s+'">    <div class="w2ui-col-group">'+(o||"&#160;")+"    </div></td>",i&&i.frozen?l+=a:n+=a}r+=t.span}return l+="<td></td></tr>",n+='<td id="grid_'+d.name+'_column_end" class="w2ui-head" col="end"></td></tr>',[l,n]}(),l=n(!1),e=i[0]+s[0]+l[0],i[1]+s[1]+l[1]):(l=n(!0),e=l[0],l[1])),[e,t];function n(i){let s="<tr>",l="<tr>";d.show.lineNumbers&&(s+='<td class="w2ui-head w2ui-col-number"        onclick="w2ui[\''+d.name+"'].columnClick('line-number', event);\"       ondblclick=\"w2ui['"+d.name+"'].columnDblClick('line-number', event);\">    <div>#</div></td>"),d.show.selectColumn&&(s+='<td class="w2ui-head w2ui-col-select"       onclick="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;">    <div>        <input type="checkbox" id="grid_'+d.name+'_check_all" tabindex="-1"            style="'+(0==d.multiSelect?"display: none;":"")+'"            onmousedown="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;"            onclick="let grid = w2ui[\''+d.name+"'];               if (this.checked) grid.selectAll(); else grid.selectNone();               if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;               clearTimeout(grid.last.kbd_timer); /* keep focus */            \"/>    </div></td>"),d.show.expandColumn&&(s+='<td class="w2ui-head w2ui-col-expand">    <div>&#160;</div></td>');let n=0,a=0,r;l+='<td id="grid_'+d.name+'_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>',d.show.orderColumn&&(l+='<td class="w2ui-head w2ui-col-order" col="order">    <div>&#160;</div></td>');for(let t=0;t<d.columns.length;t++){let e=d.columns[t];var o;null==e.text&&null!=e.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column -> ",e),e.text=e.caption),null==e.size&&(e.size="100%"),t==a&&(r=d.columnGroups[n++]||{},a+=r.span),(t<d.last.colStart||t>d.last.colEnd)&&!e.frozen||e.hidden||!0===r.main&&!i||(o=d.getColumnCellHTML(t),e&&e.frozen?s+=o:l+=o)}return s+='<td class="w2ui-head w2ui-head-last"><div>&#160;</div></td>',l+='<td class="w2ui-head w2ui-head-last" col="end"><div>&#160;</div></td>',s+="</tr>",l+="</tr>",[s,l]}}getColumnCellHTML(t){let i=this.columns[t];if(null==i)return"";var e=!this.reorderColumns||this.columnGroups&&this.columnGroups.length?"":" w2ui-reorder-cols-head ";let s="";for(let e=0;e<this.sortData.length;e++)this.sortData[e].field==i.field&&("asc"===(this.sortData[e].direction||"").toLowerCase()&&(s="w2ui-sort-up"),"desc"===(this.sortData[e].direction||"").toLowerCase()&&(s="w2ui-sort-down"));var l,n=this.last.selection.columns;let a=!1;for(l in n)for(let e=0;e<n[l].length;e++)n[l][e]==t&&(a=!0);var r=w2utils.lang("function"==typeof i.text?i.text(i):i.text),o=w2utils.lang("function"==typeof i.tooltip?i.tooltip(i):i.tooltip);return'<td id="grid_'+this.name+"_column_"+t+'" col="'+t+'" class="w2ui-head '+s+e+'" '+("normal"==this.columnTooltip&&o?'title="'+o+'" ':"")+"    onmouseEnter = \"w2ui['"+this.name+"'].columnTooltipShow('"+t+"', event);\"    onmouseLeave  = \"w2ui['"+this.name+"'].columnTooltipHide('"+t+"', event);\"    oncontextmenu = \"w2ui['"+this.name+"'].contextMenu(null, "+t+', event);"    onclick="w2ui[\''+this.name+"'].columnClick('"+i.field+"', event);\"    ondblclick=\"w2ui['"+this.name+"'].columnDblClick('"+i.field+"', event);\">"+(!1!==i.resizable?'<div class="w2ui-resizer" name="'+t+'"></div>':"")+'    <div class="w2ui-col-header '+(s?"w2ui-col-sorted":"")+" "+(a?"w2ui-col-selected":"")+'">        <div class="'+s+'"></div>'+(r||"&#160;")+"    </div></td>"}columnTooltipShow(s,e){if("normal"!=this.columnTooltip){let e=$(this.box).find("#grid_"+this.name+"_column_"+s),t=this.columns[s],i=this.columnTooltip;e.prop("_mouse_over",!0),setTimeout(()=>{!0===e.prop("_mouse_over")&&!0!==e.prop("_mouse_tooltip")&&(e.prop("_mouse_tooltip",!0),e.w2tag(t.tooltip,{position:i,top:5}))},1)}}columnTooltipHide(t,e){if("normal"!=this.columnTooltip){let e=$(this.box).find("#grid_"+this.name+"_column_"+t);e.removeProp("_mouse_over"),setTimeout(()=>{!0!==e.prop("_mouse_over")&&!0===e.prop("_mouse_tooltip")&&(e.removeProp("_mouse_tooltip"),e.w2tag())},1)}}getRecordsHTML(){let e=this.records.length;var t="object"!=typeof this.url?this.url:this.url.get;0==this.searchData.length||t||(e=this.last.searchIds.length),e>this.vs_start?this.last.show_extra=this.vs_extra:this.last.show_extra=this.vs_start;let i=$(this.box).find("#grid_"+this.name+"_records"),s=Math.floor((i.height()||0)/this.recordHeight)+this.last.show_extra+1;(!this.fixedBody||s>e)&&(s=e);var l=this.getRecordHTML(-1,0);let n="<table><tbody>"+l[0],a="<table><tbody>"+l[1];n+='<tr id="grid_'+this.name+'_frec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>',a+='<tr id="grid_'+this.name+'_rec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>';for(let e=0;e<s;e++)l=this.getRecordHTML(e,e+1),n+=l[0],a+=l[1];t=(e-s)*this.recordHeight;return n+='<tr id="grid_'+this.name+'_frec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border-right: 1px solid #D6D5D7;"></td></tr><tr id="grid_'+this.name+'_frec_more" style="display: none; ">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',a+='<tr id="grid_'+this.name+'_rec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_rec_more" style="display: none">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',this.last.range_start=0,this.last.range_end=s,[n,a]}getSummaryHTML(){if(0!==this.summary.length){var s=this.getRecordHTML(-1,0);let t="<table><tbody>"+s[0],i="<table><tbody>"+s[1];for(let e=0;e<this.summary.length;e++)s=this.getRecordHTML(e,e+1,!0),t+=s[0],i+=s[1];return t+="</tbody></table>",i+="</tbody></table>",[t,i]}}scroll(e){let c=this;var p="object"!=typeof this.url?this.url:this.url.get;let f=$(this.box).find("#grid_"+this.name+"_records"),g=$(this.box).find("#grid_"+this.name+"_frecords");e&&(a=e.target.scrollTop,n=e.target.scrollLeft,this.last.scrollTop=a,this.last.scrollLeft=n,$(this.box).find("#grid_"+this.name+"_columns")[0].scrollLeft=n,$(this.box).find("#grid_"+this.name+"_summary")[0].scrollLeft=n,g[0].scrollTop=a),this.last.bubbleEl&&($(this.last.bubbleEl).w2tag(),this.last.bubbleEl=null);let r=null,o=null;if(this.disableCVS||0<this.columnGroups.length)r=0,o=this.columns.length-1;else{var i,s=f.width();let t=0;for(let e=0;e<this.columns.length;e++)this.columns[e].frozen||this.columns[e].hidden||(i=parseInt(this.columns[e].sizeCalculated||this.columns[e].size),t+i+30>this.last.scrollLeft&&null==r&&(r=e),t+i-30>this.last.scrollLeft+s&&null==o&&(o=e),t+=i);null==o&&(o=this.columns.length-1)}if(null!=r&&(r<0&&(r=0),o<0&&(o=0),r==o&&(0<r?r--:o++),r!=this.last.colStart||o!=this.last.colEnd)){let l=$(this.box);var n=Math.abs(r-this.last.colStart),a=Math.abs(o-this.last.colEnd);if(n<5&&a<5){let e=l.find(".w2ui-grid-columns #grid_"+this.name+"_column_start"),t=l.find(".w2ui-grid-columns .w2ui-head-last"),i=l.find("#grid_"+this.name+"_records .w2ui-grid-data-spacer"),s=l.find("#grid_"+this.name+"_records .w2ui-grid-data-last"),n=l.find("#grid_"+this.name+"_summary .w2ui-grid-data-spacer"),a=l.find("#grid_"+this.name+"_summary .w2ui-grid-data-last");if(r>this.last.colStart)for(let e=this.last.colStart;e<r;e++)l.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),l.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),l.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(o<this.last.colEnd)for(let e=this.last.colEnd;e>o;e--)l.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),l.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),l.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(r<this.last.colStart)for(let l=this.last.colStart-1;l>=r;l--)this.columns[l]&&(this.columns[l].frozen||this.columns[l].hidden)||(e.after(this.getColumnCellHTML(l)),i.each((e,t)=>{var i=$(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+l+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),l,!1)),$(t).after(s)}),n.each((e,t)=>{var i=$(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+l+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),l,!0)),$(t).after(s)}));if(o>this.last.colEnd)for(let l=this.last.colEnd+1;l<=o;l++)this.columns[l]&&(this.columns[l].frozen||this.columns[l].hidden)||(t.before(this.getColumnCellHTML(l)),s.each((e,t)=>{var i=$(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+l+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),l,!1)),$(t).before(s)}),a.each((e,t)=>{var i=$(t).parent().attr("index")||-1,i=this.getCellHTML(parseInt(i),l,!0);$(t).before(i)}));this.last.colStart=r,this.last.colEnd=o,this.resizeRecords()}else{this.last.colStart=r,this.last.colEnd=o;var n=this.getColumnsHTML(),a=this.getRecordsHTML(),m=this.getSummaryHTML();let e=l.find("#grid_"+this.name+"_columns"),t=l.find("#grid_"+this.name+"_records"),i=l.find("#grid_"+this.name+"_frecords"),s=l.find("#grid_"+this.name+"_summary");e.find("tbody").html(n[1]),i.html(a[0]),t.prepend(a[1]),null!=m&&s.html(m[1]),setTimeout(()=>{t.find("> table").not("table:first-child").remove(),s[0]&&(s[0].scrollLeft=this.last.scrollLeft)},1),this.resizeRecords()}}let w=this.records.length;if(w>this.total&&-1!==this.total&&(w=this.total),0==this.searchData.length||p||(w=this.last.searchIds.length),0!==w&&0!==f.length&&0!==f.height()){w>this.vs_start?this.last.show_extra=this.vs_extra:this.last.show_extra=this.vs_start;let e=Math.round(f[0].scrollTop/this.recordHeight+1),t=e+(Math.round(f.height()/this.recordHeight)-1);if(e>w&&(e=w),t>=w-1&&(t=w),$(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right").html((this.show.statusRange?w2utils.formatNumber(this.offset+e)+"-"+w2utils.formatNumber(this.offset+t)+(-1!=this.total?" "+w2utils.lang("of")+" "+w2utils.formatNumber(this.total):""):"")+(p&&this.show.statusBuffered?" ("+w2utils.lang("buffered")+" "+w2utils.formatNumber(w)+(0<this.offset?", skip "+w2utils.formatNumber(this.offset):"")+")":"")),p||this.fixedBody&&!(-1!=this.total&&this.total<=this.vs_start)){let t=Math.floor(f[0].scrollTop/this.recordHeight)-this.last.show_extra,i=t+Math.floor(f.height()/this.recordHeight)+2*this.last.show_extra+1;t<1&&(t=1),i>this.total&&-1!=this.total&&(i=this.total);let s=f.find("#grid_"+this.name+"_rec_top"),l=f.find("#grid_"+this.name+"_rec_bottom"),n=g.find("#grid_"+this.name+"_frec_top"),a=g.find("#grid_"+this.name+"_frec_bottom");-1!=String(s.next().prop("id")).indexOf("_expanded_row")&&(s.next().remove(),n.next().remove()),this.total>i&&-1!=String(l.prev().prop("id")).indexOf("_expanded_row")&&(l.prev().remove(),a.prev().remove());m=parseInt(s.next().attr("line")),p=parseInt(l.prev().attr("line"));let e,r,o,d,h;if(m<t||1==m||this.last.pull_refresh){if(i<=p+this.last.show_extra-2&&i!=this.total)return;for(this.last.pull_refresh=!1;;){if(r=g.find("#grid_"+this.name+"_frec_top").next(),o=f.find("#grid_"+this.name+"_rec_top").next(),"bottom"==o.attr("line"))break;if(!(parseInt(o.attr("line"))<t))break;r.remove(),o.remove()}e=f.find("#grid_"+this.name+"_rec_bottom").prev(),d=e.attr("line"),"top"==d&&(d=t);for(let e=parseInt(d)+1;e<=i;e++)this.records[e-1]&&(o=this.records[e-1].w2ui,o&&!Array.isArray(o.children)&&(o.expanded=!1),h=this.getRecordHTML(e-1,e),l.before(h[1]),a.before(h[0]));b(),setTimeout(()=>{this.refreshRanges()},0)}else{if(t>=m-this.last.show_extra+2&&1<t)return;for(;;){if(r=g.find("#grid_"+this.name+"_frec_bottom").prev(),o=f.find("#grid_"+this.name+"_rec_bottom").prev(),"top"==o.attr("line"))break;if(!(parseInt(o.attr("line"))>i))break;r.remove(),o.remove()}e=f.find("#grid_"+this.name+"_rec_top").next(),d=e.attr("line"),"bottom"==d&&(d=i);for(let e=parseInt(d)-1;e>=t;e--)this.records[e-1]&&(o=this.records[e-1].w2ui,o&&!Array.isArray(o.children)&&(o.expanded=!1),h=this.getRecordHTML(e-1,e),s.after(h[1]),n.after(h[0]));b(),setTimeout(()=>{this.refreshRanges()},0)}m=(t-1)*this.recordHeight;let u=(w-i)*this.recordHeight;if(u<0&&(u=0),s.css("height",m+"px"),n.css("height",m+"px"),l.css("height",u+"px"),a.css("height",u+"px"),this.last.range_start=t,this.last.range_end=i,Math.floor(f[0].scrollTop/this.recordHeight)+Math.floor(f.height()/this.recordHeight)+10>w&&!0!==this.last.pull_more&&(w<this.total-this.offset||-1==this.total&&this.last.xhr_hasMore)){!0===this.autoLoad&&(this.last.pull_more=!0,this.last.xhr_offset+=this.limit,this.request("get"));let e=$(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more");e.show().eq(1).off(".load-more").on("click.load-more",function(){$(this).find("td").html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>'),c.last.pull_more=!0,c.last.xhr_offset+=c.limit,c.request("get")}).find("td").html(c.autoLoad?'<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>':'<div style="padding-top: 15px">'+w2utils.lang("Load ${count} more...",{count:c.limit})+"</div>")}function b(){c.markSearch&&(clearTimeout(c.last.marker_timer),c.last.marker_timer=setTimeout(()=>{let t=[];for(let e=0;e<c.searchData.length;e++){var i=c.searchData[e],s=c.getSearch(i.field);s&&!s.hidden&&(s=c.getColumn(i.field,!0),t.push({field:i.field,search:i.value,col:s}))}0<t.length&&t.forEach(e=>{$(c.box).find('td[col="'+e.col+'"]').not(".w2ui-head").w2marker(e.search)})},50))}}}}getRecordHTML(t,e,i){let s="",l="",n=this.last.selection,a;if(-1==t){s+='<tr line="0">',l+='<tr line="0">',this.show.lineNumbers&&(s+='<td class="w2ui-col-number" style="height: 0px;"></td>'),this.show.selectColumn&&(s+='<td class="w2ui-col-select" style="height: 0px;"></td>'),this.show.expandColumn&&(s+='<td class="w2ui-col-expand" style="height: 0px;"></td>'),l+='<td class="w2ui-grid-data w2ui-grid-data-spacer" col="start" style="height: 0px; width: 0px;"></td>',this.show.orderColumn&&(l+='<td class="w2ui-col-order" style="height: 0px;" col="order"></td>');for(let e=0;e<this.columns.length;e++){var r=this.columns[e],o='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px;"></td>';r.frozen&&!r.hidden?s+=o:r.hidden||e<this.last.colStart||e>this.last.colEnd||(l+=o)}return s+='<td class="w2ui-grid-data-last" style="height: 0px"></td>',l+='<td class="w2ui-grid-data-last" col="end" style="height: 0px"></td>',s+="</tr>",l+="</tr>",[s,l]}var d="object"!=typeof this.url?this.url:this.url.get;if(!0!==i)if(0<this.searchData.length&&!d){if(t>=this.last.searchIds.length)return"";t=this.last.searchIds[t],a=this.records[t]}else{if(t>=this.records.length)return"";a=this.records[t]}else{if(t>=this.summary.length)return"";a=this.summary[t]}if(!a)return"";null!=a.recid||null==this.recid||null!=(d=this.parseField(a,this.recid))&&(a.recid=d);let h=!1;-1!=n.indexes.indexOf(t)&&(h=!0);let u=a.w2ui?a.w2ui.style:"";null!=u&&"string"==typeof u||(u="");let c=a.w2ui?a.w2ui.class:"";if(null!=c&&"string"==typeof c||(c=""),s+='<tr id="grid_'+this.name+"_frec_"+a.recid+'" recid="'+a.recid+'" line="'+e+'" index="'+t+'"  class="'+(e%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+c+(h&&"row"==this.selectType?" w2ui-selected":"")+(a.w2ui&&!1===a.w2ui.editable?" w2ui-no-edit":"")+(a.w2ui&&!0===a.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(h||""==u?u.replace("background-color","none"):u)+'" '+(""!=u?'custom_style="'+u+'"':"")+">",l+='<tr id="grid_'+this.name+"_rec_"+a.recid+'" recid="'+a.recid+'" line="'+e+'" index="'+t+'"  class="'+(e%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+c+(h&&"row"==this.selectType?" w2ui-selected":"")+(a.w2ui&&!1===a.w2ui.editable?" w2ui-no-edit":"")+(a.w2ui&&!0===a.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(h||""==u?u.replace("background-color","none"):u)+'" '+(""!=u?'custom_style="'+u+'"':"")+">",this.show.lineNumbers&&(s+='<td id="grid_'+this.name+"_cell_"+t+"_number"+(i?"_s":"")+'"    class="w2ui-col-number '+(h?" w2ui-row-selected":"")+'"'+(this.reorderRows?' style="cursor: move"':"")+">"+(!0!==i?this.getLineHTML(e,a):"")+"</td>"),this.show.selectColumn&&(s+='<td id="grid_'+this.name+"_cell_"+t+"_select"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-select">'+(!0===i||a.w2ui&&!0===a.w2ui.hideCheckBox?"":'    <div>        <input class="w2ui-grid-select-check" type="checkbox" tabindex="-1" '+(h?'checked="checked"':"")+' style="pointer-events: none"/>    </div>')+"</td>"),this.show.expandColumn){let e="";e=a.w2ui&&!0===a.w2ui.expanded?"-":"+",!a.w2ui||"none"!=a.w2ui.expanded&&Array.isArray(a.w2ui.children)&&a.w2ui.children.length||(e=""),a.w2ui&&"spinner"==a.w2ui.expanded&&(e='<div class="w2ui-spinner" style="width: 16px; margin: -2px 2px;"></div>'),s+='<td id="grid_'+this.name+"_cell_"+t+"_expand"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-expand">'+(!0!==i?'    <div ondblclick="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;"             onclick="w2ui[\''+this.name+"'].toggle(jQuery(this).parents('tr').attr('recid'));                 if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;\">        "+e+" </div>":"")+"</td>"}l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',this.show.orderColumn&&(l+='<td id="grid_'+this.name+"_cell_"+t+"_order"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-order" col="order">'+(!0!==i?'<div title="Drag to reorder">&nbsp;</div>':"")+"</td>");let p=0,f=0;for(;;){let e=1;var g=this.columns[p];if(null==g)break;if(g.hidden)p++,0<f&&f--;else if(0<f){if(p++,null==this.columns[p])break;a.w2ui.colspan[this.columns[p-1].field]=0,f--}else{if(a.w2ui){let e=a.w2ui.colspan;var m=this.columns[p].field;e&&0===e[m]&&delete e[m]}if(!(p<this.last.colStart||p>this.last.colEnd)||g.frozen){if(a.w2ui&&"object"==typeof a.w2ui.colspan){var w=parseInt(a.w2ui.colspan[g.field])||null;if(1<w){let t=0;for(let e=p;e<p+w&&!(e>=this.columns.length);e++)this.columns[e].hidden&&t++;e=w-t,f=w-1}}m=this.getCellHTML(t,p,i,e);g.frozen?s+=m:l+=m,p++}else p++}}return s+='<td class="w2ui-grid-data-last"></td>',l+='<td class="w2ui-grid-data-last" col="end"></td>',s+="</tr>",l+="</tr>",[s,l]}getLineHTML(e){return"<div>"+e+"</div>"}getCellHTML(i,s,e,t){let l=this,n=this.columns[s];if(null==n)return"";let a=(!0!==e?this.records:this.summary)[i],{value:r,style:o,className:d,attr:h,divAttr:u}=this.getCellValue(i,s,e,!0);var c=-1!==i?this.getCellEditable(i,s):"";let p="max-height: "+parseInt(this.recordHeight)+"px;"+(n.clipboardCopy?"margin-right: 20px":"");var f=!e&&a&&a.w2ui&&a.w2ui.changes&&null!=a.w2ui.changes[n.field];let g=this.last.selection,m=!1,w="";if(-1!=g.indexes.indexOf(i)&&(m=!0),null==t&&(t=a&&a.w2ui&&a.w2ui.colspan&&a.w2ui.colspan[n.field]?a.w2ui.colspan[n.field]:1),0===s&&a&&a.w2ui&&Array.isArray(a.w2ui.children)){let t=0,e=this.get(a.w2ui.parent_recid,!0);for(;;){if(null==e)break;t++;var b=this.records[e].w2ui;if(null==b||null==b.parent_recid)break;e=this.get(b.parent_recid,!0)}if(a.w2ui.parent_recid)for(let e=0;e<t;e++)w+='<span class="w2ui-show-children w2ui-icon-empty"></span>';w+='<span class="w2ui-show-children '+(0<a.w2ui.children.length?a.w2ui.expanded?"w2ui-icon-collapse":"w2ui-icon-expand":"w2ui-icon-empty")+'"  onclick="event.stopPropagation(); w2ui[\''+this.name+"'].toggle(jQuery(this).parents('tr').attr('recid'))\"></span>"}if(!0===n.info&&(n.info={}),null!=n.info){let e="w2ui-icon-info";"function"==typeof n.info.icon?e=n.info.icon(a):"object"==typeof n.info.icon?e=n.info.icon[this.parseField(a,n.field)]||"":"string"==typeof n.info.icon&&(e=n.info.icon);let t=n.info.style||"";"function"==typeof n.info.style?t=n.info.style(a):"object"==typeof n.info.style?t=n.info.style[this.parseField(a,n.field)]||"":"string"==typeof n.info.style&&(t=n.info.style),w+='<span class="w2ui-info '+e+'" style="'+t+'" '+(null!=n.info.showOn?"on"+n.info.showOn:"onclick")+"=\"event.stopPropagation(); w2ui['"+this.name+"'].showBubble("+i+", "+s+')"'+(null!=n.info.hideOn?"on"+n.info.hideOn:"")+"=\"let grid = w2ui['"+this.name+"']; if (grid.last.bubbleEl) { $(grid.last.bubbleEl).w2tag() } grid.last.bubbleEl = null;\"></span>"}let y=r;c&&-1!=["checkbox","check"].indexOf(c.type)&&(p+="text-align: center;",y='<input tabindex="-1" type="checkbox" '+(y?'checked="checked"':"")+" onclick=\"    let obj = w2ui['"+this.name+"'];     obj.editChange.call(obj, this, "+(e?-(i+1):i)+", "+s+', event); "/>',w=""),y=`<div style="${p}" ${function(e){let t;l.show.recordTitles&&(null!=n.title?("function"==typeof n.title&&(t=n.title.call(l,a,i,s)),"string"==typeof n.title&&(t=n.title)):t=w2utils.stripTags(String(e).replace(/"/g,"''")));return null!=t?'title="'+String(t)+'"':""}(y)} ${u}>${w}${String(y)}</div>`,null==y&&(y=""),"string"==typeof n.render&&(c=n.render.toLowerCase().split(":"),-1!=["number","int","float","money","currency","percent","size"].indexOf(c[0])&&(o+="text-align: right;")),a&&a.w2ui&&("object"==typeof a.w2ui.style&&("string"==typeof a.w2ui.style[s]&&(o+=a.w2ui.style[s]+";"),"string"==typeof a.w2ui.style[n.field]&&(o+=a.w2ui.style[n.field]+";")),"object"==typeof a.w2ui.class&&("string"==typeof a.w2ui.class[s]&&(d+=a.w2ui.class[s]+" "),"string"==typeof a.w2ui.class[n.field]&&(d+=a.w2ui.class[n.field]+" ")));let x=!1;m&&-1!=$.inArray(s,g.columns[i])&&(x=!0);let v,_;return n.clipboardCopy&&(v="string"==typeof n.clipboardCopy?n.clipboardCopy:w2utils.lang("Copy to clipboard"),_="<span onmouseEnter=\"jQuery(this).w2tag('"+v+"', { position: 'top|bottom' })\"onclick=\"w2ui['"+this.name+"'].clipboardCopy("+i+", "+s+'); jQuery(this).w2tag(w2utils.lang(\'Copied\'), { position: \'top|bottom\' }); event.stopPropagation();" onmouseLeave="jQuery(this).w2tag()" class="w2ui-clipboard-copy w2ui-icon-paste"></span>'),y='<td class="w2ui-grid-data'+(x?" w2ui-selected":"")+" "+d+(f?" w2ui-changed":"")+'"    id="grid_'+this.name+"_data_"+i+"_"+s+'" col="'+s+'"    style="'+o+(null!=n.style?n.style:"")+'" '+(null!=n.attr?n.attr:"")+h+(1<t?'colspan="'+t+'"':"")+">"+y+(_&&w2utils.stripTags(y)?_:"")+"</td>",-1===i&&!0===e&&(y='<td class="w2ui-grid-data" col="'+s+'" style="height: 0px; '+o+'" '+(1<t?'colspan="'+t+'"':"")+"></td>"),y}clipboardCopy(e,t){e=this.records[e];let i=this.columns[t],s=i?this.parseField(e,i.field):"";"function"==typeof i.clipboardCopy&&(s=i.clipboardCopy(e)),$(this.box).find("#grid_"+this.name+"_focus").text(s).select(),document.execCommand("copy")}showBubble(l,n){let a=this.columns[n].info;if(a){let s="";var r=this.records[l],e=$(this.box).find("#grid_"+this.name+"_data_"+l+"_"+n+" .w2ui-info");if(this.last.bubbleEl&&$(this.last.bubbleEl).w2tag(),this.last.bubbleEl=e,null==a.fields){a.fields=[];for(let e=0;e<this.columns.length;e++){var i=this.columns[e];a.fields.push(i.field+("string"==typeof i.render?":"+i.render:""))}}let t=a.fields;if("function"==typeof t&&(t=t(r,l,n)),"function"==typeof a.render)s=a.render(r,l,n);else if(Array.isArray(t)){s='<table cellpadding="0" cellspacing="0">';for(let e=0;e<t.length;e++){var o=String(t[e]).split(":");if(""!=o[0]&&"-"!=o[0]&&"--"!=o[0]&&"---"!=o[0]){let e=this.getColumn(o[0]);null==e&&(e={field:o[0],caption:o[0]});let t=e?this.parseField(r,e.field):"";1<o.length&&(w2utils.formatters[o[1]]?t=w2utils.formatters[o[1]](t,o[2]||null,r):console.log('ERROR: w2utils.formatters["'+o[1]+'"] does not exists.')),(!0===a.showEmpty||null!=t&&""!=t)&&(null!=a.maxLength&&"string"==typeof t&&t.length>a.maxLength&&(t=t.substr(0,a.maxLength)+"..."),s+="<tr><td>"+e.text+"</td><td>"+((0===t?"0":t)||"")+"</td></tr>")}else s+='<tr><td colspan=2><div style="border-top: '+(""==o[0]?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>'}s+="</table>"}else if($.isPlainObject(t)){for(var d in s='<table cellpadding="0" cellspacing="0">',t){let i=t[d];if(""!=i&&"-"!=i&&"--"!=i&&"---"!=i){var h=String(i).split(":");let e=this.getColumn(h[0]);null==e&&(e={field:h[0],caption:h[0]});let t=e?this.parseField(r,e.field):"";1<h.length&&(w2utils.formatters[h[1]]?t=w2utils.formatters[h[1]](t,h[2]||null,r):console.log('ERROR: w2utils.formatters["'+h[1]+'"] does not exists.')),"function"==typeof i&&(t=i(r,l,n)),(!0===a.showEmpty||null!=t&&""!=t)&&(null!=a.maxLength&&"string"==typeof t&&t.length>a.maxLength&&(t=t.substr(0,a.maxLength)+"..."),s+="<tr><td>"+d+"</td><td>"+((0===t?"0":t)||"")+"</td></tr>")}else s+='<tr><td colspan=2><div style="border-top: '+(""==i?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>'}s+="</table>"}$(e).w2tag($.extend({html:s,left:-4,position:"bottom|top",className:"w2ui-info-bubble",style:"",hideOnClick:!0},a.options||{}))}}getCellEditable(e,t){var i=this.columns[t],s=this.records[e];if(!s||!i)return null;let l=s.w2ui?s.w2ui.editable:null;return!1===l?null:(null!=l&&!0!==l||(l=i&&0<Object.keys(i.editable).length?i.editable:null,"function"==typeof l&&(i=this.getCellValue(e,t,!1),l=l.call(this,s,e,t,i))),l)}getCellValue(t,i,s,e){let l=this.columns[i];s=(!0!==s?this.records:this.summary)[t];let n=this.parseField(s,l.field),a="",r="",o="",d="";if(null!=l.render&&-1!==t){if("function"==typeof l.render&&null!=s){let e;try{e=l.render(s,{self:this,value:n,index:t,colIndex:i})}catch(e){throw new Error(`Render function for column "${l.field}" in grid "${this.name}": -- `+e.message)}null!=e&&"object"==typeof e&&"function"!=typeof e?(null!=e.id&&null!=e.text?n=e.text:"string"==typeof e.html?n=(e.html||"").trim():(n="",console.log("ERROR: render function should return a primitive or an object of the following structure.",{html:"",attr:"",style:"",class:"",divAttr:""})),o=e.attr??"",r=e.style??"",a=e.class??"",d=e.divAttr??""):n=String(e||"").trim()}if("object"!=typeof l.render||null!=(h=l.render[n])&&""!==h&&(n=h),"string"==typeof l.render){var h=l.render.toLowerCase().indexOf(":");let e=[];-1==h?(e[0]=l.render.toLowerCase(),e[1]=""):(e[0]=l.render.toLowerCase().substr(0,h),e[1]=l.render.toLowerCase().substr(h+1));let t=w2utils.formatters[e[0]];l.options&&!1===l.options.autoFormat&&(t=null),n="function"==typeof t?t(n,e[1],s):""}}return s&&s.w2ui&&s.w2ui.changes&&null!=s.w2ui.changes[l.field]&&(n=s.w2ui.changes[l.field],n instanceof Object&&0<Object.keys(l.editable).length&&(l.options&&l.options.items?(s=l.options.items.find(e=>e.id==n.id),n=s?s.text:n.id):(null!=n.id&&null==n.text&&(n=n.id),null!=n.text&&(n=n.text)))),null==n&&(n=""),e?{value:n,attr:o,style:r,className:a,divAttr:d}:n}getFooterHTML(){return'<div>    <div class="w2ui-footer-left"></div>    <div class="w2ui-footer-right"></div>    <div class="w2ui-footer-center"></div></div>'}status(i){if(null!=i)$(this.box).find("#grid_"+this.name+"_footer").find(".w2ui-footer-left").html(i);else{let t="";i=this.getSelection();if(0<i.length&&(this.show.statusSelection&&1<i.length&&(t=String(i.length).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+w2utils.settings.groupSymbol)+" "+w2utils.lang("selected")),this.show.statusRecordID&&1==i.length)){let e=i[0];"object"==typeof e&&(e=e.recid+", "+w2utils.lang("Column")+": "+e.column),t=w2utils.lang("Record ID")+": "+e+" "}$(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-left").html(t),1==i.length?this.toolbar.enable("w2ui-edit"):this.toolbar.disable("w2ui-edit"),1<=i.length?this.toolbar.enable("w2ui-delete"):this.toolbar.disable("w2ui-delete")}}lock(e,t){let i=Array.prototype.slice.call(arguments,0);i.unshift(this.box),setTimeout(()=>{$(this.box).find("#grid_"+this.name+"_empty_msg").remove(),w2utils.lock.apply(window,i)},10)}unlock(e){setTimeout(()=>{0<$(this.box).find(".w2ui-message").not(".w2ui-closing").length||w2utils.unlock(this.box,e)},25)}stateSave(e){if(!w2utils.hasLocalStorage)return null;let t={columns:[],show:$.extend({},this.show),last:{search:this.last.search,multi:this.last.multi,logic:this.last.logic,label:this.last.label,field:this.last.field,scrollTop:this.last.scrollTop,scrollLeft:this.last.scrollLeft},sortData:[],searchData:[]},l;for(let e=0;e<this.columns.length;e++){let i=this.columns[e],s={};Object.keys(this.stateColProps).forEach((e,t)=>{this.stateColProps[e]&&(l=void 0!==i[e]?i[e]:this.colDefaults[e]||null,s[e]=l)}),t.columns.push(s)}for(let e=0;e<this.sortData.length;e++)t.sortData.push($.extend({},this.sortData[e]));for(let e=0;e<this.searchData.length;e++)t.searchData.push($.extend({},this.searchData[e]));var i=this.trigger({phase:"before",type:"stateSave",target:this.name,state:t});if(!0!==i.isCancelled){if(!0!==e&&this.useLocalStorage)try{let e=JSON.parse(localStorage.w2ui||"{}");e=e||{},e.states||(e.states={}),e.states[this.stateId||this.name]=t,localStorage.w2ui=JSON.stringify(e)}catch(e){return delete localStorage.w2ui,null}return this.trigger($.extend(i,{phase:"after"})),t}}stateRestore(i){let s="object"!=typeof this.url?this.url:this.url.get;if(!i){if(!w2utils.hasLocalStorage&&this.useLocalStorage)return!1;try{let e=JSON.parse(localStorage.w2ui||"{}");e=e||{},e.states||(e.states={}),i=e.states[this.stateId||this.name]}catch(e){return delete localStorage.w2ui,null}}var e=this.trigger({phase:"before",type:"stateRestore",target:this.name,state:i});if(!0!==e.isCancelled){if($.isPlainObject(i)){$.extend(this.show,i.show),$.extend(this.last,i.last);let e=this.last.scrollTop,t=this.last.scrollLeft;for(let e=0;e<i.columns.length;e++){var l=i.columns[e],n=this.getColumn(l.field,!0);null!==n&&($.extend(this.columns[n],l),e!==n&&this.columns.splice(e,0,this.columns.splice(n,1)[0]))}this.sortData.splice(0,this.sortData.length);for(let e=0;e<i.sortData.length;e++)this.sortData.push(i.sortData[e]);this.searchData.splice(0,this.searchData.length);for(let e=0;e<i.searchData.length;e++)this.searchData.push(i.searchData[e]);setTimeout(()=>{s||(0<this.sortData.length&&this.localSort(),0<this.searchData.length&&this.localSearch()),this.last.scrollTop=e,this.last.scrollLeft=t,this.refresh()},1)}return this.trigger($.extend(e,{phase:"after"})),!0}}stateReset(){if(this.stateRestore(this.last.state),w2utils.hasLocalStorage&&this.useLocalStorage)try{let e=JSON.parse(localStorage.w2ui||"{}");e.states&&e.states[this.stateId||this.name]&&delete e.states[this.stateId||this.name],localStorage.w2ui=JSON.stringify(e)}catch(e){return delete localStorage.w2ui,null}}parseField(e,i){if(this.nestedFields){let t="";try{t=e;var s=String(i).split(".");for(let e=0;e<s.length;e++)t=t[s[e]]}catch(e){t=""}return t}return e?e[i]:""}prepareData(){let t=this;for(let e=0;e<this.records.length;e++)!function i(s){for(let e=0;e<t.columns.length;e++){let i=t.columns[e];if(null!=s[i.field]&&"string"==typeof i.render){if(-1!=["number","int","float","money","currency","percent"].indexOf(i.render.split(":")[0])&&"number"!=typeof s[i.field]&&(s[i.field]=parseFloat(s[i.field])),-1!=["date","age"].indexOf(i.render.split(":")[0])&&!s[i.field+"_"]){let e=s[i.field];w2utils.isInt(e)&&(e=parseInt(e)),s[i.field+"_"]=new Date(e)}if(-1!=["time"].indexOf(i.render))if(w2utils.isTime(s[i.field])){let e=w2utils.isTime(s[i.field],!0),t=new Date;t.setHours(e.hours,e.minutes,e.seconds||0,0),s[i.field+"_"]||(s[i.field+"_"]=t)}else{let e=s[i.field];w2utils.isInt(e)&&(e=parseInt(e)),e=null!=e?new Date(e):new Date;let t=new Date;t.setHours(e.getHours(),e.getMinutes(),e.getSeconds(),0),s[i.field+"_"]||(s[i.field+"_"]=t)}}}if(s.w2ui&&s.w2ui.children&&!0!==s.w2ui.expanded)for(let t=0;t<s.w2ui.children.length;t++){let e=s.w2ui.children[t];i(e)}}(this.records[e])}nextCell(e,t,i){var s=t+1;if(s>=this.columns.length)return null==(e=this.nextRow(e))?e:this.nextCell(e,-1,i);var l=this.records[e].w2ui,t=this.columns[s],l=l&&l.colspan&&!isNaN(l.colspan[t.field])?parseInt(l.colspan[t.field]):1;if(null==t)return null;if(t&&t.hidden||0===l)return this.nextCell(e,s,i);if(i){l=this.getCellEditable(e,s);if(null==l||-1!=["checkbox","check"].indexOf(l.type))return this.nextCell(e,s,i)}return{index:e,colIndex:s}}prevCell(e,t,i){var s=t-1;if(s<0)return null==(e=this.prevRow(e))?e:this.prevCell(e,this.columns.length,i);if(s<0)return null;var l=this.records[e].w2ui,t=this.columns[s],l=l&&l.colspan&&!isNaN(l.colspan[t.field])?parseInt(l.colspan[t.field]):1;if(null==t)return null;if(t&&t.hidden||0===l)return this.prevCell(e,s,i);if(i){l=this.getCellEditable(e,s);if(null==l||-1!=["checkbox","check"].indexOf(l.type))return this.prevCell(e,s,i)}return{index:e,colIndex:s}}nextRow(e,t,i){var s=this.last.searchIds;let l=null;if(-1==(i=null==i?1:i))return this.records.length-1;if(e+i<this.records.length&&0===s.length||0<s.length&&e<s[s.length-i]){if(e+=i,0<s.length)for(;;){if(-1!=$.inArray(e,s)||e>this.records.length)break;e+=i}var n=this.records[e].w2ui,a=this.columns[t],a=n&&n.colspan&&null!=a&&!isNaN(n.colspan[a.field])?parseInt(n.colspan[a.field]):1;l=0===a?this.nextRow(e,t,i):e}return l}prevRow(e,t,i){var s=this.last.searchIds;let l=null;if(-1==(i=null==i?1:i))return 0;if(0<=e-i&&0===s.length||0<s.length&&e>s[0]){if(e-=i,0<s.length)for(;;){if(-1!=$.inArray(e,s)||e<0)break;e-=i}var n=this.records[e].w2ui,a=this.columns[t],a=n&&n.colspan&&null!=a&&!isNaN(n.colspan[a.field])?parseInt(n.colspan[a.field]):1;l=0===a?this.prevRow(e,t,i):e}return l}selectionSave(){return this.last._selection=this.getSelection(),this.last._selection}selectionRestore(e){var t=(new Date).getTime();this.last.selection={indexes:[],columns:{}};let i=this.last.selection;var s,l=this.last._selection;if(l)for(let e=0;e<l.length;e++)$.isPlainObject(l[e])?null!=(s=this.get(l[e].recid,!0))&&(-1==i.indexes.indexOf(s)&&i.indexes.push(s),i.columns[s]||(i.columns[s]=[]),i.columns[s].push(l[e].column)):null!=(s=this.get(l[e],!0))&&i.indexes.push(s);return delete this.last._selection,!0!==e&&this.refresh(),(new Date).getTime()-t}message(t){let i=this;(t="string"==typeof t?{width:t.length<300?350:550,height:t.length<300?170:250,body:`<div class="w2ui-centered">${t}</div>`,onOpen(e){setTimeout(()=>{w2utils.bindEvents($(i.box).find(".w2ui-btn"),i),$(e.box).find(".w2ui-btn").off(".message").on("keydown.message",function(e){27==e.keyCode&&$(e.target).click()}).focus()},25)},onClose(e){"function"==typeof t.callBack&&t.callBack(e)}}:t)&&null==t.buttons&&(t.buttons=`<button type="button" class="w2ui-btn" data-click="message">
                ${w2utils.lang("Ok")}
            </button>`),w2utils.message.call(this,{box:this.box,path:"w2ui."+this.name,title:".w2ui-grid-header:visible",body:".w2ui-grid-box"},t).then(e=>{"function"==typeof t.then&&t.then(e)});let s={ok(e){return t.callBack=e,s},then(e){return t.then=e,s}};return s}confirm(s){let l=this;"string"==typeof s&&(s={width:s.length<300?350:550,height:s.length<300?170:250,body:'<div class="w2ui-centered">'+s+"</div>"});let n=e=>{"function"==typeof s.no_click&&s.no_click(e),"function"==typeof s.callBack&&s.callBack(Object.assign(e,{answer:"no"})),l.message()};var e=`<button type="button" class="w2ui-btn btn-yes ${s.yes_class||""}">${w2utils.lang(s.yes_text||"Yes")}</button>`,t=`<button type="button" class="w2ui-btn btn-no ${s.no_class||""}">${w2utils.lang(s.no_text||"No")}</button>`;Object.assign(s,{buttons:w2utils.settings.macButtonOrder?t+e:e+t,onOpen(i){setTimeout(()=>{let t=$(this.box).find(".w2ui-btn");t.off(".message").on("blur.message",function(e){t.index(e.target)+1===t.length&&(t.get(0).focus(),e.preventDefault())}).on("keydown.message",function(e){27==e.keyCode&&n(i)}).focus(),$(this.box).find(".w2ui-btn.btn-yes").off("click").on("click",()=>{var e;e=i,"function"==typeof s.yes_click&&s.yes_click(e),"function"==typeof s.callBack&&s.callBack(Object.assign(e,{answer:"yes"})),l.message()}),$(this.box).find(".w2ui-btn.btn-no").off("click").on("click",()=>{n(i)})},25)}}),w2utils.message.call(this,{box:this.box,path:"w2ui."+this.name,title:".w2ui-grid-header:visible",body:".w2ui-grid-box"},s).then(e=>{"function"==typeof s.then&&s.then(e)});let i={yes(e){return s.yes_click=e,i},no(e){return s.no_click=e,i},answer(e){return s.callBack=e,i},then(e){return s.then=e,i}};return i}}let w2panels=["top","left","main","preview","right","bottom"];class w2layout extends w2event{constructor(e){super(e.name),this.box=null,this.name=null,this.panels=[],this.tmp={},this.padding=1,this.resizer=4,this.style="",this.onShow=null,this.onHide=null,this.onResizing=null,this.onResizerClick=null,this.onRender=null,this.onRefresh=null,this.onChange=null,this.onResize=null,this.onDestroy=null,this.panel_template={type:null,title:"",size:100,minSize:20,maxSize:!1,hidden:!1,resizable:!1,overflow:"auto",style:"",html:"",tabs:null,toolbar:null,width:null,height:null,show:{toolbar:!1,tabs:!1},removed:null,onRefresh:null,onShow:null,onHide:null},$.extend(!0,this,e),Array.isArray(this.panels)||(this.panels=[]),this.panels.forEach((e,t)=>{this.panels[t]=$.extend(!0,{},this.panel_template,e),($.isPlainObject(e.tabs)||Array.isArray(e.tabs))&&function(e,t,i){let s=e.get(t);null!=s&&null==i&&(i=s.tabs);if(null==s||null==i)return;Array.isArray(i)&&(i={tabs:i});$().w2destroy(e.name+"_"+t+"_tabs"),s.tabs=new w2tabs($.extend({},i,{owner:e,name:e.name+"_"+t+"_tabs"})),s.show.tabs=!0}(this,e.type),($.isPlainObject(e.toolbar)||Array.isArray(e.toolbar))&&function(e,t,i){let s=e.get(t);null!=s&&null==i&&(i=s.toolbar);if(null==s||null==i)return;Array.isArray(i)&&(i={items:i});$().w2destroy(e.name+"_"+t+"_toolbar"),s.toolbar=new w2toolbar($.extend({},i,{owner:e,name:e.name+"_"+t+"_toolbar"})),s.show.toolbar=!0}(this,e.type)}),w2panels.forEach(e=>{null==this.get(e)&&this.panels.push($.extend(!0,{},this.panel_template,{type:e,hidden:"main"!==e,size:50}))})}html(i,s,l){let n=this,a=this.get(i),e={panel:i,html:a.html,error:!1,cancelled:!1,removed(e){"function"==typeof e&&(a.removed=e)}};if("function"==typeof a.removed&&(a.removed({panel:i,html:a.html,html_new:s,transition:l||"none"}),a.removed=null),"css"==i)return $(this.box).find("#layout_"+n.name+"_panel_css").html("<style>"+s+"</style>"),e.status=!0,e;if(null==a)return console.log("ERROR: incorrect panel name. Panel name can be main, left, right, top, bottom, preview or css"),e.error=!0,e;if(null==s)return e;var t=this.trigger({phase:"before",type:"change",target:i,panel:a,html_new:s,transition:l});if(!0===t.isCancelled)return e.cancelled=!0,e;if(s instanceof jQuery)return console.log("ERROR: You can not pass jQuery object to w2layout.html() method"),e;let r="#layout_"+this.name+"_panel_"+a.type;var o=$(this.box).find(r+"> .w2ui-panel-content");let d=0;if(0<o.length&&($(this.box).find(r).scrollTop(0),d=$(o).position().top),""===a.html)a.html=s,this.refresh(i);else if(a.html=s,!a.hidden)if(null!=l&&""!==l){$(this.box).addClass("animating");let e=$(this.box).find(r+"> .w2ui-panel-content");e.after('<div class="w2ui-panel-content new-panel" style="'+e[0].style.cssText+'"></div>');let t=$(this.box).find(r+"> .w2ui-panel-content.new-panel");e.css("top",d),t.css("top",d),"object"==typeof s?(s.box=t[0],s.render()):t.hide().html(s),w2utils.transition(e[0],t[0],l,()=>{e.remove(),t.removeClass("new-panel"),t.css("overflow",a.overflow),$(n.box).find(r+"> .w2ui-panel-content").slice(1).remove(),n.resize(),$(n.box).removeClass("animating"),n.refresh(i)})}else this.refresh(i);return n.trigger($.extend(t,{phase:"after"})),n.resize(),e}message(e,t){let i=this;"string"==typeof t&&(t={width:t.length<300?350:550,height:t.length<300?170:250,body:'<div class="w2ui-centered">'+t+"</div>",buttons:`<button class="w2ui-btn" data-click='["message", "${e}"]'>Ok</button>`,onOpen(e){setTimeout(()=>{w2utils.bindEvents($(i.box).find(".w2ui-btn"),i),$(i.box).find(".w2ui-btn").off(".message").on("keydown.message",function(e){27==e.keyCode&&$(e.target).click()}).focus()},25)},onClose(e){"function"==typeof t.callBack&&t.callBack(e)}});let s=this.get(e),l=$(this.box).find("#layout_"+this.name+"_panel_"+s.type),n=l.css("overflow"),a;t&&(t.onClose&&(a=t.onClose),t.onClose=e=>{"function"==typeof a&&a(e),e.done(()=>{$(i.box).find("#layout_"+i.name+"_panel_"+s.type).css("overflow",n)})}),$(this.box).find("#layout_"+this.name+"_panel_"+s.type).css("overflow","hidden"),w2utils.message.call(this,{box:$(this.box).find("#layout_"+this.name+"_panel_"+s.type),param:e,path:"w2ui."+this.name,title:".w2ui-panel-title:visible",body:".w2ui-panel-content"},t).then(e=>{"function"==typeof t.then&&t.then(e)});let r={ok(e){return t.callBack=e,r},then(e){return t.then=e,r}};return r}confirm(s,l){let n=this;"string"==typeof l&&(l={width:l.length<300?350:550,height:l.length<300?170:250,body:'<div class="w2ui-centered">'+l+"</div>"});let a=e=>{"function"==typeof l.no_click&&l.no_click(e),"function"==typeof l.callBack&&l.callBack(Object.assign(e,{answer:"no"})),n.message(s)};var e=`<button type="button" class="w2ui-btn btn-yes ${l.yes_class||""}">${w2utils.lang(l.yes_text||"Yes")}</button>`,t=`<button type="button" class="w2ui-btn btn-no ${l.no_class||""}">${w2utils.lang(l.no_text||"No")}</button>`;Object.assign(l,{buttons:w2utils.settings.macButtonOrder?t+e:e+t,onOpen(i){setTimeout(()=>{let t=$(n.box).find(".w2ui-btn");t.off(".message").on("blur.message",function(e){t.index(e.target)+1===t.length&&(t.get(0).focus(),e.preventDefault())}).on("keydown.message",function(e){27==e.keyCode&&a(i)}).focus(),$(n.box).find(".w2ui-btn.btn-yes").off("click").on("click",()=>{var e;e=i,"function"==typeof l.yes_click&&l.yes_click(e),"function"==typeof l.callBack&&l.callBack(Object.assign(e,{answer:"yes"})),n.message(s)}),$(n.box).find(".w2ui-btn.btn-no").off("click").on("click",()=>{a(i)})},25)}});let i=this.get(s),r=$(this.box).find("#layout_"+this.name+"_panel_"+i.type),o=r.css("overflow"),d;l&&(l.onClose&&(d=l.onClose),l.onClose=e=>{"function"==typeof d&&d(e),e.done(()=>{$(n.box).find("#layout_"+n.name+"_panel_"+i.type).css("overflow",o)})}),$(this.box).find("#layout_"+this.name+"_panel_"+i.type).css("overflow","hidden"),w2utils.message.call(this,{box:$(this.box).find("#layout_"+this.name+"_panel_"+i.type),param:s,path:"w2ui."+this.name,title:".w2ui-panel-title:visible",body:".w2ui-panel-content"},l).then(e=>{"function"==typeof l.then&&l.then(e)});let h={yes(e){return l.yes_click=e,h},no(e){return l.no_click=e,h},answer(e){return l.callBack=e,h},then(e){return l.then=e,h}};return h}load(n,t,a){return new Promise((s,e)=>{let l=this;"css"==n&&null!=t?$.get(t,(e,t,i)=>{l.resize(),s(l.html(n,i.responseText,a))}):null!=this.get(n)&&null!=t?$.get(t,(e,t,i)=>{l.resize(),s(l.html(n,i.responseText,a))}):e()})}sizeTo(e,t,i){let s=this;return null!=s.get(e)&&($(s.box).find(" > div > .w2ui-panel").css(w2utils.cssPrefix("transition",!0!==i?".2s":"0s")),setTimeout(()=>{s.set(e,{size:t})},1),setTimeout(()=>{$(s.box).find(" > div > .w2ui-panel").css(w2utils.cssPrefix("transition","0s")),s.resize()},500),!0)}show(t,i){let s=this,l=this.trigger({phase:"before",type:"show",target:t,object:this.get(t),immediate:i});if(!0!==l.isCancelled){let e=s.get(t);return null==e?!1:(!(e.hidden=!1)===i?($(s.box).find("#layout_"+s.name+"_panel_"+t).css({opacity:"1"}),s.trigger($.extend(l,{phase:"after"})),s.resize()):($(s.box).addClass("animating"),$(s.box).find("#layout_"+s.name+"_panel_"+t).css({opacity:"0"}),$(s.box).find(" > div > .w2ui-panel").css(w2utils.cssPrefix("transition",".2s")),setTimeout(()=>{s.resize()},1),setTimeout(()=>{$(s.box).find("#layout_"+s.name+"_panel_"+t).css({opacity:"1"})},250),setTimeout(()=>{$(s.box).find(" > div > .w2ui-panel").css(w2utils.cssPrefix("transition","0s")),$(s.box).removeClass("animating"),s.trigger($.extend(l,{phase:"after"})),s.resize()},500)),!0)}}hide(t,i){let s=this,l=this.trigger({phase:"before",type:"hide",target:t,object:this.get(t),immediate:i});if(!0!==l.isCancelled){let e=s.get(t);return null==e?!1:((e.hidden=!0)===i?($(s.box).find("#layout_"+s.name+"_panel_"+t).css({opacity:"0"}),s.trigger($.extend(l,{phase:"after"})),s.resize()):($(s.box).addClass("animating"),$(s.box).find(" > div > .w2ui-panel").css(w2utils.cssPrefix("transition",".2s")),$(s.box).find("#layout_"+s.name+"_panel_"+t).css({opacity:"0"}),setTimeout(()=>{s.resize()},1),setTimeout(()=>{$(s.box).find(" > div > .w2ui-panel").css(w2utils.cssPrefix("transition","0s")),$(s.box).removeClass("animating"),s.trigger($.extend(l,{phase:"after"})),s.resize()},500)),!0)}}toggle(e,t){var i=this.get(e);return null!=i&&(i.hidden?this.show(e,t):this.hide(e,t))}set(e,t){var i=this.get(e,!0);return null!=i&&($.extend(this.panels[i],t),null==t.html&&null==t.resizable||this.refresh(e),this.resize(),!0)}get(t,i){for(let e=0;e<this.panels.length;e++)if(this.panels[e].type==t)return!0===i?e:this.panels[e];return null}el(e){e=$(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-content");return 1!=e.length?null:e[0]}hideToolbar(e){let t=this.get(e);t&&(t.show.toolbar=!1,$(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-toolbar").hide(),this.resize())}showToolbar(e){let t=this.get(e);t&&(t.show.toolbar=!0,$(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-toolbar").show(),this.resize())}toggleToolbar(e){var t=this.get(e);t&&(t.show.toolbar?this.hideToolbar(e):this.showToolbar(e))}assignToolbar(e,t){"string"==typeof t&&null!=w2ui[t]&&(t=w2ui[t]);let i=this.get(e);i.toolbar=t;let s=$(this.box).find(e+"> .w2ui-panel-toolbar");null!=i.toolbar?(0===s.find("[name="+i.toolbar.name+"]").length?s.w2render(i.toolbar):null!=i.toolbar&&i.toolbar.refresh(),(t.owner=this).showToolbar(e),this.refresh(e)):(s.html(""),this.hideToolbar(e))}hideTabs(e){let t=this.get(e);t&&(t.show.tabs=!1,$(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-tabs").hide(),this.resize())}showTabs(e){let t=this.get(e);t&&(t.show.tabs=!0,$(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-tabs").show(),this.resize())}toggleTabs(e){var t=this.get(e);t&&(t.show.tabs?this.hideTabs(e):this.showTabs(e))}render(e){let o=this;var t=(new Date).getTime(),i=o.trigger({phase:"before",type:"render",target:o.name,box:e});if(!0!==i.isCancelled){if(null!=e&&(0<$(o.box).find("#layout_"+o.name+"_panel_main").length&&$(o.box).removeAttr("name").removeClass("w2ui-layout").html(""),o.box=e),!o.box)return!1;$(o.box).attr("name",o.name).addClass("w2ui-layout").html("<div></div>"),0<$(o.box).length&&($(o.box)[0].style.cssText+=o.style);for(let e=0;e<w2panels.length;e++){var s='<div id="layout_'+o.name+"_panel_"+w2panels[e]+'" class="w2ui-panel">    <div class="w2ui-panel-title"></div>    <div class="w2ui-panel-tabs"></div>    <div class="w2ui-panel-toolbar"></div>    <div class="w2ui-panel-content"></div></div><div id="layout_'+o.name+"_resizer_"+w2panels[e]+'" class="w2ui-resizer"></div>';$(o.box).find(" > div").append(s)}return $(o.box).find(" > div").append('<div id="layout_'+o.name+'_panel_css" style="position: absolute; top: 10000px;"></div>'),o.refresh(),o.trigger($.extend(i,{phase:"after"})),setTimeout(()=>{o.tmp.events={resize(e){null==w2ui[o.name]?$(window).off("resize.w2ui-"+o.name):w2ui[o.name].resize()},resizeStart:l,mouseMove:a,mouseUp:n},$(window).on("resize.w2ui-"+o.name,o.tmp.events.resize),o.resize()},0),(new Date).getTime()-t}function l(e,t){if(o.box){t=t||window.event,$(document).off("mousemove",o.tmp.events.mouseMove).on("mousemove",o.tmp.events.mouseMove),$(document).off("mouseup",o.tmp.events.mouseUp).on("mouseup",o.tmp.events.mouseUp),o.tmp.resize={type:e,x:t.screenX,y:t.screenY,diff_x:0,diff_y:0,value:0};for(let t=0;t<w2panels.length;t++){let e=$(o.el(w2panels[t])).parent().find(".w2ui-lock");0<e.length?e.attr("locked","previous"):o.lock(w2panels[t],{opacity:0})}"left"!=e&&"right"!=e||(o.tmp.resize.value=parseInt($(o.box).find("#layout_"+o.name+"_resizer_"+e)[0].style.left)),"top"!=e&&"preview"!=e&&"bottom"!=e||(o.tmp.resize.value=parseInt($(o.box).find("#layout_"+o.name+"_resizer_"+e)[0].style.top))}}function n(l){if(o.box&&(l=l||window.event,$(document).off("mousemove",o.tmp.events.mouseMove),$(document).off("mouseup",o.tmp.events.mouseUp),null!=o.tmp.resize)){for(let t=0;t<w2panels.length;t++){let e=$(o.el(w2panels[t])).parent().find(".w2ui-lock");"previous"==e.attr("locked")?e.removeAttr("locked"):o.unlock(w2panels[t])}if(0!==o.tmp.diff_x||0!==o.tmp.resize.diff_y){var n=o.get("top"),a=o.get("bottom");let e=o.get(o.tmp.resize.type);var r=parseInt($(o.box).height()),l=parseInt($(o.box).width());let t=String(e.size),i,s;switch(o.tmp.resize.type){case"top":i=parseInt(e.sizeCalculated)+o.tmp.resize.diff_y,s=0;break;case"bottom":i=parseInt(e.sizeCalculated)-o.tmp.resize.diff_y,s=0;break;case"preview":i=parseInt(e.sizeCalculated)-o.tmp.resize.diff_y,s=(n&&!n.hidden?n.sizeCalculated:0)+(a&&!a.hidden?a.sizeCalculated:0);break;case"left":i=parseInt(e.sizeCalculated)+o.tmp.resize.diff_x,s=0;break;case"right":i=parseInt(e.sizeCalculated)-o.tmp.resize.diff_x,s=0}"%"==t.substr(t.length-1)?e.size=Math.floor(100*i/("left"==e.type||"right"==e.type?l:r-s)*100)/100+"%":"-"==String(e.size).substr(0,1)?e.size=parseInt(e.size)-e.sizeCalculated+i:e.size=i,o.resize()}$(o.box).find("#layout_"+o.name+"_resizer_"+o.tmp.resize.type).removeClass("active"),delete o.tmp.resize}}function a(l){if(o.box&&(l=l||window.event,null!=o.tmp.resize)){var n=o.get(o.tmp.resize.type);let s=o.tmp.resize;var a=o.trigger({phase:"before",type:"resizing",target:o.name,object:n,originalEvent:l,panel:s?s.type:"all",diff_x:s?s.diff_x:0,diff_y:s?s.diff_y:0});if(!0!==a.isCancelled){let e=$(o.box).find("#layout_"+o.name+"_resizer_"+s.type),t=l.screenX-s.x,i=l.screenY-s.y;var r=o.get("main");switch(e.hasClass("active")||e.addClass("active"),s.type){case"left":n.minSize-t>n.width&&(t=n.minSize-n.width),n.maxSize&&n.width+t>n.maxSize&&(t=n.maxSize-n.width),r.minSize+t>r.width&&(t=r.width-r.minSize);break;case"right":n.minSize+t>n.width&&(t=n.width-n.minSize),n.maxSize&&n.width-t>n.maxSize&&(t=n.width-n.maxSize),r.minSize-t>r.width&&(t=r.minSize-r.width);break;case"top":n.minSize-i>n.height&&(i=n.minSize-n.height),n.maxSize&&n.height+i>n.maxSize&&(i=n.maxSize-n.height),r.minSize+i>r.height&&(i=r.height-r.minSize);break;case"preview":case"bottom":n.minSize+i>n.height&&(i=n.height-n.minSize),n.maxSize&&n.height-i>n.maxSize&&(i=n.height-n.maxSize),r.minSize-i>r.height&&(i=r.minSize-r.height)}switch(s.diff_x=t,s.diff_y=i,s.type){case"top":case"preview":case"bottom":(s.diff_x=0)<e.length&&(e[0].style.top=s.value+s.diff_y+"px");break;case"left":case"right":(s.diff_y=0)<e.length&&(e[0].style.left=s.value+s.diff_x+"px")}o.trigger($.extend(a,{phase:"after"}))}}}}refresh(s){let l=this;null==s&&(s=null);var e=(new Date).getTime(),t=l.trigger({phase:"before",type:"refresh",target:null!=s?s:l.name,object:l.get(s)});if(!0!==t.isCancelled){if("string"==typeof s){let e=l.get(s);if(null==e)return;let t="#layout_"+l.name+"_panel_"+e.type;s="#layout_"+l.name+"_resizer_"+e.type;$(l.box).find(t).css({display:e.hidden?"none":"block"}),e.resizable?$(l.box).find(s).show():$(l.box).find(s).hide(),"object"==typeof e.html&&"function"==typeof e.html.render?(e.html.box=$(l.box).find(t+"> .w2ui-panel-content")[0],setTimeout(()=>{0<$(l.box).find(t+"> .w2ui-panel-content").length&&($(l.box).find(t+"> .w2ui-panel-content").removeClass().removeAttr("name").addClass("w2ui-panel-content").css("overflow",e.overflow)[0].style.cssText+=";"+e.style),e.html&&"function"==typeof e.html.render&&e.html.render()},1)):0<$(l.box).find(t+"> .w2ui-panel-content").length&&($(l.box).find(t+"> .w2ui-panel-content").removeClass().removeAttr("name").addClass("w2ui-panel-content").html(e.html).css("overflow",e.overflow)[0].style.cssText+=";"+e.style);let i=$(l.box).find(t+"> .w2ui-panel-tabs");e.show.tabs?0===i.find("[name="+e.tabs.name+"]").length&&null!=e.tabs?i.w2render(e.tabs):e.tabs.refresh():i.html("").removeClass("w2ui-tabs").hide(),i=$(l.box).find(t+"> .w2ui-panel-toolbar"),e.show.toolbar?0===i.find("[name="+e.toolbar.name+"]").length&&null!=e.toolbar?i.w2render(e.toolbar):e.toolbar.refresh():i.html("").removeClass("w2ui-toolbar").hide(),i=$(l.box).find(t+"> .w2ui-panel-title"),e.title?i.html(e.title).show():i.html("").hide()}else{if(0===$(l.box).find("#layout_"+l.name+"_panel_main").length)return void l.render();l.resize();for(let e=0;e<this.panels.length;e++)l.refresh(this.panels[e].type)}return l.trigger($.extend(t,{phase:"after"})),(new Date).getTime()-e}}resize(){if(!this.box)return!1;var c=(new Date).getTime();let p=this.tmp.resize;var f=this.trigger({phase:"before",type:"resize",target:this.name,panel:p?p.type:"all",diff_x:p?p.diff_x:0,diff_y:p?p.diff_y:0});if(!0!==f.isCancelled){this.padding<0&&(this.padding=0);var g=parseInt($(this.box).width()),m=parseInt($(this.box).height());$(this.box).find(" > div").css({width:g+"px",height:m+"px"});let i=this,e=this.get("main"),t=this.get("preview"),s=this.get("left"),l=this.get("right"),n=this.get("top"),a=this.get("bottom");var w=null!=t&&!0!==t.hidden,b=null!=s&&!0!==s.hidden,y=null!=l&&!0!==l.hidden,x=null!=n&&!0!==n.hidden,v=null!=a&&!0!==a.hidden;let r,o,d,h,u;for(let e=0;e<w2panels.length;e++)if("main"!==w2panels[e]&&(p=this.get(w2panels[e]),p)){let e=String(p.size||0);if("%"==e.substr(e.length-1)){let e=m;"preview"==p.type&&(e=e-(n&&!n.hidden?n.sizeCalculated:0)-(a&&!a.hidden?a.sizeCalculated:0)),p.sizeCalculated=parseInt(("left"==p.type||"right"==p.type?g:e)*parseFloat(p.size)/100)}else p.sizeCalculated=parseInt(p.size);p.sizeCalculated=Math.max(p.sizeCalculated,parseInt(p.minSize))}"-"==String(l.size).substr(0,1)&&(b&&"-"==String(s.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):l.sizeCalculated=g-(b?s.sizeCalculated:0)+parseInt(l.size)),"-"==String(s.size).substr(0,1)&&(y&&"-"==String(l.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):s.sizeCalculated=g-(y?l.sizeCalculated:0)+parseInt(s.size)),null!=n&&!0!==n.hidden?(r=0,o=0,d=g,h=n.sizeCalculated,$(this.box).find("#layout_"+this.name+"_panel_top").css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px"}).show(),n.width=d,n.height=h,n.resizable&&(o=n.sizeCalculated-(0===this.padding?this.resizer:0),h=this.resizer>this.padding?this.resizer:this.padding,$(this.box).find("#layout_"+this.name+"_resizer_top").show().css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){var t=i.trigger({phase:"before",type:"resizerClick",target:"top",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].tmp.events.resizeStart("top",e),i.trigger($.extend(t,{phase:"after"})),!1}))):($(this.box).find("#layout_"+this.name+"_panel_top").hide(),$(this.box).find("#layout_"+this.name+"_resizer_top").hide()),null!=s&&!0!==s.hidden?(r=0,o=0+(x?n.sizeCalculated+this.padding:0),d=s.sizeCalculated,h=m-(x?n.sizeCalculated+this.padding:0)-(v?a.sizeCalculated+this.padding:0),u=$(this.box).find("#layout_"+this.name+"_panel_left"),u.css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px"}).show(),s.width=d,s.height=h,s.resizable&&(r=s.sizeCalculated-(0===this.padding?this.resizer:0),d=this.resizer>this.padding?this.resizer:this.padding,$(this.box).find("#layout_"+this.name+"_resizer_left").show().css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",function(e){var t=i.trigger({phase:"before",type:"resizerClick",target:"left",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].tmp.events.resizeStart("left",e),i.trigger($.extend(t,{phase:"after"})),!1}))):($(this.box).find("#layout_"+this.name+"_panel_left").hide(),$(this.box).find("#layout_"+this.name+"_resizer_left").hide()),null!=l&&!0!==l.hidden?(r=g-l.sizeCalculated,o=0+(x?n.sizeCalculated+this.padding:0),d=l.sizeCalculated,h=m-(x?n.sizeCalculated+this.padding:0)-(v?a.sizeCalculated+this.padding:0),$(this.box).find("#layout_"+this.name+"_panel_right").css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px"}).show(),l.width=d,l.height=h,l.resizable&&(r-=this.padding,d=this.resizer>this.padding?this.resizer:this.padding,$(this.box).find("#layout_"+this.name+"_resizer_right").show().css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",function(e){var t=i.trigger({phase:"before",type:"resizerClick",target:"right",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].tmp.events.resizeStart("right",e),i.trigger($.extend(t,{phase:"after"})),!1}))):($(this.box).find("#layout_"+this.name+"_panel_right").hide(),$(this.box).find("#layout_"+this.name+"_resizer_right").hide()),null!=a&&!0!==a.hidden?(r=0,o=m-a.sizeCalculated,d=g,h=a.sizeCalculated,$(this.box).find("#layout_"+this.name+"_panel_bottom").css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px"}).show(),a.width=d,a.height=h,a.resizable&&(o-=0===this.padding?0:this.padding,h=this.resizer>this.padding?this.resizer:this.padding,$(this.box).find("#layout_"+this.name+"_resizer_bottom").show().css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){var t=i.trigger({phase:"before",type:"resizerClick",target:"bottom",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].tmp.events.resizeStart("bottom",e),i.trigger($.extend(t,{phase:"after"})),!1}))):($(this.box).find("#layout_"+this.name+"_panel_bottom").hide(),$(this.box).find("#layout_"+this.name+"_resizer_bottom").hide()),r=0+(b?s.sizeCalculated+this.padding:0),o=0+(x?n.sizeCalculated+this.padding:0),d=g-(b?s.sizeCalculated+this.padding:0)-(y?l.sizeCalculated+this.padding:0),h=m-(x?n.sizeCalculated+this.padding:0)-(v?a.sizeCalculated+this.padding:0)-(w?t.sizeCalculated+this.padding:0),u=$(this.box).find("#layout_"+this.name+"_panel_main"),u.css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px"}),e.width=d,e.height=h,null!=t&&!0!==t.hidden?(r=0+(b?s.sizeCalculated+this.padding:0),o=m-(v?a.sizeCalculated+this.padding:0)-t.sizeCalculated,d=g-(b?s.sizeCalculated+this.padding:0)-(y?l.sizeCalculated+this.padding:0),h=t.sizeCalculated,u=$(this.box).find("#layout_"+this.name+"_panel_preview"),u.css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px"}).show(),t.width=d,t.height=h,t.resizable&&(o-=0===this.padding?0:this.padding,h=this.resizer>this.padding?this.resizer:this.padding,$(this.box).find("#layout_"+this.name+"_resizer_preview").show().css({display:"block",left:r+"px",top:o+"px",width:d+"px",height:h+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){var t=i.trigger({phase:"before",type:"resizerClick",target:"preview",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].tmp.events.resizeStart("preview",e),i.trigger($.extend(t,{phase:"after"})),!1}))):($(this.box).find("#layout_"+this.name+"_panel_preview").hide(),$(this.box).find("#layout_"+this.name+"_resizer_preview").hide());for(let t=0;t<w2panels.length;t++){var _=this.get(w2panels[t]),k="#layout_"+this.name+"_panel_"+w2panels[t]+" > .w2ui-panel-";let e=0;_&&(_.title&&(e+=w2utils.getSize($(this.box).find(k+"title").css({top:e+"px",display:"block"}),"height")),_.show.tabs&&(null!=_.tabs&&w2ui[this.name+"_"+w2panels[t]+"_tabs"]&&w2ui[this.name+"_"+w2panels[t]+"_tabs"].resize(),e+=w2utils.getSize($(this.box).find(k+"tabs").css({top:e+"px",display:"block"}),"height")),_.show.toolbar&&(null!=_.toolbar&&w2ui[this.name+"_"+w2panels[t]+"_toolbar"]&&w2ui[this.name+"_"+w2panels[t]+"_toolbar"].resize(),e+=w2utils.getSize($(this.box).find(k+"toolbar").css({top:e+"px",display:"block"}),"height"))),$(this.box).find(k+"content").css({display:"block"}).css({top:e+"px"})}return clearTimeout(this._resize_timer),this._resize_timer=setTimeout(()=>{for(var t in w2ui)if("function"==typeof w2ui[t].resize){null==w2ui[t].panels&&w2ui[t].resize();let e=$(w2ui[t].box).parents(".w2ui-layout");0<e.length&&e.attr("name")==i.name&&w2ui[t].resize()}},100),this.trigger($.extend(f,{phase:"after"})),(new Date).getTime()-c}}destroy(){var e=this.trigger({phase:"before",type:"destroy",target:this.name});if(!0!==e.isCancelled)return null!=w2ui[this.name]&&(0<$(this.box).find("#layout_"+this.name+"_panel_main").length&&$(this.box).removeAttr("name").removeClass("w2ui-layout").html(""),delete w2ui[this.name],this.trigger($.extend(e,{phase:"after"})),this.tmp.events&&this.tmp.events.resize&&$(window).off("resize",this.tmp.events.resize),!0)}lock(t,e,i){if(-1!=w2panels.indexOf(t)){let e=Array.from(arguments);e[0]="#layout_"+this.name+"_panel_"+t,w2utils.lock.apply(window,e)}else console.log("ERROR: First parameter needs to be the a valid panel name.")}unlock(e,t){-1!=w2panels.indexOf(e)?(e="#layout_"+this.name+"_panel_"+e,w2utils.unlock(e,t)):console.log("ERROR: First parameter needs to be the a valid panel name.")}}class Dialog extends w2event{constructor(e){super(),this.defaults={title:"",body:"",buttons:"",actions:null,style:"",color:"#000",opacity:.4,speed:.3,modal:!1,maximized:!1,keyboard:!0,width:500,height:300,showClose:!0,showMax:!1,transition:null,multiple:!1,openMaximized:!1},this.status="closed",this.onOpen=null,this.onClose=null,this.onMax=null,this.onMin=null,this.onToggle=null,this.onKeydown=null,this.onAction=null,this.onMove=null,this.onMsgOpen=null,this.onMsgClose=null}open(a){let r=this;var o=$.extend(!0,{},a);if("closing"!=w2popup.status){var d=$("#w2ui-popup").data("options");"string"==typeof a&&(a=w2utils.extend({title:"Notification",body:`<div class="w2ui-centered">${a}</div>`,showClose:!1,width:450,height:220,actions:["Ok"]},arguments[1]??{})),a=$.extend({},this.defaults,d,{title:"",body:"",buttons:""},a,{maximized:!1}),0===$("#w2ui-popup").length?(w2popup.onOpen=null,w2popup.onClose=null,w2popup.onMax=null,w2popup.onMin=null,w2popup.onToggle=null,w2popup.onKeydown=null,w2popup.onAction=null,w2popup.onMove=null,w2popup.onMsgOpen=null,w2popup.onMsgClose=null):$("#w2ui-popup").data("options",a),a.onOpen&&(w2popup.onOpen=a.onOpen),a.onClose&&(w2popup.onClose=a.onClose),a.onMax&&(w2popup.onMax=a.onMax),a.onMin&&(w2popup.onMin=a.onMin),a.onToggle&&(w2popup.onToggle=a.onToggle),a.onKeydown&&(w2popup.onKeydown=a.onKeydown),a.onAction&&(w2popup.onAction=a.onAction),a.onMove&&(w2popup.onMove=a.onMove),a.onMsgOpen&&(w2popup.onMsgOpen=a.onMsgOpen),a.onMsgClose&&(w2popup.onMsgClose=a.onMsgClose),a.width=parseInt(a.width),a.height=parseInt(a.height);let e,t,s,i,l;null==window.innerHeight?(e=parseInt(document.documentElement.offsetWidth),t=parseInt(document.documentElement.offsetHeight),"IE7"===w2utils.engine&&(e+=21,t+=4)):(e=parseInt(window.innerWidth),t=parseInt(window.innerHeight)),e-10<a.width&&(a.width=e-10),t-10<a.height&&(a.height=t-10);var h=(t-a.height)/2*.6,u=(e-a.width)/2;let n={action(e){return r.off("action.prom").on("action.prom",e),n},close(e){return r.off("close.prom").on("close.prom",e),n},then(e){return r.off("open:after.prom").on("open:after.prom",e),n}};if(null!=a.actions&&(a.buttons="",Object.keys(a.actions).forEach(e=>{var t=a.actions[e];let i=e;"function"==typeof t&&(a.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${e}"]'>${e}</button>`),"object"==typeof t&&(a.buttons+=`<button class="w2ui-btn w2ui-eaction ${t.class||""}" data-click='["action","${e}"]'
                        style="${t.style}">${t.text||e}</button>`,i=t.text||e),"string"==typeof t&&(a.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${t}"]'>${t}</button>`,i=t),"string"==typeof i&&(i=i[0].toLowerCase()+i.substr(1).replace(/\s+/g,"")),n[i]=function(t){return r.off("action."+i).on("action."+i,e=>{e.target[0].toLowerCase()+e.target.substr(1).replace(/\s+/g,"")==i&&t(e)}),n}})),0===$("#w2ui-popup").length){if(s=this.trigger({phase:"before",type:"open",target:"popup",options:a,present:!1}),!0===s.isCancelled)return;w2popup.status="opening",w2popup.lockScreen(a);let e="";a.showClose&&(e+=`<div class="w2ui-popup-button w2ui-popup-close">
                            <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>
                        </div>`),a.showMax&&(e+=`<div class="w2ui-popup-button w2ui-popup-max">
                            <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>
                        </div>`),i='<div id="w2ui-popup" class="w2ui-popup w2ui-popup-opening" style="left: '+u+"px; top: "+h+"px;     width: "+parseInt(a.width)+"px; height: "+parseInt(a.height)+'px;"></div>',$("body").append(i),$("#w2ui-popup").data("options",a);let t=$("#w2ui-popup");0<t.find("div[rel=title], div[rel=body], div[rel=buttons]").length&&(l=t.find("div[rel=title]"),0<l.length&&(a.title=l.html(),l.remove()),l=t.find("div[rel=buttons]"),0<l.length&&(a.buttons=l.html(),l.remove()),l=t.find("div[rel=body]"),0<l.length?a.body=l.html():a.body=t.html()),i='<div class="w2ui-popup-title" style="'+(a.title?"":"display: none")+'">'+e+'</div><div class="w2ui-box" style="'+(a.title?"":"top: 0px !important;")+(a.buttons?"":"bottom: 0px !important;")+'">    <div class="w2ui-popup-body'+(a.title?"":" w2ui-popup-no-title")+(a.buttons?"":" w2ui-popup-no-buttons")+'" style="'+a.style+'">    </div></div><div class="w2ui-popup-buttons" style="'+(a.buttons?"":"display: none")+'"></div><input class="w2ui-popup-hidden" style="position: absolute; top: -100px"/>',$("#w2ui-popup").html(i),a.title&&$("#w2ui-popup .w2ui-popup-title").append(w2utils.lang(a.title)),a.buttons&&$("#w2ui-popup .w2ui-popup-buttons").append(a.buttons),a.body&&$("#w2ui-popup .w2ui-popup-body").append(a.body),setTimeout(()=>{$("#w2ui-popup").css(w2utils.cssPrefix({transition:a.speed+"s opacity, "+a.speed+"s -webkit-transform"})).removeClass("w2ui-popup-opening"),r.focus()},1),setTimeout(()=>{$("#w2ui-popup").css(w2utils.cssPrefix("transform","")),w2popup.status="open"},1e3*a.speed),setTimeout(()=>{r.trigger($.extend(s,{phase:"after"})),w2utils.bindEvents("#w2ui-popup .w2ui-eaction",w2popup),$("#w2ui-popup").find(".w2ui-popup-body").show()},50)}else if(!0===a.multiple)w2popup.message(o);else{if(null==w2popup._prev&&null!=w2popup._template&&r.restoreTemplate(),s=this.trigger({phase:"before",type:"open",target:"popup",options:a,present:!0}),!0===s.isCancelled)return;w2popup.status="opening",null!=d&&(d.maximized||d.width==a.width&&d.height==a.height||w2popup.resize(a.width,a.height),a.prevSize=a.width+"px:"+a.height+"px",a.maximized=d.maximized);let e=$("#w2ui-popup .w2ui-box").clone();e.removeClass("w2ui-box").addClass("w2ui-box-temp").find(".w2ui-popup-body").empty().append(a.body),"string"==typeof a.body&&0<e.find("div[rel=title], div[rel=body], div[rel=buttons]").length&&(l=e.find("div[rel=title]"),0<l.length&&(a.title=l.html(),l.remove()),l=e.find("div[rel=buttons]"),0<l.length&&(a.buttons=l.html(),l.remove()),l=e.find("div[rel=body]"),0<l.length?a.body=l.html():a.body=e.html(),e.html(a.body)),$("#w2ui-popup .w2ui-box").after(e),a.buttons?($("#w2ui-popup .w2ui-popup-buttons").show().html("").append(a.buttons),$("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-buttons"),$("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","")):($("#w2ui-popup .w2ui-popup-buttons").hide().html(""),$("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-buttons"),$("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","0px")),a.title?($("#w2ui-popup .w2ui-popup-title").show().html((a.showClose?`<div class="w2ui-popup-button w2ui-popup-close">
                                <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>
                            </div>`:"")+(a.showMax?`<div class="w2ui-popup-button w2ui-popup-max">
                                <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>
                            </div>`:"")).append(a.title),$("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-title"),$("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","")):($("#w2ui-popup .w2ui-popup-title").hide().html(""),$("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-title"),$("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","0px"));let t=$("#w2ui-popup .w2ui-box")[0],i=$("#w2ui-popup .w2ui-box-temp")[0];w2utils.transition(t,i,a.transition,()=>{r.restoreTemplate(),$(t).remove(),$(i).removeClass("w2ui-box-temp").addClass("w2ui-box");let e=$(i).find(".w2ui-popup-body");1==e.length&&(e[0].style.cssText=a.style,e.show()),$("#w2ui-popup").data("prev-size",null),r.focus()}),w2popup.status="open",r.trigger($.extend(s,{phase:"after"})),w2utils.bindEvents("#w2ui-popup .w2ui-eaction",w2popup),$("#w2ui-popup").find(".w2ui-popup-body").show()}return a.openMaximized&&this.max(),a._last_focus=$(":focus"),a.keyboard&&$(document).on("keydown",this.keydown),l={resizing:!1,mvMove:function(e){1==l.resizing&&(e=e||window.event,l.div_x=e.screenX-l.x,l.div_y=e.screenY-l.y,!0!==(e=w2popup.trigger({phase:"before",type:"move",target:"popup",div_x:l.div_x,div_y:l.div_y})).isCancelled&&($("#w2ui-popup").css(w2utils.cssPrefix({transition:"none",transform:"translate3d("+l.div_x+"px, "+l.div_y+"px, 0px)"})),w2popup.trigger($.extend(e,{phase:"after"}))))},mvStop:function(e){1==l.resizing&&(e=e||window.event,w2popup.status="open",l.div_x=e.screenX-l.x,l.div_y=e.screenY-l.y,$("#w2ui-popup").css({left:l.pos_x+l.div_x+"px",top:l.pos_y+l.div_y+"px"}).css(w2utils.cssPrefix({transition:"none",transform:"translate3d(0px, 0px, 0px)"})),l.resizing=!1,$(document).off("mousemove",l.mvMove),$(document).off("mouseup",l.mvStop),l.isLocked||w2popup.unlock())}},$("#w2ui-popup .w2ui-popup-title").on("mousedown",function(e){w2popup.get().maximized||function(e){e=e||window.event;w2popup.status="moving",l.resizing=!0,l.isLocked=1==$("#w2ui-popup > .w2ui-lock").length,l.x=e.screenX,l.y=e.screenY,l.pos_x=$("#w2ui-popup").position().left,l.pos_y=$("#w2ui-popup").position().top,l.isLocked||w2popup.lock({opacity:0});$(document).on("mousemove",l.mvMove),$(document).on("mouseup",l.mvStop),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0;{if(!e.preventDefault)return;e.preventDefault()}}(e)}),n}else setTimeout(()=>{r.open.call(r,a)},100)}load(n){return new Promise((s,e)=>{if(null==(n="string"==typeof n?{url:n}:n).url)return console.log("ERROR: The url is not defined."),void e("The url is not defined");w2popup.status="loading";var t=String(n.url).split("#"),e=t[0];let l=t[1];null==n&&(n={});t=$("#w2ui-popup").data(e);null!=t?(this.template(t,l),s()):$.get(e,(e,t,i)=>{this.template(i.responseText,l,n).then(()=>{s()})})})}template(e,t,i={}){let s=$(e);return t&&(s=s.filter("#"+t)),$.extend(i,{style:s[0].style.cssText,width:s.width(),height:s.height(),title:s.find("[rel=title]").html(),body:s.find("[rel=body]").html(),buttons:s.find("[rel=buttons]").html()}),w2popup.open(i)}action(e,t){let i=this,s=$("#w2ui-popup").data("options");null!=t&&(s=$("#w2ui-message"+t).data("options"),i={parent:this,options:s,close(){w2popup.message({msgId:t})}});var l=s.actions[e];let n=l;$.isPlainObject(l)&&l.onClick&&(n=l.onClick);l=this.trigger({phase:"before",type:"action",target:e,action:l,msgId:t,originalEvent:event});!0!==l.isCancelled&&("function"==typeof n&&n.call(i,event),this.trigger($.extend(l,{phase:"after"})))}keydown(e){var t=$("#w2ui-popup").data("options");t&&!t.keyboard||!0!==(t=w2popup.trigger({phase:"before",type:"keydown",target:"popup",options:t,originalEvent:e})).isCancelled&&(27===e.keyCode&&(e.preventDefault(),0<$("#w2ui-popup .w2ui-message").length?w2popup.message():w2popup.close()),w2popup.trigger($.extend(t,{phase:"after"})))}close(t){let i=this;if(t=$.extend({},$("#w2ui-popup").data("options"),t),0!==$("#w2ui-popup").length&&"closed"!=this.status)if("opening"!=this.status){let e=this.trigger({phase:"before",type:"close",target:"popup",options:t});!0!==e.isCancelled&&(w2popup.status="closing",$("#w2ui-popup").css(w2utils.cssPrefix({transition:t.speed+"s opacity, "+t.speed+"s -webkit-transform"})).addClass("w2ui-popup-closing"),w2popup.unlockScreen(t),setTimeout(()=>{i.restoreTemplate(),$("#w2ui-popup").remove(),w2popup.status="closed",t._last_focus&&0<t._last_focus.length&&t._last_focus.focus(),i.trigger($.extend(e,{phase:"after"}))},1e3*t.speed),t.keyboard&&$(document).off("keydown",this.keydown))}else setTimeout(()=>{w2popup.close()},100)}toggle(){let e=this;var t=$("#w2ui-popup").data("options");let i=this.trigger({phase:"before",type:"toggle",target:"popup",options:t});!0!==i.isCancelled&&(!0===t.maximized?w2popup.min():w2popup.max(),setTimeout(()=>{e.trigger($.extend(i,{phase:"after"}))},1e3*t.speed+50))}max(){let t=this,i=$("#w2ui-popup").data("options");if(!0!==i.maximized){let e=this.trigger({phase:"before",type:"max",target:"popup",options:i});!0!==e.isCancelled&&(w2popup.status="resizing",i.prevSize=$("#w2ui-popup").css("width")+":"+$("#w2ui-popup").css("height"),w2popup.resize(1e4,1e4,()=>{w2popup.status="open",i.maximized=!0,t.trigger($.extend(e,{phase:"after"})),$("#w2ui-popup .w2ui-grid, #w2ui-popup .w2ui-form, #w2ui-popup .w2ui-layout").each(()=>{var e=$(this).attr("name");w2ui[e]&&w2ui[e].resize&&w2ui[e].resize()})}))}}min(){let t=this,i=$("#w2ui-popup").data("options");if(!0===i.maximized){var s=i.prevSize.split(":");let e=this.trigger({phase:"before",type:"min",target:"popup",options:i});!0!==e.isCancelled&&(w2popup.status="resizing",w2popup.resize(parseInt(s[0]),parseInt(s[1]),()=>{w2popup.status="open",i.maximized=!1,i.prevSize=null,t.trigger($.extend(e,{phase:"after"})),$("#w2ui-popup .w2ui-grid, #w2ui-popup .w2ui-form, #w2ui-popup .w2ui-layout").each(()=>{var e=$(this).attr("name");w2ui[e]&&w2ui[e].resize&&w2ui[e].resize()})}))}}get(){return $("#w2ui-popup").data("options")}set(e){w2popup.open(e)}clear(){$("#w2ui-popup .w2ui-popup-title").html(""),$("#w2ui-popup .w2ui-popup-body").html(""),$("#w2ui-popup .w2ui-popup-buttons").html("")}reset(){w2popup.open(w2popup.defaults)}message(d){return new Promise((s,e)=>{let l=this;$().w2tag(),d=(d="string"==typeof d?{html:d,width:200,height:100}:d)||{width:200,height:100};var i=parseInt($("#w2ui-popup").width()),t=parseInt($("#w2ui-popup").height());d.originalWidth=d.width,d.originalHeight=d.height,parseInt(d.width)<10&&(d.width=10),parseInt(d.height)<10&&(d.height=10),null==d.hideOnClick&&(d.hideOnClick=!1);var n=$("#w2ui-popup").data("options")||{},a=parseInt($("#w2ui-popup > .w2ui-popup-title").css("height"));(null==d.width||d.width>n.width-10)&&(d.width=n.width-10),(null==d.height||d.height>n.height-a-5)&&(d.height=n.height-a-5),d.originalHeight<0&&(d.height=t+d.originalHeight-a),d.originalWidth<0&&(d.width=i+2*d.originalWidth);let r=$("#w2ui-popup .w2ui-popup-title"),o=$("#w2ui-popup .w2ui-message").length;if(null!=d.actions&&(d.html&&!d.body&&(d.body=d.html),d.buttons="",Object.keys(d.actions).forEach(e=>{var t=d.actions[e];"function"==typeof t&&(d.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${e}","${o}"]'>${e}</button>`),"object"==typeof t&&(d.buttons+=`<button class="w2ui-btn w2ui-eaction ${t.class||""}" style="${t.style||""}"
                            data-click='["action","${e}","${o}"]'>${t.text||e}</button>`),"string"==typeof t&&(d.buttons+=t)})),""===(d.html||"").trim()&&""===(d.body||"").trim()&&""===(d.buttons||"").trim()){let t=$("#w2ui-popup .w2ui-message").last();null!=d.msgId&&(t=$("#w2ui-message"+d.msgId)),d=t.data("options")||{};let i=l.trigger({phase:"before",type:"msgClose",msgId:t.attr("data-msgId"),target:"popup",options:d});if(!0!==i.isCancelled){t.css(w2utils.cssPrefix({transition:"0.15s",transform:"translateY(-"+d.height+"px)"}));let e=$("#w2ui-popup .w2ui-message");e=$(e[e.length-2]).css("z-index",1500).data("msg-focus"),(e&&0<e.length?e:l).focus(),1==o&&w2popup.unlock(150),setTimeout(()=>{t.remove(),"function"==typeof d.onClose&&d.onClose(i),l.trigger($.extend(i,{phase:"after"})),s(i)},150)}}else{""===(d.body||"").trim()&&""===(d.buttons||"").trim()||(d.html='<div class="w2ui-message-body">'+d.body+'</div><div class="w2ui-message-buttons">'+d.buttons+"</div>"),$("#w2ui-popup .w2ui-message").css("z-index",1390).data("msg-focus",$(":focus")),r.css("z-index",1501),null==d.close&&(d.close=()=>{w2popup.message({msgId:o})}),$("#w2ui-popup .w2ui-box").before('<div id="w2ui-message'+o+'" class="w2ui-message w2ui-eaction" style="display: none; z-index: 1500; '+(0===r.length?"top: 0px;":"top: "+w2utils.getSize(r,"height")+"px;")+(null!=d.width?"width: "+d.width+"px; left: "+(i-d.width)/2+"px;":"left: 10px; right: 10px;")+(null!=d.height?"height: "+d.height+"px;":"bottom: 6px;")+w2utils.cssPrefix("transition","0s",!0)+'" data-msgId="'+o+'" '+(!0===d.hideOnClick?'data-click="message"':"")+"></div>"),$("#w2ui-popup #w2ui-message"+o).data("options",d);let t=$("#w2ui-popup #w2ui-message"+o).css("display");if($("#w2ui-popup #w2ui-message"+o).css(w2utils.cssPrefix({transform:"none"==t?"translateY(-"+d.height+"px)":"translateY(0px)"})),"none"==t){$("#w2ui-popup #w2ui-message"+o).show().html(d.html),setTimeout(()=>{$("#w2ui-popup #w2ui-message"+o).css($.extend(w2utils.cssPrefix("transition",".3s",!1),w2utils.cssPrefix({transform:"none"==t?"translateY(0px)":"translateY(-"+d.height+"px)"})))},1),0===o&&w2popup.lock();let e=l.trigger({phase:"before",type:"msgOpen",msgId:o,target:"popup",options:d});!0!==e.isCancelled&&setTimeout(()=>{l.focus(),$("#w2ui-popup #w2ui-message"+o).css(w2utils.cssPrefix({transition:"0s"})),"function"==typeof d.onOpen&&d.onOpen(e),l.trigger($.extend(e,{phase:"after"})),w2utils.bindEvents(`#w2ui-popup #w2ui-message${o}, #w2ui-popup #w2ui-message${o} .w2ui-eaction`,w2popup),s(e)},350)}}})}focus(){let t=null,i=$("#w2ui-popup"),s="input:visible, button:visible, select:visible, textarea:visible, [contentEditable], .w2ui-input";$(i).find(s).off(".keep-focus");var l=$("#w2ui-popup .w2ui-message").length-1,l=$("#w2ui-popup #w2ui-message"+l);if(0<l.length){let e=$(l[l.length-1]).find("button");0<e.length&&e[0].focus(),t=l}else if(0<i.length){let e=i.find(".w2ui-popup-buttons button");0<e.length&&e[0].focus(),t=i}$(t).find(s).on("blur.keep-focus",function(e){setTimeout(()=>{let e=$(":focus");if(0<e.length&&!$(t).find(s).is(e)||e.hasClass("w2ui-popup-hidden")){let e=$(t).find(s);0<e.length&&e[0].focus()}},1)})}lock(e,t){let i=Array.prototype.slice.call(arguments,0);i.unshift($("#w2ui-popup")),w2utils.lock.apply(window,i)}unlock(e){w2utils.unlock($("#w2ui-popup"),e)}lockScreen(e){return!(0<$("#w2ui-lock").length)&&(null==(e=null==e?$("#w2ui-popup").data("options"):e)&&(e={}),e=$.extend({},w2popup.defaults,e),$("body").append('<div id="w2ui-lock"     style="position: '+("IE5"==w2utils.engine?"absolute":"fixed")+"; z-Index: 1199; left: 0px; top: 0px;            padding: 0px; margin: 0px; background-color: "+e.color+'; width: 100%; height: 100%; opacity: 0;"></div>'),setTimeout(()=>{$("#w2ui-lock").css("opacity",e.opacity).css(w2utils.cssPrefix("transition",e.speed+"s opacity"))},1),1==e.modal?$("#w2ui-lock").on("mousedown",function(){$("#w2ui-lock").css("opacity","0.6").css(w2utils.cssPrefix("transition",".1s"))}).on("mouseup",function(){setTimeout(()=>{$("#w2ui-lock").css("opacity",e.opacity).css(w2utils.cssPrefix("transition",".1s"))},100)}).on("mousewheel",function(e){return e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,!!e.preventDefault&&void e.preventDefault()}):$("#w2ui-lock").on("mousedown",function(){w2popup.close()}),!0)}unlockScreen(e){return 0!==$("#w2ui-lock").length&&(null==(e=null==e?$("#w2ui-popup").data("options"):e)&&(e={}),e=$.extend({},w2popup.defaults,e),$("#w2ui-lock").css("opacity","0").css(w2utils.cssPrefix("transition",e.speed+"s opacity")),setTimeout(()=>{$("#w2ui-lock").remove()},1e3*e.speed),!0)}resizeMessages(){$("#w2ui-popup .w2ui-message").each(()=>{let e=$(this).data("options"),t=$("#w2ui-popup");parseInt(e.width)<10&&(e.width=10),parseInt(e.height)<10&&(e.height=10);var i=parseInt(t.find("> .w2ui-popup-title").css("height")),s=parseInt(t.width()),l=parseInt(t.height());e.width=e.originalWidth,e.width>s-10&&(e.width=s-10),e.height=e.originalHeight,e.height>l-i-5&&(e.height=l-i-5),e.originalHeight<0&&(e.height=l+e.originalHeight-i),e.originalWidth<0&&(e.width=s+2*e.originalWidth),$(this).css({left:(s-e.width)/2+"px",width:e.width+"px",height:e.height+"px"})})}resize(e,t,i){let s=this,l=$("#w2ui-popup").data("options")||{};null==l.speed&&(l.speed=0),e=parseInt(e),t=parseInt(t);let n,a;null==window.innerHeight?(n=parseInt(document.documentElement.offsetWidth),a=parseInt(document.documentElement.offsetHeight),"IE7"===w2utils.engine&&(n+=21,a+=4)):(n=parseInt(window.innerWidth),a=parseInt(window.innerHeight)),n-10<e&&(e=n-10),a-10<t&&(t=a-10);var r=(a-t)/2*.6,o=(n-e)/2;$("#w2ui-popup").css(w2utils.cssPrefix({transition:l.speed+"s width, "+l.speed+"s height, "+l.speed+"s left, "+l.speed+"s top"})).css({top:r,left:o,width:e,height:t});let d=setInterval(()=>{s.resizeMessages()},10);setTimeout(()=>{clearInterval(d),l.width=e,l.height=t,s.resizeMessages(),"function"==typeof i&&i()},1e3*l.speed+50)}restoreTemplate(){var e=$("#w2ui-popup").data("options");if(null!=e){let t=w2popup._template,i=e.title,s=e.body,l=e.buttons;if(w2popup._prev?(t=w2popup._prev.template,i=w2popup._prev.title,s=w2popup._prev.body,l=w2popup._prev.buttons,delete w2popup._prev):delete w2popup._template,null!=t){let e=$(t);0!==e.length&&("body"==$(s).attr("rel")?(i&&e.append(i),s&&e.append(s),l&&e.append(l)):e.append(s))}}}}function w2alert(e,t,i){let s=jQuery,l;return null==t&&(t=w2utils.lang("Notification")),0<s("#w2ui-popup").length&&"closing"!=w2popup.status?w2popup.message({width:400,height:180,body:'<div class="w2ui-centered w2ui-alert-msg" style="font-size: 13px;">'+e+"</div>",actions:{Ok:{text:w2utils.lang("Ok"),onClick(){w2popup.message()}}},onOpen(e){setTimeout(()=>{s("#w2ui-popup .w2ui-message .w2ui-popup-btn").focus(),"function"==typeof l&&l(e)},1)},onClose(e){"function"==typeof i&&i(e)}}):w2popup.open({width:450,height:220,showMax:!1,showClose:!1,title:t,body:'<div class="w2ui-centered w2ui-alert-msg" style="font-size: 13px;">'+e+"</div>",actions:{Ok:{text:w2utils.lang("Ok"),onClick(){w2popup.close()}}},onOpen(e){setTimeout(()=>{s("#w2ui-popup .w2ui-popup-btn").focus(),"function"==typeof l&&l(e)},1)},onKeydown(e){s("#w2ui-popup .w2ui-popup-btn").focus().addClass("clicked")},onClose(e){"function"==typeof i&&i(e)}}),{ok(e){return i=e,this},then(e){return l=e,this}}}function w2confirm(e,t,i){let s=jQuery,l={};var n={msg:"",title:w2utils.lang("Confirmation"),width:0<s("#w2ui-popup").length?400:450,height:0<s("#w2ui-popup").length?180:220,btn_yes:{text:"Yes",class:"",styel:"",click:null},btn_no:{text:"No",class:"",styel:"",click:null},focus_to_no:!1,callBack:null};1==arguments.length&&"object"==typeof e?s.extend(l,n,e):"function"==typeof t?s.extend(l,n,{msg:e,callBack:t}):s.extend(l,n,{msg:e,title:t,callBack:i}),l.yes_text&&(l.btn_yes.text=l.yes_text),l.yes_class&&(l.btn_yes.class=l.yes_class),l.yes_style&&(l.btn_yes.style=l.yes_style),l.yes_onClick&&(l.btn_yes.click=l.yes_onClick),l.yes_callBack&&(l.btn_yes.click=l.yes_callBack),l.no_text&&(l.btn_no.text=l.no_text),l.no_class&&(l.btn_no.class=l.no_class),l.no_style&&(l.btn_no.style=l.no_style),l.no_onClick&&(l.btn_no.click=l.no_onClick),l.no_callBack&&(l.btn_no.click=l.no_callBack),0<s("#w2ui-popup").length&&"closing"!=w2popup.status&&w2popup.get()?(l.width>w2popup.get().width&&(l.width=w2popup.get().width),l.height>w2popup.get().height-50&&(l.height=w2popup.get().height-50),w2popup.message({width:l.width,height:l.height,body:'<div class="w2ui-centered w2ui-confirm-msg" style="font-size: 13px;">'+l.msg+"</div>",buttons:w2utils.settings.macButtonOrder?'<button id="No" class="w2ui-popup-btn w2ui-btn '+l.btn_no.class+'" style="'+l.btn_no.style+'">'+w2utils.lang(l.btn_no.text)+'</button><button id="Yes" class="w2ui-popup-btn w2ui-btn '+l.btn_yes.class+'" style="'+l.btn_yes.style+'">'+w2utils.lang(l.btn_yes.text)+"</button>":'<button id="Yes" class="w2ui-popup-btn w2ui-btn '+l.btn_yes.class+'" style="'+l.btn_yes.style+'">'+w2utils.lang(l.btn_yes.text)+'</button><button id="No" class="w2ui-popup-btn w2ui-btn '+l.btn_no.class+'" style="'+l.btn_no.style+'">'+w2utils.lang(l.btn_no.text)+"</button>",onOpen(e){s("#w2ui-popup .w2ui-message .w2ui-btn").on("click.w2confirm",function(e){w2popup._confirm_btn=e.target.id,w2popup.message()}),"function"==typeof l.onOpen&&l.onOpen(e),"function"==typeof l.then&&l.then(e)},onClose(e){s("#w2ui-popup .w2ui-message .w2ui-btn").off("click.w2confirm"),setTimeout(()=>{"function"==typeof l.callBack&&l.callBack(w2popup._confirm_btn),"Yes"==w2popup._confirm_btn&&"function"==typeof l.btn_yes.click&&l.btn_yes.click(e),"No"==w2popup._confirm_btn&&"function"==typeof l.btn_no.click&&l.btn_no.click(e)},300),"function"==typeof l.onClose&&l.onClose(e)}})):(w2utils.isInt(l.height)||(l.height=l.height+50),w2popup.open({width:l.width,height:l.height,title:l.title,modal:!0,showClose:!1,body:'<div class="w2ui-centered w2ui-confirm-msg" style="font-size: 13px;">'+l.msg+"</div>",buttons:w2utils.settings.macButtonOrder?'<button id="No" class="w2ui-popup-btn w2ui-btn '+l.btn_no.class+'" style="'+l.btn_no.style+'">'+w2utils.lang(l.btn_no.text)+'</button><button id="Yes" class="w2ui-popup-btn w2ui-btn '+l.btn_yes.class+'" style="'+l.btn_yes.style+'">'+w2utils.lang(l.btn_yes.text)+"</button>":'<button id="Yes" class="w2ui-popup-btn w2ui-btn '+l.btn_yes.class+'" style="'+l.btn_yes.style+'">'+w2utils.lang(l.btn_yes.text)+'</button><button id="No" class="w2ui-popup-btn w2ui-btn '+l.btn_no.class+'" style="'+l.btn_no.style+'">'+w2utils.lang(l.btn_no.text)+"</button>",onOpen(e){setTimeout(()=>{s("#w2ui-popup .w2ui-popup-btn").on("click",function(e){w2popup.close(),"function"==typeof l.callBack&&l.callBack(e.target.id),"Yes"==e.target.id&&"function"==typeof l.btn_yes.click&&l.btn_yes.click(e),"No"==e.target.id&&"function"==typeof l.btn_no.click&&l.btn_no.click(e)}),(l.focus_to_no?s("#w2ui-popup .w2ui-popup-btn#No"):s("#w2ui-popup .w2ui-popup-btn#Yes")).focus(),"function"==typeof l.onOpen&&l.onOpen(e),"function"==typeof l.then&&l.then(e)},1)},onClose(e){"function"==typeof l.onClose&&l.onClose(e)},onKeydown(e){if(0===s("#w2ui-popup .w2ui-message").length)switch(e.originalEvent.keyCode){case 13:s("#w2ui-popup .w2ui-popup-btn#Yes").focus().addClass("clicked"),w2popup.close();break;case 27:s("#w2ui-popup .w2ui-popup-btn#No").focus().click(),w2popup.close()}}}));let a={yes(e){return l.btn_yes.click=e,a},no(e){return l.btn_no.click=e,a},answer(e){return l.callBack=e,a},then(e){return l.then=e,a}};return a}function w2prompt(e,t,i){let s=jQuery,l={};var n={title:w2utils.lang("Notification"),width:0<s("#w2ui-popup").length?400:450,height:0<s("#w2ui-popup").length?180:220,label:"",value:"",attrs:"",textarea:!1,btn_ok:{text:"Ok",class:"",style:"",click:null},btn_cancel:{text:"Cancel",class:"",style:"",click:null},callBack:null,onOpen:null,onClose:null};function a(e,t,i){"ok"==e&&"function"==typeof l.btn_ok.click&&l.btn_ok.click(t,i),"cancel"==e&&"function"==typeof l.btn_cancel.click&&l.btn_cancel.click(t,i),"function"==typeof l.callBack&&l.callBack(e,t,i)}w2popup.tmp=w2popup.tmp||{},1==arguments.length&&"object"==typeof e?s.extend(l,n,e):"function"==typeof t?s.extend(l,n,{label:e,callBack:t}):s.extend(l,n,{label:e,title:t,callBack:i}),l.ok_text&&(l.btn_ok.text=l.ok_text),l.ok_class&&(l.btn_ok.class=l.ok_class),l.ok_style&&(l.btn_ok.style=l.ok_style),l.ok_onClick&&(l.btn_ok.click=l.ok_onClick),l.ok_callBack&&(l.btn_ok.click=l.ok_callBack),l.cancel_text&&(l.btn_cancel.text=l.cancel_text),l.cancel_class&&(l.btn_cancel.class=l.cancel_class),l.cancel_style&&(l.btn_cancel.style=l.cancel_style),l.cancel_onClick&&(l.btn_cancel.click=l.cancel_onClick),l.cancel_callBack&&(l.btn_cancel.click=l.cancel_callBack),0<s("#w2ui-popup").length&&"closing"!=w2popup.status&&w2popup.get()?(l.width>w2popup.get().width&&(l.width=w2popup.get().width),l.height>w2popup.get().height-50&&(l.height=w2popup.get().height-50),w2popup.message({width:l.width,height:l.height,body:l.textarea?'<div class="w2ui-prompt textarea">  <div>'+l.label+'</div>  <textarea id="w2prompt" class="w2ui-input" '+l.attrs+"></textarea></div>":'<div class="w2ui-prompt w2ui-centered">  <label>'+l.label+'</label>  <input id="w2prompt" class="w2ui-input" '+l.attrs+"></div>",buttons:w2utils.settings.macButtonOrder?'<button id="Cancel" class="w2ui-popup-btn w2ui-btn '+l.btn_cancel.class+'" style="'+l.btn_cancel.style+'">'+l.btn_cancel.text+'</button><button id="Ok" class="w2ui-popup-btn w2ui-btn '+l.btn_ok.class+'" style="'+l.btn_ok.style+'">'+l.btn_ok.text+"</button>":'<button id="Ok" class="w2ui-popup-btn w2ui-btn '+l.btn_ok.class+'" style="'+l.btn_ok.style+'">'+l.btn_ok.text+'</button><button id="Cancel" class="w2ui-popup-btn w2ui-btn '+l.btn_cancel.class+'" style="'+l.btn_cancel.style+'">'+l.btn_cancel.text+"</button>",onOpen(e){s("#w2prompt").val(l.value).off(".w2prompt").on("keydown.w2prompt",function(e){13==e.keyCode&&s("#w2ui-popup .w2ui-message .w2ui-btn#Ok").click()}),s("#w2ui-popup .w2ui-message .w2ui-btn#Ok").off(".w2prompt").on("click.w2prompt",function(e){w2popup.tmp.btn="ok",w2popup.tmp.value=s("#w2prompt").val(),w2popup.message()}),s("#w2ui-popup .w2ui-message .w2ui-btn#Cancel").off(".w2prompt").on("click.w2prompt",function(e){w2popup.tmp.btn="cancel",w2popup.tmp.value=null,w2popup.message()}),setTimeout(()=>{s("#w2prompt").focus()},100),"function"==typeof l.onOpen&&l.onOpen(e),"function"==typeof l.then&&l.then(e)},onClose(e){s("#w2ui-popup .w2ui-message .w2ui-btn").off("click.w2prompt"),setTimeout(()=>{a(w2popup.tmp.btn,w2popup.tmp.value,e)},300),"function"==typeof l.onClose&&l.onClose(e)}})):(w2utils.isInt(l.height)||(l.height=l.height+50),w2popup.open({width:l.width,height:l.height,title:l.title,modal:!0,showClose:!1,body:l.textarea?'<div class="w2ui-prompt">  <div>'+l.label+'</div>  <textarea id="w2prompt" class="w2ui-input" '+l.attrs+"></textarea></div>":'<div class="w2ui-prompt w2ui-centered" style="font-size: 13px;">  <label>'+l.label+'</label>  <input id="w2prompt" class="w2ui-input" '+l.attrs+"></div>",buttons:w2utils.settings.macButtonOrder?'<button id="Cancel" class="w2ui-popup-btn w2ui-btn '+l.btn_cancel.class+'" style="'+l.btn_cancel.style+'">'+l.btn_cancel.text+'</button><button id="Ok" class="w2ui-popup-btn w2ui-btn '+l.btn_ok.class+'" style="'+l.btn_ok.style+'">'+l.btn_ok.text+"</button>":'<button id="Ok" class="w2ui-popup-btn w2ui-btn '+l.btn_ok.class+'" style="'+l.btn_ok.style+'">'+l.btn_ok.text+'</button><button id="Cancel" class="w2ui-popup-btn w2ui-btn '+l.btn_cancel.class+'" style="'+l.btn_cancel.style+'">'+l.btn_cancel.text+"</button>",onOpen(e){setTimeout(()=>{s("#w2prompt").val(l.value),s("#w2prompt").w2field("text"),s("#w2ui-popup .w2ui-popup-btn#Ok").on("click",function(e){w2popup.tmp.btn="ok",w2popup.tmp.value=s("#w2prompt").val(),w2popup.close()}),s("#w2ui-popup .w2ui-popup-btn#Cancel").on("click",function(e){w2popup.tmp.btn="cancel",w2popup.tmp.value=null,w2popup.close()}),s("#w2ui-popup .w2ui-popup-btn#Ok"),setTimeout(()=>{s("#w2prompt").focus()},100),"function"==typeof l.onOpen&&l.onOpen(e),"function"==typeof l.then&&l.then(e)},1)},onClose(e){a(w2popup.tmp.btn,w2popup.tmp.value,e),"function"==typeof l.onClose&&l.onClose(e)},onKeydown(e){if(0===s("#w2ui-popup .w2ui-message").length)switch(e.originalEvent.keyCode){case 13:s("#w2ui-popup .w2ui-popup-btn#Ok").focus().addClass("clicked");break;case 27:w2popup.tmp.btn="cancel",w2popup.tmp.value=null}}}));let r={ok(e){return l.btn_ok.click=e,r},cancel(e){return l.btn_cancel.click=e,r},answer(e){return l.callBack=e,r},change(e){return s("#w2prompt").on("keyup",e).keyup(),r},then(e){return l.then=e,r}};return r}let w2popup=new Dialog;class w2tabs extends w2event{constructor(e){super(e.name),this.box=null,this.name=null,this.active=null,this.reorder=!1,this.flow="down",this.tooltip="top|left",this.tabs=[],this.routeData={},this.tmp={},this.right="",this.style="",this.onClick=null,this.onClose=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.tab_template={id:null,text:null,route:null,hidden:!1,disabled:!1,closable:!1,tooltip:null,style:"",onClick:null,onRefresh:null,onClose:null};var t=e.tabs;delete e.tabs,$.extend(!0,this,e),Array.isArray(t)&&this.add(t),e.tabs=t}add(e){return this.insert(null,e)}insert(s,e){(e=!Array.isArray(e)?[e]:e).forEach(e=>{var t,i;null!=e.id?w2utils.checkUniqueId(e.id,this.tabs,"tabs",this.name)&&(t=Object.assign({},this.tab_template,e),null==s?(this.tabs.push(t),this.animateInsert(null,t)):(i=this.get(s,!0),e=this.tabs[i].id,this.tabs.splice(i,0,t),this.animateInsert(e,t))):console.log(`ERROR: The parameter "id" is required but not supplied. (obj: ${this.name})`)})}remove(){let t=0;return Array.from(arguments).forEach(e=>{e=this.get(e);e&&(t++,this.tabs.splice(this.get(e.id,!0),1),$(this.box).find(`#tabs_${this.name}_tab_${w2utils.escapeId(e.id)}`).remove())}),this.resize(),t}select(e){return this.active!=e&&null!=this.get(e)&&(this.active=e,this.refresh(),!0)}set(e,t){var i=this.get(e,!0);return null!=i&&($.extend(this.tabs[i],t),this.refresh(e),!0)}get(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.tabs.length;e++)null!=this.tabs[e].id&&t.push(this.tabs[e].id);return t}for(let e=0;e<this.tabs.length;e++)if(this.tabs[e].id==t)return!0===i?e:this.tabs[e];return null}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!1!==t.hidden&&(t.hidden=!1,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!0!==t.hidden&&(t.hidden=!0,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!1!==t.disabled&&(t.disabled=!1,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!0!==t.disabled&&(t.disabled=!0,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}dragMove(a){if(this.tmp.reordering){let s=this,l=this.tmp.moving;var e=this.tabs[l.index],r=d(l.index,1),o=d(l.index,-1);let n=$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(e.id));if(0<l.divX&&r){let e=$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(r.id)),t=parseInt(n.css("width")),i=parseInt(e.css("width"));if(t=t<i?Math.floor(t/3):Math.floor(i/3),i-=t,l.divX>i){r=this.tabs.indexOf(r);return this.tabs.splice(l.index,0,this.tabs.splice(r,1)[0]),l.$tab.before(e),l.$tab.css("opacity",0),void Object.assign(this.tmp.moving,{index:r,divX:-t,x:a.pageX+t,left:l.left+l.divX+t})}}if(l.divX<0&&o){let e=$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(o.id)),t=parseInt(n.css("width")),i=parseInt(e.css("width"));t=t<i?Math.floor(t/3):Math.floor(i/3),i-=t,Math.abs(l.divX)>i&&(o=this.tabs.indexOf(o),this.tabs.splice(l.index,0,this.tabs.splice(o,1)[0]),e.before(l.$tab),l.$tab.css("opacity",0),Object.assign(l,{index:o,divX:t,x:a.pageX-t,left:l.left+l.divX-t}))}function d(e,t){e+=t;let i=s.tabs[e];return i&&i.hidden&&(i=d(e,t)),i}}}tooltipShow(e,t,i){var s=this.get(e);let l=$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(e));if(null!=this.tooltip&&!s.disabled&&!this.tmp.reordering){let e=this.tooltip,t=s.tooltip;"function"==typeof t&&(t=t.call(this,s)),l.prop("_mouse_over",!0),setTimeout(()=>{!0===l.prop("_mouse_over")&&!0!==l.prop("_mouse_tooltip")&&(l.prop("_mouse_tooltip",!0),l.w2tag(w2utils.lang(t),{position:e})),1==i&&l.w2tag(w2utils.lang(t),{position:e})},1)}}tooltipHide(e){var t=this.get(e);let i=$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(e));null==this.tooltip||t.disabled||this.tmp.reordering||(i.removeProp("_mouse_over"),setTimeout(()=>{!0!==i.prop("_mouse_over")&&!0===i.prop("_mouse_tooltip")&&(i.removeProp("_mouse_tooltip"),i.w2tag())},1))}getTabHTML(e){e=this.get(e,!0);let t=this.tabs[e];if(null==t)return!1;null==t.text&&null!=t.caption&&(t.text=t.caption),null==t.tooltip&&null!=t.hint&&(t.tooltip=t.hint),null!=t.caption&&console.log("NOTICE: tabs tab.caption property is deprecated, please use tab.text. Tab -> ",t),null!=t.hint&&console.log("NOTICE: tabs tab.hint property is deprecated, please use tab.tooltip. Tab -> ",t);let i=t.text;"function"==typeof i&&(i=i.call(this,t)),null==i&&(i="");let s="",l="";return t.hidden&&(l+="display: none;"),t.disabled&&(l+="opacity: 0.2;"),t.closable&&!t.disabled&&(s=`<div class="w2ui-tab-close w2ui-eaction ${this.active===t.id?"active":""}"
                data-mouseenter='["tooltipShow", "${t.id}", "event"]'
                data-mouseleave='["tooltipHide", "${t.id}", "event"]'
                data-mousedown="stop"
                data-mouseup='["clickClose", "${t.id}", "event"]'>
            </div>`),`
            <div id="tabs_${this.name}_tab_${t.id}" style="${l} ${t.style}"
               class="w2ui-tab w2ui-eaction ${this.active===t.id?"active":""} ${t.closable?"closable":""} ${t.class||""}"
               data-mouseenter ='["tooltipShow", "${t.id}", "event"]'
               data-mouseleave ='["tooltipHide", "${t.id}", "event"]'
               data-mousedown  ='["initReorder", "${t.id}", "event"]'
               data-click      ='["click", "${t.id}", "event"]'
               >
                    ${w2utils.lang(i)+s}
            </div>`}refresh(t){var e=(new Date).getTime();"up"==this.flow?$(this.box).addClass("w2ui-tabs-up"):$(this.box).removeClass("w2ui-tabs-up");var i=this.trigger({phase:"before",type:"refresh",target:null!=t?t:this.name,object:this.get(t)});if(!0!==i.isCancelled){if(null==t)for(let e=0;e<this.tabs.length;e++)this.refresh(this.tabs[e].id);else{var s="#tabs_"+this.name+"_tab_"+w2utils.escapeId(t);let e=$(this.box).find(s);t=this.getTabHTML(t);0===e.length?$(this.box).find("#tabs_"+this.name+"_right").before(t):0==$(this.box).find(".tab-animate-insert").length&&e.replaceWith(t),w2utils.bindEvents($(this.box).find(`${s}, ${s} .w2ui-eaction`),this)}return $(this.box).find("#tabs_"+this.name+"_right").html(this.right),this.trigger($.extend(i,{phase:"after"})),(new Date).getTime()-e}}render(e){var t=(new Date).getTime(),i=this.trigger({phase:"before",type:"render",target:this.name,box:e});if(!0!==i.isCancelled){if(null!=e&&(0<$(this.box).find("#tabs_"+this.name+"_right").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-tabs").html(""),this.box=e),!this.box)return!1;e=`
            <div class="w2ui-tabs-line"></div>
            <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                <div id="tabs_${this.name}_right" class="w2ui-tabs-right">${this.right}</div>
            </div>
            <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll","left"]'></div>
            <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll","right"]'></div>`;return $(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-tabs").html(e),0<$(this.box).length&&($(this.box)[0].style.cssText+=this.style),w2utils.bindEvents($(this.box).find(".w2ui-eaction"),this),this.trigger($.extend(i,{phase:"after"})),this.refresh(),this.resize(),(new Date).getTime()-t}}initReorder(e,a){if(this.reorder){let t=this,i=$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(e)),s=this.get(e,!0),l=i.clone(),n;l.attr("id","#tabs_"+this.name+"_tab_ghost"),this.tmp.moving={index:s,indexFrom:s,$tab:i,$ghost:l,divX:0,left:i.offset().left,parentX:$(this.box).offset().left,x:a.pageX,opacity:i.css("opacity")},$(document).off(".w2uiTabReorder").on("mousemove.w2uiTabReorder",function(e){if(!t.tmp.reordering){if(n=t.trigger({phase:"before",type:"reorder",target:t.tabs[s].id,indexFrom:s,tab:t.tabs[s]}),!0===n.isCancelled)return;$().w2tag(),t.tmp.reordering=!0,l.addClass("moving"),l.css({"pointer-events":"none",position:"absolute",left:i.offset().left}),i.css("opacity",0),$(t.box).find(".w2ui-scroll-wrapper").append(l),$(t.box).find(".w2ui-tab-close").hide()}t.tmp.moving.divX=e.pageX-t.tmp.moving.x,l.css("left",t.tmp.moving.left-t.tmp.moving.parentX+t.tmp.moving.divX+"px"),t.dragMove(e)}).on("mouseup.w2uiTabReorder",function(){$(document).off(".w2uiTabReorder"),l.css({transition:"0.1s",left:t.tmp.moving.$tab.offset().left-t.tmp.moving.parentX}),$(t.box).find(".w2ui-tab-close").show(),setTimeout(()=>{l.remove(),i.css({opacity:t.tmp.moving.opacity}),t.tmp.reordering&&t.trigger($.extend(n,{phase:"after",indexTo:t.tmp.moving.index})),t.tmp.reordering=!1},100)})}}scroll(e,t){let i=$(this.box),s=this,l=i.find(".w2ui-scroll-wrapper");var n=l.scrollLeft();let a=i.find(".w2ui-tabs-right");var r=l.outerWidth(),o=n+parseInt(a.offset().left)+parseInt(a.width());let d=!1;switch(e){case"left":d=n-r+50,d<=0&&(d=0);break;case"right":d=n+r-50,d>=o-r&&(d=o-r)}!1!==d&&l.animate({scrollLeft:d},t?0:300,function(){s.resize()})}scrollIntoView(s,l,n){let a=this;null==s&&(s=a.active);let r=a.get(s);if(null!=r){let e=$(a.box),t=e.find(".w2ui-scroll-wrapper"),i=e.find("#tabs_"+a.name+"_tab_"+w2utils.escapeId(s));var o=i.offset().left-t.offset().left;t.animate({scrollLeft:t.scrollLeft()+o-t.width()/2+i.width()},l?0:350,"linear",function(){a.resize(),"function"==typeof n&&n(s,r)})}}resize(){var i=(new Date).getTime(),s=this.trigger({phase:"before",type:"resize",target:this.name});if(!0!==s.isCancelled){let e=$(this.box);e.find(".w2ui-scroll-left, .w2ui-scroll-right").hide();let t=e.find(".w2ui-scroll-wrapper");var l=$(e).find(".w2ui-tabs-right"),n=t.outerWidth(),a=0<l.length?l[0].offsetLeft+l[0].clientWidth:0,r=parseInt(e.css("padding-right"));return n<a-r&&(0<t.scrollLeft()&&e.find(".w2ui-scroll-left").show(),l=parseInt(t.css("padding-right")),n<a-t.scrollLeft()-r-l&&e.find(".w2ui-scroll-right").show()),this.trigger($.extend(s,{phase:"after"})),(new Date).getTime()-i}}destroy(){var e=this.trigger({phase:"before",type:"destroy",target:this.name});!0!==e.isCancelled&&(0<$(this.box).find("#tabs_"+this.name+"_right").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-tabs").html(""),delete w2ui[this.name],this.trigger($.extend(e,{phase:"after"})))}click(e,t){var i=this.get(e);if(null==i||i.disabled||this.tmp.reordering)return!1;t=this.trigger({phase:"before",type:"click",target:e,tab:i,object:i,originalEvent:t});if(!0!==t.isCancelled){if($(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(this.active)).removeClass("active"),$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(this.active)).removeClass("active"),this.active=i.id,"string"==typeof i.route){let t=""!==i.route?String("/"+i.route).replace(/\/{2,}/g,"/"):"";var s=w2utils.parseRoute(t);if(0<s.keys.length)for(let e=0;e<s.keys.length;e++)null!=this.routeData[s.keys[e].name]&&(t=t.replace(new RegExp(":"+s.keys[e].name,"g"),this.routeData[s.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}this.trigger($.extend(t,{phase:"after"})),this.refresh(e)}}clickClose(e,t){var i=this.get(e);if(null==i||i.disabled)return!1;let s=this.trigger({phase:"before",type:"close",target:e,object:this.get(e),originalEvent:t});!0!==s.isCancelled&&(this.animateClose(e).then(()=>{this.remove(e),this.trigger($.extend(s,{phase:"after"})),this.refresh()}),t&&t.stopPropagation())}animateClose(n){return new Promise((e,t)=>{let i=$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(n));var s=parseInt(i.css("width")||0);let l=$(`<div class="tab-animate-close" style="display: inline-block; flex-shrink: 0; width: ${s}px; transition: width 0.25s"></div>`);i.replaceWith(l),setTimeout(()=>{l.css({width:"0px"})},1),setTimeout(()=>{l.remove(),this.resize(),e()},300)})}animateInsert(t,a){return new Promise((s,e)=>{let l=$(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(t)),n=$(this.getTabHTML(a.id));if(0==l.length)l=$(this.box).find("#tabs_tabs_right"),l.before(n),this.resize();else{n.css({opacity:0}),$(this.box).find("#tabs_tabs_right").before(n);let e=$(this.box).find("#"+n.attr("id")),t=parseInt(e.css("width")||0),i=$('<div class="tab-animate-insert" style="display: inline-block; flex-shrink: 0; width: 0px; transition: width 0.25s"></div>');l.before(i),n.hide(),n.insertBefore(i),setTimeout(()=>{i.css({width:t+"px"})},1),setTimeout(()=>{i.remove(),n.css({opacity:1}).show(),this.refresh(a.id),this.resize(),s()},300)}})}}class w2toolbar extends w2event{constructor(e){super(e.name),this.box=null,this.name=null,this.routeData={},this.items=[],this.right="",this.tooltip="top|left",this.onClick=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.item_template={id:null,type:"button",text:null,html:"",tooltip:null,count:null,hidden:!1,disabled:!1,checked:!1,icon:null,route:null,arrow:null,style:null,group:null,items:null,selected:null,overlay:{},color:null,options:{advanced:!1,transparent:!0,html:""},onClick:null,onRefresh:null},this.tmp={badge:{}};var t=e.items;delete e.items,$.extend(!0,this,e),Array.isArray(t)&&this.add(t),e.items=t}add(e){this.insert(null,e)}insert(n,e){(e=!Array.isArray(e)?[e]:e).forEach((e,t,i)=>{"string"==typeof e&&(e=i[t]={id:e,text:e});let s=["button","check","radio","drop","menu","menu-radio","menu-check","color","text-color","html","break","spacer","new-line"];if(-1!=s.indexOf(String(e.type)))if(null!=e.id||-1!=["break","spacer","new-line"].indexOf(e.type))if(null!=e.type){if(w2utils.checkUniqueId(e.id,this.items,"toolbar",this.name)){let s=Object.assign({},this.item_template,e);var l;"menu-check"==s.type?(Array.isArray(s.selected)||(s.selected=[]),Array.isArray(s.items)&&s.items.forEach(e=>{(e="string"==typeof e?i[t]={id:e,text:e}:e).checked&&-1==s.selected.indexOf(e.id)&&s.selected.push(e.id),e.checked||-1==s.selected.indexOf(e.id)||(e.checked=!0),null==e.checked&&(e.checked=!1)})):"menu-radio"==s.type&&Array.isArray(s.items)&&s.items.forEach((e,t,i)=>{(e="string"==typeof e?i[t]={id:e,text:e}:e).checked&&null==s.selected?s.selected=e.id:e.checked=!1,e.checked||s.selected!=e.id||(e.checked=!0),null==e.checked&&(e.checked=!1)}),null==n?this.items.push(s):(l=this.get(n,!0),this.items=this.items.slice(0,l).concat([s],this.items.slice(l))),s.line=s.line||1,this.refresh(s.id)}}else console.log('ERROR: The parameter "type" is required but not supplied.',e);else console.log('ERROR: The parameter "id" is required but not supplied.',e);else console.log('ERROR: The parameter "type" should be one of the following:',s,`, but ${e.type} is supplied.`,e)}),this.resize()}remove(){let i=0;return Array.from(arguments).forEach(e=>{var t=this.get(e);t&&-1==String(e).indexOf(":")&&(i++,$(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(t.id)).remove(),null!=(t=this.get(t.id,!0))&&this.items.splice(t,1))}),this.resize(),i}set(e,t){var i=this.get(e);return null!=i&&(Object.assign(i,t),this.refresh(String(e).split(":")[0]),!0)}get(e,i){if(0===arguments.length){let t=[];for(let e=0;e<this.items.length;e++)null!=this.items[e].id&&t.push(this.items[e].id);return t}var s=String(e).split(":");for(let e=0;e<this.items.length;e++){var t=this.items[e];if(-1!=["menu","menu-radio","menu-check"].indexOf(t.type)&&2==s.length&&t.id==s[0]){let e=t.items;"function"==typeof e&&(e=e(this));for(let t=0;t<e.length;t++){var l=e[t];if(l.id==s[1]||null==l.id&&l.text==s[1])return 1==i?t:l;if(Array.isArray(l.items))for(let e=0;e<l.items.length;e++)if(l.items[e].id==s[1]||null==l.items[e].id&&l.items[e].text==s[1])return 1==i?t:l.items[e]}}else if(t.id==s[0])return 1==i?e:t}return null}setCount(e,t,i,s){let l=$(this.box).find(`#tb_${this.name}_item_${e} .w2ui-tb-count > span`);l.removeClass().addClass(i||"").text(t)[0].style.cssText=s||"",this.tmp.badge[e]={className:i||"",style:s||""};let n=this.get(e);n.count=t}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.hidden=!1,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.hidden=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.tooltipHide(e),this.resize()})},15),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.disabled=!1,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.disabled=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.tooltipHide(e)})},15),i}check(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&-1==String(e).indexOf(":")&&(t.checked=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}uncheck(){let i=this,s=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&-1==String(e).indexOf(":")&&(-1!=["menu","menu-radio","menu-check","drop","color","text-color"].indexOf(t.type)&&t.checked&&setTimeout(()=>{let e=$(i.box).find("#tb_"+i.name+"_item_"+w2utils.escapeId(t.id));e.w2overlay({name:i.name,data:{"tb-item":t.id}})},1),t.checked=!1,s.push(String(e).split(":")[0]))}),setTimeout(()=>{s.forEach(e=>{this.refresh(e)})},15),s}click(t,i){let l=this;var e=String(t).split(":");let n=this.get(e[0]),a=n&&n.items?w2utils.normMenu.call(this,n.items,n):[];if(1<e.length){var s=this.get(t);s&&!s.disabled&&l.menuClick({name:l.name,item:n,subItem:s,originalEvent:i})}else if(n&&!n.disabled){s=this.trigger({phase:"before",type:"click",target:null!=t?t:this.name,item:n,object:n,originalEvent:i});if(!0!==s.isCancelled){a=n&&n.items?w2utils.normMenu.call(this,n.items,n):[];let e="#tb_"+this.name+"_item_"+w2utils.escapeId(n.id);if($(this.box).find(e).removeClass("down"),"radio"==n.type){for(let t=0;t<this.items.length;t++){let e=this.items[t];null!=e&&e.id!=n.id&&"radio"===e.type&&e.group==n.group&&e.checked&&(e.checked=!1,this.refresh(e.id))}n.checked=!0,$(this.box).find(e).addClass("checked")}if(-1!=["menu","menu-radio","menu-check","drop","color","text-color"].indexOf(n.type)&&(l.tooltipHide(t),n.checked?setTimeout(()=>{let e=$(l.box).find("#tb_"+l.name+"_item_"+w2utils.escapeId(n.id));e.w2overlay({name:l.name,data:{"tb-item":n.id}}),n.checked=!1,l.refresh(n.id)},1):setTimeout(()=>{let t=$(l.box).find("#tb_"+l.name+"_item_"+w2utils.escapeId(n.id));$.isPlainObject(n.overlay)||(n.overlay={});let i=(t.width()-50)/2;if(19<i&&(i=19),"drop"==n.type&&t.w2overlay(n.html,$.extend({name:l.name,left:i,top:3,data:{"tb-item":n.id}},n.overlay,{onHide(e){s()}})),-1!=["menu","menu-radio","menu-check"].indexOf(n.type)){let e="normal";"menu-radio"==n.type&&(e="radio",a.forEach(e=>{n.selected==e.id?e.checked=!0:e.checked=!1})),"menu-check"==n.type&&(e="check",a.forEach(e=>{Array.isArray(n.selected)&&-1!=n.selected.indexOf(e.id)?e.checked=!0:e.checked=!1})),l.tmp.overlayEl=t,t.w2menu($.extend({name:l.name,items:a,left:i,top:3,data:{"tb-item":n.id}},n.overlay,{type:e,remove(e){l.menuClick({name:l.name,remove:!0,item:n,subItem:e.item,originalEvent:e.originalEvent,keepOpen:e.keepOpen})},select(e){l.menuClick({name:l.name,item:n,subItem:e.item,originalEvent:e.originalEvent,keepOpen:e.keepOpen})},onHide(e){s()}}))}function s(){n.checked=!1,$(l.box).find(e).removeClass("checked")}-1!=["color","text-color"].indexOf(n.type)&&$(t).w2color($.extend({color:n.color,onHide(e){s(),l._tmpColor&&l.colorClick({name:l.name,item:n,color:l._tmpColor,final:!0}),delete l._tmpColor},onSelect(e){null!=e&&(l.colorClick({name:l.name,item:n,color:e}),l._tmpColor=e)}},n.options))},1)),-1!=["check","menu","menu-radio","menu-check","drop","color","text-color"].indexOf(n.type)&&(n.checked=!n.checked,n.checked?$(this.box).find(e).addClass("checked"):$(this.box).find(e).removeClass("checked")),n.route){let t=String("/"+n.route).replace(/\/{2,}/g,"/");var r=w2utils.parseRoute(t);if(0<r.keys.length)for(let e=0;e<r.keys.length;e++)t=t.replace(new RegExp(":"+r.keys[e].name,"g"),this.routeData[r.keys[e].name]);setTimeout(()=>{window.location.hash=t},1)}i&&-1!=["button","check","radio"].indexOf(n.type)&&this.tooltipShow(t,i,!0),this.trigger($.extend(s,{phase:"after"}))}}}scroll(e,t){let i=$(this.box).find(`.w2ui-tb-line:nth-child(${t}) .w2ui-scroll-wrapper`);var s=i.scrollLeft();let l=$(i).find(".w2ui-tb-right");var n=i.outerWidth(),a=s+parseInt(l.offset().left)+parseInt(l.width());let r;switch(e){case"left":r=s-n+50,r<=0&&(r=0),i.animate({scrollLeft:r},300);break;case"right":r=s+n-50,r>=a-n&&(r=a-n),i.animate({scrollLeft:r},300)}setTimeout(()=>{this.resize()},350)}render(e){var t=(new Date).getTime(),l=this.trigger({phase:"before",type:"render",target:this.name,box:e});if(!0!==l.isCancelled&&(null!=e&&(0<$(this.box).find(".w2ui-scroll-wrapper .w2ui-tb-right").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-toolbar").html(""),this.box=e),this.box)){Array.isArray(this.right)||(this.right=[this.right]);let i="",s=0;for(let t=0;t<this.items.length;t++){let e=this.items[t];null!=e&&(null==e.id&&(e.id="item_"+t),null!=e.caption&&console.log("NOTICE: toolbar item.caption property is deprecated, please use item.text. Item -> ",e),null!=e.hint&&console.log("NOTICE: toolbar item.hint property is deprecated, please use item.tooltip. Item -> ",e),0!==t&&"new-line"!=e.type||(s++,i+=`
                    <div class="w2ui-tb-line">
                        <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                            <div class="w2ui-tb-right">${this.right[s-1]||""}</div>
                        </div>
                        <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll", "left", "${s}"]'></div>
                        <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll", "right", "${s}"]'></div>
                    </div>
                `),e.line=s)}return $(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-toolbar").html(i),0<$(this.box).length&&($(this.box)[0].style.cssText+=this.style),w2utils.bindEvents($(this.box).find(".w2ui-tb-line .w2ui-eaction"),this),this.refresh(),this.resize(),this.trigger($.extend(l,{phase:"after"})),(new Date).getTime()-t}}refresh(i){var s=(new Date).getTime(),l=this.trigger({phase:"before",type:"refresh",target:null!=i?i:this.name,item:this.get(i)});if(!0!==l.isCancelled){let t;if(null!=i){var n=this.get(i);if(null==n)return!1;if("function"!=typeof n.onRefresh||(t=this.trigger({phase:"before",type:"refresh",target:i,item:n,object:n}),!0!==t.isCancelled)){let e=$(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(n.id)}`);var a=this.getItemHTML(n);if(this.tooltipHide(i,{}),"spacer"==n.type&&$(this.box).find(`.w2ui-tb-line:nth-child(${n.line}`).find(".w2ui-tb-right").css("width","auto"),0===e.length){i=parseInt(this.get(i,!0))+1;let e=$(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(this.items[i]?this.items[i].id:"")}`);0==e.length?e=$(this.box).find(`.w2ui-tb-line:nth-child(${n.line}`).find(".w2ui-tb-right").before(a):e.after(a),w2utils.bindEvents($(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(n.id)}`),this)}else{if(-1!=["menu","menu-radio","menu-check","drop","color","text-color"].indexOf(n.type)){let e=$(this.box).find("#w2ui-overlay-"+this.name);0<e.length&&(0==n.checked?e[0].hide():-1!=["menu","menu-radio","menu-check"].indexOf(n.type)&&$(this.tmp.overlayEl).w2menu("refresh",{items:n.items}))}e.replaceWith($(a)),n.hidden?e.css("display","none"):e.css("display",""),n.disabled?e.addClass("disabled"):e.removeClass("disabled"),w2utils.bindEvents($(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(n.id)}`),this)}return"function"==typeof n.onRefresh&&this.trigger($.extend(t,{phase:"after"})),this.trigger($.extend(l,{phase:"after"})),(new Date).getTime()-s}}else for(let t=0;t<this.items.length;t++){let e=this.items[t];null==e.id&&(e.id="item_"+t),this.refresh(e.id)}}}resize(){var e=(new Date).getTime(),t=this.trigger({phase:"before",type:"resize",target:this.name});if(!0!==t.isCancelled)return $(this.box).find(".w2ui-tb-line").each((e,t)=>{let i=$(t);i.find(".w2ui-scroll-left, .w2ui-scroll-right").hide();let s=i.find(".w2ui-scroll-wrapper");var l=$(i).find(".w2ui-tb-right"),n=s.outerWidth(),a=0<l.length?l[0].offsetLeft+l[0].clientWidth:0,t=parseInt(i.css("padding-right"));n<a-t&&(0<s.scrollLeft()&&i.find(".w2ui-scroll-left").show(),l=parseInt(s.css("padding-right")),n<a-s.scrollLeft()-t-l&&i.find(".w2ui-scroll-right").show())}),this.trigger($.extend(t,{phase:"after"})),(new Date).getTime()-e}destroy(){var e=this.trigger({phase:"before",type:"destroy",target:this.name});!0!==e.isCancelled&&(0<$(this.box).find(".w2ui-scroll-wrapper  .w2ui-tb-right").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-toolbar").html(""),$(this.box).html(""),delete w2ui[this.name],this.trigger($.extend(e,{phase:"after"})))}getItemHTML(i){let e="";null!=i.caption&&null==i.text&&(i.text=i.caption),null==i.text&&(i.text=""),null==i.tooltip&&null!=i.hint&&(i.tooltip=i.hint),null==i.tooltip&&(i.tooltip=""),"function"==typeof i.get||!Array.isArray(i.items)&&"function"!=typeof i.items||(i.get=function(t){let e=i.items;return"function"==typeof e&&(e=i.items(i)),e.find(e=>e.id==t)});let t="",s="function"==typeof i.text?i.text.call(this,i):i.text;i.icon&&(t=i.icon,"function"==typeof i.icon&&(t=i.icon.call(this,i)),"<"!==String(t).substr(0,1)&&(t=`<span class="${t}"></span>`),t=`<div class="w2ui-tb-icon">${t}</div>`);let l=["w2ui-tb-button"];switch(i.checked&&l.push("checked"),i.disabled&&l.push("disabled"),i.hidden&&l.push("hidden"),t||l.push("no-icon"),i.type){case"color":case"text-color":"string"==typeof i.color&&("#"==i.color.substr(0,1)&&(i.color=i.color.substr(1)),3!=i.color.length&&6!=i.color.length||(i.color="#"+i.color)),"color"==i.type&&(s=`<span class="w2ui-tb-color-box" style="background-color: ${null!=i.color?i.color:"#fff"}"></span>
                           ${i.text?`<div style="margin-left: 17px;">${w2utils.lang(i.text)}</div>`:""}`),"text-color"==i.type&&(s='<span style="color: '+(null!=i.color?i.color:"#444")+';">'+(i.text?w2utils.lang(i.text):"<b>Aa</b>")+"</span>");case"menu":case"menu-check":case"menu-radio":case"button":case"check":case"radio":case"drop":var n=!0===i.arrow||!1!==i.arrow&&-1!=["menu","menu-radio","menu-check","drop","color","text-color"].indexOf(i.type);e=`
                    <div id="tb_${this.name}_item_${i.id}" style="${i.hidden?"display: none":""}"
                        class="${l.join(" ")} ${i.class||""}"
                        ${i.disabled?"":`data-click='["click","${i.id}"]'
                               data-mouseenter='["mouseAction", "event", "this", "enter", "${i.id}"]'
                               data-mouseleave='["mouseAction", "event", "this", "leave", "${i.id}"]'
                               data-mousedown='["mouseAction", "event", "this", "down", "${i.id}"]'
                               data-mouseup='["mouseAction", "event", "this", "up", "${i.id}"]'`}
                    >
                        ${t}
                        ${""!=s?`<div class="w2ui-tb-text" style="${i.style||""}">
                                    ${w2utils.lang(s)}
                                    ${null!=i.count?`<span class="w2ui-tb-count">
                                                <span class="${this.tmp.badge[i.id]&&this.tmp.badge[i.id].className||""}"
                                                    style="${this.tmp.badge[i.id]&&this.tmp.badge[i.id].style||""}">
                                                        ${i.count}
                                                </span>
                                           </span>`:""}
                                    ${n?'<span class="w2ui-tb-down"><span></span></span>':""}
                                </div>`:""}
                    </div>
                `;break;case"break":e=`<div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-break">&#160;</div>`;break;case"spacer":e=`<div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-spacer"></div>`;break;case"html":e=`
                    <div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-html ${l.join(" ")}"
                            style="${i.hidden?"display: none":""}; ${i.style||""}">
                        ${"function"==typeof i.html?i.html.call(this,i):i.html}
                </div>`}return e}tooltipShow(l,e,n){if(null!=this.tooltip){let e=$(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(l)),t=this.get(l),i=this.tooltip,s=t.tooltip;"function"==typeof s&&(s=s.call(this,t)),clearTimeout(this._tooltipTimer),this._tooltipTimer=setTimeout(()=>{!0!==e.prop("_mouse_tooltip")&&(e.prop("_mouse_tooltip",!0),-1!=["menu","menu-radio","menu-check","drop","color","text-color"].indexOf(t.type)&&1==t.checked||e.w2tag(w2utils.lang(s),{position:i}))},0),e.prop("_mouse_tooltip")&&1==n&&e.w2tag(w2utils.lang(s),{position:i})}}tooltipHide(t,e){if(null!=this.tooltip){let e=$(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(t));clearTimeout(this._tooltipTimer),setTimeout(()=>{!0===e.prop("_mouse_tooltip")&&(e.removeProp("_mouse_tooltip"),e.w2tag())},1)}}menuClick(t){if(t.item&&!t.item.disabled){var i=this.trigger({phase:"before",type:!0!==t.remove?"click":"remove",target:t.item.id+":"+t.subItem.id,item:t.item,subItem:t.subItem,originalEvent:t.originalEvent});if(!0!==i.isCancelled){let l=t.subItem,n=this.get(t.item.id),e=n.items;if("function"==typeof e&&(e=n.items()),"menu-radio"==n.type&&(n.selected=l.id,Array.isArray(e)&&e.forEach(e=>{!0===e.checked&&delete e.checked,Array.isArray(e.items)&&e.items.forEach(e=>{!0===e.checked&&delete e.checked})}),l.checked=!0),"menu-check"==n.type)if(Array.isArray(n.selected)||(n.selected=[]),null==l.group){var s=n.selected.indexOf(l.id);-1==s?(n.selected.push(l.id),l.checked=!0):(n.selected.splice(s,1),l.checked=!1)}else if(!1!==l.group){let s=[];!function i(e){e.forEach(e=>{var t;e.group!==l.group||-1!=(t=n.selected.indexOf(e.id))&&(e.id!=l.id&&s.push(e.id),n.selected.splice(t,1)),Array.isArray(e.items)&&i(e.items)})}(e),-1==n.selected.indexOf(l.id)&&(n.selected.push(l.id),l.checked=!0)}if("string"==typeof l.route){let t=""!==l.route?String("/"+l.route).replace(/\/{2,}/g,"/"):"";var a=w2utils.parseRoute(t);if(0<a.keys.length)for(let e=0;e<a.keys.length;e++)null!=this.routeData[a.keys[e].name]&&(t=t.replace(new RegExp(":"+a.keys[e].name,"g"),this.routeData[a.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}this.refresh(t.item.id),this.trigger($.extend(i,{phase:"after"}))}}}colorClick(e){var t;!e.item||e.item.disabled||!0!==(t=this.trigger({phase:"before",type:"click",target:e.item.id,item:e.item,color:e.color,final:e.final,originalEvent:e.originalEvent})).isCancelled&&(e.item.color=e.color,this.refresh(e.item.id),this.trigger($.extend(t,{phase:"after"})))}mouseAction(e,t,i,s){var l=this.get(s);if(!l.disabled&&!l.hidden)switch(i){case"enter":$(t).addClass("over"),this.tooltipShow(s,e);break;case"leave":$(t).removeClass("over").removeClass("down"),this.tooltipHide(s,e);break;case"down":$(t).addClass("down");break;case"up":$(t).removeClass("down")}}}class w2sidebar extends w2event{constructor(e){super(e.name),this.name=null,this.box=null,this.sidebar=null,this.parent=null,this.nodes=[],this.menu=[],this.routeData={},this.selected=null,this.icon=null,this.style="",this.topHTML="",this.bottomHTML="",this.flatButton=!1,this.keyboard=!0,this.flat=!1,this.hasFocus=!1,this.levelPadding=12,this.skipRefresh=!1,this.tabIndex=null,this.handle={size:0,style:"",html:""},this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onMenuClick=null,this.onExpand=null,this.onCollapse=null,this.onKeydown=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onFocus=null,this.onBlur=null,this.onFlat=null,this.node_template={id:null,text:"",order:null,count:null,icon:null,nodes:[],style:"",route:null,selected:!1,expanded:!1,hidden:!1,disabled:!1,group:!1,groupShowHide:!0,collapsible:!1,plus:!1,onClick:null,onDblClick:null,onContextMenu:null,onExpand:null,onCollapse:null,parent:null,sidebar:null},this.tmp={badge:{}};var t=e.nodes;delete e.nodes,$.extend(!0,this,e),Array.isArray(t)&&this.add(t),e.nodes=t}add(e,t){return 1==arguments.length&&(t=arguments[0],e=this),"string"==typeof e&&(e=this.get(e)),this.insert(e=null==e||""==e?this:e,null,t)}insert(t,i,s){let l,n,a,r,o;if(2==arguments.length&&"string"==typeof t)if(s=arguments[1],null!=(i=arguments[0])){if(n=this.get(i),null==n)return null!=(s=!Array.isArray(s)?[s]:s)[0].caption&&null==s[0].text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",s[0]),s[0].text=s[0].caption),l=s[0].text,console.log('ERROR: Cannot insert node "'+l+'" because cannot find node "'+i+'" to insert before.'),null;t=this.get(i).parent}else t=this;null!=(t="string"==typeof t?this.get(t):t)&&""!=t||(t=this),Array.isArray(s)||(s=[s]);for(let e=0;e<s.length;e++)if(r=s[e],null!=r.caption&&null==r.text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text"),r.text=r.caption),null!=typeof r.id)if(null==this.get(this,r.id)){if(a=Object.assign({},this.node_template,r),a.sidebar=this,a.parent=t,o=a.nodes||[],a.nodes=[],null==i)t.nodes.push(a);else{if(n=this.get(t,i,!0),null==n)return console.log('ERROR: Cannot insert node "'+r.text+'" because cannot find node "'+i+'" to insert before.'),null;t.nodes.splice(n,0,a)}0<o.length&&this.insert(a,null,o)}else console.log("ERROR: Cannot insert node with id="+r.id+" (text: "+r.text+") because another node with the same id already exists.");else l=r.text,console.log('ERROR: Cannot insert node "'+l+'" because it has no id.');return this.skipRefresh||this.refresh(t.id),a}remove(){let t=0,i;return Array.from(arguments).forEach(e=>{i=this.get(e),null!=i&&(null!=this.selected&&this.selected===i.id&&(this.selected=null),null!=(e=this.get(i.parent,e,!0))&&(i.parent.nodes[e].selected&&i.sidebar.unselect(i.id),i.parent.nodes.splice(e,1),t++))}),this.skipRefresh||(0<t&&1==arguments.length?this.refresh(i.parent.id):this.refresh()),t}set(t,i,s){if(2==arguments.length&&(s=i,i=t,t=this),null==(t="string"==typeof t?this.get(t):t).nodes)return null;for(let e=0;e<t.nodes.length;e++){if(t.nodes[e].id===i){var l=this.update(i,s);return 0!=Object.keys(l).length&&(l=s.nodes,$.extend(t.nodes[e],s,{nodes:[]}),null!=l&&this.add(t.nodes[e],l),this.skipRefresh||this.refresh(i)),!0}if(this.set(t.nodes[e],i,s))return!0}return!1}get(t,i,s){if(0===arguments.length){let t=[];var l=this.find({});for(let e=0;e<l.length;e++)null!=l[e].id&&t.push(l[e].id);return t}if((1==arguments.length||2==arguments.length&&!0===i)&&(s=i,i=t,t=this),null==(t="string"==typeof t?this.get(t):t).nodes)return null;for(let e=0;e<t.nodes.length;e++){if(t.nodes[e].id==i)return!0===s?e:t.nodes[e];var n=this.get(t.nodes[e],i,s);if(n||0===n)return n}return null}setCount(e,t,i,s){let l=$(this.box).find(`#node_${e} .w2ui-node-count`);l.removeClass().addClass(`w2ui-node-count ${i||""}`).text(t)[0].style.cssText=s||"",this.tmp.badge[e]={className:i||"",style:s||""};let n=this.get(e);n.count=t}find(i,s,l){if(1==arguments.length&&(s=i,i=this),l=l||[],null==(i="string"==typeof i?this.get(i):i).nodes)return l;for(let t=0;t<i.nodes.length;t++){let e=!0;for(var n in s)i.nodes[t][n]!=s[n]&&(e=!1);e&&l.push(i.nodes[t]),0<i.nodes[t].nodes.length&&(l=this.find(i.nodes[t],s,l))}return l}sort(l,e){null==(l=!l||"object"!=typeof l?{}:l).foldersFirst&&(l.foldersFirst=!0),null==l.caseSensitive&&(l.caseSensitive=!1),null==l.reverse&&(l.reverse=!1),(e=null==e?this.nodes:e).sort((i,s)=>{var e=i.nodes&&0<i.nodes.length,t=s.nodes&&0<s.nodes.length;if(!1===l.foldersFirst||!e&&!t||e&&t){let e=i.text,t=s.text;l.caseSensitive||(e=e.toLowerCase(),t=t.toLowerCase()),null!=i.order&&(e=i.order),null!=s.order&&(t=s.order);s=w2utils.naturalCompare(e,t);return(1===s||-1===s)&l.reverse?-s:s}return e&&!t?l.reverse?1:-1:!e&&t?l.reverse?-1:1:void 0}),e.forEach(e=>{e.nodes&&0<e.nodes.length&&this.sort(l,e.nodes)})}each(t,e){(e=null==e?this.nodes:e).forEach(e=>{t.call(this,e),e.nodes&&0<e.nodes.length&&this.each(t,e.nodes)})}search(e){let t=0,i=e.toLowerCase();return this.each(e=>{-1===e.text.toLowerCase().indexOf(i)?e.hidden=!0:(t++,function e(t){t.parent&&(t.parent.hidden=!1,e(t.parent))}(e),e.hidden=!1)}),this.refresh(),t}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!1!==t.hidden&&(t.hidden=!1,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!0!==t.hidden&&(t.hidden=!0,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!1!==t.disabled&&(t.disabled=!1,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!0!==t.disabled&&(t.disabled=!0,t.selected&&this.unselect(t.id),i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}select(e){let t=this.get(e);if(!t)return!1;if(this.selected==e&&t.selected)return!1;this.unselect(this.selected);let i=$(this.box).find("#node_"+w2utils.escapeId(e));return i.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),0<i.length&&this.scrollIntoView(e,!0),t.selected=!0,this.selected=e,!0}unselect(e){0===arguments.length&&(e=this.selected);let t=this.get(e);return!!t&&(t.selected=!1,$(this.box).find("#node_"+w2utils.escapeId(e)).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),this.selected==e&&(this.selected=null),!0)}toggle(e){var t=this.get(e);return null!=t&&(t.plus?(this.set(e,{plus:!1}),this.expand(e),void this.refresh(e)):0!==t.nodes.length&&(!!t.collapsible&&(this.get(e).expanded?this.collapse(e):this.expand(e))))}collapse(e){let t=this,i=this.get(e);if(null==i)return!1;var s=this.trigger({phase:"before",type:"collapse",target:e,object:i});return!0!==s.isCancelled?($(this.box).find("#node_"+w2utils.escapeId(e)+"_sub").slideUp(200),$(this.box).find("#node_"+w2utils.escapeId(e)+" .w2ui-expanded").removeClass("w2ui-expanded").addClass("w2ui-collapsed"),i.expanded=!1,this.trigger($.extend(s,{phase:"after"})),setTimeout(()=>{t.refresh(e)},200),!0):void 0}collapseAll(t){if(null==(t="string"==typeof(t=null==t?this:t)?this.get(t):t).nodes)return!1;for(let e=0;e<t.nodes.length;e++)!0===t.nodes[e].expanded&&(t.nodes[e].expanded=!1),t.nodes[e].nodes&&0<t.nodes[e].nodes.length&&this.collapseAll(t.nodes[e]);return this.refresh(t.id),!0}expand(e){let t=this,i=this.get(e);var s=this.trigger({phase:"before",type:"expand",target:e,object:i});if(!0!==s.isCancelled)return $(this.box).find("#node_"+w2utils.escapeId(e)+"_sub").slideDown(200),$(this.box).find("#node_"+w2utils.escapeId(e)+" .w2ui-collapsed").removeClass("w2ui-collapsed").addClass("w2ui-expanded"),i.expanded=!0,this.trigger($.extend(s,{phase:"after"})),setTimeout(()=>{t.refresh(e)},200),!0}expandAll(t){if(null==(t="string"==typeof(t=null==t?this:t)?this.get(t):t).nodes)return!1;for(let e=0;e<t.nodes.length;e++)!1===t.nodes[e].expanded&&(t.nodes[e].expanded=!0),t.nodes[e].nodes&&0<t.nodes[e].nodes.length&&this.expandAll(t.nodes[e]);this.refresh(t.id)}expandParents(e){let t=this.get(e);return null!=t&&(t.parent&&(t.parent.expanded||(t.parent.expanded=!0,this.refresh(t.parent.id)),this.expandParents(t.parent.id)),!0)}click(l,n){let a=this,r=this.get(l);if(null!=r&&!r.disabled&&!r.group){$(a.box).find(".w2ui-node.w2ui-selected").each((e,t)=>{var i=$(t).attr("id").replace("node_","");let s=a.get(i);null!=s&&(s.selected=!1),$(t).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected")});let t=$(a.box).find("#node_"+w2utils.escapeId(l)),s=$(a.box).find("#node_"+w2utils.escapeId(a.selected));t.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),setTimeout(()=>{var e=a.trigger({phase:"before",type:"click",target:l,originalEvent:n,node:r,object:r});if(!0===e.isCancelled)return t.removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),void s.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected");if(null!=s&&(s.selected=!1),a.get(l).selected=!0,a.selected=l,"string"==typeof r.route){let t=""!==r.route?String("/"+r.route).replace(/\/{2,}/g,"/"):"";var i=w2utils.parseRoute(t);if(0<i.keys.length)for(let e=0;e<i.keys.length;e++)null!=a.routeData[i.keys[e].name]&&(t=t.replace(new RegExp(":"+i.keys[e].name,"g"),a.routeData[i.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}a.trigger($.extend(e,{phase:"after"}))},1)}}focus(e){let t=this;e=this.trigger({phase:"before",type:"focus",target:this.name,originalEvent:e});if(!0===e.isCancelled)return!1;this.hasFocus=!0,$(this.box).find(".w2ui-sidebar-body").addClass("w2ui-focus"),setTimeout(()=>{let e=$(t.box).find("#sidebar_"+t.name+"_focus");e.is(":focus")||e.focus()},10),this.trigger($.extend(e,{phase:"after"}))}blur(e){e=this.trigger({phase:"before",type:"blur",target:this.name,originalEvent:e});if(!0===e.isCancelled)return!1;this.hasFocus=!1,$(this.box).find(".w2ui-sidebar-body").removeClass("w2ui-focus"),this.trigger($.extend(e,{phase:"after"}))}keydown(e){let a=this,t=a.get(a.selected);var i;function s(e,t){null==e||e.hidden||e.disabled||e.group||(a.click(e.id,t),setTimeout(()=>{a.scrollIntoView()},50))}function l(e,t){for(e=t(e);null!=e&&(e.hidden||e.disabled)&&!e.group;)e=t(e);return e}function n(e){if(null==e)return null;var t=e.parent,e=a.get(e.id,!0);let i=0<e?function t(i){if(i.expanded&&0<i.nodes.length){let e=i.nodes[i.nodes.length-1];return(e.hidden||e.disabled||e.group?n:t)(e)}return i}(t.nodes[e-1]):t;return null!=i&&(i.hidden||i.disabled||i.group)&&(i=n(i)),i}!0===a.keyboard&&(t=t||a.nodes[0],!0!==(i=a.trigger({phase:"before",type:"keydown",target:a.name,originalEvent:e})).isCancelled&&(13!=e.keyCode&&32!=e.keyCode||0<t.nodes.length&&a.toggle(a.selected),37==e.keyCode&&(0<t.nodes.length&&t.expanded?a.collapse(a.selected):(s(t.parent),t.parent.group||a.collapse(t.parent.id))),39==e.keyCode&&(0<t.nodes.length||t.plus)&&!t.expanded&&a.expand(a.selected),38==e.keyCode&&(null==a.get(a.selected)?s(this.nodes[0]||null):s(l(t,n))),40==e.keyCode&&(null==a.get(a.selected)?s(this.nodes[0]||null):s(l(t,function t(i,e){if(null==i)return null;let s=i.parent;let l=a.get(i.id,!0);let n=null;if(i.expanded&&0<i.nodes.length&&!0!==e){let e=i.nodes[0];n=e.hidden||e.disabled||e.group?t(e):e}else n=s&&l+1<s.nodes.length?s.nodes[l+1]:t(s,!0);null!=n&&(n.hidden||n.disabled||n.group)&&(n=t(n));return n}))),-1!=$.inArray(e.keyCode,[13,32,37,38,39,40])&&(e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()),a.trigger($.extend(i,{phase:"after"}))))}scrollIntoView(i,s){if(null==i&&(i=this.selected),null!=this.get(i)){let e=$(this.box).find(".w2ui-sidebar-body"),t=$(this.box).find("#node_"+w2utils.escapeId(i));i=t.offset().top-e.offset().top;(i+t.height()>e.height()||i<=0)&&e.animate({scrollTop:e.scrollTop()+i-e.height()/2+t.height()},s?0:250,"linear")}}dblClick(e,t){var i=this.get(e),i=this.trigger({phase:"before",type:"dblClick",target:e,originalEvent:t,object:i});!0!==i.isCancelled&&(this.toggle(e),this.trigger($.extend(i,{phase:"after"})))}contextMenu(t,e){let i=this;var s=i.get(t);t!=i.selected&&i.click(t);var l=i.trigger({phase:"before",type:"contextMenu",target:t,originalEvent:e,object:s,allowOnDisabled:!1});!0!==l.isCancelled&&(s.disabled&&!l.allowOnDisabled||(0<i.menu.length&&$(i.box).find("#node_"+w2utils.escapeId(t)).w2menu({items:i.menu,contextMenu:!0,originalEvent:e,onSelect(e){i.menuClick(t,parseInt(e.index),e.originalEvent)}}),e.preventDefault&&e.preventDefault(),i.trigger($.extend(l,{phase:"after"}))))}menuClick(e,t,i){t=this.trigger({phase:"before",type:"menuClick",target:e,originalEvent:i,menuIndex:t,menuItem:this.menu[t]});!0!==t.isCancelled&&this.trigger($.extend(t,{phase:"after"}))}goFlat(){var e=this.trigger({phase:"before",type:"flat",goFlat:!this.flat});!0!==e.isCancelled&&(this.flat=!this.flat,this.refresh(),this.trigger($.extend(e,{phase:"after"})))}render(e){var i=(new Date).getTime();let s=this;var l=this.trigger({phase:"before",type:"render",target:this.name,box:e});if(!0!==l.isCancelled&&(null!=e&&(0<$(this.box).find("> div > div.w2ui-sidebar-body").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-sidebar").html(""),this.box=e),this.box)){$(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-sidebar").html('<div><input id="sidebar_'+this.name+'_focus" '+(this.tabIndex?'tabindex="'+this.tabIndex+'"':"")+'   style="position: absolute; top: 0; right: 0; width: 1px; z-index: -1; opacity: 0" '+(w2utils.isIOS?"readonly":"")+'/><div class="w2ui-sidebar-top"></div><div class="w2ui-sidebar-body"></div><div class="w2ui-sidebar-bottom"></div></div>'),$(this.box).find("> div").css({width:$(this.box).width()+"px",height:$(this.box).height()+"px"}),0<$(this.box).length&&($(this.box)[0].style.cssText+=this.style);let e="";1==this.flatButton&&(e='<div class="w2ui-flat-'+(this.flat?"right":"left")+'" onclick="w2ui[\''+this.name+"'].goFlat()\"></div>"),""===this.topHTML&&""===e||($(this.box).find(".w2ui-sidebar-top").html(this.topHTML+e),$(this.box).find(".w2ui-sidebar-body").css("top",$(this.box).find(".w2ui-sidebar-top").height()+"px")),""!==this.bottomHTML&&($(this.box).find(".w2ui-sidebar-bottom").html(this.bottomHTML),$(this.box).find(".w2ui-sidebar-body").css("bottom",$(this.box).find(".w2ui-sidebar-bottom").height()+"px"));let t;return $(this.box).find("#sidebar_"+this.name+"_focus").on("focus",function(e){clearTimeout(t),s.hasFocus||s.focus(e)}).on("blur",function(e){t=setTimeout(()=>{s.hasFocus&&s.blur(e)},100)}).on("keydown",function(e){9!=e.keyCode&&w2ui[s.name].keydown.call(w2ui[s.name],e)}),$(this.box).off("mousedown").on("mousedown",function(i){setTimeout(()=>{if(-1==["INPUT","TEXTAREA","SELECT"].indexOf(i.target.tagName.toUpperCase())){let e=$(s.box).find("#sidebar_"+s.name+"_focus");var t;e.is(":focus")||($(i.target).hasClass("w2ui-node")&&(t=$(i.target).position().top+$(s.box).find(".w2ui-sidebar-top").height()+i.offsetY,e.css({top:t+"px",left:"0px"})),e.focus())}},1)}),this.trigger($.extend(l,{phase:"after"})),this.refresh(),(new Date).getTime()-i}}update(e,i){let s=this.get(e),l;if(s){let t=$(this.box).find("#node_"+w2utils.escapeId(s.id));if(s.group)i.text&&(s.text=i.text,t.find(".w2ui-group-text").replaceWith("function"==typeof s.text?s.text.call(this,s):'<span class="w2ui-group-text">'+s.text+"</span>"),delete i.text),i.class&&(s.class=i.class,l=t.data("level"),t[0].className="w2ui-node-group w2ui-level-"+l+(s.class?" "+s.class:""),delete i.class),i.style&&(s.style=i.style,t.next()[0].style=s.style+";"+(!s.hidden&&s.expanded?"":"display: none;"),delete i.style);else{if(i.icon){let e=t.find(".w2ui-node-image > span");0<e.length&&(s.icon=i.icon,e[0].className="function"==typeof s.icon?s.icon.call(this,s):s.icon,delete i.icon)}if(i.count&&(s.count=i.count,t.find(".w2ui-node-count").html(s.count),0<t.find(".w2ui-node-count").length&&delete i.count),i.class&&0<t.length&&(s.class=i.class,l=t.data("level"),t[0].className="w2ui-node w2ui-level-"+l+(s.selected?" w2ui-selected":"")+(s.disabled?" w2ui-disabled":"")+(s.class?" "+s.class:""),delete i.class),i.text&&(s.text=i.text,t.find(".w2ui-node-text").html("function"==typeof s.text?s.text.call(this,s):s.text),delete i.text),i.style&&0<t.length){let e=t.find(".w2ui-node-text");s.style=i.style,e[0].style=s.style,delete i.style}}}return i}refresh(l,n){if(null!=this.box){var a=(new Date).getTime(),r=this.trigger({phase:"before",type:"refresh",target:null!=l?l:this.name,fullRefresh:null==l});if(!0!==r.isCancelled){let e="";1==this.flatButton&&(e='<div class="w2ui-flat-'+(this.flat?"right":"left")+'" onclick="w2ui[\''+this.name+"'].goFlat()\"></div>"),""===this.topHTML&&""===e||($(this.box).find(".w2ui-sidebar-top").html(this.topHTML+e),$(this.box).find(".w2ui-sidebar-body").css("top",$(this.box).find(".w2ui-sidebar-top").height()+"px")),""!==this.bottomHTML&&($(this.box).find(".w2ui-sidebar-bottom").html(this.bottomHTML),$(this.box).find(".w2ui-sidebar-body").css("bottom",$(this.box).find(".w2ui-sidebar-bottom").height()+"px")),$(this.box).find("> div").removeClass("w2ui-sidebar-flat").addClass(this.flat?"w2ui-sidebar-flat":"").css({width:$(this.box).width()+"px",height:$(this.box).height()+"px"}),0<this.nodes.length&&null==this.nodes[0].parent&&(o=this.nodes,this.nodes=[],this.add(this,o));let d=this,t,i;if(null==l)t=this,i=".w2ui-sidebar-body";else{if(t=this.get(l),null==t)return;i="#node_"+w2utils.escapeId(t.id)+"_sub"}var o="#node_"+w2utils.escapeId(t.id);let s;t!==this&&(s=u(t),$(this.box).find(o).before('<div id="sidebar_'+this.name+'_tmp"></div>'),$(this.box).find(o).remove(),$(this.box).find(i).remove(),$(this.box).find("#sidebar_"+this.name+"_tmp").before(s),$(this.box).find("#sidebar_"+this.name+"_tmp").remove());l={top:$(this.box).find(i).scrollTop(),left:$(this.box).find(i).scrollLeft()};$(this.box).find(i).html("");for(let e=0;e<t.nodes.length;e++){var h=t.nodes[e];if(s=u(h),$(this.box).find(i).append(s),0!==h.nodes.length)this.refresh(h.id,!0);else{h=this.trigger({phase:"before",type:"refresh",target:h.id});if(!0===h.isCancelled)return;this.trigger($.extend(h,{phase:"after"}))}}return $(this.box).find(i).scrollLeft(l.left).scrollTop(l.top),n||(o=$(this.box).find(`${o}.w2ui-eaction, ${i} .w2ui-eaction`),w2utils.bindEvents(o,this)),this.trigger($.extend(r,{phase:"after"})),(new Date).getTime()-a;function u(i){let s="",l=i.icon;null==l&&(l=d.icon);let n=i.parent,a=0;for(;n&&null!=n.parent;)n=n.parent,a++;if(null!=i.caption&&null==i.text&&(i.text=i.caption),null!=i.caption&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",i),i.text=i.caption),Array.isArray(i.nodes)&&0<i.nodes.length&&(i.collapsible=!0),i.group){let e=w2utils.lang("function"==typeof i.text?i.text.call(d,i):i.text);"<span"!=String(e).substr(0,5)&&(e=`<span class="w2ui-group-text">${e}</span>`),s=`
                    <div id="node_${i.id}" data-level="${a}" style="${i.hidden?"display: none":""}"
                        class="w2ui-node-group w2ui-level-${a} ${i.class||""} w2ui-eaction"
                        data-click="toggle|${i.id}"
                        data-contextmenu="contextMenu|${i.id}|event"
                        data-mouseenter="showPlus|this|inherit"
                        data-mouseleave="showPlus|this|transparent">
                        ${i.groupShowHide&&i.collapsible?`<span>${!i.hidden&&i.expanded?w2utils.lang("Hide"):w2utils.lang("Show")}</span>`:"<span></span>"} ${e}
                    </div>
                    <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}">
                </div>`,d.flat&&(s=`
                        <div class="w2ui-node-group" id="node_${i.id}"><span>&#160;</span></div>
                        <div id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`)}else{i.selected&&!i.disabled&&(d.selected=i.id),n="",l&&(n=`
                    <div class="w2ui-node-image">
                        <span class="${"function"==typeof l?l.call(d,i):l}"></span>
                    </div>`);let e="";var r=null!=i.count?`<div class="w2ui-node-count ${d.tmp.badge[i.id]&&d.tmp.badge[i.id].className||""}"
                            style="${d.tmp.badge[i.id]&&d.tmp.badge[i.id].style||""}">
                                ${i.count}
                       </div>`:"";!0===i.collapsible&&(e=`<div class="w2ui-${i.expanded?"expanded":"collapsed"}"><span></span></div>`);var o=w2utils.lang("function"==typeof i.text?i.text.call(d,i):i.text);let t=["w2ui-node",`w2ui-level-${a}`,"w2ui-eaction"];i.selected&&t.push("w2ui-selected"),i.disabled&&t.push("w2ui-disabled"),i.class&&t.push(i.class),s=`
                    <div id="node_${i.id}" class="${t.join(" ")}" data-level="${a}"
                        style="position: relative; ${i.hidden?"display: none;":""}"
                        data-click="click|${i.id}|event"
                        data-dblclick="dblClick|${i.id}|event"
                        data-contextmenu="contextMenu|${i.id}|event">
                        ${d.handle.html?`<div class="w2ui-node-handle" style="width: ${d.handle.size}px; ${d.handle.style}">
                                   ${"function"==typeof d.handle.html?d.handle.html.call(d,i):d.handle.html}
                              </div>`:""}
                      <div class="w2ui-node-data" style="margin-left: ${a*d.levelPadding+d.handle.size}px">
                            ${e} ${n} ${r}
                            <div class="w2ui-node-text w2ui-node-caption" style="${i.style||""}">${o}</div>
                       </div>
                    </div>
                    <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`,d.flat&&(o=w2utils.base64encode(o+(i.count||0===i.count?' - <span class="w2ui-node-count">'+i.count+"</span>":"")),s=`
                        <div id="node_${i.id}" class="${t.join(" ")}" style="${i.hidden?"display: none;":""}"
                            data-click="click|${i.id}|event"
                            data-dblclick="dblClick|${i.id}|event"
                            data-contextmenu="contextMenu|${i.id}|event"
                            data-mouseenter="tooltip|this|${o}|${i.id}"
                            data-mouseleave="tooltip|this|">
                            <div class="w2ui-node-data w2ui-node-flat">${n}</div>
                        </div>
                        <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`)}return s}}}}tooltip(e,t,i){let s=$(e).find(".w2ui-node-data");""!==t?$(e).find(".w2ui-node-data").w2tag(w2utils.base64decode(t),{id:i,left:-5}):s.w2tag()}showPlus(e,t){$(e).find("span:nth-child(1)").css("color",t)}resize(){var e=(new Date).getTime(),t=this.trigger({phase:"before",type:"resize",target:this.name});if(!0!==t.isCancelled)return $(this.box).css("overflow","hidden"),$(this.box).find("> div").css({width:$(this.box).width()+"px",height:$(this.box).height()+"px"}),this.trigger($.extend(t,{phase:"after"})),(new Date).getTime()-e}destroy(){var e=this.trigger({phase:"before",type:"destroy",target:this.name});!0!==e.isCancelled&&(0<$(this.box).find("> div > div.w2ui-sidebar-body").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-sidebar").html(""),delete w2ui[this.name],this.trigger($.extend(e,{phase:"after"})))}lock(e,t){let i=Array.prototype.slice.call(arguments,0);i.unshift(this.box),w2utils.lock.apply(window,i)}unlock(e){w2utils.unlock(this.box,e)}}let custom={};function addType(e,t){return e=String(e).toLowerCase(),custom[e]=t,!0}function removeType(e){return e=String(e).toLowerCase(),!!custom[e]&&(delete custom[e],!0)}class w2field extends w2event{constructor(e,t){super(),"string"==typeof e&&null==t&&(t={type:e}),"object"==typeof e&&null==t&&(t=$.extend(!0,{},e)),"string"==typeof e&&"object"==typeof t&&(t.type=e),t.type=String(t.type).toLowerCase(),this.options=t,this.el=null,this.helpers={},this.type=t.type||"text",this.options=$.extend(!0,{},t),this.onSearch=t.onSearch||null,this.onRequest=t.onRequest||null,this.onLoad=t.onLoad||null,this.onError=t.onError||null,this.onClick=t.onClick||null,this.onAdd=t.onAdd||null,this.onNew=t.onNew||null,this.onRemove=t.onRemove||null,this.onMouseOver=t.onMouseOver||null,this.onMouseOut=t.onMouseOut||null,this.onIconClick=t.onIconClick||null,this.onScroll=t.onScroll||null,this.tmp={},delete this.options.type,delete this.options.onSearch,delete this.options.onRequest,delete this.options.onLoad,delete this.options.onError,delete this.options.onClick,delete this.options.onMouseOver,delete this.options.onMouseOut,delete this.options.onIconClick,delete this.options.onScroll}render(e){0!=$(e).length?(this.el=$(e)[0],this.init()):console.log("ERROR: Cannot init w2field on empty set")}init(){let t=this,i=this.options,e;if("function"!=typeof custom[this.type])if(-1!=["INPUT","TEXTAREA"].indexOf(this.el.tagName.toUpperCase())){switch(this.type){case"text":case"int":case"float":case"money":case"currency":case"percent":case"alphanumeric":case"bin":case"hex":e={min:null,max:null,step:1,autoFormat:!0,autoCorrect:!0,currencyPrefix:w2utils.settings.currencyPrefix,currencySuffix:w2utils.settings.currencySuffix,currencyPrecision:w2utils.settings.currencyPrecision,decimalSymbol:w2utils.settings.decimalSymbol,groupSymbol:w2utils.settings.groupSymbol,arrows:!1,keyboard:!0,precision:null,prefix:"",suffix:""},this.options=$.extend(!0,{},e,i),i=this.options,i.numberRE=new RegExp("["+i.groupSymbol+"]","g"),i.moneyRE=new RegExp("["+i.currencyPrefix+i.currencySuffix+i.groupSymbol+"]","g"),i.percentRE=new RegExp("["+i.groupSymbol+"%]","g"),-1!==["text","alphanumeric","hex","bin"].indexOf(this.type)&&(i.arrows=!1,i.keyboard=!1),this.addPrefix(),this.addSuffix();break;case"color":e={prefix:"",suffix:'<div style="width: '+(parseInt($(this.el).css("font-size"))||12)+'px">&#160;</div>',arrows:!1,keyboard:!1,advanced:null,transparent:!0},this.options=$.extend(!0,{},e,i),i=this.options,this.addPrefix(),this.addSuffix(),""!==$(this.el).val()&&setTimeout(()=>{t.change()},1);break;case"date":e={format:w2utils.settings.dateFormat,keyboard:!0,autoCorrect:!0,start:"",end:"",blocked:{},colored:{},blockWeekDays:null},this.options=$.extend(!0,{},e,i),i=this.options,null==$(this.el).attr("placeholder")&&$(this.el).attr("placeholder",i.format);break;case"time":e={format:w2utils.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:"",end:"",noMinutes:!1},this.options=$.extend(!0,{},e,i),i=this.options,null==$(this.el).attr("placeholder")&&$(this.el).attr("placeholder",i.format);break;case"datetime":e={format:w2utils.settings.dateFormat+" | "+w2utils.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:"",end:"",blocked:[],colored:{},placeholder:null,btn_now:!0,noMinutes:!1},this.options=$.extend(!0,{},e,i),i=this.options,null==$(this.el).attr("placeholder")&&$(this.el).attr("placeholder",i.placeholder||i.format);break;case"list":case"combo":if(e={items:[],selected:{},url:null,recId:null,recText:null,method:null,interval:350,postData:{},minLength:1,cacheMax:250,maxDropHeight:350,maxDropWidth:null,minDropWidth:null,match:"begins",icon:null,iconStyle:"",align:"both",altRows:!0,onSearch:null,onRequest:null,onLoad:null,onError:null,onIconClick:null,renderDrop:null,compare:null,filter:!0,prefix:"",suffix:"",openOnFocus:!1,markSearch:!1},"function"==typeof i.items&&(i._items_fun=i.items),i.items=w2utils.normMenu.call(this,i.items),"list"===this.type){if(e.openOnFocus=!0,$(this.el).addClass("w2ui-select"),!$.isPlainObject(i.selected)&&Array.isArray(i.items))for(let e=0;e<i.items.length;e++){var s=i.items[e];if(s&&s.id===i.selected){i.selected=$.extend(!0,{},s);break}}this.watchSize()}i=$.extend({},e,i),this.options=i,$.isPlainObject(i.selected)||(i.selected={}),$(this.el).data("selected",i.selected),i.url&&(i.items=[],this.request(0)),"list"===this.type&&this.addFocus(),this.addPrefix(),this.addSuffix(),setTimeout(()=>{t.refresh()},10),$(this.el).attr("autocapitalize","off").attr("autocomplete","off").attr("autocorrect","off").attr("spellcheck","false"),null!=i.selected.text&&$(this.el).val(i.selected.text);break;case"enum":e={items:[],selected:[],max:0,url:null,recId:null,recText:null,interval:350,method:null,postData:{},minLength:1,cacheMax:250,maxWidth:250,maxHeight:350,maxDropHeight:350,maxDropWidth:null,match:"contains",align:"both",altRows:!0,openOnFocus:!1,markSearch:!0,renderDrop:null,renderItem:null,compare:null,filter:!0,style:"",onSearch:null,onRequest:null,onLoad:null,onError:null,onClick:null,onAdd:null,onNew:null,onRemove:null,onMouseOver:null,onMouseOut:null,onScroll:null},i=$.extend({},e,i,{suffix:""}),"function"==typeof i.items&&(i._items_fun=i.items),i.items=w2utils.normMenu.call(this,i.items),i.selected=w2utils.normMenu.call(this,i.selected),this.options=i,Array.isArray(i.selected)||(i.selected=[]),$(this.el).data("selected",i.selected),i.url&&(i.items=[],this.request(0)),this.addSuffix(),this.addMulti(),this.watchSize();break;case"file":e={selected:[],max:0,maxSize:0,maxFileSize:0,maxWidth:250,maxHeight:350,maxDropHeight:350,maxDropWidth:null,readContent:!0,silent:!0,align:"both",altRows:!0,renderItem:null,style:"",onClick:null,onAdd:null,onRemove:null,onMouseOver:null,onMouseOut:null},i=$.extend({},e,i),this.options=i,Array.isArray(i.selected)||(i.selected=[]),$(this.el).data("selected",i.selected),null==$(this.el).attr("placeholder")&&$(this.el).attr("placeholder",w2utils.lang("Attach files by dragging and dropping or Click to Select")),this.addMulti(),this.watchSize()}this.tmp={onChange(e){t.change.call(t,e)},onClick(e){t.click.call(t,e)},onFocus(e){t.focus.call(t,e)},onBlur(e){t.blur.call(t,e)},onKeydown(e){t.keyDown.call(t,e)},onKeyup(e){t.keyUp.call(t,e)},onKeypress(e){t.keyPress.call(t,e)}},$(this.el).addClass("w2field w2ui-input").data("w2field",this).on("change.w2field",this.tmp.onChange).on("click.w2field",this.tmp.onClick).on("focus.w2field",this.tmp.onFocus).on("blur.w2field",this.tmp.onBlur).on("keydown.w2field",this.tmp.onKeydown).on("keyup.w2field",this.tmp.onKeyup).on("keypress.w2field",this.tmp.onKeypress).css(w2utils.cssPrefix("box-sizing","border-box")),this.change($.Event("change"))}else console.log("ERROR: w2field could only be applied to INPUT or TEXTAREA.",this.el);else custom[this.type].call(this,i)}watchSize(){let e=this,t=$(e.el).data("tmp")||{};t.sizeTimer=setInterval(()=>{0<$(e.el).parents("body").length?e.resize():clearInterval(t.sizeTimer)},200),$(e.el).data("tmp",t)}get(){let e;return e=-1!==["list","enum","file"].indexOf(this.type)?$(this.el).data("selected"):$(this.el).val(),e}set(e,t){-1!==["list","enum","file"].indexOf(this.type)?("list"!==this.type&&t?(null==$(this.el).data("selected")&&$(this.el).data("selected",[]),$(this.el).data("selected").push(e),$(this.el).trigger("input").trigger("change")):(t="enum"===this.type?[e]:e,$(this.el).data("selected",t).trigger("input").trigger("change")),this.refresh()):$(this.el).val(e)}setIndex(e,t){if(-1!==["list","enum"].indexOf(this.type)){var i=this.options.items;if(i&&i[e])return"list"!==this.type&&t?(null==$(this.el).data("selected")&&$(this.el).data("selected",[]),$(this.el).data("selected").push(i[e]),$(this.el).trigger("input").trigger("change")):(e="enum"===this.type?[i[e]]:i[e],$(this.el).data("selected",e).trigger("input").trigger("change")),this.refresh(),!0}return!1}clear(){var e=this.options;-1!==["money","currency"].indexOf(this.type)&&$(this.el).val($(this.el).val().replace(e.moneyRE,"")),"percent"===this.type&&$(this.el).val($(this.el).val().replace(/%/g,"")),"list"===this.type&&$(this.el).removeClass("w2ui-select"),this.type="clear";e=$(this.el).data("tmp");if(this.tmp){for(var t in null!=e&&($(this.el).height("auto"),e&&e["old-padding-left"]&&$(this.el).css("padding-left",e["old-padding-left"]),e&&e["old-padding-right"]&&$(this.el).css("padding-right",e["old-padding-right"]),e&&e["old-background-color"]&&$(this.el).css("background-color",e["old-background-color"]),e&&e["old-border-color"]&&$(this.el).css("border-color",e["old-border-color"]),clearInterval(e.sizeTimer)),$(this.el).val(this.clean($(this.el).val())).removeClass("w2field").removeData().off(".w2field"),this.helpers)$(this.helpers[t]).remove();this.helpers={}}}refresh(){let n=this,l=this.options,a=$(this.el).data("selected");var e=(new Date).getTime();if(-1!==["list"].indexOf(this.type)&&($(n.el).parent().css("white-space","nowrap"),n.helpers.prefix&&n.helpers.prefix.hide(),setTimeout(()=>{if(n.helpers.focus){!$.isEmptyObject(a)&&l.icon?l.prefix='<span class="w2ui-icon '+l.icon+'"style="cursor: pointer; font-size: 14px; display: inline-block; margin-top: -1px; color: #7F98AD;'+l.iconStyle+'"></span>':l.prefix="",n.addPrefix();let e=n.helpers.focus.find("input");""===$(e).val()?($(e).css({"text-indent":"-9999em",outline:"none"}).prev().css("opacity",0),$(n.el).val(a&&null!=a.text?w2utils.lang(a.text):"")):($(e).css("text-indent",0).prev().css("opacity",1),$(n.el).val(""),setTimeout(()=>{n.helpers.prefix&&n.helpers.prefix.hide(),l.icon?($(e).css("margin-left","17px"),$(n.helpers.focus).find(".w2ui-icon-search").addClass("show-search")):($(e).css("margin-left","0px"),$(n.helpers.focus).find(".w2ui-icon-search").removeClass("show-search"))},1)),$(n.el).prop("readonly")||$(n.el).prop("disabled")?setTimeout(()=>{$(n.helpers.prefix).css("opacity","0.6"),$(n.helpers.suffix).css("opacity","0.6")},1):setTimeout(()=>{$(n.helpers.prefix).css("opacity","1"),$(n.helpers.suffix).css("opacity","1")},1)}},1)),-1!==["enum","file"].indexOf(this.type)){let i="";if(a)for(let t=0;t<a.length;t++){var r=a[t];let e="";e="function"==typeof l.renderItem?l.renderItem(r,t,'<div class="w2ui-list-remove" title="'+w2utils.lang("Remove")+'" index="'+t+'">&#160;&#160;</div>'):'<div class="w2ui-list-remove" title="'+w2utils.lang("Remove")+'" index="'+t+'">&#160;&#160;</div>'+("enum"===n.type?r.text:r.name+'<span class="file-size"> - '+w2utils.formatSize(r.size)+"</span>"),i+='<li index="'+t+'" style="max-width: '+parseInt(l.maxWidth)+"px; "+(r.style||"")+'">'+e+"</li>"}let e=n.helpers.multi,t=e.find("ul");e.attr("style",e.attr("style")+";"+l.style),$(n.el).css("z-index","-1"),$(n.el).prop("readonly")||$(n.el).prop("disabled")?setTimeout(()=>{e[0].scrollTop=0,e.addClass("w2ui-readonly").find("li").css("opacity","0.9").parent().find("li.nomouse").hide().find("input").prop("readonly",!0).parents("ul").find(".w2ui-list-remove").hide()},1):setTimeout(()=>{e.removeClass("w2ui-readonly").find("li").css("opacity","1").parent().find("li.nomouse").show().find("input").prop("readonly",!1).parents("ul").find(".w2ui-list-remove").show()},1),e.find(".w2ui-enum-placeholder").remove(),t.find("li").not("li.nomouse").remove(),""!==i?t.prepend(i):null!=$(n.el).attr("placeholder")&&""===e.find("input").val()&&(o="padding-top: "+$(this.el).css("padding-top")+";padding-left: "+$(this.el).css("padding-left")+"; box-sizing: "+$(this.el).css("box-sizing")+"; line-height: "+$(this.el).css("line-height")+"; font-size: "+$(this.el).css("font-size")+"; font-family: "+$(this.el).css("font-family")+"; ",e.prepend('<div class="w2ui-enum-placeholder" style="'+o+'">'+$(n.el).attr("placeholder")+"</div>")),e.off("scroll.w2field").on("scroll.w2field",function(e){e=n.trigger({phase:"before",type:"scroll",target:n.el,originalEvent:e});!0!==e.isCancelled&&n.trigger($.extend(e,{phase:"after"}))}).find("li").data("mouse","out").on("click",function(t){var i="LI"===t.target.tagName.toUpperCase()?t.target:$(t.target).parents("LI"),s=a[$(i).attr("index")];if(!$(i).hasClass("nomouse")){t.stopPropagation();let e;if($(t.target).hasClass("w2ui-list-remove"))$(n.el).prop("readonly")||$(n.el).prop("disabled")||(e=n.trigger({phase:"before",type:"remove",target:n.el,originalEvent:t.originalEvent,item:s}),!0!==e.isCancelled&&($().w2overlay(),a.splice($(t.target).attr("index"),1),$(n.el).trigger("input").trigger("change"),$(t.target).parent().fadeOut("fast"),setTimeout(()=>{n.refresh(),n.trigger($.extend(e,{phase:"after"}))},300)));else if(e=n.trigger({phase:"before",type:"click",target:n.el,originalEvent:t.originalEvent,item:s}),!0!==e.isCancelled){if("file"===n.type){let e="";/image/i.test(s.type)&&(e=`
                                    <div style="padding: 3px">
                                        <img data-src="${s.content?"data:"+s.type+";base64,"+s.content:""}"
                                            style="max-width: 300px">
                                    </div>`);var l='style="padding: 3px; text-align: right; color: #777"',t='style="padding: 3px"';e+=`
                                <div style="padding: 8px;">
                                    <table cellpadding="2">
                                    <tr>
                                        <td ${l}>${w2utils.lang("Name")}</td>
                                        <td ${t}>${s.name}</td>
                                    </tr>
                                    <tr>
                                        <td ${l}>${w2utils.lang("Size")}</td>
                                        <td ${t}>${w2utils.formatSize(s.size)}</td>
                                    </tr>
                                    <tr>
                                        <td ${l}>${w2utils.lang("Type")}</td>
                                        <td ${t}>
                                            <span style="width: 200px; display: block-inline; overflow: hidden;
                                                text-overflow: ellipsis; white-space: nowrap="nowrap";">${s.type}</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td ${l}>${w2utils.lang("Modified")}</td>
                                        <td ${t}>${w2utils.date(s.modified)}</td>
                                    </tr>
                                    </table>
                                </div>`,$("#w2ui-overlay").remove(),$(i).w2overlay(e,{onShow(e){let t=$("#w2ui-overlay img");t.on("load",function(e){var t=$(this).width(),i=$(this).height();t<300&i<300||(i<=t&&300<t&&$(this).width(300),t<i&&300<i&&$(this).height(300))}).on("error",function(e){this.style.display="none"}).attr("src",t.data("src"))}})}n.trigger($.extend(e,{phase:"after"}))}}}).on("mouseover",function(e){var t="LI"===e.target.tagName.toUpperCase()?e.target:$(e.target).parents("LI");if(!$(t).hasClass("nomouse")){if("out"===$(t).data("mouse")){var i=a[$(e.target).attr("index")],i=n.trigger({phase:"before",type:"mouseOver",target:n.el,originalEvent:e.originalEvent,item:i});if(!0===i.isCancelled)return;n.trigger($.extend(i,{phase:"after"}))}$(t).data("mouse","over")}}).on("mouseout",function(t){let i="LI"===t.target.tagName.toUpperCase()?t.target:$(t.target).parents("LI");$(i).hasClass("nomouse")||($(i).data("mouse","leaving"),setTimeout(()=>{var e;"leaving"===$(i).data("mouse")&&($(i).data("mouse","out"),e=a[$(t.target).attr("index")],!0!==(e=n.trigger({phase:"before",type:"mouseOut",target:n.el,originalEvent:t.originalEvent,item:e})).isCancelled&&n.trigger($.extend(e,{phase:"after"})))},0))}),$(this.el).height("auto");let s=$(e).find("> div.w2ui-multi-items").height()+2*w2utils.getSize(e,"+height");s<26&&(s=26),s>l.maxHeight&&(s=l.maxHeight),0<e.length&&(e[0].scrollTop=1e3);var o=w2utils.getSize($(this.el),"height")-2;o>s&&(s=o),$(e).css({height:s+"px",overflow:s==l.maxHeight?"auto":"hidden"}),s<l.maxHeight&&$(e).prop("scrollTop",0);o=parseInt($(this.el).css("min-height"));if(o>s&&(s=o,$(n.helpers.multi).css("height",s+"px")),$(this.el).css({height:s+"px"}),"enum"===n.type){let e=n.helpers.multi.find("input");e.width(8*(e.val().length+2)+"px")}}return(new Date).getTime()-e}reset(){var e=this.type;this.clear(),this.type=e,this.init()}resize(){var t=this,i=$(t.el).width(),s=$(t.el).height();if(!(t.tmp.current_width==i&&0<s)){let e=this.helpers.focus;var l=this.helpers.multi,n=this.helpers.suffix,a=this.helpers.prefix;e&&e.width($(t.el).width()),l&&(s=w2utils.getSize(t.el,"width")-parseInt($(t.el).css("margin-left"),10)-parseInt($(t.el).css("margin-right"),10),$(l).width(s)),n&&(t.options.suffix='<div class="arrow-down" style="margin-top: '+(parseInt($(t.el).height())-6)/2+'px;"></div>',t.addSuffix()),a&&t.addPrefix(),t.tmp.current_width=i}}clean(e){if("number"==typeof e)return e;var t=this.options;return e=String(e).trim(),-1!==["int","float","money","currency","percent"].indexOf(this.type)&&("string"==typeof e&&(t.autoFormat&&-1!==["money","currency"].indexOf(this.type)&&(e=String(e).replace(t.moneyRE,"")),t.autoFormat&&"percent"===this.type&&(e=String(e).replace(t.percentRE,"")),e=(e=t.autoFormat&&-1!==["int","float"].indexOf(this.type)?String(e).replace(t.numberRE,""):e).replace(/\s+/g,"").replace(w2utils.settings.groupSymbol,"").replace(w2utils.settings.decimalSymbol,".")),e=""!==e&&w2utils.isFloat(e)?Number(e):""),e}format(e){var t=this.options;if(t.autoFormat&&""!==e)switch(this.type){case"money":case"currency":""!==(e=w2utils.formatNumber(e,t.currencyPrecision,t.groupSymbol))&&(e=t.currencyPrefix+e+t.currencySuffix);break;case"percent":""!==(e=w2utils.formatNumber(e,t.precision,t.groupSymbol))&&(e+="%");break;case"float":e=w2utils.formatNumber(e,t.precision,t.groupSymbol);break;case"int":e=w2utils.formatNumber(e,0,t.groupSymbol)}return e}change(e){let t=this;var i,s=t.options;if(-1!==["int","float","money","currency","percent"].indexOf(this.type)){var l=$(this.el).val(),n=this.format(this.clean($(this.el).val()));if(""!==l&&l!=n)return $(this.el).val(n).trigger("input").trigger("change"),e.stopPropagation(),e.preventDefault(),!1}if("color"===this.type){let e=$(this.el).val();"rgb"!==e.substr(0,3).toLowerCase()&&(e="#"+e,8!==(i=$(this.el).val().length)&&6!==i&&3!==i&&(e="")),$(this.el).next().find("div").css("background-color",e),$(this.el).hasClass("has-focus")&&!0!==$(this.el).data("skipInit")&&this.updateOverlay()}-1!==["list","enum","file"].indexOf(this.type)&&(t.refresh(),setTimeout(()=>{t.refresh()},5)),-1!==["date","time","datetime"].indexOf(this.type)&&(i=parseInt(t.el.value),w2utils.isInt(t.el.value)&&3e3<i&&("time"===this.type&&$(t.el).val(w2utils.formatTime(new Date(i),s.format)).trigger("input").trigger("change"),"date"===this.type&&$(t.el).val(w2utils.formatDate(new Date(i),s.format)).trigger("input").trigger("change"),"datetime"===this.type&&$(t.el).val(w2utils.formatDateTime(new Date(i),s.format)).trigger("input").trigger("change")))}click(e){e.stopPropagation(),-1!==["list","combo","enum"].indexOf(this.type)&&($(this.el).hasClass("has-focus")||this.focus(e),"combo"==this.type&&this.updateOverlay()),-1!==["date","time","color","datetime"].indexOf(this.type)&&this.updateOverlay()}focus(e){let t=this;if(!$(t.el).hasClass("has-focus")){if($(t.el).addClass("has-focus"),-1!==["color","date","time","datetime"].indexOf(t.type)){if($(t.el).prop("readonly")||$(t.el).prop("disabled"))return;0<$("#w2ui-overlay").length&&$("#w2ui-overlay")[0].hide(),setTimeout(()=>{t.updateOverlay()},150)}if(-1!==["list","combo","enum"].indexOf(t.type)){if($(t.el).prop("readonly")||$(t.el).prop("disabled"))return;0<$("#w2ui-overlay").length&&$("#w2ui-overlay")[0].hide(),t.resize(),setTimeout(()=>{"list"===t.type&&$(t.el).is(":focus")?$(t.helpers.focus).find("input").focus():(t.updateOverlay(),t.search())},1),"function"==typeof t.options._items_fun&&(t.options.items=w2utils.normMenu.call(this,t.options._items_fun))}"file"==this.type&&$(this.el).prev().addClass("has-focus")}}blur(e){let i=this;var s,l=i.options,n=$(i.el).val().trim();let t=$("#w2ui-overlay");if($(i.el).removeClass("has-focus"),-1!==["color","date","time","list","combo","enum","datetime"].indexOf(i.type)){let e=setTimeout(()=>{!0!==t.data("keepOpen")&&t.hide()},0);$(".menu",t).one("focus",function(){clearTimeout(e),$(this).one("focusout",function(e){t.hide()})})}if(-1!==["int","float","money","currency","percent"].indexOf(i.type)&&""!==n){let e=n,t="";i.checkType(n)?(s=this.clean(n),null!=l.min&&s<l.min&&(e=l.min,t=`Should be >= ${l.min}`),null!=l.max&&s>l.max&&(e=l.max,t=`Should be <= ${l.max}`)):e="",l.autoCorrect&&($(i.el).val(e).trigger("input").trigger("change"),t&&($(i.el).w2tag(t),setTimeout(()=>{$(i.el).w2tag("")},3e3)))}-1!==["date","time","datetime"].indexOf(i.type)&&((""===n||i.inRange(i.el.value))&&("date"!==i.type||""===n||w2utils.isDate(i.el.value,l.format))&&("time"!==i.type||""===n||w2utils.isTime(i.el.value))&&("datetime"!==i.type||""===n||w2utils.isDateTime(i.el.value,l.format))||l.autoCorrect&&$(i.el).val("").removeData("selected").trigger("input").trigger("change")),"enum"===i.type&&$(i.helpers.multi).find("input").val("").width(20),"file"==this.type&&$(this.el).prev().removeClass("has-focus")}keyPress(e){let t=this;if(-1!==["int","float","money","currency","percent","hex","bin","color","alphanumeric"].indexOf(t.type)){if(e.metaKey||e.ctrlKey||e.altKey||e.charCode!=e.keyCode&&0<e.keyCode)return;var i=String.fromCharCode(e.charCode);if(!t.checkType(i,!0)&&13!=e.keyCode)return e.preventDefault(),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,!1}-1!==["date","time","datetime"].indexOf(t.type)&&9!==e.keyCode&&setTimeout(()=>{t.updateOverlay()},1)}keyDown(s,e){let l=this;var n=l.options,a=s.keyCode||e&&e.keyCode;let t=!1,i,r,o,d,h,u;if(-1!==["int","float","money","currency","percent"].indexOf(l.type)){if(!n.keyboard||$(l.el).prop("readonly")||$(l.el).prop("disabled"))return;switch(i=parseFloat($(l.el).val().replace(n.moneyRE,""))||0,r=n.step,(s.ctrlKey||s.metaKey)&&(r=10),a){case 38:if(s.shiftKey)break;h=i+r<=n.max||null==n.max?Number((i+r).toFixed(12)):n.max,$(l.el).val(h).trigger("input").trigger("change"),t=!0;break;case 40:if(s.shiftKey)break;h=i-r>=n.min||null==n.min?Number((i-r).toFixed(12)):n.min,$(l.el).val(h).trigger("input").trigger("change"),t=!0}t&&(s.preventDefault(),setTimeout(()=>{l.el.setSelectionRange(l.el.value.length,l.el.value.length)},0))}if("date"===l.type){if(!n.keyboard||$(l.el).prop("readonly")||$(l.el).prop("disabled"))return;switch(o=864e5,r=1,(s.ctrlKey||s.metaKey)&&(r=10),d=w2utils.isDate($(l.el).val(),n.format,!0),d||(d=new Date,o=0),a){case 38:if(s.shiftKey)break;u=w2utils.formatDate(d.getTime()+o,n.format),10==r&&(u=w2utils.formatDate(new Date(d.getFullYear(),d.getMonth()+1,d.getDate()),n.format)),$(l.el).val(u).trigger("input").trigger("change"),t=!0;break;case 40:if(s.shiftKey)break;u=w2utils.formatDate(d.getTime()-o,n.format),10==r&&(u=w2utils.formatDate(new Date(d.getFullYear(),d.getMonth()-1,d.getDate()),n.format)),$(l.el).val(u).trigger("input").trigger("change"),t=!0}t&&(s.preventDefault(),setTimeout(()=>{l.el.setSelectionRange(l.el.value.length,l.el.value.length),l.updateOverlay()},0))}if("time"===l.type){if(!n.keyboard||$(l.el).prop("readonly")||$(l.el).prop("disabled"))return;r=s.ctrlKey||s.metaKey?60:1,i=$(l.el).val();let e=l.toMin(i)||l.toMin((new Date).getHours()+":"+((new Date).getMinutes()-1));switch(a){case 38:if(s.shiftKey)break;e+=r,t=!0;break;case 40:if(s.shiftKey)break;e-=r,t=!0}t&&($(l.el).val(l.fromMin(e)).trigger("input").trigger("change"),s.preventDefault(),setTimeout(()=>{l.el.setSelectionRange(l.el.value.length,l.el.value.length)},0))}if("datetime"===l.type){if(!n.keyboard||$(l.el).prop("readonly")||$(l.el).prop("disabled"))return;o=864e5,r=1,(s.ctrlKey||s.metaKey)&&(r=10);var c=$(l.el).val();switch(d=w2utils.isDateTime(c,this.options.format,!0),d||(d=new Date,o=0),a){case 38:if(s.shiftKey)break;u=w2utils.formatDateTime(d.getTime()+o,n.format),10==r&&(u=w2utils.formatDateTime(new Date(d.getFullYear(),d.getMonth()+1,d.getDate()),n.format)),$(l.el).val(u).trigger("input").trigger("change"),t=!0;break;case 40:if(s.shiftKey)break;u=w2utils.formatDateTime(d.getTime()-o,n.format),10==r&&(u=w2utils.formatDateTime(new Date(d.getFullYear(),d.getMonth()-1,d.getDate()),n.format)),$(l.el).val(u).trigger("input").trigger("change"),t=!0}t&&(s.preventDefault(),setTimeout(()=>{l.el.setSelectionRange(l.el.value.length,l.el.value.length),l.updateOverlay()},0))}if("color"===l.type){if($(l.el).prop("readonly")||$(l.el).prop("disabled"))return;if((s.ctrlKey||s.metaKey)&&!s.shiftKey){let e=null;switch(a){case 38:e="up";break;case 40:e="down";break;case 39:e="right";break;case 37:e="left"}l.el.nav&&null!=e&&(c=l.el.nav(e),$(l.el).val(c).trigger("input").trigger("change"),s.preventDefault())}}if(-1!==["list","combo","enum"].indexOf(l.type)&&!$(l.el).prop("readonly")&&!$(l.el).prop("disabled")){let t=$(l.el).data("selected"),i=$(l.el);switch(-1!==["list","enum"].indexOf(l.type)&&("list"===l.type&&(i=$(l.helpers.focus).find("input")),"enum"===l.type&&(i=$(l.helpers.multi).find("input")),-1==[37,38,39,40].indexOf(a)&&setTimeout(()=>{l.refresh()},1),86==s.keyCode&&(s.ctrlKey||s.metaKey)&&setTimeout(()=>{l.refresh(),l.search(),l.request()},50)),a){case 27:"list"===l.type&&(""!==i.val()&&i.val(""),s.stopPropagation());break;case 13:{if(0===$("#w2ui-overlay").length){l.updateOverlay();break}let e=$("#w2ui-overlay")[0].getCurrent()["item"];if("enum"===l.type)if(null==e||e.hidden||e.disabled){e={id:i.val(),text:i.val()};var p=l.trigger({phase:"before",type:"new",target:l.el,originalEvent:s.originalEvent,item:e});if(!0===p.isCancelled)return;if(e=p.item,l.options.autoAdd){if(!e||void 0===e.id||""===String(e.id).trim()||e.disabled||e.hidden)return void s.preventDefault();delete l.tmp.force_open,t.length>=n.max&&0<n.max&&t.pop(),t.push(e),$(l.el).trigger("input").trigger("change"),i.val("").width(20),l.refresh()}l.trigger($.extend(p,{phase:"after"}))}else{var f=l.trigger({phase:"before",type:"add",target:l.el,originalEvent:s.originalEvent,item:e});if(!0===f.isCancelled)return;e=f.item,t.length>=n.max&&0<n.max&&t.pop(),delete e.hidden,delete l.tmp.force_open,t.push(e),$(l.el).trigger("input").trigger("change"),i.val("").width(20),l.refresh(),l.trigger($.extend(f,{phase:"after"}))}else e&&$(l.el).data("selected",e).val(e.text).trigger("input").trigger("change"),""===$(l.el).val()&&$(l.el).data("selected")&&$(l.el).removeData("selected").val("").trigger("input").trigger("change"),"list"===l.type&&(i.val(""),l.refresh()),l.tmp.force_hide=!0;break}case 8:case 46:if("enum"===l.type&&8===a&&""===i.val()&&0<t.length){f=t[t.length-1],f=l.trigger({phase:"before",type:"remove",target:l.el,originalEvent:s.originalEvent,item:f});if(!0===f.isCancelled)return;t.pop(),$(l.el).trigger("input").trigger("change"),l.refresh(),l.trigger($.extend(f,{phase:"after"}))}"list"===l.type&&""===i.val()&&($(l.el).data("selected",{}).trigger("input").trigger("change"),l.refresh());break;case 37:case 39:0!=$("#w2ui-overlay").length&&$("#w2ui-overlay")[0].change(s);break;case 38:if(0===$("#w2ui-overlay").length){l.updateOverlay();break}$("#w2ui-overlay")[0].change(s);break;case 40:if(0===$("#w2ui-overlay").length){l.updateOverlay();break}$("#w2ui-overlay")[0].change(s),""===i.val()&&0===$("#w2ui-overlay").length&&(l.tmp.force_open=!0);break;default:0===$("#w2ui-overlay").length&&l.updateOverlay()}0,"enum"===l.type&&i.width(8*(i.val().length+2)+"px")}}keyUp(t){if(-1!==["list","combo","enum"].indexOf(this.type)&&!$(this.el).prop("readonly")&&!$(this.el).prop("disabled")&&-1==[16,17,18,20,37,39,91].indexOf(t.keyCode)){let e=$(this.helpers.focus).find("input");0===e.length&&(e=$(this.el));var i=this.trigger({phase:"before",type:"search",originalEvent:t,target:e,search:e.val()});!0!==i.isCancelled&&(this.tmp.force_hide||this.request(),1==e.val().length&&this.refresh(),0!==$("#w2ui-overlay").length&&-1!=[38,40].indexOf(t.keyCode)||this.search(),this.trigger($.extend(i,{phase:"after"})))}}clearCache(){let e=this.options;e.items=[],this.tmp.xhr_loading=!1,this.tmp.xhr_search="",this.tmp.xhr_total=-1}request(e){let n=this,a=this.options,r=$(n.el).val()||"";if(a.url){if("enum"===n.type){let e=$(n.helpers.multi).find("input");r=0===e.length?"":e.val()}if("list"===n.type){let e=$(n.helpers.focus).find("input");r=0===e.length?"":e.val()}if(0!==a.minLength&&r.length<a.minLength)return a.items=[],void this.updateOverlay();if(null==e&&(e=a.interval),null==n.tmp.xhr_search&&(n.tmp.xhr_search=""),null==n.tmp.xhr_total&&(n.tmp.xhr_total=-1),a.url&&!0!==$(n.el).prop("readonly")&&!0!==$(n.el).prop("disabled")&&(0===a.items.length&&0!==n.tmp.xhr_total||n.tmp.xhr_total==a.cacheMax&&r.length>n.tmp.xhr_search.length||r.length>=n.tmp.xhr_search.length&&r.substr(0,n.tmp.xhr_search.length)!==n.tmp.xhr_search||r.length<n.tmp.xhr_search.length)){if(n.tmp.xhr)try{n.tmp.xhr.abort()}catch(e){}n.tmp.xhr_loading=!0,n.search(),clearTimeout(n.tmp.timeout),n.tmp.timeout=setTimeout(()=>{var t=a.url;let l={search:r,max:a.cacheMax};$.extend(l,a.postData);var i=n.trigger({phase:"before",type:"request",search:r,target:n.el,url:t,postData:l});if(!0!==i.isCancelled){t=i.url,l=i.postData;let e={type:"GET",url:t,data:l,dataType:"JSON"};a.method&&(e.type=a.method),"JSON"===w2utils.settings.dataType&&(e.type="POST",e.data=JSON.stringify(e.data),e.contentType="application/json"),"HTTPJSON"===w2utils.settings.dataType&&(e.data={request:JSON.stringify(e.data)}),"RESTFULLJSON"===w2utils.settings.dataType&&(e.data=JSON.stringify(e.data),e.contentType="application/json"),null!=a.method&&(e.type=a.method),n.tmp.xhr=$.ajax(e).done((e,t,i)=>{var s=n.trigger({phase:"before",type:"load",target:n.el,search:l.search,data:e,xhr:i});if(!0!==s.isCancelled)if("string"==typeof(e=s.data)&&(e=JSON.parse(e)),null==(e=Array.isArray(e)?{records:e}:e).records&&null!=e.items&&(e.records=e.items,delete e.items),"success"==e.status&&null==e.records&&(e.records=[]),Array.isArray(e.records)){e.records.length>a.cacheMax&&e.records.splice(a.cacheMax,1e5),null==a.recId&&null!=a.recid&&(a.recId=a.recid),(a.recId||a.recText)&&e.records.forEach(e=>{"string"==typeof a.recId&&(e.id=e[a.recId]),"function"==typeof a.recId&&(e.id=a.recId(e)),"string"==typeof a.recText&&(e.text=e[a.recText]),"function"==typeof a.recText&&(e.text=a.recText(e))}),n.tmp.xhr_loading=!1,n.tmp.xhr_search=r,n.tmp.xhr_total=e.records.length,n.tmp.lastError="",a.items=w2utils.normMenu(e.records),""===r&&0===e.records.length?n.tmp.emptySet=!0:n.tmp.emptySet=!1;let t=$(n.el).data("find_selected");if(t){let s;Array.isArray(t)?(s=[],t.forEach(t=>{let i=!1;a.items.forEach(e=>{(e.id==t||t&&t.id==e.id)&&(s.push($.extend(!0,{},e)),i=!0)}),i||s.push(t)})):(s=t,a.items.forEach(e=>{(e.id==t||t&&t.id==e.id)&&(s=e)})),$(n.el).data("selected",s).removeData("find_selected").trigger("input").trigger("change")}n.search(),n.trigger($.extend(s,{phase:"after"}))}else console.error("ERROR: server did not return proper data structure","\n"," - it should return",{status:"success",records:[{id:1,text:"item"}]},"\n"," - or just an array ",[{id:1,text:"item"}],"\n"," - actual response","object"==typeof e?e:i.responseText)}).fail((t,e,i)=>{i={status:e,error:i,rawResponseText:t.responseText},i=n.trigger({phase:"before",type:"error",target:n.el,search:r,error:i,xhr:t});if(!0!==i.isCancelled){if("abort"!==e){let e;try{e=JSON.parse(t.responseText)}catch(e){}console.error("ERROR: server did not return proper data structure","\n"," - it should return",{status:"success",records:[{id:1,text:"item"}]},"\n"," - or just an array ",[{id:1,text:"item"}],"\n"," - actual response","object"==typeof e?e:t.responseText)}n.tmp.xhr_loading=!1,n.tmp.xhr_search=r,n.tmp.xhr_total=0,n.tmp.emptySet=!0,n.tmp.lastError=i.error||"Server communication failed",a.items=[],n.clearCache(),n.search(),n.updateOverlay(!1),n.trigger($.extend(i,{phase:"after"}))}}),n.trigger($.extend(i,{phase:"after"}))}},e)}}}search(){var i=this;let l=this.options,n=$(i.el).val(),e=i.el,a=[];var t=$(i.el).data("selected");if("enum"===i.type)for(var s in e=$(i.helpers.multi).find("input"),n=e.val(),t)t[s]&&a.push(t[s].id);else if("list"===i.type)for(var r in e=$(i.helpers.focus).find("input"),n=e.val(),t)t[r]&&a.push(t[r].id);let o=l.items;if(!0!==i.tmp.xhr_loading){let t=0;for(let e=0;e<o.length;e++){let s=o[e];if(null!=l.compare)"function"==typeof l.compare&&(s.hidden=!1===l.compare.call(this,s,n));else{let t="",i="";-1!==["is","begins"].indexOf(l.match)&&(t="^"),-1!==["is","ends"].indexOf(l.match)&&(i="$");try{let e=new RegExp(t+n+i,"i");e.test(s.text)||"..."===s.text?s.hidden=!1:s.hidden=!0}catch(e){}}!1===l.filter&&(s.hidden=!1),"enum"===i.type&&-1!==$.inArray(s.id,a)&&(s.hidden=!0),!0!==s.hidden&&(t++,delete s.hidden)}l.index=[],l.spinner=!1,setTimeout(()=>{l.markSearch&&0==$("#w2ui-overlay .no-matches").length&&$("#w2ui-overlay").w2marker(n)},1)}else o.splice(0,l.cacheMax),l.spinner=!0;0<$("#w2ui-overlay").length&&i.updateOverlay()}updateOverlay(e){let n=this,a=this.options,t,i,l,r;if("color"===this.type){if($(n.el).prop("readonly")||$(n.el).prop("disabled"))return;$(this.el).w2color({color:$(this.el).val(),transparent:a.transparent,advanced:a.advanced},e=>{null!=e&&$(n.el).val(e).trigger("input").trigger("change")})}if("date"===this.type){if($(n.el).prop("readonly")||$(n.el).prop("disabled"))return;0===$("#w2ui-overlay").length&&$(n.el).w2overlay('<div class="w2ui-reset w2ui-calendar"></div>',{css:{"background-color":"#f5f5f5"}}),l=w2utils.isDate($(n.el).val(),n.options.format,!0),l&&(t=l.getMonth()+1,i=l.getFullYear()),function i(s,l){if(!s&&!l){let e=new Date;s=e.getMonth(),l=e.getFullYear()}$("#w2ui-overlay > div > div").html(n.getMonthHTML(s,l,$(n.el).val())),$("#w2ui-overlay .w2ui-calendar-title").on("mousedown",function(){if($(this).next().hasClass("w2ui-calendar-jump"))$(this).next().remove();else{let e,t;$(this).after('<div class="w2ui-calendar-jump" style=""></div>'),$(this).next().hide().html(n.getYearHTML()).fadeIn(200),setTimeout(()=>{$("#w2ui-overlay .w2ui-calendar-jump").find(".w2ui-jump-month, .w2ui-jump-year").on("dblclick",function(){$(this).hasClass("w2ui-jump-month")&&($(this).parent().find(".w2ui-jump-month").removeClass("selected"),$(this).addClass("selected"),t=$(this).attr("name")),$(this).hasClass("w2ui-jump-year")&&($(this).parent().find(".w2ui-jump-year").removeClass("selected"),$(this).addClass("selected"),e=$(this).attr("name")),null==t&&(t=s),null==e&&(e=l),$("#w2ui-overlay .w2ui-calendar-jump").fadeOut(100),setTimeout(()=>{i(parseInt(t)+1,e)},100)}).on("click",function(){$(this).hasClass("w2ui-jump-month")&&($(this).parent().find(".w2ui-jump-month").removeClass("selected"),$(this).addClass("selected"),t=$(this).attr("name")),$(this).hasClass("w2ui-jump-year")&&($(this).parent().find(".w2ui-jump-year").removeClass("selected"),$(this).addClass("selected"),e=$(this).attr("name")),null!=e&&null!=t&&($("#w2ui-overlay .w2ui-calendar-jump").fadeOut(100),setTimeout(()=>{i(parseInt(t)+1,e)},100))}),$("#w2ui-overlay .w2ui-calendar-jump >:last-child").prop("scrollTop",2e3)},1)}}),$("#w2ui-overlay .w2ui-date").on("mousedown",function(){var e=$(this).attr("date");$(n.el).val(e).trigger("input").trigger("change"),$(this).css({"background-color":"#B6D5FB","border-color":"#aaa"})}).on("mouseup",function(){setTimeout(()=>{0<$("#w2ui-overlay").length&&$("#w2ui-overlay").removeData("keepOpen")[0].hide()},10)}),$("#w2ui-overlay .previous").on("mousedown",function(){let e=n.options.current.split("/");e[0]=parseInt(e[0])-1,i(e[0],e[1])}),$("#w2ui-overlay .next").on("mousedown",function(){let e=n.options.current.split("/");e[0]=parseInt(e[0])+1,i(e[0],e[1])})}(t,i)}if("time"===this.type){if($(n.el).prop("readonly")||$(n.el).prop("disabled"))return;0===$("#w2ui-overlay").length&&$(n.el).w2overlay('<div class="w2ui-reset w2ui-calendar-time"></div>',{css:{"background-color":"#fff"}});let i="h24"===this.options.format;$("#w2ui-overlay > div").html(n.getHourHTML()),$("#w2ui-overlay .w2ui-time").on("mousedown",function(e){$(this).css({"background-color":"#B6D5FB","border-color":"#aaa"});var t=$(this).attr("hour");$(n.el).val((12<t&&!i?t-12:t)+":00"+(i?"":t<12?" am":" pm")).trigger("input").trigger("change")}),null==this.options.noMinutes||!1===this.options.noMinutes?$("#w2ui-overlay .w2ui-time").on("mouseup",function(){let t=$(this).attr("hour");0<$("#w2ui-overlay").length&&$("#w2ui-overlay")[0].hide(),$(n.el).w2overlay('<div class="w2ui-reset w2ui-calendar-time"></div>',{css:{"background-color":"#fff"}}),$("#w2ui-overlay > div").html(n.getMinHTML(t)),$("#w2ui-overlay .w2ui-time").on("mousedown",function(){$(this).css({"background-color":"#B6D5FB","border-color":"#aaa"});var e=$(this).attr("min");$(n.el).val((12<t&&!i?t-12:t)+":"+(e<10?0:"")+e+(i?"":t<12?" am":" pm")).trigger("input").trigger("change")}).on("mouseup",function(){setTimeout(()=>{0<$("#w2ui-overlay").length&&$("#w2ui-overlay").removeData("keepOpen")[0].hide()},10)})}):$("#w2ui-overlay .w2ui-time").on("mouseup",function(){setTimeout(()=>{0<$("#w2ui-overlay").length&&$("#w2ui-overlay").removeData("keepOpen")[0].hide()},10)})}if("datetime"===this.type){if($(n.el).prop("readonly")||$(n.el).prop("disabled"))return;0<$("#w2ui-overlay .w2ui-time").length&&$("#w2ui-overlay")[0].hide(),0===$("#w2ui-overlay").length&&$(n.el).w2overlay('<div class="w2ui-reset w2ui-calendar"></div>',{css:{"background-color":"#f5f5f5"}}),l=w2utils.isDateTime($(n.el).val(),n.options.format,!0),l&&(t=l.getMonth()+1,i=l.getFullYear());let s=null;!function i(e,t){$("#w2ui-overlay > div > div").html(n.getMonthHTML(e,t,$(n.el).val())+(a.btn_now?'<div class="w2ui-calendar-now now">'+w2utils.lang("Current Date & Time")+"</div>":"")),$("#w2ui-overlay .w2ui-calendar-title").on("mousedown",function(){if($(this).next().hasClass("w2ui-calendar-jump"))$(this).next().remove();else{let e,t;$(this).after('<div class="w2ui-calendar-jump" style=""></div>'),$(this).next().hide().html(n.getYearHTML()).fadeIn(200),setTimeout(()=>{$("#w2ui-overlay .w2ui-calendar-jump").find(".w2ui-jump-month, .w2ui-jump-year").on("click",function(){$(this).hasClass("w2ui-jump-month")&&($(this).parent().find(".w2ui-jump-month").removeClass("selected"),$(this).addClass("selected"),t=$(this).attr("name")),$(this).hasClass("w2ui-jump-year")&&($(this).parent().find(".w2ui-jump-year").removeClass("selected"),$(this).addClass("selected"),e=$(this).attr("name")),null!=e&&null!=t&&($("#w2ui-overlay .w2ui-calendar-jump").fadeOut(100),setTimeout(()=>{i(parseInt(t)+1,e)},100))}),$("#w2ui-overlay .w2ui-calendar-jump >:last-child").prop("scrollTop",2e3)},1)}}),$("#w2ui-overlay .w2ui-date").on("mousedown",function(){var e=$(this).attr("date");$(n.el).val(e).trigger("input").trigger("change"),$(this).css({"background-color":"#B6D5FB","border-color":"#aaa"}),s=new Date($(this).attr("data-date"))}).on("mouseup",function(){let i,t;0<$("#w2ui-overlay").length&&$("#w2ui-overlay")[0].hide(),$(n.el).w2overlay('<div class="w2ui-reset w2ui-calendar-time"></div>',{css:{"background-color":"#fff"}}),$("#w2ui-overlay > div").html(n.getHourHTML()),$("#w2ui-overlay .w2ui-time").on("mousedown",function(e){$(this).css({"background-color":"#B6D5FB","border-color":"#aaa"}),i=$(this).attr("hour"),s.setHours(i);var t=w2utils.formatDateTime(s,n.options.format);$(n.el).val(t).trigger("input").trigger("change")}),null==n.options.noMinutes||!1===n.options.noMinutes?$("#w2ui-overlay .w2ui-time").on("mouseup",function(){var e=$(this).attr("hour");0<$("#w2ui-overlay").length&&$("#w2ui-overlay")[0].hide(),$(n.el).w2overlay('<div class="w2ui-reset w2ui-calendar-time"></div>',{css:{"background-color":"#fff"}}),$("#w2ui-overlay > div").html(n.getMinHTML(e)),$("#w2ui-overlay .w2ui-time").on("mousedown",function(){$(this).css({"background-color":"#B6D5FB","border-color":"#aaa"}),t=$(this).attr("min"),s.setHours(i,t);var e=w2utils.formatDateTime(s,n.options.format);$(n.el).val(e).trigger("input").trigger("change")}).on("mouseup",function(){setTimeout(()=>{0<$("#w2ui-overlay").length&&$("#w2ui-overlay").removeData("keepOpen")[0].hide()},10)})}):$("#w2ui-overlay .w2ui-time").on("mouseup",function(){setTimeout(()=>{0<$("#w2ui-overlay").length&&$("#w2ui-overlay").removeData("keepOpen")[0].hide()},10)})}),$("#w2ui-overlay .previous").on("mousedown",function(){let e=n.options.current.split("/");e[0]=parseInt(e[0])-1,i(e[0],e[1])}),$("#w2ui-overlay .next").on("mousedown",function(){let e=n.options.current.split("/");e[0]=parseInt(e[0])+1,i(e[0],e[1])}),$("#w2ui-overlay .now").on("mousedown",function(){var e=w2utils.formatDateTime(new Date,n.options.format);return $(n.el).val(e).trigger("input").trigger("change"),!1}).on("mouseup",function(){setTimeout(()=>{0<$("#w2ui-overlay").length&&$("#w2ui-overlay").removeData("keepOpen")[0].hide()},10)})}(t,i)}if(-1!==["list","combo","enum"].indexOf(this.type)){let l=this.el,i=this.el;var s;if("enum"===this.type&&(l=$(this.helpers.multi),i=$(l).find("input")),"list"===this.type&&(s=$(i).data("selected"),!$.isPlainObject(s)||$.isEmptyObject(s)||0<(s=function i(e,s,l){let n=[];l=l||[];e.forEach((e,t)=>{e.id===s&&(n=l.concat([t]),a.index=[t]),0==n.length&&e.items&&0<e.items.length&&(l.push(t),n=i(e.items,s,l),l.pop())});return n}(a.items,s.id)).length&&(a.index=s),i=$(this.helpers.focus).find("input")),$(this.el).hasClass("has-focus"))if(!1!==a.openOnFocus||""!==$(i).val()||!0===n.tmp.force_open){if(n.tmp.force_hide)return $().w2overlay(),void setTimeout(()=>{delete n.tmp.force_hide},1);""!==$(i).val()&&delete n.tmp.force_open;let t=w2utils.lang("No matches");if(null!=a.url&&String($(i).val()).length<a.minLength&&!0!==n.tmp.emptySet&&(t=w2utils.lang("${count} letters or more...",{count:a.minLength})),null!=a.url&&""===$(i).val()&&!0!==n.tmp.emptySet&&(t=w2utils.lang(a.msgSearch||"Type to search...")),null==a.url&&0===a.items.length&&(t=w2utils.lang("Empty list")),null!=a.msgNoItems){let e={search:$(i).val(),options:$.extend(!0,{},a)};a.url&&(e.remote={url:a.url,empty:!!n.tmp.emptySet,error:n.tmp.lastError,minLength:a.minLength}),t="function"==typeof a.msgNoItems?a.msgNoItems(e):a.msgNoItems}n.tmp.lastError&&(t=n.tmp.lastError),t=t&&'<div class="no-matches" style="white-space: normal; line-height: 1.3">'+t+"</div>",r=$.extend(!0,{},a,{search:!1,render:a.renderDrop,maxHeight:a.maxDropHeight,maxWidth:a.maxDropWidth,minWidth:a.minDropWidth,msgNoItems:t,onSelect(s){if("enum"===n.type){let e=$(n.el).data("selected");if(s.item){var t=n.trigger({phase:"before",type:"add",target:n.el,originalEvent:s.originalEvent,item:s.item});if(!0!==t.isCancelled){if(e.length>=a.max&&0<a.max&&e.pop(),delete s.item.hidden,e.push(s.item),$(n.el).data("selected",e).trigger("input").trigger("change"),$(n.helpers.multi).find("input").val("").width(20),n.refresh(),!0!==s.keepOpen)0<$("#w2ui-overlay").length&&$("#w2ui-overlay")[0].hide();else{let i;r.items.forEach((e,t)=>{e.id==s.item.id&&(i=t)}),null!=i&&r.items.splice(i,1),r.selected=e,$(l).w2menu("refresh",r)}n.trigger($.extend(t,{phase:"after"}))}}}else $(n.el).data("selected",s.item).val(s.item.text).trigger("input").trigger("change"),n.helpers.focus&&n.helpers.focus.find("input").val("")}}),e?$(l).w2menu("refresh-index",r):0<$("#w2ui-overlay").length?$(l).w2menu("refresh",r):$(l).w2menu(r)}else $().w2overlay()}}inRange(l,e){let n=!1;if("date"===this.type){let i=w2utils.isDate(l,this.options.format,!0);if(i){if(this.options.start||this.options.end){var s="string"==typeof this.options.start?this.options.start:$(this.options.start).val(),a="string"==typeof this.options.end?this.options.end:$(this.options.end).val();let e=w2utils.isDate(s,this.options.format,!0),t=w2utils.isDate(a,this.options.format,!0);a=new Date(i);e=e||a,t=t||a,a>=e&&a<=t&&(n=!0)}else n=!0;if(this.options.blocked&&-1!==$.inArray(l,this.options.blocked)&&(n=!1),null!==this.options.blockWeekDays&&void 0!==this.options.blockWeekDays&&null!=this.options.blockWeekDays.length){var t=this.options.blockWeekDays.length;for(let e=0;e<t;e++)i.getDay()==this.options.blockWeekDays[e]&&(n=!1)}}}else if("time"===this.type)if(this.options.start||this.options.end){a=this.toMin(l);let e=this.toMin(this.options.start),t=this.toMin(this.options.end);e=e||a,t=t||a,a>=e&&a<=t&&(n=!0)}else n=!0;else if("datetime"===this.type){let s=w2utils.isDateTime(l,this.options.format,!0);if(s){if(this.options.start||this.options.end){let t,i;if("object"==typeof this.options.start&&this.options.start instanceof Date)t=this.options.start;else{let e="string"==typeof this.options.start?this.options.start:$(this.options.start).val();t=""!==e.trim()?w2utils.isDateTime(e,this.options.format,!0):""}if("object"==typeof this.options.end&&this.options.end instanceof Date)i=this.options.end;else{let e="string"==typeof this.options.end?this.options.end:$(this.options.end).val();i=""!==e.trim()?w2utils.isDateTime(e,this.options.format,!0):""}l=s;t=t||l,i=i||l,e&&t instanceof Date&&(t.setHours(0),t.setMinutes(0),t.setSeconds(0)),l>=t&&l<=i&&(n=!0)}else n=!0;if(n&&this.options.blocked)for(let t=0;t<this.options.blocked.length;t++){let e=this.options.blocked[t];if("string"==typeof e&&(e=w2utils.isDateTime(e,this.options.format,!0)),"object"==typeof e&&e instanceof Date&&e.getFullYear()==s.getFullYear()&&e.getMonth()==s.getMonth()&&e.getDate()==s.getDate()){n=!1;break}}}}return n}checkType(e,t){var i=this;switch(i.type){case"int":return t&&-1!==["-",i.options.groupSymbol].indexOf(e)?!0:w2utils.isInt(e.replace(i.options.numberRE,""));case"percent":e=e.replace(/%/g,"");case"float":return t&&-1!==["-",w2utils.settings.decimalSymbol,i.options.groupSymbol].indexOf(e)?!0:w2utils.isFloat(e.replace(i.options.numberRE,""));case"money":case"currency":return t&&-1!==["-",i.options.decimalSymbol,i.options.groupSymbol,i.options.currencyPrefix,i.options.currencySuffix].indexOf(e)?!0:w2utils.isFloat(e.replace(i.options.moneyRE,""));case"bin":return w2utils.isBin(e);case"hex":return w2utils.isHex(e);case"alphanumeric":return w2utils.isAlphaNumeric(e)}return!0}addPrefix(){let i=this;setTimeout(()=>{if("clear"!==i.type){let e,t=$(i.el).data("tmp")||{};t["old-padding-left"]&&$(i.el).css("padding-left",t["old-padding-left"]),t["old-padding-left"]=$(i.el).css("padding-left"),$(i.el).data("tmp",t),i.helpers.prefix&&$(i.helpers.prefix).remove(),""!==i.options.prefix&&($(i.el).before('<div class="w2ui-field-helper">'+i.options.prefix+"</div>"),e=$(i.el).prev(),e.css({color:$(i.el).css("color"),"font-family":$(i.el).css("font-family"),"font-size":$(i.el).css("font-size"),"padding-top":$(i.el).css("padding-top"),"padding-bottom":$(i.el).css("padding-bottom"),"padding-left":$(i.el).css("padding-left"),"padding-right":0,"margin-top":parseInt($(i.el).css("margin-top"),10)+2+"px","margin-bottom":parseInt($(i.el).css("margin-bottom"),10)+1+"px","margin-left":$(i.el).css("margin-left"),"margin-right":0}).on("click",function(e){var t;i.options.icon&&"function"==typeof i.onIconClick?!0!==(t=i.trigger({phase:"before",type:"iconClick",target:i.el,el:$(this).find("span.w2ui-icon")[0]})).isCancelled&&i.trigger($.extend(t,{phase:"after"})):("list"===i.type?$(i.helpers.focus).find("input"):$(i.el)).focus()}),$(i.el).css("padding-left",e.width()+parseInt($(i.el).css("padding-left"),10)+"px"),i.helpers.prefix=e)}},1)}addSuffix(){let l=this,t,i;setTimeout(()=>{if("clear"!==l.type){let e=$(l.el).data("tmp")||{};e["old-padding-right"]&&$(l.el).css("padding-right",e["old-padding-right"]),e["old-padding-right"]=$(l.el).css("padding-right"),$(l.el).data("tmp",e),i=parseInt($(l.el).css("padding-right"),10),l.options.arrows&&(l.helpers.arrows&&$(l.helpers.arrows).remove(),$(l.el).after('<div class="w2ui-field-helper" style="border: 1px solid transparent">&#160;    <div class="w2ui-field-up" type="up">        <div class="arrow-up" type="up"></div>    </div>    <div class="w2ui-field-down" type="down">        <div class="arrow-down" type="down"></div>    </div></div>'),t=$(l.el).next(),t.css({color:$(l.el).css("color"),"font-family":$(l.el).css("font-family"),"font-size":$(l.el).css("font-size"),height:$(l.el).height()+parseInt($(l.el).css("padding-top"),10)+parseInt($(l.el).css("padding-bottom"),10)+"px",padding:0,"margin-top":parseInt($(l.el).css("margin-top"),10)+1+"px","margin-bottom":0,"border-left":"1px solid silver"}).css("margin-left","-"+(t.width()+parseInt($(l.el).css("margin-right"),10)+12)+"px").on("mousedown",function(t){let i=$("body");function s(e){$(l.el).focus(),l.keyDown($.Event("keydown"),{keyCode:"up"===$(t.target).attr("type")?38:40}),!1!==e&&$("body").data("_field_update_timer",setTimeout(s,60))}i.on("mouseup",function e(){clearTimeout(i.data("_field_update_timer"));i.off("mouseup",e)}),i.data("_field_update_timer",setTimeout(s,700)),s(!1)}),i+=t.width()+12,$(l.el).css("padding-right",i+"px"),l.helpers.arrows=t),""!==l.options.suffix&&(l.helpers.suffix&&$(l.helpers.suffix).remove(),$(l.el).after('<div class="w2ui-field-helper">'+l.options.suffix+"</div>"),t=$(l.el).next(),t.css({color:$(l.el).css("color"),"font-family":$(l.el).css("font-family"),"font-size":$(l.el).css("font-size"),"padding-top":$(l.el).css("padding-top"),"padding-bottom":$(l.el).css("padding-bottom"),"padding-left":"3px","padding-right":$(l.el).css("padding-right"),"margin-top":parseInt($(l.el).css("margin-top"),10)+2+"px","margin-bottom":parseInt($(l.el).css("margin-bottom"),10)+1+"px"}).on("click",function(e){("list"===l.type?$(l.helpers.focus).find("input"):$(l.el)).focus()}),t.css("margin-left","-"+(w2utils.getSize(t,"width")+parseInt($(l.el).css("margin-right"),10)+2)+"px"),i+=t.width()+3,$(l.el).css("padding-right",i+"px"),l.helpers.suffix=t)}},1)}addFocus(){let i=this;let s;$(i.helpers.focus).remove();let e=parseInt($(i.el).attr("tabIndex"));isNaN(e)||-1===e||(i.el._tabIndex=e),i.el._tabIndex&&(e=i.el._tabIndex),null==e&&(e=-1),isNaN(e)&&(e=0);let t="";null!=$(i.el).attr("id")&&(t='id="'+$(i.el).attr("id")+'_search"');var l='<div class="w2ui-field-helper">    <span class="w2ui-icon w2ui-icon-search"></span>    <input '+t+' type="text" tabIndex="'+e+'" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"/></div>';$(i.el).attr("tabindex",-1).before(l);let n=$(i.el).prev();i.helpers.focus=n,n.css({width:$(i.el).width(),"margin-top":$(i.el).css("margin-top"),"margin-left":parseInt($(i.el).css("margin-left"))+parseInt($(i.el).css("padding-left"))+"px","margin-bottom":$(i.el).css("margin-bottom"),"margin-right":$(i.el).css("margin-right")}).find("input").css({cursor:"default",width:"100%",opacity:1,margin:0,border:"1px solid transparent",padding:$(i.el).css("padding-top"),"padding-left":0,"margin-left":0,"background-color":"transparent"}),n.find("input").on("click",function(e){0==$("#w2ui-overlay").length?i.updateOverlay():$("#w2ui-overlay").data("keepOpen",!0)}).on("focus",function(e){s=$(i.el).attr("placeholder"),$(this).val(""),$(i.el).triggerHandler("focus"),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}).on("blur",function(e){$(this).val(""),i.refresh(),$(i.el).triggerHandler("blur"),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,null!=s&&$(i.el).attr("placeholder",s)}).on("keydown",function(e){let t=this;i.keyDown(e),setTimeout(()=>{""===t.value?$(i.el).attr("placeholder",s):$(i.el).attr("placeholder","")},10)}).on("keyup",function(e){i.keyUp(e)}).on("keypress",function(e){i.keyPress(e)}),n.on("click",function(e){$(this).find("input").focus()}),i.refresh()}addMulti(){let s=this;$(s.helpers.multi).remove();let t="";var i="margin-top     : 0px; margin-bottom  : 0px; margin-left    : "+$(s.el).css("margin-left")+"; margin-right   : "+$(s.el).css("margin-right")+"; width          : "+(w2utils.getSize(s.el,"width")-parseInt($(s.el).css("margin-left"),10)-parseInt($(s.el).css("margin-right"),10))+"px;";let l="";if(null!=$(s.el).attr("id")&&(l='id="'+$(s.el).attr("id")+'_search" '),"enum"===s.type){let e=parseInt($(s.el).attr("tabIndex"));isNaN(e)||-1===e||(s.el._tabIndex=e),s.el._tabIndex&&(e=s.el._tabIndex),null==e&&(e=0),isNaN(e)&&(e=0),t=`
            <div class="w2ui-field-helper w2ui-list" style="${i}; box-sizing: border-box">
                <div style="padding: 0px; margin: 0px; display: inline-block" class="w2ui-multi-items">
                <ul>
                    <li style="padding-left: 0px; padding-right: 0px" class="nomouse">
                        <input ${l} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            style="width: 20px; margin: -3px 0 0; padding: 2px 0; border-color: transparent" tabindex="${e}"
                            ${$(s.el).prop("readonly")?' readonly="readonly"':""}
                            ${$(s.el).prop("disabled")?' disabled="disabled"':""}/>
                    </li>
                </ul>
                </div>
            </div>`}"file"===s.type&&(t=`
            <div class="w2ui-field-helper w2ui-list" style="${i}; box-sizing: border-box">
                <div style="position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px;">
                    <input ${l} name="attachment" class="file-input" type="file" tabindex="-1"'
                        style="width: 100%; height: 100%; opacity: 0"
                        ${1!==s.options.max?' multiple="multiple"':""}
                        ${$(s.el).prop("readonly")?' readonly="readonly"':""}
                        ${$(s.el).prop("disabled")?' disabled="disabled"':""}
                        ${$(s.el).attr("accept")?' accept="'+$(s.el).attr("accept")+'"':""}/>
                </div>
                <div style="position: absolute; padding: 0px; margin: 0px; display: inline-block" class="w2ui-multi-items">
                    <ul>
                        <li style="padding-left: 0px; padding-right: 0px" class="nomouse"></li>
                    </ul>
                </div>
            </div>`);let e=$(s.el).data("tmp")||{};e["old-background-color"]=$(s.el).css("background-color"),e["old-border-color"]=$(s.el).css("border-color"),$(s.el).data("tmp",e),$(s.el).before(t).css({"background-color":"transparent","border-color":"transparent"});let n=$(s.el).prev();s.helpers.multi=n,"enum"===s.type&&($(s.el).attr("tabindex",-1),n.find("input").on("click",function(e){0===$("#w2ui-overlay").length&&s.focus(e),$(s.el).triggerHandler("click")}).on("focus",function(e){$(s.el).triggerHandler("focus"),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}).on("blur",function(e){$(s.el).triggerHandler("blur"),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}).on("keyup",function(e){s.keyUp(e)}).on("keydown",function(e){s.keyDown(e)}).on("keypress",function(e){s.keyPress(e)}),n.on("click",function(e){$(this).find("input").focus()})),"file"===s.type&&n.find("input").off(".drag").on("click.drag",function(e){e.stopPropagation(),$(s.el).prop("readonly")||$(s.el).prop("disabled")||$(s.el).focus()}).on("dragenter.drag",function(e){$(s.el).prop("readonly")||$(s.el).prop("disabled")||$(n).addClass("w2ui-file-dragover")}).on("dragleave.drag",function(e){$(s.el).prop("readonly")||$(s.el).prop("disabled")||$(n).removeClass("w2ui-file-dragover")}).on("drop.drag",function(e){if(!$(s.el).prop("readonly")&&!$(s.el).prop("disabled")){$(n).removeClass("w2ui-file-dragover");var i=e.originalEvent.dataTransfer.files;for(let e=0,t=i.length;e<t;e++)s.addFile.call(s,i[e]);$(s.el).focus(),e.preventDefault(),e.stopPropagation()}}).on("dragover.drag",function(e){e.preventDefault(),e.stopPropagation()}).on("change.drag",function(){if($(s.el).focus(),void 0!==this.files)for(let e=0,t=this.files.length;e<t;e++)s.addFile.call(s,this.files[e])}),s.refresh()}addFile(t){let i=this;var e=this.options;let s=$(i.el).data("selected"),l={name:t.name,type:t.type,modified:t.lastModifiedDate,size:t.size,content:null,file:t},n=0,a=0,r;if(s)for(let e=0;e<s.length;e++){if(s[e].name==t.name&&s[e].size==t.size)return;n+=s[e].size,a++}let o=i.trigger({phase:"before",type:"add",target:i.el,file:l,total:a,totalSize:n});if(!0!==o.isCancelled){if(0!==e.maxFileSize&&l.size>e.maxFileSize)return r="Maximum file size is "+w2utils.formatSize(e.maxFileSize),!1===e.silent&&$(i.el).w2tag(r),void console.log("ERROR: "+r);if(0!==e.maxSize&&n+l.size>e.maxSize)return r=w2utils.lang("Maximum total size is ${count}",{count:w2utils.formatSize(e.maxSize)}),!1===e.silent&&$(i.el).w2tag(r),void console.log("ERROR: "+r);if(0!==e.max&&a>=e.max)return r=w2utils.lang("Maximum number of files is ${count}",{count:e.max}),!1===e.silent&&$(i.el).w2tag(r),void console.log("ERROR: "+r);if(s.push(l),"undefined"!=typeof FileReader&&!0===e.readContent){let e=new FileReader;e.onload=function(e){let t=e.target.result;e=t.indexOf(",");l.content=t.substr(e+1),i.refresh(),$(i.el).trigger("input").trigger("change"),i.trigger($.extend(o,{phase:"after"}))},e.readAsDataURL(t)}else i.refresh(),$(i.el).trigger("input").trigger("change"),i.trigger($.extend(o,{phase:"after"}))}}getMonthHTML(r,o,d){let e=new Date;var t=w2utils.settings.fullmonths;let h=["31","28","31","30","31","30","31","31","30","31","30","31"];var u=e.getFullYear()+"/"+(Number(e.getMonth())+1)+"/"+e.getDate();let i=w2utils.settings.fulldays.slice(),s=w2utils.settings.shortdays.slice();"M"!==w2utils.settings.weekStarts&&(i.unshift(i.pop()),s.unshift(s.pop()));let c=this.options;null==c&&(c={}),o=w2utils.isInt(o)?parseInt(o):e.getFullYear(),12<(r=w2utils.isInt(r)?parseInt(r):e.getMonth()+1)&&(r-=12,o++),(r<1||0===r)&&(r+=12,o--),o/4==Math.floor(o/4)?h[1]="29":h[1]="28",c.current=r+"/"+o,e=new Date(o,r-1,1);let p=e.getDay(),l="";for(let e=0;e<s.length;e++)l+='<td title="'+i[e]+'">'+s[e]+"</td>";let f='<div class="w2ui-calendar-title title">    <div class="w2ui-calendar-previous previous"> <div></div> </div>    <div class="w2ui-calendar-next next"> <div></div> </div> '+t[r-1]+", "+o+'       <span class="arrow-down" style="position: relative; top: -1px; left: 5px; opacity: 0.6;"></span></div><table class="w2ui-calendar-days" cellspacing="0"><tbody>    <tr class="w2ui-day-title">'+l+"</tr>    <tr>",g=1;"M"!==w2utils.settings.weekStarts&&p++,"datetime"===this.type&&(t=w2utils.isDateTime(d,c.format,!0),d=w2utils.formatDate(t,w2utils.settings.dateFormat));for(let a=1;a<43;a++){if(0===p&&1==a){for(let e=0;e<6;e++)f+='<td class="w2ui-day-empty">&#160;</td>';a+=6}else if(a<p||g>h[r-1]){f+='<td class="w2ui-day-empty">&#160;</td>',a%7==0&&(f+="</tr><tr>");continue}var m=o+"/"+r+"/"+g;let e=new Date(m),t="";6===e.getDay()&&(t=" w2ui-saturday"),0===e.getDay()&&(t=" w2ui-sunday"),m==u&&(t+=" w2ui-today");var w=g;let i="",s="",l,n;n="datetime"===this.type?(l=w2utils.formatDateTime(m,c.format),w2utils.formatDate(m,w2utils.settings.dateFormat)):(l=w2utils.formatDate(m,c.format),l),c.colored&&void 0!==c.colored[n]&&(m=c.colored[n].split(":"),s="background-color: "+m[0]+";",i="color: "+m[1]+";"),f+='<td class="'+(this.inRange(l,!0)?"w2ui-date "+(n==d?"w2ui-date-selected":""):"w2ui-blocked")+t+'"    style="'+i+s+'" date="'+l+'" data-date="'+e+'">'+w+"</td>",(a%7==0||0===p&&1==a)&&(f+="</tr><tr>"),g++}return f+="</tr></tbody></table>",f}getYearHTML(){var t=w2utils.settings.shortmonths,i=w2utils.settings.dateStartYear,s=w2utils.settings.dateEndYear;let l="",n="";for(let e=0;e<t.length;e++)l+='<div class="w2ui-jump-month" name="'+e+'">'+t[e]+"</div>";for(let e=i;e<=s;e++)n+='<div class="w2ui-jump-year" name="'+e+'">'+e+"</div>";return'<div id="w2ui-jump-month">'+l+'</div><div id="w2ui-jump-year">'+n+"</div>"}getHourHTML(){let l=[],n=this.options;null==n&&(n={format:w2utils.settings.timeFormat});var a,r,o=-1<n.format.indexOf("h24");for(let s=0;s<24;s++){let e=(12<=s&&!o?s-12:s)+":00"+(o?"":s<12?" am":" pm");12!=s||o||(e="12:00 pm"),l[Math.floor(s/8)]||(l[Math.floor(s/8)]="");let t=this.fromMin(this.toMin(e)),i=this.fromMin(this.toMin(e)+59);"datetime"===this.type&&(a=w2utils.isDateTime(this.el.value,n.format,!0),r=n.format.split("|")[0].trim(),t=w2utils.formatDate(a,r)+" "+t,i=w2utils.formatDate(a,r)+" "+i),l[Math.floor(s/8)]+='<div class="'+(this.inRange(t)||this.inRange(i)?"w2ui-time ":"w2ui-blocked")+'" hour="'+s+'">'+e+"</div>"}return'<div class="w2ui-calendar">   <div class="w2ui-calendar-title">'+w2utils.lang("Select Hour")+'</div>   <div class="w2ui-calendar-time"><table><tbody><tr>       <td>'+l[0]+"</td>       <td>"+l[1]+"</td>       <td>"+l[2]+"</td>   </tr></tbody></table></div></div>"}getMinHTML(i){null==i&&(i=0);let s=this.options;null==s&&(s={format:w2utils.settings.timeFormat});var l=-1<s.format.indexOf("h24");let n=[];for(let t=0;t<60;t+=5){var a=(12<i&&!l?i-12:i)+":"+(t<10?0:"")+t+" "+(l?"":i<12?"am":"pm");let e=a;var r,o,d=t<20?0:t<40?1:2;n[d]||(n[d]=""),"datetime"===this.type&&(r=w2utils.isDateTime(this.el.value,s.format,!0),o=s.format.split("|")[0].trim(),e=w2utils.formatDate(r,o)+" "+e),n[d]+='<div class="'+(this.inRange(e)?"w2ui-time ":"w2ui-blocked")+'" min="'+t+'">'+a+"</div>"}return'<div class="w2ui-calendar">   <div class="w2ui-calendar-title">'+w2utils.lang("Select Minute")+'</div>   <div class="w2ui-calendar-time"><table><tbody><tr>       <td>'+n[0]+"</td>       <td>"+n[1]+"</td>       <td>"+n[2]+"</td>   </tr></tbody></table></div></div>"}toMin(e){if("string"!=typeof e)return null;let t=e.split(":");return 2!==t.length?null:(t[0]=parseInt(t[0]),t[1]=parseInt(t[1]),-1!==e.indexOf("pm")&&12!==t[0]&&(t[0]+=12),60*t[0]+t[1])}fromMin(e){let t="";1440<=e&&(e%=1440),e<0&&(e=1440+e);var i=Math.floor(e/60),e=(e%60<10?"0":"")+e%60;let s=this.options;return null==s&&(s={format:w2utils.settings.timeFormat}),t=-1!==s.format.indexOf("h24")?i+":"+e:(i<=12?i:i-12)+":"+e+" "+(12<=i?"pm":"am"),t}}class w2form extends w2event{constructor(e){super(e.name),this.name=null,this.header="",this.box=null,this.url="",this.routeData={},this.formURL="",this.formHTML="",this.page=0,this.pageStyle="",this.recid=0,this.fields=[],this.actions={},this.record={},this.original=null,this.postData={},this.httpHeaders={},this.method=null,this.toolbar={},this.tabs={},this.style="",this.focus=0,this.autosize=!0,this.nestedFields=!0,this.multipart=!1,this.tabindexBase=0,this.isGenerated=!1,this.last={xhr:null,errors:[]},this.onRequest=null,this.onLoad=null,this.onValidate=null,this.onSubmit=null,this.onProgress=null,this.onSave=null,this.onChange=null,this.onInput=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onAction=null,this.onToolbar=null,this.onError=null,this.msgNotJSON="Returned data is not in valid JSON format.",this.msgAJAXerror="AJAX error. See console for more details.",this.msgRefresh="Loading...",this.msgSaving="Saving...",$.extend(!0,this,e);var t,i,s=e.record,l=e.original,n=e.fields,a=e.toolbar;let r=e.tabs;if($.extend(this,{record:{},original:null,fields:[],tabs:{},toolbar:{},handlers:[]}),n&&(n=function l(n){let a=[];let r=[];if($.isPlainObject(n)){let e=n;function o(t){let i=["html"];return null==t.html&&(t.html={}),Object.keys(t).forEach(e=>{-1==i.indexOf(e)&&-1!=["label","attr","style","text","span","page","column","anchor","group","groupStyle","groupTitleStyle","groupCollapsible"].indexOf(e)&&(t.html[e]=t[e],delete t[e])}),t}function d(t,i){let s=["style","html"];Object.keys(t).forEach(e=>{-1==s.indexOf(e)&&-1!=["span","column","attr","text","label"].indexOf(e)&&t[e]&&!i.html[e]&&(i.html[e]=t[e])})}n=[],Object.keys(e).forEach(i=>{let s=e[i];if("group"==s.type){if(s.text=i,$.isPlainObject(s.fields)){let i=s.fields;s.fields=[],Object.keys(i).forEach(e=>{let t=i[e];t.field=e,s.fields.push(o(t))})}n.push(s)}else if("tab"==s.type){let e={id:i,text:i};s.style&&(e.style=s.style),r.push(e);let t=l(s.fields).fields;t.forEach(e=>{e.html=e.html||{},e.html.page=r.length-1,d(s,e)}),n.push(...t)}else s.field=i,n.push(o(s))})}n.forEach(s=>{if("group"==s.type){let i={group:s.text||"",groupStyle:s.style||"",groupTitleStyle:s.titleStyle||"",groupCollapsible:!0===s.collapsible};Array.isArray(s.fields)&&s.fields.forEach(e=>{let t=$.extend(!0,{},e);null==t.html&&(t.html={}),$.extend(t.html,i),Array("span","column","attr","label","page").forEach(e=>{null==t.html[e]&&null!=s[e]&&(t.html[e]=s[e])}),null==t.field&&null!=t.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",s),t.field=t.name),a.push(t)})}else{let e=$.extend(!0,{},s);null==e.field&&null!=e.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",s),e.field=e.name),a.push(e)}});return{fields:a,tabs:r}}(n),this.fields=n.fields,!r&&0<n.tabs.length&&(r=n.tabs)),Array.isArray(r)){$.extend(!0,this.tabs,{tabs:[]});for(let e=0;e<r.length;e++){var o=r[e];"object"==typeof o?(this.tabs.tabs.push(o),!0===o.active&&(this.tabs.active=o.id)):this.tabs.tabs.push({id:o,text:o})}}else $.extend(!0,this.tabs,r);for(t in $.extend(!0,this.toolbar,a),s)$.isPlainObject(s[t])?this.record[t]=$.extend(!0,{},s[t]):this.record[t]=s[t];for(i in l)$.isPlainObject(l[i])?this.original[i]=$.extend(!0,{},l[i]):this.original[i]=l[i];""!==this.formURL?$.get(this.formURL,e=>{this.formHTML=e,this.isGenerated=!0}):this.formURL||this.formHTML||(this.formHTML=this.generateHTML(),this.isGenerated=!0)}get(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.fields.length;e++)null!=this.fields[e].field&&t.push(this.fields[e].field);return t}for(let e=0;e<this.fields.length;e++)if(this.fields[e].field==t)return!0===i?e:this.fields[e];return null}set(t,i){for(let e=0;e<this.fields.length;e++)if(this.fields[e].field==t)return $.extend(this.fields[e],i),this.refresh(t),!0;return!1}getValue(t){if(this.nestedFields){let e=void 0;try{var i=this.record;e=String(t).split(".").reduce((e,t)=>e[t],i)}catch(e){}return e}return this.record[t]}setValue(e,l){if(!this.nestedFields)return this.record[e]=l,!0;try{let s=this.record;return String(e).split(".").map((e,t,i)=>{i.length-1!==t?s=s[e]||(s[e]={},s[e]):s[e]=l}),!0}catch(e){return!1}}show(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&e.hidden&&(e.hidden=!1,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),this.updateEmptyGroups(),i}hide(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&!e.hidden&&(e.hidden=!0,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),this.updateEmptyGroups(),i}enable(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&e.disabled&&(e.disabled=!1,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),i}disable(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&!e.disabled&&(e.disabled=!0,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),i}updateEmptyGroups(){$(this.box).find(".w2ui-group").each((e,t)=>{!function(e){let i=!0;return e.each((e,t)=>{"none"!=t.style.display&&(i=!1)}),i}($(t).find(".w2ui-field"))?$(t).show():$(t).hide()})}change(){Array.from(arguments).forEach(e=>{let t=this.get(e);t.$el&&t.$el.change()})}reload(e){("object"!=typeof this.url?this.url:this.url.get)&&0!==this.recid&&null!=this.recid?this.request(e):"function"==typeof e&&e()}clear(){0!=arguments.length?Array.from(arguments).forEach(e=>{let s=this.record;String(e).split(".").map((e,t,i)=>{i.length-1!==t?s=s[e]:delete s[e]}),this.refresh(e)}):(this.recid=0,this.record={},this.original=null,this.refresh()),$().w2tag()}error(e){let t=this;var i=this.trigger({target:this.name,type:"error",message:e,xhr:this.last.xhr});!0!==i.isCancelled&&(setTimeout(()=>{t.message(e)},1),this.trigger($.extend(i,{phase:"after"})))}message(t){let i=this;(t="string"==typeof t?{width:t.length<300?350:550,height:t.length<300?170:250,body:`<div class="w2ui-centered">${t}</div>`,onOpen(e){setTimeout(()=>{w2utils.bindEvents($(i.box).find(".w2ui-btn"),i),$(e.box).find(".w2ui-btn").off(".message").on("keydown.message",function(e){27==e.keyCode&&$(e.target).click()}).focus()},25)},onClose(e){"function"==typeof t.callBack&&t.callBack(e)}}:t)&&null==t.buttons&&(t.buttons=`<button type="button" class="w2ui-btn" data-click="message">
                ${w2utils.lang("Ok")}
            </button>`),w2utils.message.call(this,{box:this.box,path:"w2ui."+this.name,title:".w2ui-form-header:visible",body:".w2ui-form-box"},t).then(e=>{"function"==typeof t.then&&t.then(e)});let s={ok(e){return t.callBack=e,s},then(e){return t.then=e,s}};return s}confirm(s){let l=this;"string"==typeof s&&(s={width:s.length<300?350:550,height:s.length<300?170:250,body:'<div class="w2ui-centered">'+s+"</div>"});let n=e=>{"function"==typeof s.no_click&&s.no_click(e),"function"==typeof s.callBack&&s.callBack(Object.assign(e,{answer:"no"})),l.message()};var e=`<button type="button" class="w2ui-btn btn-yes ${s.yes_class||""}">${w2utils.lang(s.yes_text||"Yes")}</button>`,t=`<button type="button" class="w2ui-btn btn-no ${s.no_class||""}">${w2utils.lang(s.no_text||"No")}</button>`;Object.assign(s,{buttons:w2utils.settings.macButtonOrder?t+e:e+t,onOpen(i){setTimeout(()=>{let t=$(this.box).find(".w2ui-btn");t.off(".message").on("blur.message",function(e){t.index(e.target)+1===t.length&&(t.get(0).focus(),e.preventDefault())}).on("keydown.message",function(e){27==e.keyCode&&n(i)}).focus(),$(this.box).find(".w2ui-btn.btn-yes").off("click").on("click",()=>{var e;e=i,"function"==typeof s.yes_click&&s.yes_click(e),"function"==typeof s.callBack&&s.callBack(Object.assign(e,{answer:"yes"})),l.message()}),$(this.box).find(".w2ui-btn.btn-no").off("click").on("click",()=>{n(i)})},25)}}),w2utils.message.call(this,{box:this.box,path:"w2ui."+this.name,title:".w2ui-form-header:visible",body:".w2ui-form-box"},s).then(e=>{"function"==typeof s.then&&s.then(e)});let i={yes(e){return s.yes_click=e,i},no(e){return s.no_click=e,i},answer(e){return s.callBack=e,i},then(e){return s.then=e,i}};return i}validate(e){null==e&&(e=!0),$().w2tag();let i=[];for(let t=0;t<this.fields.length;t++){let e=this.fields[t];var s,l;switch(null==this.getValue(e.field)&&this.setValue(e.field,""),-1!=["int","float","currency","money"].indexOf(e.type)&&(s=this.getValue(e.field),l=e.options.min,n=e.options.max,null!=l&&s<l&&i.push({field:e,error:w2utils.lang("Should be more than ${min}",{min:l})}),null!=n&&n<s&&i.push({field:e,error:w2utils.lang("Should be less than ${max}",{max:n})})),e.type){case"alphanumeric":this.getValue(e.field)&&!w2utils.isAlphaNumeric(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not alpha-numeric")});break;case"int":this.getValue(e.field)&&!w2utils.isInt(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not an integer")});break;case"percent":case"float":this.getValue(e.field)&&!w2utils.isFloat(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a float")});break;case"currency":case"money":this.getValue(e.field)&&!w2utils.isMoney(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not in money format")});break;case"color":case"hex":this.getValue(e.field)&&!w2utils.isHex(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a hex number")});break;case"email":this.getValue(e.field)&&!w2utils.isEmail(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a valid email")});break;case"checkbox":1==this.getValue(e.field)?this.setValue(e.field,1):this.setValue(e.field,0);break;case"date":e.options.format||(e.options.format=w2utils.settings.dateFormat),this.getValue(e.field)&&!w2utils.isDate(this.getValue(e.field),e.options.format)&&i.push({field:e,error:w2utils.lang("Not a valid date")+": "+e.options.format})}var n=this.getValue(e.field);e.required&&!0!==e.hidden&&-1==["div","custom","html","empty"].indexOf(e.type)&&(""===n||Array.isArray(n)&&0===n.length||$.isPlainObject(n)&&$.isEmptyObject(n))&&i.push({field:e,error:w2utils.lang("Required field")}),e.options&&!0!==e.hidden&&0<e.options.minLength&&-1==["enum","list","combo"].indexOf(e.type)&&this.getValue(e.field).length<e.options.minLength&&i.push({field:e,error:w2utils.lang("Field should be at least ${count} characters.",{count:e.options.minLength})})}var t=this.trigger({phase:"before",target:this.name,type:"validate",errors:i});if(!0!==t.isCancelled)return this.last.errors=i,e&&this.showErrors(),this.trigger($.extend(t,{phase:"after"})),i}showErrors(){let i=this.last.errors;if(0<i.length){var t=i[0];this.goto(i[0].field.page),$(t.field.$el).parents(".w2ui-field")[0].scrollIntoView(!0);for(let e=0;e<i.length;e++){var t=i[e],s=$.extend({class:"w2ui-error",hideOnFocus:!0},t.options);null!=t.field&&("radio"===t.field.type?$($(t.field.el).closest("div")[0]).w2tag(t.error,s):-1!==["enum","file"].indexOf(t.field.type)?function(t){setTimeout(()=>{var e=$(t.field.el).data("w2field").helpers.multi;$(t.field.el).w2tag(t.error,t.options),$(e).addClass("w2ui-error")},1)}(t):$(t.field.el).w2tag(t.error,s))}setTimeout(()=>{let t=i[0];$(t.field.$el).parents(".w2ui-page").off(".hideErrors").on("scroll.hideErrors",function(e){for(let e=0;e<i.length;e++)t=i[e],$(t.field.el).w2tag();$(t.field.$el).parents(".w2ui-page").off(".hideErrors")})},300)}}getChanges(){let e={};return null==this.original||"object"!=typeof this.original||$.isEmptyObject(this.record)||(e=function e(t,i,s){if(Array.isArray(t)&&Array.isArray(i))for(;t.length<i.length;)t.push(null);for(var l in t)null!=t[l]&&"object"==typeof t[l]?(s[l]=e(t[l],i[l]||{},{}),(!s[l]||$.isEmptyObject(s[l])&&$.isEmptyObject(i[l]))&&delete s[l]):(t[l]!=i[l]||null==t[l]&&null!=i[l])&&(s[l]=t[l]);return $.isEmptyObject(s)?null:s}(this.record,this.original,{})),e}getCleanRecord(e){let l=$.extend(!0,{},this.record);return this.fields.forEach(t=>{if(-1!=["list","combo","enum"].indexOf(t.type)){var s={nestedFields:!0,record:l};let i=this.getValue.call(s,t.field);$.isPlainObject(i)&&null!=i.id&&this.setValue.call(s,t.field,i.id),Array.isArray(i)&&i.forEach((e,t)=>{$.isPlainObject(e)&&e.id&&(i[t]=e.id)})}if("map"==t.type){s={nestedFields:!0,record:l};let e=this.getValue.call(s,t.field);e._order&&delete e._order}}),!0===e&&Object.keys(l).forEach(e=>{this.get(e)||delete l[e]}),l}request(s,l){let n=this;if("function"==typeof s&&(l=s,s=null),null==s&&(s={}),this.url&&("object"!=typeof this.url||this.url.get)){null==this.recid&&(this.recid=0);let e={cmd:"get"};e.recid=this.recid,e.name=this.name,$.extend(e,this.postData),$.extend(e,s);s=this.trigger({phase:"before",type:"request",target:this.name,url:this.url,postData:e,httpHeaders:this.httpHeaders});if(!0!==s.isCancelled){this.record={},this.original=null,this.lock(w2utils.lang(this.msgRefresh));let t=s.url;if("object"==typeof s.url&&s.url.get&&(t=s.url.get),this.last.xhr)try{this.last.xhr.abort()}catch(e){}if(!$.isEmptyObject(n.routeData)){var a=w2utils.parseRoute(t);if(0<a.keys.length)for(let e=0;e<a.keys.length;e++)null!=n.routeData[a.keys[e].name]&&(t=t.replace(new RegExp(":"+a.keys[e].name,"g"),n.routeData[a.keys[e].name]))}let e={type:"POST",url:t,data:s.postData,headers:s.httpHeaders,dataType:"json"},i=n.dataType||w2utils.settings.dataType;switch(s.dataType&&(i=s.dataType),i){case"HTTP":e.data=String($.param(e.data,!1)).replace(/%5B/g,"[").replace(/%5D/g,"]");break;case"HTTPJSON":e.data={request:JSON.stringify(e.data)};break;case"RESTFULL":e.type="GET",e.data=String($.param(e.data,!1)).replace(/%5B/g,"[").replace(/%5D/g,"]");break;case"RESTFULLJSON":e.type="GET",e.data=JSON.stringify(e.data),e.contentType="application/json";break;case"JSON":e.type="POST",e.data=JSON.stringify(e.data),e.contentType="application/json"}this.method&&(e.type=this.method),s.method&&(e.type=s.method),this.last.xhr=$.ajax(e).done((e,t,i)=>{n.unlock(),null==(e=i.responseJSON)&&(e={status:"error",message:w2utils.lang(n.msgNotJSON),responseText:i.responseText});i=n.trigger({phase:"before",target:n.name,type:"load",data:e,xhr:i});!0!==i.isCancelled?("error"===i.data.status?n.error(w2utils.lang(i.data.message)):n.record=$.extend({},i.data.record),n.trigger($.extend(i,{phase:"after"})),n.refresh(),n.applyFocus(),"function"==typeof l&&l(i.data)):"function"==typeof l&&l({status:"error",message:w2utils.lang("Request aborted.")})}).fail((t,e,i)=>{i={status:e,error:i,rawResponseText:t.responseText},i=n.trigger({phase:"before",type:"error",error:i,xhr:t});if(!0!==i.isCancelled){if("abort"!==e){let e;try{e="object"==typeof t.responseJSON?t.responseJSON:JSON.parse(t.responseText)}catch(e){}console.log("ERROR: Server communication failed.","\n   EXPECTED:",{status:"success",items:[{id:1,text:"item"}]},"\n         OR:",{status:"error",message:"error message"},"\n   RECEIVED:","object"==typeof e?e:t.responseText),n.unlock()}n.trigger($.extend(i,{phase:"after"}))}}),this.trigger($.extend(s,{phase:"after"}))}else"function"==typeof l&&l({status:"error",message:w2utils.lang("Request aborted.")})}}submit(e,t){return this.save(e,t)}save(t,n){let a=this;$(this.box).find(":focus").change(),"function"==typeof t&&(n=t,t=null),0===a.validate(!0).length&&(null==t&&(t={}),a.url&&("object"!=typeof a.url||a.url.save)?(a.lock(w2utils.lang(a.msgSaving)+' <span id="'+a.name+'_progress"></span>'),setTimeout(()=>{let e={cmd:"save"};e.recid=a.recid,e.name=a.name,$.extend(e,a.postData),$.extend(e,t),a.multipart||a.fields.forEach(e=>{"file"===e.type&&Array.isArray(a.getValue(e.field))&&a.getValue(e.field).forEach(e=>{delete e.file})}),e.record=$.extend(!0,{},a.record);var s=a.trigger({phase:"before",type:"submit",target:a.name,url:a.url,postData:e,httpHeaders:a.httpHeaders});if(!0!==s.isCancelled){let t=s.url;if("object"==typeof s.url&&s.url.save&&(t=s.url.save),a.last.xhr)try{a.last.xhr.abort()}catch(e){}if(!$.isEmptyObject(a.routeData)){var l=w2utils.parseRoute(t);if(0<l.keys.length)for(let e=0;e<l.keys.length;e++)null!=a.routeData[l.keys[e].name]&&(t=t.replace(new RegExp(":"+l.keys[e].name,"g"),a.routeData[l.keys[e].name]))}let i={type:"POST",url:t,data:s.postData,headers:s.httpHeaders,dataType:"json",xhr(){let e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){var t;!e.lengthComputable||!0!==(t=a.trigger({phase:"before",type:"progress",total:e.total,loaded:e.loaded,originalEvent:e})).isCancelled&&(((e=Math.round(e.loaded/e.total*100))&&100!=e||""!=$(a.box).find("#"+a.name+"_progress").text())&&$(a.box).find("#"+a.name+"_progress").text(e+"%"),a.trigger($.extend(t,{phase:"after"})))},!1),e}},e=a.dataType||w2utils.settings.dataType;switch(s.dataType&&(e=s.dataType),e){case"HTTP":i.data=String($.param(i.data,!1)).replace(/%5B/g,"[").replace(/%5D/g,"]");break;case"HTTPJSON":i.data={request:JSON.stringify(i.data)};break;case"RESTFULL":0!==a.recid&&null!=a.recid&&(i.type="PUT"),i.data=String($.param(i.data,!1)).replace(/%5B/g,"[").replace(/%5D/g,"]");break;case"RESTFULLJSON":0!==a.recid&&null!=a.recid&&(i.type="PUT"),i.data=JSON.stringify(i.data),i.contentType="application/json";break;case"JSON":if(i.type="POST",i.contentType="application/json",a.multipart){function r(e,t,i,s){for(var l in null==s&&(s=""),t){var n=""==s?l:"${p}[${prop}]",a=i&&i[l];!function t(i,s,l){if("object"==typeof i&&i instanceof File&&e.append(l,i),"object"==typeof i)if(i&&i.constructor===Array)for(let e=0;e<i.length;e++){var n=s&&s[e];t(i[e],n,l+"["+e+"]")}else r(e,i,s,l)}(t[l],a,n)}}let e=new FormData;e.append("__body",JSON.stringify(i.data)),r(e,i.data),i.data=e,i.contentType=!1,i.processData=!1}else i.data=JSON.stringify(i.data)}this.method&&(i.type=this.method),s.method&&(i.type=s.method),a.last.xhr=$.ajax(i).done((e,t,i)=>{a.unlock();t=a.trigger({phase:"before",target:a.name,type:"save",xhr:i,status:t,data:e});!0!==t.isCancelled&&("error"===(e=null==(e=i.responseJSON)?{status:"error",message:w2utils.lang(a.msgNotJSON),responseText:i.responseText}:e).status?a.error(w2utils.lang(e.message)):a.original=null,a.trigger($.extend(t,{phase:"after"})),a.refresh(),"function"==typeof n&&n(e,i))}).fail((e,t,i)=>{i={status:t,error:i,rawResponseText:e.responseText},e=a.trigger({phase:"before",type:"error",error:i,xhr:e});!0!==e.isCancelled&&(console.log("ERROR: server communication failed. The server should return",{status:"success"},"OR",{status:"error",message:"error message"},", instead the AJAX request produced this: ",i),a.unlock(),a.trigger($.extend(e,{phase:"after"})))}),a.trigger($.extend(s,{phase:"after"}))}},50)):console.log("ERROR: Form cannot be saved because no url is defined."))}lock(e,t){let i=Array.prototype.slice.call(arguments,0);i.unshift(this.box),setTimeout(()=>{w2utils.lock.apply(window,i)},10)}unlock(e){let t=this.box;setTimeout(()=>{w2utils.unlock(t,e)},25)}lockPage(e,t,i){e=$(this.box).find(".page-"+e);return!!e.length&&(w2utils.lock(e,t,i),!0)}unlockPage(e,t){e=$(this.box).find(".page-"+e);return!!e.length&&(w2utils.unlock(e,t),!0)}goto(e){this.page!==e&&(null!=e&&(this.page=e),$(this.box).find(":focus").change(),!0===$(this.box).data("auto-size")&&$(this.box).height(0),this.refresh())}generateHTML(){let l=[],t="",n,a,r,o;var d;for(let e=0;e<this.fields.length;e++){r="",o=this.tabindexBase+e+1,d=' tabindex="'+o+'"';let i=this.fields[e];null==i.html&&(i.html={}),null==i.options&&(i.options={}),null!=i.html.caption&&null==i.html.label&&(console.log("NOTICE: form field.html.caption property is deprecated, please use field.html.label. Field ->",i),i.html.label=i.html.caption),null==i.html.label&&(i.html.label=i.field),i.html=$.extend(!0,{label:"",span:6,attr:"",text:"",style:"",page:0,column:0},i.html),null==n&&(n=i.html.page),null==a&&(a=i.html.column);let s='<input id="'+i.field+'" name="'+i.field+'" class="w2ui-input" type="text" '+i.html.attr+d+">";switch(i.type){case"pass":case"password":s='<input id="'+i.field+'" name="'+i.field+'" class="w2ui-input" type = "password" '+i.html.attr+d+">";break;case"check":case"checks":{null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;s="",Array.isArray(t)||(t=[]),0<t.length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+='<label class="w2ui-box-label">  <input id="'+i.field+e+'" name="'+i.field+'" class="w2ui-input" type="checkbox" '+i.html.attr+d+' data-value="'+t[e].id+'" data-index="'+e+'"><span>&#160;'+t[e].text+"</span></label><br>";break}case"checkbox":s='<label class="w2ui-box-label">   <input id="'+i.field+'" name="'+i.field+'" class="w2ui-input" type="checkbox" '+i.html.attr+d+">   <span>"+i.html.label+"</span></label>";break;case"radio":{s="",null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;Array.isArray(t)||(t=[]),0<t.length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+='<label class="w2ui-box-label">  <input id="'+i.field+e+'" name="'+i.field+'" class="w2ui-input" type = "radio" '+i.html.attr+(0===e?d:"")+' value="'+t[e].id+'"><span>&#160;'+t[e].text+"</span></label><br>";break}case"select":{s='<select id="'+i.field+'" name="'+i.field+'" class="w2ui-input" '+i.html.attr+d+">",null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;Array.isArray(t)||(t=[]),0<t.length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+='<option value="'+t[e].id+'">'+t[e].text+"</option>";s+="</select>";break}case"textarea":s='<textarea id="'+i.field+'" name="'+i.field+'" class="w2ui-input" '+i.html.attr+d+"></textarea>";break;case"toggle":s='<input id="'+i.field+'" name="'+i.field+'" type="checkbox" '+i.html.attr+d+' class="w2ui-input w2ui-toggle"><div><div></div></div>';break;case"map":case"array":i.html.key=i.html.key||{},i.html.value=i.html.value||{},i.html.tabindex_str=d,s='<span style="float: right">'+(i.html.text||"")+'</span><input id="'+i.field+'" name="'+i.field+'" type="hidden" '+i.html.attr+d+'><div class="w2ui-map-container"></div>';break;case"div":case"custom":s='<div id="'+i.field+'" name="'+i.field+'" '+i.html.attr+d+' class="w2ui-input">'+(i&&i.html&&i.html.html?i.html.html:"")+"</div>";break;case"html":case"empty":s=i&&i.html?(i.html.html||"")+(i.html.text||""):""}if(""!==t&&(n!=i.html.page||a!=i.html.column||i.html.group&&t!=i.html.group)&&(l[n][a]+="\n   </div>\n  </div>",t=""),i.html.group&&t!=i.html.group){let e="";i.html.groupCollapsible&&(e='<span class="w2ui-icon-collapse" style="width: 15px; display: inline-block; position: relative; top: -2px;"></span>'),r+='\n <div class="w2ui-group">\n   <div class="w2ui-group-title w2ui-eaction" style="'+(i.html.groupTitleStyle||"")+"; "+(""!=e?"cursor: pointer; user-select: none":"")+'"'+(""!=e?'data-group="'+w2utils.base64encode(i.html.group)+'"':"")+(""!=e?'data-click="toggleGroup|'+i.html.group+'"':"")+">"+e+w2utils.lang(i.html.group)+'</div>\n   <div class="w2ui-group-fields" style="'+(i.html.groupStyle||"")+'">',t=i.html.group}if(null==i.html.anchor){let e=null!=i.html.span?"w2ui-span"+i.html.span:"";-1==i.html.span&&(e="w2ui-span-none");let t="<label"+("none"==e?' style="display: none"':"")+">"+w2utils.lang("checkbox"!=i.type?i.html.label:i.html.text)+"</label>";i.html.label||(t=""),r+='\n      <div class="w2ui-field '+e+'" style="'+(i.hidden?"display: none;":"")+i.html.style+'">\n         '+t+("empty"===i.type?s:"\n         <div>"+s+("array"!=i.type&&"map"!=i.type?w2utils.lang("checkbox"!=i.type?i.html.text:""):"")+"</div>")+"\n      </div>"}else l[i.html.page].anchors=l[i.html.page].anchors||{},l[i.html.page].anchors[i.html.anchor]='<div class="w2ui-field w2ui-field-inline" style="'+(i.hidden?"display: none;":"")+i.html.style+'">'+("empty"===i.type?s:"<div>"+w2utils.lang("checkbox"!=i.type?i.html.label:i.html.text,!0)+s+w2utils.lang("checkbox"!=i.type?i.html.text:"")+"</div>")+"</div>";null==l[i.html.page]&&(l[i.html.page]={}),null==l[i.html.page][i.html.column]&&(l[i.html.page][i.html.column]=""),l[i.html.page][i.html.column]+=r,n=i.html.page,a=i.html.column}if(""!==t&&(l[n][a]+="\n   </div>\n  </div>"),this.tabs.tabs)for(let e=0;e<this.tabs.tabs.length;e++)null==l[e]&&(l[e]=[]);let i="";if(!$.isEmptyObject(this.actions)){for(var s in i+='\n<div class="w2ui-buttons">',o=this.tabindexBase+this.fields.length+1,this.actions){let e=this.actions[s],t={text:"",style:"",class:""};$.isPlainObject(e)?(null==e.text&&null!=e.caption&&(console.log("NOTICE: form action.caption property is deprecated, please use action.text. Action ->",e),e.text=e.caption),e.text&&(t.text=e.text),e.style&&(t.style=e.style),e.class&&(t.class=e.class)):(t.text=s,-1!==["save","update","create"].indexOf(s.toLowerCase())?t.class="w2ui-btn-blue":t.class=""),i+='\n    <button name="'+s+'" class="w2ui-btn '+t.class+'" style="'+t.style+'" tabindex="'+o+'">'+w2utils.lang(t.text)+"</button>",o++}i+="\n</div>"}r="";for(let i=0;i<l.length;i++){if(r+='<div class="w2ui-page page-'+i+'" style="'+(0!==i?"display: none;":"")+this.pageStyle+'">',!l[i])return console.log(`ERROR: Page ${i} does not exist`),!1;l[i].before&&(r+=l[i].before),r+='<div class="w2ui-column-container">',Object.keys(l[i]).sort().forEach((e,t)=>{e==parseInt(e)&&(r+='<div class="w2ui-column col-'+e+'">'+(l[i][e]||"")+"\n</div>")}),r+="\n</div>",l[i].after&&(r+=l[i].after),r+="\n</div>",l[i].anchors&&Object.keys(l[i].anchors).forEach((e,t)=>{r=r.replace(e,l[i].anchors[e])})}return r+=i,r}toggleGroup(e,i){let s=$(this.box).find('.w2ui-group-title[data-group="'+w2utils.base64encode(e)+'"]');if(s&&s.length){let t=s.next();if(i=void 0===i?"none"==t.css("display"):i)t.slideDown(300),t.next().remove(),s.find("span").addClass("w2ui-icon-collapse").removeClass("w2ui-icon-expand");else{t.slideUp(300);let e="width: "+t.css("width")+";padding-left: "+t.css("padding-left")+";padding-right: "+t.css("padding-right")+";margin-left: "+t.css("margin-left")+";margin-right: "+t.css("margin-right")+";";setTimeout(()=>{t.after('<div style="height: 5px;'+e+'"></div>')},100),s.find("span").addClass("w2ui-icon-expand").removeClass("w2ui-icon-collapse")}}}action(e,t){var i=this.actions[e];let s=i;$.isPlainObject(i)&&i.onClick&&(s=i.onClick);i=this.trigger({phase:"before",target:e,type:"action",action:i,originalEvent:t});!0!==i.isCancelled&&("function"==typeof s&&s.call(this,t),this.trigger($.extend(i,{phase:"after"})))}resize(){let a=this;var r=this.trigger({phase:"before",target:this.name,type:"resize"});if(!0!==r.isCancelled){let e=$(this.box).find("> div.w2ui-form-box"),t=$(this.box).find("> div .w2ui-form-header"),i=$(this.box).find("> div .w2ui-form-toolbar"),s=$(this.box).find("> div .w2ui-form-tabs"),l=$(this.box).find("> div .w2ui-page");var o=$(this.box).find("> div .w2ui-page.page-"+this.page),d=$(this.box).find("> div .w2ui-page.page-"+this.page+" > div");let n=$(this.box).find("> div .w2ui-buttons");function h(){e.width($(a.box).width()).height($(a.box).height()),i.css("top",""!==a.header?w2utils.getSize(t,"height"):0),s.css("top",(""!==a.header?w2utils.getSize(t,"height"):0)+("object"==typeof a.toolbar&&Array.isArray(a.toolbar.items)&&0<a.toolbar.items.length?w2utils.getSize(i,"height"):0)),l.css("top",(""!==a.header?w2utils.getSize(t,"height"):0)+("object"==typeof a.toolbar&&Array.isArray(a.toolbar.items)&&0<a.toolbar.items.length?w2utils.getSize(i,"height")+5:0)+("object"==typeof a.tabs&&Array.isArray(a.tabs.tabs)&&0<a.tabs.tabs.length?w2utils.getSize(s,"height")+5:0)),l.css("bottom",0<n.length?w2utils.getSize(n,"height"):0)}h(),this.autosize&&(0!==parseInt($(this.box).height())&&!0!==$(this.box).data("auto-size")||($(this.box).height((0<t.length?w2utils.getSize(t,"height"):0)+("object"==typeof this.tabs&&Array.isArray(this.tabs.tabs)&&0<this.tabs.tabs.length?w2utils.getSize(s,"height"):0)+("object"==typeof this.toolbar&&Array.isArray(this.toolbar.items)&&0<this.toolbar.items.length?w2utils.getSize(i,"height"):0)+(0<l.length?w2utils.getSize(d,"height")+w2utils.getSize(o,"+height")+12:0)+(0<n.length?w2utils.getSize(n,"height"):0)),$(this.box).data("auto-size",!0)),h()),this.toolbar&&this.toolbar.resize&&this.toolbar.resize(),this.tabs&&this.tabs.resize&&this.tabs.resize(),a.trigger($.extend(r,{phase:"after"}))}}refresh(){var e=(new Date).getTime();let o=this;if(this.box&&this.isGenerated&&null!=$(this.box).html()){var t=this.trigger({phase:"before",target:this.name,type:"refresh",page:this.page,field:arguments[0],fields:arguments});if(!0!==t.isCancelled){let s=Array.from(this.fields.keys());0<arguments.length?s=Array.from(arguments).map((e,t)=>("string"!=typeof e&&console.log("ERROR: Arguments in refresh functions should be field names"),this.get(e,!0))).filter((e,t)=>null!=e):($(this.box).find("input, textarea, select").each((e,i)=>{var t=null!=$(i).attr("name")?$(i).attr("name"):$(i).attr("id");let s=o.get(t);if(s){let t=$(i).closest(".w2ui-page");if(0<t.length)for(let e=0;e<100;e++)if(t.hasClass("page-"+e)){s.page=e;break}}}),$(this.box).find(".w2ui-page").hide(),$(this.box).find(".w2ui-page.page-"+this.page).show(),$(this.box).find(".w2ui-form-header").html(w2utils.lang(this.header)),"object"==typeof this.tabs&&Array.isArray(this.tabs.tabs)&&0<this.tabs.tabs.length?($(this.box).find("#form_"+this.name+"_tabs").show(),this.tabs.active=this.tabs.tabs[this.page].id,this.tabs.refresh()):$(this.box).find("#form_"+this.name+"_tabs").hide(),"object"==typeof this.toolbar&&Array.isArray(this.toolbar.items)&&0<this.toolbar.items.length?($(this.box).find("#form_"+this.name+"_toolbar").show(),this.toolbar.refresh()):$(this.box).find("#form_"+this.name+"_toolbar").hide());for(let i=0;i<s.length;i++){let t=this.fields[s[i]];null==t.name&&null!=t.field&&(t.name=t.field),null==t.field&&null!=t.name&&(t.field=t.name),t.$el=$(this.box).find('[name="'+String(t.name).replace(/\\/g,"\\\\")+'"]'),t.el=t.$el[0],t.el&&(t.el.id=t.name);let e=$(t).data("w2field");if(e&&e.clear(),$(t.$el).off(".w2form").on("change.w2form",function(l){let n=this;var e,a=o.get(this.name);if(null!=a)if(1!=$(this).data("skip_change")){let i=this.value,s=o.getValue(this.name);if(null==s&&(s=""),-1!==["list","enum","file"].indexOf(a.type)&&$(this).data("selected")){var t=$(this).data("selected"),r=o.getValue(this.name);if(Array.isArray(t)){i=[];for(let e=0;e<t.length;e++)i[e]=$.extend(!0,{},t[e])}if($.isPlainObject(t)&&(i=$.extend(!0,{},t)),Array.isArray(r)){s=[];for(let e=0;e<r.length;e++)s[e]=$.extend(!0,{},r[e])}$.isPlainObject(r)&&(s=$.extend(!0,{},r))}if(-1!==["toggle","checkbox"].indexOf(a.type)&&(i=!!$(this).prop("checked")&&("on"===$(this).prop("value")||$(this).prop("value"))),-1!==["check","checks"].indexOf(a.type)&&(Array.isArray(s)||(s=[]),i=s.slice(),e=a.options.items[$(this).attr("data-index")],$(this).prop("checked")?i.push(e.id):i.splice(i.indexOf(e.id),1)),-1!==["int","float","percent","money","currency"].indexOf(a.type)&&(i=$(this).data("w2field").clean(i)),i!==s){let e=o.trigger({phase:"before",target:this.name,type:"change",value_new:i,value_previous:s,originalEvent:l});!0===e.isCancelled&&(e.value_new=o.getValue(this.name),$(this).val()!==e.value_new&&($(this).data("skip_change",!0),setTimeout(()=>{$(n).data("skip_change",!1)},10)),$(this).val(e.value_new));let t=e.value_new;-1!==["enum","file"].indexOf(a.type)&&0<t.length&&(a=$(a.el).data("w2field").helpers.multi,$(a).removeClass("w2ui-error")),(""===t||null==t||Array.isArray(t)&&0===t.length||$.isPlainObject(t)&&$.isEmptyObject(t))&&(t=null),o.setValue(this.name,t),o.trigger($.extend(e,{phase:"after"}))}}else $(this).data("skip_change",!1)}).on("input.w2form",function(e){let t=this.value;"checkbox"==e.target.type&&(t=e.target.checked),null==o.original&&($.isEmptyObject(o.record)?o.original={}:o.original=$.extend(!0,{},o.record));e=o.trigger({phase:"before",target:this.name,type:"input",value_new:t,originalEvent:e});!0!==e.isCancelled&&o.trigger($.extend(e,{phase:"after"}))}),t.required?$(t.el).parent().parent().addClass("w2ui-required"):$(t.el).parent().parent().removeClass("w2ui-required"),null!=t.disabled){let e=$(t.el);t.disabled?(null==e.data("w2ui-tabIndex")&&e.data("w2ui-tabIndex",e.prop("tabIndex")),$(t.el).prop("readonly",!0).prop("tabindex",-1).closest(".w2ui-field").addClass("w2ui-disabled")):$(t.el).prop("readonly",!1).prop("tabIndex",e.data("w2ui-tabIndex")).closest(".w2ui-field").removeClass("w2ui-disabled")}e=t.el,e=e||$(this.box).find("#"+t.field),t.hidden?$(e).closest(".w2ui-field").hide():$(e).closest(".w2ui-field").show()}$(this.box).find("button, input[type=button]").each((e,t)=>{$(t).off("click").on("click",function(e){let t=this.value;this.id&&(t=this.id),this.name&&(t=this.name),o.action(t,e)})});for(let e=0;e<s.length;e++){let l=this.fields[s[e]],n=null!=this.getValue(l.name)?this.getValue(l.name):"";if(l.el)switch($(l.el).hasClass("w2ui-input")||$(l.el).addClass("w2ui-input"),l.type=String(l.type).toLowerCase(),l.options||(l.options={}),l.type){case"text":case"textarea":case"email":case"pass":case"password":l.el.value=n;break;case"int":case"float":case"money":case"currency":case"percent":l.el.value=n,$(l.el).w2field($.extend({},l.options,{type:l.type}));break;case"hex":case"alphanumeric":case"color":case"date":case"time":case"datetime":l.el.value=n,$(l.el).w2field($.extend({},l.options,{type:l.type}));break;case"toggle":w2utils.isFloat(n)&&(n=parseFloat(n)),$(l.el).prop("checked",!!n),this.setValue(l.name,n||!1);break;case"radio":$(l.$el).prop("checked",!1).each((e,t)=>{$(t).val()==n&&$(t).prop("checked",!0)});break;case"checkbox":$(l.el).prop("checked",!!n),!0!==l.disabled&&!1!==l.disabled||$(l.el).prop("disabled",!!l.disabled);break;case"check":case"checks":Array.isArray(n)&&n.forEach(e=>{$(l.el).closest("div").find('[data-value="'+e+'"]').prop("checked",!0)}),l.disabled?$(l.el).closest("div").find("input[type=checkbox]").prop("disabled",!0):$(l.el).closest("div").find("input[type=checkbox]").removeProp("disabled");break;case"list":case"combo":if("list"===l.type){var a=$.isPlainObject(n)?n.id:$.isPlainObject(l.options.selected)?l.options.selected.id:n;l.options.items||(l.options.items=[]);let t=l.options.items;"function"==typeof t&&(t=t());let i=!1;if(Array.isArray(t))for(let e=0;e<t.length;e++){var r=t[e];if(r.id==a){n=$.extend(!0,{},r),o.setValue(l.name,n),i=!0;break}}i||null==n||""===n||l.$el.data("find_selected",n)}else"combo"!==l.type||$.isPlainObject(n)?$.isPlainObject(n)&&null!=n.text?l.el.value=n.text:l.el.value="":l.el.value=n;$.isPlainObject(n)||(n={}),$(l.el).w2field($.extend({},l.options,{type:l.type,selected:n}));break;case"enum":case"file":let i=[],s=!1;Array.isArray(n)||(n=[]),"function"!=typeof l.options.items&&(Array.isArray(l.options.items)||(l.options.items=[]),n.forEach(t=>{l.options.items.forEach(e=>{e&&(e.id==t||$.isPlainObject(t)&&e.id==t.id)&&(i.push($.isPlainObject(e)?$.extend(!0,{},e):e),s=!0)})})),s||null==n||0===n.length||(l.$el.data("find_selected",n),i=n);let t=$.extend({},l.options,{type:l.type,selected:i});Object.keys(l.options).forEach(e=>{"function"==typeof l.options[e]&&(t[e]=l.options[e])}),$(l.el).w2field(t);break;case"select":{let t=l.options.items;if(null!=t&&0<t.length){t=w2utils.normMenu.call(this,t,l),$(l.el).html("");for(let e=0;e<t.length;e++)$(l.el).append('<option value="'+t[e].id+'">'+t[e].text+"</option")}$(l.el).val(n);break}case"map":case"array":"map"!=l.type||null!=n&&$.isPlainObject(n)||(this.setValue(l.field,{}),n=this.getValue(l.field)),"array"!=l.type||null!=n&&Array.isArray(n)||(this.setValue(l.field,[]),n=this.getValue(l.field)),function(c,p){p.el.mapAdd=function(e,t,i){var s=(e.disabled?" readOnly ":"")+(e.html.tabindex_str||""),e='<div class="w2ui-map-field" style="margin-bottom: 5px"><input id="'+e.field+"_key_"+i+'" data-cnt="'+i+'" type="text" '+e.html.key.attr+s+' class="w2ui-input w2ui-map key">'+(e.html.key.text||"")+'<input id="'+e.field+"_value_"+i+'" data-cnt="'+i+'" type="text" '+e.html.value.attr+s+' class="w2ui-input w2ui-map value">'+(e.html.value.text||"")+"</div>";t.append(e)},p.el.mapRefresh=function(h,u){let s=1,e;"map"==p.type&&(null==(h=!$.isPlainObject(h)?{}:h)._order&&(h._order=Object.keys(h)),e=h._order),"array"==p.type&&(Array.isArray(h)||(h=[]),e=h.map(e=>e.key));let l,n;e.forEach(t=>{l=u.find("#"+w2utils.escapeId(p.name)+"_key_"+s),n=u.find("#"+w2utils.escapeId(p.name)+"_value_"+s),0!=l.length&&0!=n.length||(p.el.mapAdd(p,u,s),l=u.find("#"+w2utils.escapeId(p.name)+"_key_"+s),n=u.find("#"+w2utils.escapeId(p.name)+"_value_"+s));let e=h[t];var i;"array"!=p.type||0<(i=h.filter(e=>e.key==t)).length&&(e=i[0].value),l.val(t),n.val(e),!0!==p.disabled&&!1!==p.disabled||(l.prop("readOnly",!!p.disabled),n.prop("readOnly",!!p.disabled)),l.parents(".w2ui-map-field").attr("data-key",t),s++});let t=u.find("#"+w2utils.escapeId(p.name)+"_key_"+s).parent(),i=u.find("#"+w2utils.escapeId(p.name)+"_key_"+(s+1)).parent();0!==t.length||l&&(!0===l.prop("readOnly")||!0===l.prop("disabled"))||p.el.mapAdd(p,u,s),1==t.length&&1==i.length&&(t.removeAttr("data-key"),t.find(".key").val(i.find(".key").val()),t.find(".value").val(i.find(".value").val()),i.remove()),!0!==p.disabled&&!1!==p.disabled||(t.find(".key").prop("readOnly",!!p.disabled),t.find(".value").prop("readOnly",!!p.disabled)),$(p.el).next().find("input.w2ui-map").off(".mapChange").on("keyup.mapChange",function(e){let t=$(e.target).parents(".w2ui-map-field");13==e.keyCode&&t.next().find("input.key").focus()}).on("change.mapChange",function(){let i=$(event.target).parents(".w2ui-map-field"),s=i.attr("data-key"),l=i.find(".key").val();var e=i.find(".value").val();let t={},n={},a=null,r=null;t[l]=e,"array"==p.type&&(h.forEach((e,t)=>{e.key==s&&(r=t)}),a=h[r]),null!=s&&"map"==p.type&&(n[s]=h[s]),null!=s&&"array"==p.type&&(n[s]=a.value);var o=c.trigger({phase:"before",target:p.field,type:"change",originalEvent:event,value_new:t,value_previous:n});if(!0!==o.isCancelled){if("map"==p.type){delete h[s];var d=h._order.indexOf(s);if(""!=l){if(null!=h[l]){let e,t=0;for(;t++,e=l+t,null!=h[e];);l=e,i.find(".key").val(e)}h[l]=e,i.attr("data-key",l),-1!=d?h._order[d]=l:h._order.push(l)}else h._order.splice(d,1),i.find(".value").val("")}else"array"==p.type&&(""!=l?null==a?h.push({key:l,value:e}):(a.key=l,a.value=e):h.splice(r,1));c.setValue(p.field,h),p.el.mapRefresh(h,u),c.trigger($.extend(o,{phase:"after"}))}})},p.el.mapRefresh(n,$(p.el).parent().find(".w2ui-map-container"))}(this,l);break;case"div":case"custom":$(l.el).html(n);break;case"html":case"empty":break;default:$(l.el).val(n),$(l.el).w2field($.extend({},l.options,{type:l.type}))}}var i=$(this.box).find(".w2ui-page");for(let e=0;e<i.length;e++)1<$(i[e]).find("> *").length&&$(i[e]).wrapInner("<div></div>");return this.trigger($.extend(t,{phase:"after"})),this.resize(),(new Date).getTime()-e}}}render(e){var t=(new Date).getTime();let i=this;if("object"==typeof e&&(0<$(this.box).find("#form_"+this.name+"_tabs").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-form").html(""),this.box=e),this.isGenerated&&this.box){var s=this.trigger({phase:"before",target:this.name,type:"render",box:null!=e?e:this.box});if(!0!==s.isCancelled){e='<div class="w2ui-form-box">'+(""!==this.header?'<div class="w2ui-form-header">'+w2utils.lang(this.header)+"</div>":"")+'    <div id="form_'+this.name+'_toolbar" class="w2ui-form-toolbar" style="display: none"></div>    <div id="form_'+this.name+'_tabs" class="w2ui-form-tabs" style="display: none"></div>'+this.formHTML+"</div>";return $(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-form").html(e),0<$(this.box).length&&($(this.box)[0].style.cssText+=this.style),w2utils.bindEvents($(this.box).find(".w2ui-eaction"),this),"function"!=typeof this.toolbar.render&&(this.toolbar=new w2toolbar($.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.toolbar.on("click",function(e){e=i.trigger({phase:"before",type:"toolbar",target:e.target,originalEvent:e});!0!==e.isCancelled&&i.trigger($.extend(e,{phase:"after"}))})),"object"==typeof this.toolbar&&"function"==typeof this.toolbar.render&&this.toolbar.render($(this.box).find("#form_"+this.name+"_toolbar")[0]),"function"!=typeof this.tabs.render&&(this.tabs=new w2tabs($.extend({},this.tabs,{name:this.name+"_tabs",owner:this,active:this.tabs.active})),this.tabs.on("click",function(e){i.goto(this.get(e.target,!0))})),"object"==typeof this.tabs&&"function"==typeof this.tabs.render&&(this.tabs.render($(this.box).find("#form_"+this.name+"_tabs")[0]),this.tabs.active&&this.tabs.click(this.tabs.active)),this.trigger($.extend(s,{phase:"after"})),this.resize(),("object"!=typeof this.url?this.url:this.url.get)&&0!==this.recid&&null!=this.recid?this.request():this.refresh(),0===$(this.box).closest(".w2ui-layout").length&&(this.tmp_resize=function(e){null==w2ui[i.name]?$(window).off("resize.w2uiResize",i.tmp_resize):w2ui[i.name].resize()},$(window).off("resize.w2uiResize").on("resize.w2uiResize",i.tmp_resize)),-1!=this.focus&&setTimeout(()=>{0===$(i.box).find("input, select, textarea").length?setTimeout(i.applyFocus,500):i.applyFocus()},50),(new Date).getTime()-t}}}applyFocus(e){void 0===e&&(e=this.focus);let t;if(w2utils.isInt(e)){if(e<0)return;for(var i=$(this.box).find("div:not(.w2ui-field-helper) > input, select, textarea, div > label:nth-child(1) > :radio").not(".file-input");$(i[e]).is(":hidden")&&i.length>=e;)e++;i[e]&&(t=$(i[e]))}else"string"==typeof e&&(t=$(this.box).find("[name='"+e+"']").first());return t&&t.trigger("focus"),t}destroy(){var e=this.trigger({phase:"before",target:this.name,type:"destroy"});!0!==e.isCancelled&&("object"==typeof this.toolbar&&this.toolbar.destroy&&this.toolbar.destroy(),"object"==typeof this.tabs&&this.tabs.destroy&&this.tabs.destroy(),0<$(this.box).find("#form_"+this.name+"_tabs").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-form").html(""),delete w2ui[this.name],this.trigger($.extend(e,{phase:"after"})),$(window).off("resize","body"))}}!function(v){if(v){v.w2globals=function(){var t,i;t=window,i={w2ui:w2ui,w2locale:w2locale,w2event:w2event,w2utils:w2utils,w2popup:w2popup,w2alert:w2alert,w2confirm:w2confirm,w2prompt:w2prompt,w2field:w2field,w2form:w2form,w2grid:w2grid,w2layout:w2layout,w2sidebar:w2sidebar,w2tabs:w2tabs,w2toolbar:w2toolbar,addType:addType,removeType:removeType},Object.keys(i).forEach(e=>{t[e]=i[e]})};let e=String(void 0).split("?")[1]||"";function t(t,i){if(v.isPlainObject(t)){let e;return"w2form"==i&&(e=new w2form(t),0<this.find(".w2ui-field").length&&(e.formHTML=this.html())),"w2grid"==i&&(e=new w2grid(t)),"w2layout"==i&&(e=new w2layout(t)),"w2sidebar"==i&&(e=new w2sidebar(t)),"w2tabs"==i&&(e=new w2tabs(t)),"w2toolbar"==i&&(e=new w2toolbar(t)),0!==v(this).length&&e.render(this[0]),e}{let e=w2ui[v(this).attr("name")];return e?0<arguments.length?(e[t]&&e[t].apply(e,Array.prototype.slice.call(arguments,1)),this):e:null}}"globals"!=e&&"globals="!=e.substr(0,8)||v.w2globals(),v.fn.w2render=function(e){0<v(this).length&&("string"==typeof e&&w2ui[e]&&w2ui[e].render(v(this)[0]),"object"==typeof e&&e.render(v(this)[0]))},v.fn.w2destroy=function(e){"string"==typeof(e=!e&&0<this.length?this.attr("name"):e)&&w2ui[e]&&w2ui[e].destroy(),"object"==typeof e&&e.destroy()},v.fn.w2field=function(s,l){return 0!==arguments.length?this.each((e,t)=>{let i=v(t).data("w2field");return null==i?(i=new w2field(s,l),i.render(t),i):(i.clear(),"clear"===s?void 0:(i=new w2field(s,l),i.render(t),i))}):v(this).data("w2field")},v.fn.w2form=function(e){return t.call(this,e,"w2form")},v.fn.w2grid=function(e){return t.call(this,e,"w2grid")},v.fn.w2layout=function(e){return t.call(this,e,"w2layout")},v.fn.w2sidebar=function(e){return t.call(this,e,"w2sidebar")},v.fn.w2tabs=function(e){return t.call(this,e,"w2tabs")},v.fn.w2toolbar=function(e){return t.call(this,e,"w2toolbar")},v.fn.w2popup=function(e){0<this.length?w2popup.template(this[0],null,e):e.url&&w2popup.load(e)},v.fn.w2marker=function(){let n=Array.prototype.slice.call(arguments,0);return Array.isArray(n[0])&&(n=n[0]),0!==n.length&&n[0]?v(this).each((e,i)=>{t(0,i);for(let t=0;t<n.length;t++){let e=n[t];"string"!=typeof e&&(e=String(e)),e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&").replace(/&/g,"&amp;").replace(/</g,"&gt;").replace(/>/g,"&lt;");var s=new RegExp(e+"(?!([^<]+)?>)","gi");i.innerHTML=i.innerHTML.replace(s,l)}function l(e){return'<span class="w2ui-marker">'+e+"</span>"}}):v(this).each(t);function t(e,t){for(;-1!==t.innerHTML.indexOf('<span class="w2ui-marker">');)t.innerHTML=t.innerHTML.replace(/\<span class=\"w2ui\-marker\"\>((.|\n|\r)*)\<\/span\>/gi,"$1")}},v.fn.w2tag=function(d,u){if(1===arguments.length&&"object"==typeof d&&null!=(u=d).html&&(d=u.html),null!=(u=v.extend({id:null,auto:null,html:d,position:"right|top",align:"none",left:0,top:0,maxWidth:null,style:"",css:{},attachTo:null,className:"",inputClass:"",onShow:null,onHide:null,hideOnKeyPress:!0,hideOnFocus:!1,hideOnBlur:!1,hideOnClick:!1,hideOnChange:!0},u)).name&&null==u.id&&(u.id=u.name),""!==u.class&&""===u.inputClass&&(u.inputClass=u.class),0!==v(this).length)return!0===u.auto||null!=u.showOn||null!=u.hideOn?0!=arguments.length&&d?v(this).each((e,t)=>{let i="mouseenter",s="mouseleave";u.showOn&&(i=String(u.showOn).toLowerCase(),delete u.showOn),u.hideOn&&(s=String(u.hideOn).toLowerCase(),delete u.hideOn),u.position||(u.position="top|bottom"),v(t).off(".w2tooltip").on(i+".w2tooltip",function(){u.auto=!1,v(this).w2tag(d,u)}).on(s+".w2tooltip",function(){v(this).w2tag()})}):v(this).each((e,t)=>{v(t).off(".w2tooltip")}):v(this).each((e,t)=>{let h,i=u.id||t.id;""==i&&(i=v(t).find("input").attr("id")),i=i||"noid";var s,l,n=w2utils.escapeId(i);if(null!=v(this).data("w2tag")?(h=v(this).data("w2tag"),v.extend(h.options,u)):(l=(s=v(t).parents("*").last()[0])&&s.parentNode instanceof DocumentFragment,h={id:i,attachedTo:t,context:l?s:document,box:v("#w2ui-tag-"+n),options:v.extend({},u),init:a,hide:function(){h.box.length<=0||(h.tmp.timer&&clearTimeout(h.tmp.timer),h.box.remove(),h.options.hideOnClick&&v("body").off(".w2tag"+(h.id||"")),v(h.attachedTo,h.context).off(".w2tag").removeClass(h.options.inputClass).removeData("w2tag"),0<v(h.attachedTo,h.context).length&&(v(h.attachedTo,h.context)[0].style.cssText=h.tmp.originalCSS),"function"==typeof h.options.onHide&&h.options.onHide())},getPos:o,isMoved:r,tmp:{}}),""===d||null==d)h.hide();else if(0!==h.box.length)h.box.find(".w2ui-tag-body").css(h.options.css).attr("style",h.options.style).addClass(h.options.className).html(h.options.html);else{h.tmp.originalCSS="",0<v(h.attachedTo,h.context).length&&(h.tmp.originalCSS=v(h.attachedTo,h.context)[0].style.cssText);let e="white-space: nowrap;";h.options.maxWidth&&w2utils.getStrWidth(d)>h.options.maxWidth&&(e="width: "+h.options.maxWidth+"px"),v("body").append('<div data-click="stop" style="display: none;" id="w2ui-tag-'+h.id+'"        class="w2ui-tag '+(0<v(h.attachedTo,h.context).parents(".w2ui-popup, .w2ui-overlay-popup, .w2ui-message").length?"w2ui-tag-popup":"")+'">   <div style="margin: -2px 0px 0px -2px; '+e+'">      <div class="w2ui-tag-body '+h.options.className+'" style="'+(h.options.style||"")+'">'+d+"</div>   </div></div>"),h.box=v("#w2ui-tag-"+n),v(h.attachedTo,h.context).data("w2tag",h),w2utils.bindEvents(h.box,{}),setTimeout(a,1)}function a(){var e;h.box.css("display","block"),h&&h.box&&v(h.attachedTo,h.context).offset()&&(e=h.getPos(),h.box.css({opacity:"1",left:e.left+"px",top:e.top+"px"}).data("w2tag",h).find(".w2ui-tag-body").addClass(e.posClass),h.tmp.pos=e.left+"x"+e.top,v(h.attachedTo,h.context).off(".w2tag").css(h.options.css).addClass(h.options.inputClass),h.options.hideOnKeyPress&&v(h.attachedTo,h.context).on("keypress.w2tag",h.hide),h.options.hideOnFocus&&v(h.attachedTo,h.context).on("focus.w2tag",h.hide),u.hideOnChange&&("INPUT"===t.nodeName?v(t):v(t).find("input")).on("change.w2tag",h.hide),h.options.hideOnBlur&&v(h.attachedTo,h.context).on("blur.w2tag",h.hide),h.options.hideOnClick&&v("body").on("click.w2tag"+(h.id||""),h.hide),"function"==typeof h.options.onShow&&h.options.onShow(),r())}function r(e){var t=v(h.attachedTo,h.context).offset();0===v(h.attachedTo,h.context).length||0===t.left&&0===t.top||0===h.box.find(".w2ui-tag-body").length?h.hide():(t=o(),h.tmp.pos!==t.left+"x"+t.top&&(h.box.css(w2utils.cssPrefix({transition:e?"0s":".2s"})).css({left:t.left+"px",top:t.top+"px"}),h.tmp.pos=t.left+"x"+t.top),h.tmp.timer&&clearTimeout(h.tmp.timer),h.tmp.timer=setTimeout(r,100))}function o(){var t=v(h.attachedTo,h.context).offset();let i="w2ui-tag-right",s=parseInt(t.left+h.attachedTo.offsetWidth+(h.options.left||0)),l=parseInt(t.top+(h.options.top||0)),e=h.box.find(".w2ui-tag-body");var n=e[0].offsetWidth,a=e[0].offsetHeight;if("string"==typeof h.options.position&&-1!==h.options.position.indexOf("|")&&(h.options.position=h.options.position.split("|")),"top"===h.options.position)i="w2ui-tag-top",s=parseInt(t.left+(h.options.left||0))-14,l=parseInt(t.top+(h.options.top||0))-a-10;else if("bottom"===h.options.position)i="w2ui-tag-bottom",s=parseInt(t.left+(h.options.left||0))-14,l=parseInt(t.top+h.attachedTo.offsetHeight+(h.options.top||0))+10;else if("left"===h.options.position)i="w2ui-tag-left",s=parseInt(t.left+(h.options.left||0))-n-20,l=parseInt(t.top+(h.options.top||0));else if(Array.isArray(h.options.position)){var r=window.innerWidth,o=window.innerHeight;for(let e=0;e<h.options.position.length;e++){var d=h.options.position[e];if("right"===d){if(i="w2ui-tag-right",s=parseInt(t.left+h.attachedTo.offsetWidth+(h.options.left||0)),l=parseInt(t.top+(h.options.top||0)),s+n<=r)break}else if("left"===d){if(i="w2ui-tag-left",s=parseInt(t.left+(h.options.left||0))-n-20,l=parseInt(t.top+(h.options.top||0)),0<=s)break}else if("top"===d){if(i="w2ui-tag-top",s=parseInt(t.left+(h.options.left||0))-14,l=parseInt(t.top+(h.options.top||0))-a-10,s+n<=r&&0<=l)break}else if("bottom"===d&&(i="w2ui-tag-bottom",s=parseInt(t.left+(h.options.left||0))-14,l=parseInt(t.top+h.attachedTo.offsetHeight+(h.options.top||0))+10,s+n<=r&&l+a<=o))break}e.data("posClass")!==i&&e.removeClass("w2ui-tag-right w2ui-tag-left w2ui-tag-top w2ui-tag-bottom").addClass(i).data("posClass",i)}return{left:s,top:l,posClass:i}}});v(".w2ui-tag").each((e,t)=>{let i=v(t).data("w2tag");i&&i.hide()})},v.fn.w2overlay=function(e,w){let b=this,y="";1===arguments.length&&(w="object"==typeof e?e:{html:e}),2===arguments.length&&(w.html=e),v.isPlainObject(w)||(w={}),(w=v.extend({},{name:null,html:"",align:"none",left:0,top:0,tipLeft:30,noTip:!1,selectable:!1,width:0,height:0,minWidth:null,maxWidth:null,maxHeight:null,contextMenu:!1,pageX:null,pageY:null,originalEvent:null,style:"",class:"",overlayStyle:"",onShow:null,onHide:null,openAbove:null,tmp:{}},w)).name&&(y="-"+w.name);let t;if(0===this.length||""===w.html||null==w.html)return 0<v("#w2ui-overlay"+y).length?(t=v("#w2ui-overlay"+y)[0].hide,"function"==typeof t&&t()):v("#w2ui-overlay"+y).remove(),v(this);let i=v("#w2ui-overlay"+y),s=i.find(" > div");0<i.length&&(n=i.data("options"),null!=w.name&&""!=w.name||n.name==w.name?s.attr("style",`min-width: 100%; ${w.style}`).attr("class",w.class):(t=v("#w2ui-overlay"+y)[0].hide,v(document).off(".w2overlay"+y),"function"==typeof t&&t())),0<b.length&&(null==b[0].tagName||"BODY"===b[0].tagName.toUpperCase())&&(w.contextMenu=!0),w.contextMenu&&w.originalEvent&&(w.pageX=w.originalEvent.pageX,w.pageY=w.originalEvent.pageY),!w.contextMenu||null!=w.pageX&&null!=w.pageY||console.log("ERROR: to display menu at mouse location, pass options.pageX and options.pageY.");let l="";w.data&&Object.keys(w.data).forEach(e=>{l+="data-"+e+'="'+w.data[e]+'"'}),0==i.length&&(v("body").append('<div id="w2ui-overlay'+y+'" style="display: none; left: 0px; top: 0px; '+w.overlayStyle+'" '+l+'        class="w2ui-reset w2ui-overlay '+(0<v(this).parents(".w2ui-popup, .w2ui-overlay-popup, .w2ui-message").length?"w2ui-overlay-popup":"")+'">    <style></style>    <div style="min-width: 100%; '+w.style+'" class="'+w.class+'"></div></div>'),i=v("#w2ui-overlay"+y),s=i.find(" > div")),s.html(w.html);var n=s.css("background-color");null!=n&&"rgba(0, 0, 0, 0)"!==n&&"transparent"!==n&&i.css({"background-color":n,"border-color":n});n=v(b).offset()||{};return i.data("element",0<b.length?b[0]:null).data("options",w).data("position",n.left+"x"+n.top).fadeIn("fast").on("click",function(e){v("#w2ui-overlay"+y).data("keepOpen",!0),"LABEL"===e.target.tagName.toUpperCase()&&e.stopPropagation()}).on("mousedown",function(e){var t=e.target.tagName.toUpperCase();-1!==["INPUT","TEXTAREA","SELECT"].indexOf(t)||w.selectable||e.preventDefault()}),i[0].hide=a,i[0].resize=x,setTimeout(()=>{v(document).off(".w2overlay"+y).on("click.w2overlay"+y,a),"function"==typeof w.onShow&&w.onShow(),x()},10),function e(){let t=v("#w2ui-overlay"+y);if(t.data("element")!==b[0])return;if(0===t.length)return;let i=v(b).offset()||{};let s=i.left+"x"+i.top;t.data("position")!==s?a():setTimeout(e,250)}(),v(this);function a(e){if(!e||0===e.button){let t=v("#w2ui-overlay"+y);if(!e||v(v(e.target).closest(".w2ui-overlay").data("element")).closest(".w2ui-overlay")[0]!==t[0])if(!0!==t.data("keepOpen")){let e;"function"==typeof w.onHide&&(e=w.onHide()),!1!==e&&(t.remove(),v(document).off(".w2overlay"+y),clearInterval(t.data("timer")))}else t.removeData("keepOpen")}}function x(){let c=v("#w2ui-overlay"+y),p=c.find(" > div"),e=v("#w2ui-overlay"+y+" div.w2ui-menu"),t={};if(0<e.length&&(e.css("overflow-y","hidden"),t.scrollTop=e.scrollTop(),t.scrollLeft=e.scrollLeft()),0<c.length){p.height("auto").width("auto");let t=!1,i=p.height(),s=p.width();w.width&&w.width<s&&(s=w.width),s<30&&(s=30),w.tmp.contentHeight&&(i=parseInt(w.tmp.contentHeight),p.height(i),setTimeout(()=>{let e=p.find("div.w2ui-menu");i>e.height()&&p.find("div.w2ui-menu").css("overflow-y","hidden")},1),setTimeout(()=>{let e=p.find("div.w2ui-menu");"auto"!==e.css("overflow-y")&&e.css("overflow-y","auto")},10)),w.tmp.contentWidth&&"both"!==w.align&&(s=parseInt(w.tmp.contentWidth),p.width(s),setTimeout(()=>{s>p.find("div.w2ui-menu > table").width()&&p.find("div.w2ui-menu > table").css("overflow-x","hidden")},1),setTimeout(()=>{p.find("div.w2ui-menu > table").css("overflow-x","auto")},10)),p.find("div.w2ui-menu").css("width","100%");let e=w.left,l=w.width,n=w.tipLeft,a=w.minWidth,r=w.maxWidth;var f=w2utils.getSize(v(b),"width");switch(w.align){case"both":e=17,a="input",r="input";break;case"left":e=17}a&&"auto"!==a||(a=0),"input"===a&&(a=f),a=parseInt(a,10),r&&"auto"!==r||(r=0),"input"===r&&(r=f),r=parseInt(r,10),l&&"auto"!==l||(l=0),"input"===l&&(l=f),l=parseInt(l,10),a&&(l=Math.max(l,a)),r&&(l=Math.min(l,r)),"right"===w.align&&(g=Math.max(s-10,a-17),e=f-g,n=g-30),30!==s||l||(l=30);var g=((l||s)-17)/2;g<25&&(n=Math.floor(g));let o,d,h;h=w.contextMenu?(o=w.pageX+8,d=+w.pageY,w.pageY):(m=b.offset()||{},o=(25<m.left?m.left:25)+e,d=m.top+w2utils.getSize(b,"height")+w.top+7,m.top),c.css({left:o+"px",top:d+"px",width:l||"auto","min-width":a||"auto","max-width":r||"auto","min-height":w.height||"auto"});var m=p.offset()||{};let u=window.innerHeight+v(document).scrollTop()-m.top-7;if(r=window.innerWidth+v(document).scrollLeft()-m.left-7,w.contextMenu&&(u=window.innerHeight+v(document).scrollTop()-w.pageY-15,r=window.innerWidth+v(document).scrollLeft()-w.pageX),(-50<u&&u<210||!0===w.openAbove)&&!1!==w.openAbove){let e;e=w.contextMenu?(u=w.pageY-7,5):(u=m.top-v(document).scrollTop()-7,24),w.maxHeight&&u>w.maxHeight&&(u=w.maxHeight),i>u&&(t=!0,p.height(u).width(s).css({"overflow-y":"auto"}),i=u),c.addClass("bottom-arrow"),c.css("top",h-i-e+w.top+"px"),c.find(">style").html("#w2ui-overlay"+y+":before { margin-left: "+parseInt(n)+"px; }#w2ui-overlay"+y+":after { margin-left: "+parseInt(n)+"px; }")}else w.maxHeight&&u>w.maxHeight&&(u=w.maxHeight),i>u&&(t=!0,p.height(u).width(s).css({"overflow-y":"auto"})),c.addClass("top-arrow"),c.find(">style").html("#w2ui-overlay"+y+":before { margin-left: "+parseInt(n)+"px; }#w2ui-overlay"+y+":after { margin-left: "+parseInt(n)+"px; }");s=p.width(),r=window.innerWidth+v(document).scrollLeft()-m.left-7,w.maxWidth&&r>w.maxWidth&&(r=w.maxWidth),s>r&&"both"!==w.align&&(w.align="right",setTimeout(()=>{x()},1)),(w.contextMenu||w.noTip)&&c.find(">style").html("#w2ui-overlay"+y+":before { display: none; }#w2ui-overlay"+y+":after { display: none; }"),t&&"both"!==w.align&&p.width(s+w2utils.scrollBarSize()+2)}0<e.length&&(e.css("overflow-y","auto"),e.scrollTop(t.scrollTop),e.scrollLeft(t.scrollLeft))}},v.fn.w2tmp={},v.fn.w2menu=function(i,f){f&&"function"==typeof f.items&&(f.items=f.items());var s={type:"normal",index:null,items:[],render:null,msgNoItems:w2utils.lang("No items found"),onSelect:null,hideOnSelect:!0,hideOnRemove:!1,tmp:{}};let l,c=this,p="",g;if("refresh"===i){v.fn.w2tmp.menuOptions&&v.fn.w2tmp.menuOptions.name&&(p="-"+v.fn.w2tmp.menuOptions.name),f.name&&(p="-"+f.name);var n=v("#w2ui-overlay"+p).data("element");0==v("#w2ui-overlay"+p).length||null!=n&&n!=this[0]?v(this).w2menu(f):(f=v.extend(v.fn.w2tmp.menuOptions,f),a=v("#w2ui-overlay"+p+" div.w2ui-menu").scrollTop(),v("#w2ui-overlay"+p+" div.w2ui-menu").html(w()),v("#w2ui-overlay"+p+" div.w2ui-menu").scrollTop(a),setTimeout(()=>{w2utils.bindEvents(`#w2ui-overlay${p} .w2ui-menu-item`,jQuery.fn.w2tmp),o()},1))}else if("refresh-index"===i){!Array.isArray(f.index)&&w2utils.isInt(f.index)&&0<=parseInt(f.index)&&(f.index=[f.index]);let e=v("#w2ui-overlay"+p+" div.w2ui-menu"),t=e.find('tr[index="'+(Array.isArray(f.index)?f.index.join("-"):"")+'"]');var a,r=e.scrollTop();e.find("tr.w2ui-selected").removeClass("w2ui-selected"),t.addClass("w2ui-selected"),0<t.length&&(n=t[0].offsetTop-5,a=e.height(),e.scrollTop(r),(n<r||n+t.height()>r+a)&&e.animate({scrollTop:n-(a-2*t.height())/2},200,"linear")),o()}else{1===arguments.length?f=i:f.items=i,"object"!=typeof f&&(f={}),f=v.extend({},s,f),w2utils.isInt(f.index)&&0<=parseInt(f.index)&&(f.index=[f.index]),f.items=w2utils.normMenu(f.items),(v.fn.w2tmp.menuOptions=f).name&&(p="-"+f.name),"function"==typeof f.select&&"function"!=typeof f.onSelect&&(f.onSelect=f.select),"function"==typeof f.remove&&"function"!=typeof f.onRemove&&(f.onRemove=f.remove),"function"==typeof f.onRender&&"function"!=typeof f.render&&(f.render=f.onRender),v.fn.w2tmp.menuClick=function(t,i,s){let l=!1,n=f.items,a=v(t.target).closest("tr");if((t.shiftKey||t.metaKey||t.ctrlKey)&&(l=!0),"string"==typeof s&&""!==s){let e=s.split("-");e.forEach(e=>{n=n[e].items})}if(!n[i].disabled){if(v(t.target).hasClass("remove"))"function"==typeof f.onRemove&&f.onRemove({index:i,parentIndex:s,item:n[i],keepOpen:l,originalEvent:t}),l=!f.hideOnRemove,v(t.target).closest("tr").remove(),o();else if(a.hasClass("has-sub-menu")){let e=v("#w2ui-overlay"+p+" div.w2ui-menu");0<e.length&&e.css("overflow-y","hidden"),l=!0,g=(a.hasClass("expanded")?(n[i].expanded=!1,a.removeClass("expanded").addClass("collapsed").next().hide()):(n[i].expanded=!0,a.addClass("expanded").removeClass("collapsed").next().show()),null),f.index=a.attr("index").split("-"),o()}else if("function"==typeof f.onSelect){let e=n;"function"==typeof n&&(e=n(f.items[s])),null!=e[i].keepOpen&&(l=e[i].keepOpen),f.onSelect({index:i,parentIndex:s,item:e[i],keepOpen:l,originalEvent:t})}if(f.hideOnSelect&&(null==n[i]||!0!==n[i].keepOpen)){let e=v("#w2ui-overlay"+p);e.removeData("keepOpen"),0<e.length&&"function"==typeof e[0].hide&&!l&&e[0].hide()}}},v.fn.w2tmp.menuDown=function(e,t,i){let s=f.items,l=v(e.target).closest("tr"),n=v(l.get(0)).find(".w2ui-icon");if("string"==typeof i&&""!==i){let e=i.split("-");e.forEach(e=>{s=s[e].items})}let a=s[t];a.disabled||("check"!==f.type&&"radio"!==f.type||!1===a.group||v(e.target).hasClass("remove")||v(e.target).closest("tr").hasClass("has-sub-menu")||(a.checked=!a.checked,a.checked?("radio"===f.type&&n.parents("table").find(".w2ui-icon").removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),"check"===f.type&&null!=a.group&&s.forEach((e,t)=>{e.id!=a.id&&e.group===a.group&&e.checked&&(n.closest("table").find("tr[index="+t+"] .w2ui-icon").removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),s[t].checked=!1)}),n.removeClass("w2ui-icon-empty").addClass("w2ui-icon-check")):"check"===f.type&&null==a.group&&!1!==a.group&&n.removeClass("w2ui-icon-check").addClass("w2ui-icon-empty")),l.parent().find("tr").removeClass("w2ui-selected"),l.addClass("w2ui-selected"))};let e="";if(f.search){e+=`
                    <div class="w2ui-menu-search">
                        <div class="w2ui-icon w2ui-icon-search"></div>
                        <input id="menu-search" type="text"/>
                    </div>`;for(let e=0;e<f.items.length;e++)f.items[e].hidden=!1}e+=(f.topHTML||"")+`<div class="w2ui-menu" style="top: ${f.search?40:0}px; ${f.menuStyle||""}">
                        ${w()}
                    </div>`,l=v(this).w2overlay(e,f),g=null,setTimeout(()=>{v(`#w2ui-overlay${p} #menu-search`).on("click",function(e){e.stopPropagation()}).on("keyup",d).on("keydown",function(e){-1!==[40,38].indexOf(e.keyCode)&&(e.stopPropagation(),e.preventDefault())}),w2utils.bindEvents(`#w2ui-overlay${p} .w2ui-menu-item`,jQuery.fn.w2tmp),o(),f.search&&-1===["text","password"].indexOf(v(c)[0].type)&&"TEXTAREA"!==v(c)[0].tagName.toUpperCase()&&v(`#w2ui-overlay${p} #menu-search`).focus()},1),o();let t=v("#w2ui-overlay"+p);0<t.length&&(t[0].mresize=o,t[0].change=d,t[0].getCurrent=m)}return l;function o(){setTimeout(()=>{v("#w2ui-overlay"+p+" tr.w2ui-selected").removeClass("w2ui-selected");let t=v("#w2ui-overlay"+p+' tr[index="'+(Array.isArray(f.index)?f.index.join("-"):"")+'"]');var i=v("#w2ui-overlay"+p+" div.w2ui-menu").scrollTop();if(t.addClass("w2ui-selected"),f.tmp&&(f.tmp.contentHeight=v("#w2ui-overlay"+p+" table").height()+12+(parseInt(v("#w2ui-overlay"+p+" .w2ui-menu").css("top"))||0)+(parseInt(v("#w2ui-overlay"+p+" .w2ui-menu").css("bottom"))||0),f.tmp.contentWidth=v("#w2ui-overlay"+p+" table").width()),0<v("#w2ui-overlay"+p).length&&v("#w2ui-overlay"+p)[0].resize(),0<t.length){var s=t[0].offsetTop-5;let e=v("#w2ui-overlay"+p+" div.w2ui-menu table");var l=e.height();v("#w2ui-overlay"+p+" div.w2ui-menu").scrollTop(i),(s<i||s+t.height()>i+l)&&v("#w2ui-overlay"+p+" div.w2ui-menu").animate({scrollTop:s-(l-2*t.height())/2},200,"linear")}},1)}function m(){var e=f.index.length-1;let t=f.index[e];var i=f.index.slice(0,f.index.length-1).join("-");t=w2utils.isInt(t)?parseInt(t):0;let s=f.items;return f.index.forEach((e,t)=>{t<f.index.length-1&&(s=s[e].items)}),{last:e,index:t,items:s,item:s[t],parents:i}}function d(t){var i,e=this.value;let s=!0,l=!1;switch(t.keyCode){case 13:var{item:n,index:a,parents:r}=m();Array.isArray(n.items)&&0<n.items.length?(t.target=v("#w2ui-overlay"+p).find(".w2ui-selected")[0],g=null):(m(),v("#w2ui-overlay"+p)[0].hide()),v.fn.w2tmp.menuClick(t,a,r),s=!1;break;case 9:case 27:s=!1,v("#w2ui-overlay"+p)[0].hide();break;case 37:var{item:o,index:d,parents:h}=m();Array.isArray(o.items)&&0<o.items.length&&o.expanded&&(t.target=v("#w2ui-overlay"+p).find(".w2ui-selected")[0],v.fn.w2tmp.menuClick(t,d,h)),s=!1;break;case 39:var{item:o,index:d,parents:h}=m();Array.isArray(o.items)&&0<o.items.length&&!o.expanded&&(t.target=v("#w2ui-overlay"+p).find(".w2ui-selected")[0],v.fn.w2tmp.menuClick(t,d,h)),s=!1;break;case 38:{let e=u(f.items);Array.isArray(f.index)&&0==f.index.length?f.index=[e[e.length-1]]:0<(i=e.indexOf(f.index.join("-")))&&(f.index=e[i-1].split("-")),s=!1,l=!0,t.preventDefault();break}case 40:{let e=u(f.items);Array.isArray(f.index)&&0==f.index.length?f.index=[e[0]]:-1!=(i=e.indexOf(f.index.join("-")))&&i<e.length-1&&(f.index=e[i+1].split("-")),s=!1,l=!0,t.preventDefault();break}}if(s){if(0<function l(n,a){let r=0;for(let e=0;e<n.length;e++){let t=n[e],i="",s="";-1!==["is","begins with"].indexOf(f.match)&&(i="^"),-1!==["is","ends with"].indexOf(f.match)&&(s="$");try{let e=new RegExp(i+a+s,"i");e.test(t.text)||"..."===t.text?t.hidden=!1:t.hidden=!0}catch(e){}if(Array.isArray(t.items)&&0<t.items.length){delete t._noSearchInside;let e=l(t.items,a);0<e&&(r+=e,t.hidden&&(t._noSearchInside=!0),t.expanded=!0,t.hidden=!1)}!0!==t.hidden&&r++}return r}(f.items,e)){let e=u(f.items);f.index=0<e.length?[e[0].split("-")[0]]:[]}else f.index=[];v(c).w2menu("refresh",f)}function u(e,i,s,t){return null!=g?g:(null==s&&(s=[]),null==i&&(i=[]),e.forEach((e,t)=>{e.hidden||e.disabled||(s.push(i.concat([t]).join("-")),Array.isArray(e.items)&&0<e.items.length&&e.expanded&&(i.push(t),u(e.items,i,s,!0),i.pop()))}),null==t&&(g=s),s)}l&&v(c).w2menu("refresh-index",f)}function w(e,o,t,d){if(f.spinner)return`
                    <table>
                        <tr><td class="w2ui-no-items">
                            <div class="w2ui-spinner" style="width: 18px; height: 18px; position: relative; top: 5px;"></div>
                            <div class="w2ui-no-items-label">${w2utils.lang("Loading...")}</div>
                        </td></tr>
                    </table>`;d=d||[],null!=f.index&&-1!=f.index||(f.index=[]),!Array.isArray(f.index)&&w2utils.isInt(f.index)&&0<=parseInt(f.index)&&(f.index=[f.index]);let h=0,u='<table cellspacing="0" cellpadding="0" class="'+(o?" sub-menu":"")+'"><tbody>',i=null,c=null;null==e&&(e=f.items),Array.isArray(e)||(e=[]);for(let r=0;r<e.length;r++){let a=e[r];if("string"==typeof a?a={id:a,text:a}:(null!=a.text&&null==a.id&&(a.id=a.text),null==a.text&&null!=a.id&&(a.text=a.id),null!=a.caption&&(a.text=a.caption),i=a.img,c=a.icon,null==i&&(i=null),null==c&&(c=null)),-1==["radio","check"].indexOf(f.type)||Array.isArray(a.items)||!1===a.group||(c=!0===a.checked?"w2ui-icon-check":"w2ui-icon-empty"),!0!==a.hidden){let s="",l=a.text,n="";if("function"==typeof f.render&&(l=f.render(a,f)),"function"==typeof l&&(l=l(a,f)),i&&(s='<td class="menu-icon"><div class="w2ui-tb-image w2ui-icon '+i+'"></div></td>'),c&&(s='<td class="menu-icon" align="center"><span class="w2ui-icon '+c+'"></span></td>'),"break"!==a.type&&null!=l&&""!==l&&"--"!=String(l).substr(0,2)){let e=["w2ui-menu-item"];1==f.altRows&&e.push(h%2==0?"w2ui-item-even":"w2ui-item-odd");let t=1;""===s&&t++,null==a.count&&null==a.hotkey&&!0!==a.remove&&null==a.items&&t++,null==a.tooltip&&null!=a.hint&&(a.tooltip=a.hint);let i="";if(!0===a.remove)i='<span class="remove">X</span>';else if(null!=a.items){let e=[];"function"==typeof a.items?e=a.items(a):Array.isArray(a.items)&&(e=a.items),i="<span></span>",n=`
                                <tr style="${a.expanded?"":"display: none"}">
                                    <td colspan="4" style="padding: 0px !important">
                                        ${w(e,!0,a.expanded,d.concat(r))}
                                    </td>
                                <tr>`}else null!=a.count&&(i+="<span>"+a.count+"</span>"),null!=a.hotkey&&(i+='<span class="hotkey">'+a.hotkey+"</span>");f.index.join("-")==d.concat([r]).join("-")&&e.push("w2ui-selected"),!0===a.disabled&&e.push("w2ui-disabled"),!0===a._noSearchInside&&e.push("w2ui-no-search-inside"),""!==n&&(e.push("has-sub-menu"),a.expanded?e.push("expanded"):e.push("collapsed")),u+=`<tr index="${(0<d.length?d.join("-")+"-":"")+r}" class="${e.join(" ")}"
                            ${a.style?`style="${a.style}"`:""}
                            ${a.tooltip?`title="${w2utils.lang(a.tooltip)}"`:""}
                            data-mousedown='["menuDown", "event", ${r}, "${d.join("-")}"]'
                            data-click='["menuClick", "event", ${r}, "${d.join("-")}"]'>
                                ${o?"<td></td>":""} ${s}
                               <td class="menu-text" colspan="${t}">${w2utils.lang(l)}</td>
                               <td class="menu-count">${i}</td>
                            </tr>
                            ${n}`,h++}else{var p=l.replace(/^-+/g,"");u+='<tr><td colspan="4" class="menu-divider '+(""!=p?"divider-text":"")+'">   <div class="line">'+p+'</div>   <div class="text">'+p+"</div></td></tr>"}}e[r]=a}return 0===h&&f.msgNoItems&&(u+=`
                    <tr><td class="w2ui-no-items">
                        <div class="w2ui-no-items-label">${w2utils.lang(f.msgNoItems)}</div>
                    </td></tr>`),u+="</tbody></table>",u}},v.fn.w2color=function(l,e){let t=v(this),n=t[0];if(t.data("skipInit"))return void t.removeData("skipInit");let a=[-1,-1];null==v.fn.w2colorPalette&&(v.fn.w2colorPalette=[["000000","333333","555555","777777","888888","999999","AAAAAA","CCCCCC","DDDDDD","EEEEEE","F7F7F7","FFFFFF"],["FF011B","FF9838","FFC300","FFFD59","86FF14","14FF7A","2EFFFC","2693FF","006CE7","9B24F4","FF21F5","FF0099"],["FFEAEA","FCEFE1","FCF4DC","FFFECF","EBFFD9","D9FFE9","E0FFFF","E8F4FF","ECF4FC","EAE6F4","FFF5FE","FCF0F7"],["F4CCCC","FCE5CD","FFF1C2","FFFDA1","D5FCB1","B5F7D0","BFFFFF","D6ECFF","CFE2F3","D9D1E9","FFE3FD","FFD9F0"],["EA9899","F9CB9C","FFE48C","F7F56F","B9F77E","84F0B1","83F7F7","B5DAFF","9FC5E8","B4A7D6","FAB9F6","FFADDE"],["E06666","F6B26B","DEB737","E0DE51","8FDB48","52D189","4EDEDB","76ACE3","6FA8DC","8E7CC3","E07EDA","F26DBD"],["CC0814","E69138","AB8816","B5B20E","6BAB30","27A85F","1BA8A6","3C81C7","3D85C6","674EA7","A14F9D","BF4990"],["99050C","B45F17","80650E","737103","395E14","10783D","13615E","094785","0A5394","351C75","780172","782C5A"]]);let r=v.fn.w2colorPalette;null==(l="string"==typeof l?{color:l,transparent:!0}:l).onSelect&&null!=e&&(l.onSelect=e),l.transparent&&"333333"==r[0][1]&&(r[0].splice(1,1),r[0].push("")),l.transparent||"333333"==r[0][1]||(r[0].splice(1,0,"333333"),r[0].pop()),l.color&&(l.color=String(l.color).toUpperCase()),"string"==typeof l.color&&"#"===l.color.substr(0,1)&&(l.color=l.color.substr(1)),null==l.fireChange&&(l.fireChange=!0);let i={keepOpen(e){v(e).parents(".w2ui-overlay").data("keepOpen",!0)},colorClick(e){v(e).addClass("selected").next().removeClass("selected").parents(".w2ui-overlay").find(".w2ui-color-advanced").hide().parent().find(".w2ui-color-palette").show(),v.fn._colorAdvanced=!1,v("#w2ui-overlay")[0].resize()},colorClick2(e){v(e).addClass("selected").prev().removeClass("selected").parents(".w2ui-overlay").find(".w2ui-color-advanced").show().parent().find(".w2ui-color-palette").hide(),v.fn._colorAdvanced=!0,v("#w2ui-overlay")[0].resize()}};0===v("#w2ui-overlay").length?v(n).w2overlay(b(l),l):(v("#w2ui-overlay .w2ui-colors").parent().html(b(l)),v("#w2ui-overlay").show()),setTimeout(()=>{w2utils.bindEvents(v("#w2ui-overlay .w2ui-eaction"),i)},1),v("#w2ui-overlay .w2ui-color").off(".w2color").on("mousedown.w2color",e=>{var t=v(e.originalEvent.target).attr("name");a=v(e.originalEvent.target).attr("index").split(":"),"INPUT"===n.tagName.toUpperCase()?(l.fireChange&&v(n).change(),v(n).next().find(">div").css("background-color",t)):v(n).data("_color",t),"function"==typeof l.onSelect&&l.onSelect(t)}).on("mouseup.w2color",()=>{setTimeout(()=>{0<v("#w2ui-overlay").length&&v("#w2ui-overlay").removeData("keepOpen")[0].hide()},10)}),v("#w2ui-overlay .color-original").off(".w2color").on("click.w2color",e=>{e=w2utils.parseColor(v(e.target).css("background-color"));null!=e&&(h=e,d=w2utils.rgb2hsv(h),u(d),c(),p())}),v("#w2ui-overlay input").off(".w2color").on("mousedown.w2color",e=>{v("#w2ui-overlay").data("keepOpen",!0),setTimeout(()=>{v("#w2ui-overlay").data("keepOpen",!0)},10),e.stopPropagation()}).on("change.w2color",()=>{let e=v(this),t=parseFloat(e.val());var i=parseFloat(e.attr("max"));isNaN(t)&&(t=0),1<i&&(t=parseInt(t)),0<i&&t>i&&(e.val(i),t=i),t<0&&(e.val(0),t=0);i=e.attr("name");let s={};-1!==["r","g","b","a"].indexOf(i)?(h[i]=t,d=w2utils.rgb2hsv(h)):-1!==["h","s","v"].indexOf(i)&&(s[i]=t),u(s),c(),p()});let o,d,h=w2utils.parseColor(l.color);function u(e,t){null!=e.h&&(d.h=e.h),null!=e.s&&(d.s=e.s),null!=e.v&&(d.v=e.v),null!=e.a&&(h.a=e.a,d.a=e.a),h=w2utils.hsv2rgb(d);let i="rgba("+h.r+","+h.g+","+h.b+","+h.a+")",s=[Number(h.r).toString(16).toUpperCase(),Number(h.g).toString(16).toUpperCase(),Number(h.b).toString(16).toUpperCase(),Math.round(255*Number(h.a)).toString(16).toUpperCase()];s.forEach((e,t)=>{1===e.length&&(s[t]="0"+e)}),i=s[0]+s[1]+s[2]+s[3],1===h.a&&(i=s[0]+s[1]+s[2]),v("#w2ui-overlay .color-preview").css("background-color","#"+i),v("#w2ui-overlay input").each((e,t)=>{t.name&&(null!=h[t.name]&&(t.value=h[t.name]),null!=d[t.name]&&(t.value=d[t.name]),"a"===t.name&&(t.value=h.a))}),t?v("#w2ui-overlay .color-original").css("background-color","#"+i):("INPUT"===n.tagName.toUpperCase()?(v(n).val(i).data("skipInit",!0),l.fireChange&&v(n).change(),v(n).next().find(">div").css("background-color","#"+i)):v(n).data("_color",i),"function"==typeof l.onSelect&&l.onSelect(i))}function c(){let e=v("#w2ui-overlay .palette .value1"),t=v("#w2ui-overlay .rainbow .value2"),i=v("#w2ui-overlay .alpha .value2");var s=parseInt(e.width())/2,l=parseInt(t.width())/2;e.css({left:150*d.s/100-s,top:125*(100-d.v)/100-s}),t.css("left",d.h/2.4-l),i.css("left",150*h.a-l)}function p(){var e=w2utils.hsv2rgb(d.h,100,100),e=e.r+","+e.g+","+e.b;v("#w2ui-overlay .palette").css("background-image","linear-gradient(90deg, rgba("+e+",0) 0%, rgba("+e+",1) 100%)")}function s(e){let t=v(this).find(".value1, .value2");var i=parseInt(t.width())/2;t.hasClass("move-x")&&t.css({left:e.offsetX-i+"px"}),t.hasClass("move-y")&&t.css({top:e.offsetY-i+"px"}),o={$el:t,x:e.pageX,y:e.pageY,width:t.parent().width(),height:t.parent().height(),left:parseInt(t.css("left")),top:parseInt(t.css("top"))},g(e),v("body").off(".w2color").on(w,g).on(m,f)}function f(e){v("body").off(".w2color")}function g(e){let t=o.$el;var i=e.pageX-o.x,s=e.pageY-o.y;let l=o.left+i,n=o.top+s;e=parseInt(t.width())/2;l<-e&&(l=-e),n<-e&&(n=-e),l>o.width-e&&(l=o.width-e),n>o.height-e&&(n=o.height-e),t.hasClass("move-x")&&t.css({left:l+"px"}),t.hasClass("move-y")&&t.css({top:n+"px"});i=t.parent().attr("name"),s=parseInt(t.css("left"))+e,e=parseInt(t.css("top"))+e;"palette"===i&&u({s:Math.round(s/o.width*100),v:Math.round(100-e/o.height*100)}),"rainbow"===i&&(u({h:Math.round(2.4*s)}),p()),"alpha"===i&&u({a:parseFloat(Number(s/150).toFixed(2))})}null==h&&(h={r:140,g:150,b:160,a:1},d=w2utils.rgb2hsv(h)),d=w2utils.rgb2hsv(h),!0!==v.fn._colorAdvanced&&!0!==l.advanced||(v("#w2ui-overlay .w2ui-color-tabs :nth-child(2)").click(),v("#w2ui-overlay").removeData("keepOpen")),u({},!0),p(),c();let m="mouseup.w2color",w="mousemove.w2color";function b(i){let s,l='<div class="w2ui-colors w2ui-eaction" data-mousedown="keepOpen|this"><div class="w2ui-color-palette"><table cellspacing="5"><tbody>';for(let t=0;t<r.length;t++){l+="<tr>";for(let e=0;e<r[t].length;e++)s="FFFFFF"===r[t][e]?";border: 1px solid #efefef":"",l+='<td>    <div class="w2ui-color '+(""===r[t][e]?"w2ui-no-color":"")+'" style="background-color: #'+r[t][e]+s+';"        name="'+r[t][e]+'" index="'+t+":"+e+'">'+(i.color==r[t][e]?"&#149;":"&#160;")+"    </div></td>",i.color==r[t][e]&&(a=[t,e]);l+="</tr>",t<2&&(l+='<tr><td style="height: 8px" colspan="8"></td></tr>')}return l+="</tbody></table></div>",l+='<div class="w2ui-color-advanced" style="display: none">   <div class="color-info">       <div class="color-preview-bg"><div class="color-preview"></div><div class="color-original"></div></div>       <div class="color-part">           <span>H</span> <input name="h" maxlength="3" max="360" tabindex="101">           <span>R</span> <input name="r" maxlength="3" max="255" tabindex="104">       </div>       <div class="color-part">           <span>S</span> <input name="s" maxlength="3" max="100" tabindex="102">           <span>G</span> <input name="g" maxlength="3" max="255" tabindex="105">       </div>       <div class="color-part">           <span>V</span> <input name="v" maxlength="3" max="100" tabindex="103">           <span>B</span> <input name="b" maxlength="3" max="255" tabindex="106">       </div>       <div class="color-part" style="margin: 30px 0px 0px 2px">           <span style="width: 40px">'+w2utils.lang("Opacity")+'</span>            <input name="a" maxlength="5" max="1" style="width: 32px !important" tabindex="107">       </div>   </div>   <div class="palette" name="palette">       <div class="palette-bg"></div>       <div class="value1 move-x move-y"></div>   </div>   <div class="rainbow" name="rainbow">       <div class="value2 move-x"></div>   </div>   <div class="alpha" name="alpha">       <div class="alpha-bg"></div>       <div class="value2 move-x"></div>   </div></div>',l+='<div class="w2ui-color-tabs">   <div class="w2ui-color-tab selected w2ui-eaction" data-click="colorClick|this"><span class="w2ui-icon w2ui-icon-colors"></span></div>   <div class="w2ui-color-tab w2ui-eaction" data-click="colorClick2|this"><span class="w2ui-icon w2ui-icon-settings"></span></div>   <div style="padding: 8px; text-align: right;">'+("string"==typeof i.html?i.html:"")+'</div></div></div><div style="clear: both; height: 0"></div>',l}w2utils.isIOS&&(m="touchend.w2color",w="touchmove.w2color"),v("#w2ui-overlay .palette").off(".w2color").on("mousedown.w2color",s),v("#w2ui-overlay .rainbow").off(".w2color").on("mousedown.w2color",s),v("#w2ui-overlay .alpha").off(".w2color").on("mousedown.w2color",s),n.nav=e=>{switch(e){case"up":a[0]--;break;case"down":a[0]++;break;case"right":a[1]++;break;case"left":a[1]--}a[0]<0&&(a[0]=0),a[0]>r.length-2&&(a[0]=r.length-2),a[1]<0&&(a[1]=0),a[1]>r[0].length-1&&(a[1]=r[0].length-1);e=r[a[0]][a[1]];return v(n).data("_color",e),e}}}}(jQuery),function(t,i){if("function"==typeof define&&define.amd)return define(()=>i);if("undefined"!=typeof exports){if("undefined"!=typeof module&&module.exports)return exports=module.exports=i;t=exports}t&&Object.keys(i).forEach(e=>{t[e]=i[e]})}(self,{w2ui:w2ui,w2locale:w2locale,w2event:w2event,w2utils:w2utils,w2popup:w2popup,w2alert:w2alert,w2confirm:w2confirm,w2prompt:w2prompt,w2field:w2field,w2form:w2form,w2grid:w2grid,w2layout:w2layout,w2sidebar:w2sidebar,w2tabs:w2tabs,w2toolbar:w2toolbar,addType:addType,removeType:removeType});